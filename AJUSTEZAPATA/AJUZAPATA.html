<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ajuste de Inventario – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{font-family: Arial; background:#f4f4f4; padding:20px;}
 h2{color:#00416A; font-size:26px; margin-bottom:20px;}
 table{width:100%; border-collapse:collapse; background:white; margin-top:15px;}
 th,td{border:1px solid #ccc; padding:10px; text-align:center; font-size:15px;}
 th{background:#00416A; color:white;}
 .positivo{color:green; font-weight:bold;}
 .negativo{color:red; font-weight:bold;}
 .btn{margin-top:20px; padding:12px 20px; background:#00416A; color:white; border:none;
      border-radius:6px; font-size:16px; cursor:pointer;}
</style>
</head>

<body>

<h2>Ajuste de Inventario – Almacén Zapata</h2>

<table>
<thead>
   <tr>
     <th>Código</th>
     <th>Descripción</th>
     <th>Base</th>
     <th>Entradas nuevas</th>
     <th>Salidas nuevas</th>
     <th>Existencia</th>
     <th>Inventario físico</th>
     <th>Diferencia</th>
   </tr>
</thead>
</table>
 
<div id="tablaInventario"></div>
<button id="btnGuardarAjustes" class="btn">Guardar ajustes</button>

<script type="module">

// ----------------------------------------------------------
// FIREBASE
// ----------------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, doc, query, where,
  getDocs, onSnapshot, addDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----------------------------------------------------------
// VARIABLES
// ----------------------------------------------------------
let productos = {};
let inventarioBase = {};
let entradasNuevas = {};
let salidasNuevas = {};

let productosListos = false;
let baseLista = false;
let entradasListas = false;
let salidasListas = false;

const fechaCorte = new Date("2025-11-24T00:00:00");

function normCodigo(cod){
  return (cod||"").toString().trim().padStart(12,"0");
}

// ----------------------------------------------------------
// CARGAR PRODUCTOS
// ----------------------------------------------------------
async function cargarProductos() {
  const q = query(collection(db, "productos"), where("activo","==",true));
  const snap = await getDocs(q);

  snap.forEach(d=>{
    const x = d.data();
    const codigo = normCodigo(x.codigoBarra || x.codigo);
    productos[codigo] = {
      descripcion: x.concepto || x.descripcion || "-",
      proveedor: x.proveedor || "OTROS"
    };
  });

  productosListos = true;
  intentarDibujar();
}

// ----------------------------------------------------------
// CARGAR INVENTARIO BASE
// ----------------------------------------------------------
async function cargarBase(){
  const snap = await getDocs(collection(db, "almacenes/almacen_zapata/inventario_base"));

  snap.forEach(d=>{
    const codigo = normCodigo(d.id);
    inventarioBase[codigo] = d.data().existencia || 0;
  });

  baseLista = true;
  intentarDibujar();
}

// ----------------------------------------------------------
// CARGAR ENTRADAS NUEVAS
// ----------------------------------------------------------
function cargarEntradas(){
  const ref = collection(db, "almacenes/almacen_zapata/entradas");

  onSnapshot(ref, snap=>{
    entradasNuevas = {};
    snap.forEach(docu=>{
      const x = docu.data();
      const f = x.fecha?.toDate?.() || new Date(x.fecha);
      if(f < fechaCorte) return;

      if(Array.isArray(x.productos)){
        x.productos.forEach(p=>{
          const codigo = normCodigo(p.codigoBarra || p.codigo);
          entradasNuevas[codigo] = (entradasNuevas[codigo]||0) + Number(p.cantidad||0);
        });
      }
    });

    entradasListas = true;
    intentarDibujar();
  });
}

// ----------------------------------------------------------
// CARGAR SALIDAS NUEVAS
// ----------------------------------------------------------
function cargarSalidas(){
  const ref = collection(db, "almacenes/almacen_zapata/salidas1.0");

  onSnapshot(ref, snap=>{
    salidasNuevas = {};
    snap.forEach(docu=>{
      const x = docu.data();
      const f = x.timestamp?.toDate?.() || new Date(x.timestamp);
      if(f < fechaCorte) return;

      if(Array.isArray(x.articulos)){
        x.articulos.forEach(p=>{
          const codigo = normCodigo(p.codigoBarra || p.codigo);
          salidasNuevas[codigo] = (salidasNuevas[codigo]||0) + Number(p.cantidad||0);
        });
      }
    });

    salidasListas = true;
    intentarDibujar();
  });
}

// ----------------------------------------------------------
// DIBUJAR TABLA (Optimizado anti-freeze)
// ----------------------------------------------------------
let dibujarTimeout = null;

function intentarDibujar(){
  if(!productosListos || !baseLista || !entradasListas || !salidasListas) return;

  // Evita que dibujar() se ejecute demasiadas veces al recibir snapshots
  clearTimeout(dibujarTimeout);

  dibujarTimeout = setTimeout(()=>{
    dibujar();
  }, 300); // puedes subirlo a 500 si tu tabla tiene +5,000 productos
}
// ----------------------------------------------------------
// CONFIG VIRTUAL TABLE
// ----------------------------------------------------------
const ROW_HEIGHT = 48; // altura estimada de una fila
let proveedorKeys = [];
let proveedorData = {};
let totalRows = 0;

let scrollContainer = null;
let visibleContainer = null;

function dibujar(){

  // Construimos grupos nuevamente
  proveedorData = {};
  totalRows = 0;

  Object.keys(productos).forEach(codigo=>{
    const p = productos[codigo];
    const base = inventarioBase[codigo] || 0;
    const ent = entradasNuevas[codigo] || 0;
    const sal = salidasNuevas[codigo] || 0;
    const exis = base + ent - sal;

    if(!proveedorData[p.proveedor]) proveedorData[p.proveedor] = [];
    proveedorData[p.proveedor].push({codigo, descripcion:p.descripcion, base, ent, sal, exis});
  });

  proveedorKeys = Object.keys(proveedorData).sort();

  // Calcular cuántas filas totales tendrá la tabla
  proveedorKeys.forEach(pk=>{
    // 1 fila para el título del proveedor
    totalRows += 1;
    // + filas del detalle
    totalRows += proveedorData[pk].length;
  });

  // Crear contenedor virtual si aún no existe
  if(!scrollContainer){
const tabla = document.getElementById("tablaInventario");

// SOLO BORRAR UNA VEZ, si NO existe contenedor
if (!scrollContainer) {
    tabla.innerHTML = "";
}

    // contenedor que hará scroll
    scrollContainer = document.createElement("div");
    scrollContainer.style.height = "75vh";
    scrollContainer.style.overflowY = "auto";
    scrollContainer.style.position = "relative";
    scrollContainer.style.border = "1px solid #ccc";

    // contenedor que contiene solo las filas visibles
    visibleContainer = document.createElement("div");
    visibleContainer.style.position = "absolute";
    visibleContainer.style.top = "0";
    visibleContainer.style.left = "0";
    visibleContainer.style.right = "0";

    scrollContainer.appendChild(visibleContainer);
    tabla.appendChild(scrollContainer);

    scrollContainer.addEventListener("scroll", renderVisibleRows);
  }

  // altura total virtual
  scrollContainer.style.height = "75vh";
  visibleContainer.style.height = (totalRows * ROW_HEIGHT) + "px";

  // Render de las filas visibles
  renderVisibleRows();
}
function renderVisibleRows(){
  const scrollTop = scrollContainer.scrollTop;
  const viewportHeight = scrollContainer.clientHeight;

  const startRow = Math.floor(scrollTop / ROW_HEIGHT);
  const endRow = Math.min(totalRows, Math.ceil((scrollTop + viewportHeight) / ROW_HEIGHT));

  // limpiar
  visibleContainer.innerHTML = "";

  let rowIndex = 0;
  let offsetTop = startRow * ROW_HEIGHT;

  proveedorKeys.forEach(pk=>{
    // título proveedor
    if(rowIndex >= startRow && rowIndex <= endRow){
      const div = document.createElement("div");
      div.style.position = "absolute";
      div.style.top = (rowIndex * ROW_HEIGHT) + "px";
      div.style.height = ROW_HEIGHT + "px";
      div.style.lineHeight = ROW_HEIGHT + "px";
      div.style.background = "#00416A";
      div.style.color = "white";
      div.style.fontWeight = "bold";
      div.style.paddingLeft = "10px";
      div.textContent = pk;
      visibleContainer.appendChild(div);
    }
    rowIndex++;

    // productos
    proveedorData[pk].forEach(p=>{
      if(rowIndex >= startRow && rowIndex <= endRow){
        const div = document.createElement("div");
        div.style.position = "absolute";
        div.style.top = (rowIndex * ROW_HEIGHT) + "px";
        div.style.height = ROW_HEIGHT + "px";
        div.style.display = "grid";
        div.style.gridTemplateColumns = "120px 1fr 80px 80px 80px 80px 120px 80px";
        div.style.alignItems = "center";
        div.style.borderBottom = "1px solid #ccc";
        div.style.background = "white";

        div.innerHTML = `
          <div>${p.codigo}</div>
          <div>${p.descripcion}</div>
          <div>${p.base}</div>
          <div>${p.ent}</div>
          <div>${p.sal}</div>
          <div style="color:${p.exis<0?'red':'green'}">${p.exis}</div>
          <div><input id="fisico_${p.codigo}" type="number" style="width:90%;padding:4px"
                      oninput="calcular('${p.codigo}', ${p.exis})"></div>
          <div id="dif_${p.codigo}" style="font-weight:bold;">0</div>
        `;

        visibleContainer.appendChild(div);
      }
      rowIndex++;
    });
  });
}

// ----------------------------------------------------------
// CALCULAR DIF
// ----------------------------------------------------------
window.calcular = function(codigo, existencia){
  const v = Number(document.getElementById("fisico_"+codigo).value);
  const celda = document.getElementById("dif_"+codigo);

  if(isNaN(v)){ celda.textContent="0"; celda.style.color="#000"; return; }

  const dif = v - existencia;
  celda.textContent = dif;
  celda.style.color = dif>0 ? "green" : dif<0 ? "red" : "#000";
};

// ----------------------------------------------------------
// GUARDAR AJUSTES (AFECTA SOLO EL PRODUCTO AJUSTADO)
// ----------------------------------------------------------
async function guardarAjustes(){

  let movimientos = [];
  let nuevosBases = {};

  Object.keys(productos).forEach(codigo=>{
    const base = inventarioBase[codigo] || 0;
    const ent = entradasNuevas[codigo] || 0;
    const sal = salidasNuevas[codigo] || 0;
    const exis = base + ent - sal;

    const fis = Number(document.getElementById("fisico_"+codigo)?.value);
    if(isNaN(fis)) return;
    const dif = fis - exis;
    if(dif === 0) return;

    movimientos.push({
      codigo,
      descripcion: productos[codigo].descripcion,
      cantidad: Math.abs(dif),
      tipoMovimiento: dif>0 ? "ENTRADA_AJUSTE" : "SALIDA_AJUSTE"
    });

    nuevosBases[codigo] = fis;
  });

  if(movimientos.length === 0){
    alert("No hay ajustes.");
    return;
  }

  const fecha = new Date();

  // ENTRADA DE AJUSTE
  await addDoc(collection(db, "almacenes/almacen_zapata/ajustes"), {
    fecha,
    movimientos
  });

  // SOLO SE ACTUALIZAN LOS PRODUCTOS AJUSTADOS
  for(const codigo of Object.keys(nuevosBases)){
    await setDoc(
      doc(db, "almacenes/almacen_zapata/inventario_base", codigo),
      {
        existencia: nuevosBases[codigo],
        descripcion: productos[codigo].descripcion,
        proveedor: productos[codigo].proveedor,
        actualizadoEn: fecha
      }
    );

    inventarioBase[codigo] = nuevosBases[codigo]; // REFRESCO INMEDIATO
  }

  alert("Ajuste guardado correctamente (solo productos ajustados).");
}

document.getElementById("btnGuardarAjustes")
  .addEventListener("click", guardarAjustes);

// ----------------------------------------------------------
// EJECUTAR
// ----------------------------------------------------------
await cargarProductos();
await cargarBase();
cargarEntradas();
cargarSalidas();

</script>

</body>

</html>

