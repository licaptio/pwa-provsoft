<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ajuste de Inventario – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
    font-family: Arial;
    background:#f4f4f4;
    margin:0;
    padding:20px;
 }

 h2{
    color:#003d66;
    font-size:28px;
    margin-bottom:25px;
 }

 /* Encabezado */
 .header-grid{
    display:grid;
    grid-template-columns:140px 1fr 90px 90px 90px 90px 120px 90px;
    background:#003d66;
    color:white;
    font-weight:bold;
    padding:12px;
    border-radius:6px 6px 0 0;
 }

 /* Banda del proveedor */
 .proveedor-banda{
    font-weight:bold;
    padding:10px 6px;
    color:#003d66;
    background:#e9f3f8;
    border-left:5px solid #003d66;
    margin-top:15px;
    margin-bottom:5px;
 }

 /* Filas */
 .fila{
    display:grid;
    grid-template-columns:140px 1fr 90px 90px 90px 90px 120px 90px;
    padding:10px;
    background:white;
    border-bottom:1px solid #ddd;
 }

 .fila:nth-child(even){
    background:#f9f9f9;
 }

 /* Input físico */
 .input-fisico{
    width:80px;
    padding:5px;
    border:1px solid #888;
    border-radius:4px;
    text-align:center;
 }

 /* Diferencias */
 .dif-pos{ color: green; font-weight:bold; }
 .dif-neg{ color: red; font-weight:bold; }
</style>
</head>

<body>

<h2>Ajuste de Inventario – Almacén Zapata</h2>

<div class="header-grid">
  <div>Código</div>
  <div>Descripción</div>
  <div>Base</div>
  <div>Entradas</div>
  <div>Salidas</div>
  <div>Existencia</div>
  <div>Físico</div>
  <div>Diferencia</div>
</div>

<div id="contenedorTabla"></div>

<button id="btnGuardar" 
        style="margin-top:20px;background:#003d66;padding:15px 20px;color:white;font-size:18px;border:none;border-radius:6px;cursor:pointer;">
  Guardar ajustes
</button>


<script type="module">
/* =======================
   FIREBASE
======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, query, where, getDocs, onSnapshot, addDoc, setDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* =======================
   VARIABLES
======================= */
let productos = {};
let baseInv   = {};
let entradas  = {};
let salidas   = {};
let fisicos   = {};

const fechaCorte = new Date("2025-11-24T00:00:00");

/* Normalización de código */
function norm(c){ return (c||"").toString().padStart(12,"0"); }

/* =======================
   CARGAS FIRESTORE
======================= */
async function cargarProductos() {
  const q = query(collection(db,"productos"), where("activo","==",true));
  const snap = await getDocs(q);
  snap.forEach(d=>{
    const x = d.data();
    const c = norm(x.codigoBarra||x.codigo);
    productos[c] = {
      descripcion: x.descripcion || x.concepto || "-",
      proveedor  : x.proveedor || "OTROS"
    };
  });
}

async function cargarBase() {
  const snap = await getDocs(collection(db,"almacenes/almacen_zapata/inventario_base"));
  snap.forEach(d=>{
    baseInv[norm(d.id)] = d.data().existencia || 0;
  });
}

function cargarEntradas(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/entradas"),snap=>{
    entradas = {};
    snap.forEach(d=>{
      const x = d.data();
      const f = x.fecha?.toDate?.() || new Date(x.fecha);
      if(f < fechaCorte) return;
      if(Array.isArray(x.productos)){
        x.productos.forEach(p=>{
          const c = norm(p.codigo||p.codigoBarra);
          entradas[c] = (entradas[c]||0) + Number(p.cantidad||0);
        });
      }
    });
    dibujar();
  });
}

function cargarSalidas(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/salidas1.0"),snap=>{
    salidas = {};
    snap.forEach(d=>{
      const x = d.data();
      const f = x.timestamp?.toDate?.() || new Date(x.timestamp);
      if(f < fechaCorte) return;
      if(Array.isArray(x.articulos)){
        x.articulos.forEach(p=>{
          const c = norm(p.codigo||p.codigoBarra);
          salidas[c] = (salidas[c]||0) + Number(p.cantidad||0);
        });
      }
    });
    dibujar();
  });
}

/* =======================
   DIBUJAR PÁGINA COMPLETA
======================= */
function dibujar(){
  
  let grupos = {};

  Object.keys(productos).forEach(c=>{
    const p = productos[c];
    const base = baseInv[c] || 0;
    const ent  = entradas[c] || 0;
    const sal  = salidas[c] || 0;
    const exis = base + ent - sal;

    if(!grupos[p.proveedor]) grupos[p.proveedor] = [];
    grupos[p.proveedor].push({codigo:c, descripcion:p.descripcion, base, ent, sal, exis});
  });

  const root = document.getElementById("contenedorTabla");
  root.innerHTML = "";

  Object.keys(grupos).sort().forEach(prov => {

    // Banda
    const banda = document.createElement("div");
    banda.className = "proveedor-banda";
    banda.textContent = `── ${prov} ───────────────────────────────────────`;
    root.appendChild(banda);

    // Productos
    grupos[prov].forEach(p => {

      const fila = document.createElement("div");
      fila.className = "fila";

      fila.innerHTML = `
        <div>${p.codigo}</div>
        <div>${p.descripcion}</div>
        <div>${p.base}</div>
        <div>${p.ent}</div>
        <div>${p.sal}</div>
        <div style="color:${p.exis<0?'red':'green'}">${p.exis}</div>

        <div>
          <input class="input-fisico" 
                 type="number" 
                 id="fisico_${p.codigo}"
                 value="${fisicos[p.codigo] ?? ''}"
                 oninput="calcular('${p.codigo}',${p.exis})">
        </div>

        <div id="dif_${p.codigo}" 
             class="${(fisicos[p.codigo] - p.exis)>=0 ? 'dif-pos':'dif-neg'}">
             ${fisicos[p.codigo] ? fisicos[p.codigo] - p.exis : 0}
        </div>
      `;

      root.appendChild(fila);
    });

  });
}

/* =======================
   CÁLCULO DIFERENCIA
======================= */
window.calcular = function(codigo, existencia){
  const v = Number(document.getElementById("fisico_"+codigo).value);
  fisicos[codigo] = v;
  const dif = v - existencia;
  const celda = document.getElementById("dif_"+codigo);
  celda.textContent = dif;
  celda.className = dif >= 0 ? "dif-pos" : "dif-neg";
};

/* =======================
   GUARDAR
======================= */
document.getElementById("btnGuardar").onclick = async () => {

  let movs = {};
  let lista = [];

  Object.keys(productos).forEach(c=>{
    const base = baseInv[c] || 0;
    const ent  = entradas[c] || 0;
    const sal  = salidas[c] || 0;
    const exis = base + ent - sal;
    const fis  = fisicos[c];
    if(fis === undefined) return;
    const dif = fis - exis;
    if(dif === 0) return;

    lista.push({
      codigo:c,
      cantidad:Math.abs(dif),
      tipoMovimiento: dif>0? "ENTRADA_AJUSTE":"SALIDA_AJUSTE",
      descripcion: productos[c].descripcion
    });

    movs[c] = fis;
  });

  if(lista.length===0){
    alert("No hay ajustes.");
    return;
  }

  const fecha = new Date();
  await addDoc(collection(db,"almacenes/almacen_zapata/ajustes"), {
    fecha,
    movimientos:lista
  });

  for(const c of Object.keys(movs)){
    await setDoc(doc(db,"almacenes/almacen_zapata/inventario_base",c),{
      existencia: movs[c],
      proveedor: productos[c].proveedor,
      descripcion: productos[c].descripcion,
      actualizadoEn: fecha
    });
  }

  alert("Ajuste guardado.");
};

/* =======================
   EJECUTAR
======================= */
await cargarProductos();
await cargarBase();
cargarEntradas();
cargarSalidas();

</script>

</body>
</html>
