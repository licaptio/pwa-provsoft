<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc, addDoc, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const selectRuta = document.getElementById("selectRuta");
const tbody = document.getElementById("tbodyCortes");
const modal = document.getElementById("modalResumen");
const contenido = document.getElementById("resumenContenido");
const btnCancelar = document.getElementById("btnCancelar");
const btnConfirmar = document.getElementById("btnConfirmar");

let corteActual = null;

// 🔹 Carga rutas desde usuarios_ruta
async function cargarRutas() {
  const snap = await getDocs(collection(db, "usuarios_ruta"));
  if (snap.empty) {
    // Si no tienes usuarios_ruta, añadimos manualmente tus rutas actuales
    const opt = document.createElement("option");
    opt.value = "AdministradorGeneral";
    opt.textContent = "GERARDO RIOS QUEZADA – AdministradorGeneral";
    selectRuta.appendChild(opt);
  } else {
    snap.forEach(docu => {
      const u = docu.data();
      if (u.rutaId) {
        const opt = document.createElement("option");
        opt.value = u.rutaId;
        opt.textContent = `${u.nombre || u.usuario} – ${u.rutaId}`;
        selectRuta.appendChild(opt);
      }
    });
  }
}

// 🔹 Cargar ventas pendientes de la ruta seleccionada
async function cargarPendientes(rutaId) {
  tbody.innerHTML = "<tr><td colspan='5'>Buscando ventas...</td></tr>";

  const ventasSnap = await getDocs(collection(db, "rutas_venta", rutaId, "ventas"));
  const hoy = new Date(); 
  const d = hoy.getDate(), m = hoy.getMonth() + 1, a = hoy.getFullYear();

  const ventasDeHoy = ventasSnap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(v => {
      const txt = v.fecha_txt || "";
      // Detectar día, mes y año con regex más flexible
      const match = txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
      if (!match) return false;
      const [_, diaV, mesV, anioV] = match.map(Number);
      return diaV === d && mesV === m && anioV === a && !v.cortado;
    });

  tbody.innerHTML = "";
  if (ventasDeHoy.length === 0) {
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>No hay cortes pendientes para esta ruta</td></tr>";
    return;
  }

  const totalHoy = ventasDeHoy.reduce((acc, v) => acc + (v.total || 0), 0);
  const ultimaVenta = ventasDeHoy.sort((a, b) => b.fecha_txt.localeCompare(a.fecha_txt))[0]?.fecha_txt || "—";

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${rutaId}</td>
    <td>${rutaId}</td>
    <td>$${totalHoy.toFixed(2)}</td>
    <td>${ultimaVenta}</td>
    <td><button data-ruta="${rutaId}">📊 Hacer Corte</button></td>
  `;
  tbody.appendChild(tr);
}

// 🔹 Evento: cambio en el selector
selectRuta.addEventListener("change", (e) => {
  const rutaId = e.target.value;
  if (!rutaId) {
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>Selecciona una ruta</td></tr>";
    return;
  }
  cargarPendientes(rutaId);
});

// 🔹 Al hacer clic en “Hacer Corte”
tbody.addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-ruta]");
  if (!btn) return;
  const rutaId = btn.getAttribute("data-ruta");
  corteActual = { rutaId, btn };
  await mostrarResumenCorte(rutaId);
});

btnCancelar.onclick = () => {
  modal.style.display = "none";
  corteActual = null;
};

// 🔹 Confirmar corte
btnConfirmar.onclick = async () => {
  if (!corteActual) return;
  const { rutaId, resumen } = corteActual;
  btnConfirmar.disabled = true;
  btnConfirmar.textContent = "Cortando...";

  const ventasRef = collection(db, "rutas_venta", rutaId, "ventas");
  const snap = await getDocs(ventasRef);
  const hoy = new Date(); 
  const d = hoy.getDate(), m = hoy.getMonth() + 1, a = hoy.getFullYear();

  for (const docu of snap.docs) {
    const v = docu.data();
    const txt = v.fecha_txt || "";
    const match = txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
    if (!match) continue;
    const [_, diaV, mesV, anioV] = match.map(Number);
    if (diaV === d && mesV === m && anioV === a) {
      await updateDoc(doc(db, "rutas_venta", rutaId, "ventas", docu.id), { cortado: true });
    }
  }

  await addDoc(collection(db, "cortes_globales"), {
    rutaId,
    fecha: serverTimestamp(),
    resumen: resumen || {},
    realizado_por: "Administrador"
  });

  const usuario = encodeURIComponent("Administrador");
  const url = `corte_reporte.html?rutaId=${encodeURIComponent(rutaId)}&usuario=${usuario}`;
  window.open(url, "_blank");

  alert("✅ Corte realizado y reporte generado");
  modal.style.display = "none";
  selectRuta.value = "";
  tbody.innerHTML = "<tr><td colspan='5'>Selecciona una ruta...</td></tr>";
};

// 🔹 Mostrar resumen antes de confirmar
async function mostrarResumenCorte(rutaId) {
  contenido.innerHTML = "Generando resumen...";
  modal.style.display = "flex";

  const ventasSnap = await getDocs(collection(db, "rutas_venta", rutaId, "ventas"));
  const hoy = new Date();
  const d = hoy.getDate(), m = hoy.getMonth() + 1, a = hoy.getFullYear();
  const ventasDeHoy = ventasSnap.docs.map(d => ({ id: d.id, ...d.data() })).filter(v => {
    const txt = v.fecha_txt || "";
    const match = txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
    if (!match) return false;
    const [_, diaV, mesV, anioV] = match.map(Number);
    return diaV === d && mesV === m && anioV === a && !v.cortado;
  });

  const porMetodo = {}, porDepto = {};
  let totalDia = 0;
  for (const v of ventasDeHoy) {
    totalDia += v.total || 0;
    const metodo = v.metodo_pago || "otro";
    porMetodo[metodo] = (porMetodo[metodo] || 0) + (v.total || 0);

    for (const det of (v.detalle || [])) {
      const dep = det.departamento || "General";
      porDepto[dep] = (porDepto[dep] || 0) + (det.importe || 0);
    }
  }

  const totalTickets = ventasDeHoy.length;
  const totalEfectivo = porMetodo.efectivo || 0;
  const totalCredito  = porMetodo.credito || porMetodo.tarjeta || 0;
  corteActual.resumen = { totalDia, porMetodo, porDepto, totalTickets, totalEfectivo, totalCredito };

  let html = `<h3>Total del día: $${totalDia.toFixed(2)}</h3>`;
  html += `<p>Tickets: ${totalTickets}</p>`;
  html += "<h4>Por Departamento</h4><table><tbody>";
  for (const [dep, val] of Object.entries(porDepto)) {
    html += `<tr><td>${dep}</td><td style='text-align:right;'>$${val.toFixed(2)}</td></tr>`;
  }
  html += "</tbody></table><h4>Métodos de Pago</h4><table><tbody>";
  for (const [met, val] of Object.entries(porMetodo)) {
    html += `<tr><td>${met}</td><td style='text-align:right;'>$${val.toFixed(2)}</td></tr>`;
  }
  html += "</tbody></table>";

  contenido.innerHTML = html;
}

cargarRutas();
</script>
