<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cortes Pendientes ‚Äì PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #222;
    }
    h1 { color: #00416A; text-align:center; margin-bottom:10px; }
    select {
      display:block;
      margin:0 auto 20px auto;
      padding:8px 12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:14px;
    }
    table {
      width: 100%; border-collapse: collapse; background:#fff;
      border-radius: 10px; overflow:hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    th, td {
      padding: 10px 12px; border-bottom: 1px solid #ddd;
      text-align: left; font-size: 14px;
    }
    th { background: #00416A; color: #fff; }
    tr:hover { background: #f1f5f9; }
    button {
      padding: 6px 10px; border:none; border-radius:6px; cursor:pointer;
      background:#0c6cbd; color:white; font-weight:600;
    }
    button[disabled] { background:#999; cursor:not-allowed; }
    /* Modal */
    #modalResumen {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.55);
      align-items:center; justify-content:center; z-index:2000;
    }
    .modal-card {
      background:#fff; border-radius:12px; width:min(500px,95vw);
      padding:20px; box-shadow:0 8px 25px rgba(0,0,0,.3);
    }
    .modal-card h2 { margin-top:0; color:#00416A; }
    .modal-card table { width:100%; margin-top:10px; }
    .modal-card td, .modal-card th { border-bottom:1px solid #ddd; padding:6px; }
    .modal-actions { margin-top:15px; text-align:right; }
  </style>
<!-- üåç Librer√≠as para mapa y captura de imagen -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.3.0/dist/dom-to-image-more.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

  <!-- Contenedores ocultos para capturar im√°genes -->
  <div id="mapaCorte"
     style="width:600px;height:400px;position:absolute;left:-9999px;top:0;">
</div>
  <div id="graficaDeptos" style="width:600px; height:400px; display:none;">
    <canvas id="canvasDeptos" width="600" height="400"></canvas>
  </div>
  <h1>Cortes Pendientes</h1>
  <select id="selectRuta">
  <option value="">Selecciona una ruta...</option>
</select>

<table id="tablaCortes">
  <thead>
    <tr>
      <th>Usuario</th>
      <th>Ruta</th>
      <th>Total D√≠a</th>
      <th>√öltima Venta</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody id="tbodyCortes">
    <tr><td colspan="5" style="text-align:center;">Selecciona una ruta para ver pendientes</td></tr>
  </tbody>
</table>

<!-- Modal resumen -->
<div id="modalResumen">
  <div class="modal-card">
    <h2>Resumen de Corte</h2>
    <div id="resumenContenido">Cargando...</div>
    <div class="modal-actions">
      <button id="btnCancelar">Cancelar</button>
      <button id="btnConfirmar" style="background:#1e8e3e;">Confirmar Corte</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, query, where, updateDoc, doc, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", async () => {
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const selectRuta = document.getElementById("selectRuta");
  const tbody = document.getElementById("tbodyCortes");
  const modal = document.getElementById("modalResumen");
  const contenido = document.getElementById("resumenContenido");
  const btnCancelar = document.getElementById("btnCancelar");
  const btnConfirmar = document.getElementById("btnConfirmar");

  let corteActual = null;
  let mapaDepartamentos = {};

  // üîπ Cargar departamentos (cat√°logo)
  async function cargarDepartamentos() {
    const depSnap = await getDocs(collection(db, "departamentos_venta"));
    depSnap.forEach(d => {
      const data = d.data();
      mapaDepartamentos[data.id?.toString()] = data;
    });
  }

  // üîπ Cargar rutas √∫nicas
  async function cargarRutas() {
    const snap = await getDocs(collection(db, "rutas_venta"));
    const rutas = new Map();
    snap.forEach(d => {
      const v = d.data();
      if (v.rutaId) rutas.set(v.rutaId, v.atendio || v.usuario || "Desconocido");
    });
    rutas.forEach((nombre, id) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = `${nombre} ‚Äì ${id}`;
      selectRuta.appendChild(opt);
    });
  }

  async function cargarPendientes(rutaId) {
    tbody.innerHTML = "<tr><td colspan='5'>Buscando ventas...</td></tr>";
    const qVentas = query(collection(db, "rutas_venta"), where("rutaId", "==", rutaId), where("cortado", "==", false));
    const snap = await getDocs(qVentas);
    const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (ventas.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>No hay cortes pendientes</td></tr>";
      return;
    }
    const totalHoy = ventas.reduce((a, v) => a + (v.total || 0), 0);
    const ultima = ventas.sort((a,b)=> (b.fecha_txt||'').localeCompare(a.fecha_txt||''))[0]?.fecha_txt || "‚Äî";
    tbody.innerHTML = `
      <tr>
        <td>${ventas[0].atendio || ventas[0].usuario || "‚Äî"}</td>
        <td>${rutaId}</td>
        <td>$${totalHoy.toFixed(2)}</td>
        <td>${ultima}</td>
        <td><button data-ruta="${rutaId}">üìä Hacer Corte</button></td>
      </tr>`;
  }

  selectRuta.addEventListener("change", e => {
    const rutaId = e.target.value;
    if (!rutaId) {
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>Selecciona una ruta</td></tr>";
      return;
    }
    cargarPendientes(rutaId);
  });

  tbody.addEventListener("click", async e => {
    const btn = e.target.closest("button[data-ruta]");
    if (!btn) return;
    const rutaId = btn.getAttribute("data-ruta");
    corteActual = { rutaId, btn };
    await mostrarResumenCorte(rutaId);
  });

  btnCancelar.onclick = () => (modal.style.display = "none");

btnConfirmar.onclick = async () => {
  if (!corteActual) return;
  const { rutaId, resumen } = corteActual;
  btnConfirmar.disabled = true;
  btnConfirmar.textContent = "Cortando...";

  // üîπ Marcar ventas como cortadas
  const qVentas = query(
    collection(db, "rutas_venta"),
    where("rutaId", "==", rutaId),
    where("cortado", "==", false)
  );
  const snap = await getDocs(qVentas);
  const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  for (const d of snap.docs) await updateDoc(doc(db, "rutas_venta", d.id), { cortado: true });
// üîπ Construir ventas_incluidas con los datos clave de cada venta
const ventas_incluidas = ventas.map(v => ({
  idVenta: v.folio || v.id,
  total: v.total || 0,
  cliente: v.cliente || "PUBLICO EN GENERAL",
  metodo_pago: v.metodo_pago || "efectivo",
  fecha_txt: v.fecha_txt || "",
  ubicacion: v.ubicacion || null,
  resumen_deptos: (() => {
    const porDepto = {};
    for (const det of (v.detalle || [])) {
      const depId = det.departamento_id?.toString() || "0";
      const depInfo = mapaDepartamentos[depId] || { nombre: "SIN DEPTO" };
      const nombre = depInfo.nombre;
      const importe = det.importe || (det.precioVenta * det.cantidad) || 0;
      porDepto[nombre] = (porDepto[nombre] || 0) + importe;
    }
    return porDepto;
  })()
}));

// üîπ Guardar resumen + detalle completo en Firestore
const corteRef = await addDoc(collection(db, "cortes_globales"), {
  rutaId,
  fecha: serverTimestamp(),
  creado_en: new Date().toISOString(),
  realizado_por: "Administrador",
  version: "1.0.3",
  total_registros: ventas_incluidas.length,
  resumen,
  ventas_incluidas
});

// üîπ Crear PDF con jsPDF
const { jsPDF } = window.jspdf;
const pdf = new jsPDF();

// === üßæ HOJA 1: RESUMEN + DETALLE ===
pdf.setFont("helvetica", "bold");
pdf.text(`REPORTE DE CORTE ‚Äì ${rutaId}`, 10, 15);
pdf.setFont("helvetica", "normal");
pdf.text(`Fecha: ${new Date().toLocaleString()}`, 10, 25);
pdf.text(`Total del d√≠a: $${resumen.totalDia.toFixed(2)}`, 10, 35);
pdf.text(`Tickets: ${resumen.totalTickets}`, 10, 43);

// üîπ Desglose por departamento
pdf.setFont("helvetica", "bold");
pdf.text("Por Departamento:", 10, 55);
pdf.setFont("helvetica", "normal");
let y = 63;
for (const [dep, val] of Object.entries(resumen.porDepto)) {
  if (y > 260) break; // Evita desbordar
  pdf.text(`${dep}: $${val.toFixed(2)}`, 12, y);
  y += 7;
}

// üîπ M√©todos de pago
y += 8;
pdf.setFont("helvetica", "bold");
pdf.text("Por M√©todo de Pago:", 10, y);
pdf.setFont("helvetica", "normal");
y += 8;
for (const [met, val] of Object.entries(resumen.porMetodo)) {
  pdf.text(`${met}: $${val.toFixed(2)}`, 12, y);
  y += 7;
}

// === üó∫Ô∏è HOJA 2: MAPA DE RUTA ===
pdf.addPage();
pdf.setFont("helvetica", "bold");
pdf.setFontSize(14);
pdf.text("üìç RUTA DE VENTAS DEL D√çA", 10, 20);
try {
  const imgMapa = await generarImagenMapa(ventas);
  if (imgMapa) pdf.addImage(imgMapa, "PNG", 10, 30, 180, 120);
} catch (err) {
  console.error("‚ö†Ô∏è Error generando mapa:", err);
}
pdf.setFontSize(10);
pdf.text("Mapa generado autom√°ticamente por PROVSOFT POS", 10, 160);

// üíæ Guardar PDF local
const fecha = new Date().toISOString().slice(0,10);
pdf.save(`Corte_${rutaId}_${fecha}.pdf`);

  alert("‚úÖ Corte realizado y PDF generado con mapa de ruta.");
  modal.style.display = "none";
  selectRuta.value = "";
  tbody.innerHTML = "<tr><td colspan='5'>Selecciona una ruta...</td></tr>";
};

  async function mostrarResumenCorte(rutaId) {
    contenido.innerHTML = "Generando resumen...";
    modal.style.display = "flex";

    const qVentas = query(collection(db, "rutas_venta"), where("rutaId", "==", rutaId), where("cortado", "==", false));
    const snap = await getDocs(qVentas);
    const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    const porMetodo = {}, porDepto = {};
    let totalDia = 0;

    for (const v of ventas) {
      totalDia += v.total || 0;
      const metodo = v.metodo_pago || "otro";
      porMetodo[metodo] = (porMetodo[metodo] || 0) + (v.total || 0);

      for (const det of (v.detalle || [])) {
        const depId = det.departamento_id?.toString() || "0";
        const depInfo = mapaDepartamentos[depId] || { nombre: "SIN DEPARTAMENTO" };
        const depNombre = depInfo.nombre;
        const importe = det.importe || (det.precioVenta * det.cantidad) || 0;
        porDepto[depNombre] = (porDepto[depNombre] || 0) + importe;
      }
    }

    const totalTickets = ventas.length;
    const totalEfectivo = porMetodo.efectivo || 0;
    const totalCredito = porMetodo.tarjeta || 0;
    corteActual.resumen = { totalDia, totalTickets, totalEfectivo, totalCredito, porMetodo, porDepto };

    let html = `<h3>Total del d√≠a: $${totalDia.toFixed(2)}</h3>`;
    html += `<p>Tickets: ${totalTickets}</p>`;
    html += "<h4>Por Departamento</h4><table><tbody>";
    for (const [dep, val] of Object.entries(porDepto))
      html += `<tr><td>${dep}</td><td style='text-align:right;'>$${val.toFixed(2)}</td></tr>`;
    html += "</tbody></table><h4>M√©todos de Pago</h4><table><tbody>";
    for (const [met, val] of Object.entries(porMetodo))
      html += `<tr><td>${met}</td><td style='text-align:right;'>$${val.toFixed(2)}</td></tr>`;
    html += "</tbody></table>";

    contenido.innerHTML = html;
  }

  await cargarDepartamentos();
  await cargarRutas();
});
async function generarImagenMapa(ventas) {
  const divMapa = document.getElementById("mapaCorte");
  divMapa.style.display = "block";

  // Inicializa el mapa
  const map = L.map(divMapa, {
    zoomControl: false,
    attributionControl: false
  }).setView([25.5, -99.56], 12);

// Capa base con calles y colonias (Carto Light)
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png", {
  subdomains: "abcd",
  maxZoom: 19,
  attribution: "¬© OpenStreetMap & CARTO"
}).addTo(map);

  const puntos = [];

  for (const v of ventas) {
    if (!v.ubicacion?.lat || !v.ubicacion?.lon) continue;
    const { lat, lon } = v.ubicacion;
    const total = (v.total || 0).toFixed(2);
    const cliente = v.cliente || "Mostrador";

    const marker = L.circleMarker([lat, lon], {
      radius: 6,
      color: "#00416A",
      fillColor: "#0c6cbd",
      fillOpacity: 0.8
    }).addTo(map);

    marker.bindTooltip(`${cliente} ‚Äì $${total}`, { permanent: false });
    puntos.push([lat, lon]);
  }

  if (puntos.length > 1) {
    const poly = L.polyline(puntos, { color: "#0c6cbd", weight: 3 }).addTo(map);
    map.fitBounds(poly.getBounds(), { padding: [40, 40] });
  } else if (puntos.length === 1) {
    map.setView(puntos[0], 14);
  }

  // Forzar render completo del mapa
  map.invalidateSize();
  await new Promise(r => setTimeout(r, 3000));

  // Capturar imagen
  let dataUrl = null;
  try {
    dataUrl = await domtoimage.toPng(divMapa, {
      quality: 0.98,
      bgcolor: "#ffffff"
    });
  } catch (e) {
    console.error("‚ö†Ô∏è Error al capturar mapa:", e);
  }

  map.remove();
  divMapa.style.display = "none";

  console.log("üó∫Ô∏è Mapa generado correctamente con", puntos.length, "puntos.");
  return dataUrl;
}

// === üìä Generar imagen de gr√°fica por departamento ===
async function generarImagenGraficaDeptos(porDepto) {
  const divGrafica = document.getElementById("graficaDeptos");
  const canvas = document.getElementById("canvasDeptos");
  divGrafica.style.display = "block";

  const etiquetas = Object.keys(porDepto);
  const valores = Object.values(porDepto).map(v => Number(v.toFixed(2)));

  // Crear gr√°fica de pastel con Chart.js
  const ctx = canvas.getContext("2d");
  const chart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: etiquetas,
      datasets: [{
        data: valores,
        backgroundColor: etiquetas.map(() =>
          `hsl(${Math.floor(Math.random()*360)},70%,60%)`
        )
      }]
    },
    options: {
      plugins: {
        legend: { position: "right" },
        title: {
          display: true,
          text: "Distribuci√≥n por Departamento",
          font: { size: 16 }
        }
      }
    }
  });

  // Esperar renderizado y exportar imagen
  await new Promise(r => setTimeout(r, 1200));
  const dataUrl = await domtoimage.toPng(divGrafica, { quality: 0.95 });

  chart.destroy();
  divGrafica.style.display = "none";

  console.log("üìä Gr√°fica de departamentos generada como imagen PNG");
  return dataUrl;
}

</script>
</body>
</html>
