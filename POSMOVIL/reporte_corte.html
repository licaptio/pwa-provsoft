<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Corte ‚Äì PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 30px;
      color: #222;
    }
    h1 { color: #00416A; text-align:center; margin-bottom:5px; }
    h2 { text-align:center; color:#555; margin-top:0; }
    #resumen {
      display: flex; justify-content: center; gap: 40px; margin: 20px 0;
      flex-wrap: wrap;
    }
    .card {
      background: white; border-radius: 10px; padding: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,.1); text-align:center; min-width: 150px;
    }
    .card h3 { margin: 0; color:#0c6cbd; }
    .card p { margin: 5px 0 0; font-size: 18px; font-weight:600; }
    table {
      width:100%; border-collapse:collapse; background:white; margin-top:30px;
      box-shadow:0 3px 8px rgba(0,0,0,.1);
    }
    th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
    th { background:#00416A; color:white; }
    tr:hover { background:#f1f5f9; }
    #grafico {
      max-width:600px; margin: 40px auto;
    }
    #btnImprimir {
      display:block; margin:20px auto; padding:10px 20px;
      border:none; background:#0c6cbd; color:white; border-radius:6px;
      cursor:pointer; font-weight:bold;
    }
    #infoCorte { text-align:center; color:#555; margin-top:10px; }
  </style>
</head>
<body>

<h1>Reporte de Corte</h1>
<h2 id="tituloRuta">Cargando...</h2>
<p id="infoCorte">Obteniendo informaci√≥n del corte...</p>

<div id="resumen">
  <div class="card">
    <h3>Ventas Totales</h3>
    <p id="ventaTotal">$0.00</p>
  </div>
  <div class="card">
    <h3>Total Efectivo</h3>
    <p id="efectivoTotal">$0.00</p>
  </div>
  <div class="card">
    <h3>Total Cr√©dito</h3>
    <p id="creditoTotal">$0.00</p>
  </div>
</div>

<div id="grafico">
  <canvas id="graficaDeptos"></canvas>
</div>

<table id="tablaDeptos">
  <thead>
    <tr>
      <th>Departamento</th>
      <th>Venta</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="2" style="text-align:center;color:#888;">Cargando...</td></tr>
  </tbody>
</table>

<button id="btnImprimir">üñ®Ô∏è Imprimir / Exportar PDF</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// üîπ Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîπ Leer par√°metros de URL
const params = new URLSearchParams(window.location.search);
const corteId = params.get("corteId");

if (!corteId) {
  document.body.innerHTML = "<h2 style='text-align:center;color:red;'>‚ùå No se proporcion√≥ un ID de corte v√°lido.</h2>";
  throw new Error("Sin corteId");
}

// üîπ Funci√≥n principal
async function mostrarCorte() {
  const ref = doc(db, "cortes_globales", corteId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    document.body.innerHTML = "<h2 style='text-align:center;color:red;'>‚ö†Ô∏è Corte no encontrado en Firestore.</h2>";
    return;
  }

  const data = snap.data();
  const resumen = data.resumen || {};
  const ruta = data.rutaId || "Desconocida";
  const fecha = data.fecha?.toDate?.()?.toLocaleString?.() || "Sin fecha";
  const porDepto = resumen.porDepto || {};
  const porMetodo = resumen.porMetodo || {};

  document.getElementById("tituloRuta").textContent = `Ruta: ${ruta}`;
  document.getElementById("infoCorte").textContent = `Fecha: ${fecha} | Realizado por: ${data.realizado_por}`;

  // üî∏ Mostrar totales
  document.getElementById("ventaTotal").textContent = `$${(resumen.totalDia || 0).toFixed(2)}`;
  document.getElementById("efectivoTotal").textContent = `$${(resumen.totalEfectivo || porMetodo.efectivo || 0).toFixed(2)}`;
  document.getElementById("creditoTotal").textContent = `$${(resumen.totalCredito || porMetodo.tarjeta || 0).toFixed(2)}`;

  // üî∏ Tabla de departamentos
  const tbody = document.querySelector("#tablaDeptos tbody");
  const entries = Object.entries(porDepto);
  if (entries.length === 0) {
    tbody.innerHTML = "<tr><td colspan='2' style='text-align:center;color:#888;'>No hay informaci√≥n por departamento</td></tr>";
  } else {
    tbody.innerHTML = entries.map(([dep, val]) => `
      <tr>
        <td>${dep}</td>
        <td>$${val.toFixed(2)}</td>
      </tr>
    `).join("");
  }

  // üî∏ Gr√°fica
  const ctx = document.getElementById("graficaDeptos");
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(porDepto),
      datasets: [{
        label: 'Ventas por Departamento',
        data: Object.values(porDepto),
        backgroundColor: [
          "#0c6cbd","#1e8e3e","#ffb703","#ff006e","#8338ec","#fb5607","#3a86ff","#06d6a0","#ffd166"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Distribuci√≥n de Ventas por Departamento' }
      }
    }
  });
}

// üîπ Bot√≥n imprimir/exportar
document.getElementById("btnImprimir").addEventListener("click", () => {
  window.print();
});

mostrarCorte();
</script>
</body>
</html>
