<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Control ‚Äì Fijaci√≥n de Art√≠culos | PROVSOFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ===== BLOQUE 1: FIREBASE + CONTROL DE ORDEN ===== -->
  <script type="module">
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, query, where, orderBy, limit,
      getDocs, getDoc, setDoc, doc, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== DOM ELEMENTOS =====
    const busqueda = document.getElementById('busqueda');
    const resultados = document.getElementById('resultados');
    const codigo = document.getElementById('codigo');
    const concepto = document.getElementById('concepto');
    const inventario_fijado = document.getElementById('inventario_fijado');
    const inventario_minimo = document.getElementById('inventario_minimo');
    const usuario = document.getElementById('usuario');
    const msg = document.getElementById('msg');
    const tbody = document.getElementById('tbody');
    const selectorOrden = document.getElementById('selectorOrden');

    // ===== BLOQUE: FUNCI√ìN DE CARGA (ahora ordenada) =====
    async function cargarTabla() {
      const orden = selectorOrden.value; // 'concepto' o 'codigoBarra'
      const segRef = collection(db, "seguimiento_inventario");
      const q = query(segRef, where("activo", "==", true), orderBy(orden));
      const snap = await getDocs(q);

      tbody.innerHTML = "";
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.codigoBarra}</td>
          <td>${data.concepto || "-"}</td>
          <td>${data.inventario_fijado}</td>
          <td>${data.inventario_minimo}</td>
          <td>${data.inventario_teorico || data.inventario_fijado}</td>
          <td>${data.actualizadoEn ? data.actualizadoEn.split("T")[0] : "-"}</td>
        `;
        tr.onclick = () => {
          codigo.value = data.codigoBarra;
          concepto.value = data.concepto;
          inventario_fijado.value = data.inventario_fijado;
          inventario_minimo.value = data.inventario_minimo;
          msg.innerText = "üìù Editando art√≠culo " + data.codigoBarra;
          msg.style.color = "white";
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        tbody.appendChild(tr);
      });
    }

    // Cuando cambie el selector, recarga tabla
    selectorOrden.addEventListener("change", cargarTabla);

    // ===== FIN DEL SCRIPT =====
    cargarTabla();
// =======================================================
// üîç BLOQUE: B√öSQUEDA DIN√ÅMICA DE ART√çCULOS (por c√≥digo o nombre)
// =======================================================
busqueda.addEventListener("input", async () => {
  const texto = busqueda.value.trim().toUpperCase();
  resultados.innerHTML = "";
  tbody.innerHTML = "";

  if (texto.length < 2) {
    await cargarTabla(); // üîÑ si borras el texto, recarga todo
    return;
  }

  const segRef = collection(db, "seguimiento_inventario");

  try {
    // üîé Buscar por c√≥digo o por concepto (2 consultas paralelas)
    const [snapCod, snapNom] = await Promise.all([
      getDocs(query(segRef, where("codigoBarra", ">=", texto), where("codigoBarra", "<=", texto + "\uf8ff"))),
      getDocs(query(segRef, where("concepto", ">=", texto), where("concepto", "<=", texto + "\uf8ff")))
    ]);

    const resultadosFinales = new Map(); // evitar duplicados
    [...snapCod.docs, ...snapNom.docs].forEach(docu => resultadosFinales.set(docu.id, docu.data()));

    if (resultadosFinales.size === 0) {
      resultados.innerHTML = "<p style='color:yellow;'>‚ö†Ô∏è No se encontraron coincidencias</p>";
      return;
    }

    resultadosFinales.forEach((data, id) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.codigoBarra}</td>
        <td>${data.concepto || "-"}</td>
        <td>${data.inventario_fijado}</td>
        <td>${data.inventario_minimo}</td>
        <td>${data.inventario_teorico || data.inventario_fijado}</td>
        <td>${data.actualizadoEn ? data.actualizadoEn.split("T")[0] : "-"}</td>
      `;
      tr.onclick = () => {
        codigo.value = data.codigoBarra;
        concepto.value = data.concepto;
        inventario_fijado.value = data.inventario_fijado;
        inventario_minimo.value = data.inventario_minimo;
        msg.innerText = "üìù Editando art√≠culo " + data.codigoBarra;
        msg.style.color = "white";
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("‚ùå Error al buscar:", err);
    resultados.innerHTML = "<p style='color:red;'>Error al buscar productos</p>";
  }
});

// ===== BLOQUE: GUARDAR / ACTUALIZAR ART√çCULO =====
async function guardarArticulo() {
  const codigoVal = codigo.value.trim();
  const conceptoVal = concepto.value.trim();
  const fijadoVal = parseFloat(inventario_fijado.value);
  const minimoVal = parseFloat(inventario_minimo.value);
  const usuarioVal = usuario.value.trim();

  if (!codigoVal || !conceptoVal || isNaN(fijadoVal)) {
    msg.innerText = "‚ö†Ô∏è Completa todos los campos antes de guardar.";
    msg.style.color = "yellow";
    return;
  }

  try {
    const docRef = doc(db, "seguimiento_inventario", codigoVal);

await setDoc(docRef, {
  codigoBarra: codigoVal,
  concepto: conceptoVal,
  inventario_fijado: fijadoVal,
  inventario_minimo: minimoVal || 0,
  usuario: usuarioVal, // ‚úÖ corregido
  actualizadoEn: new Date().toISOString(),
  activo: true
}, { merge: true });


    msg.innerText = "‚úÖ Art√≠culo guardado correctamente.";
    msg.style.color = "lightgreen";
    await cargarTabla();
  } catch (err) {
    console.error(err);
    msg.innerText = "‚ùå Error al guardar el art√≠culo.";
    msg.style.color = "red";
  }
}

// Hacer accesible la funci√≥n al bot√≥n HTML
window.guardarArticulo = guardarArticulo;
    
  </script>

  <!-- ===== BLOQUE 2: ESTILOS ===== -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: white;
      padding: 20px;
    }
    .card {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 800px;
      margin: auto;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: none;
    }
    select {
      background: #fff;
      color: #00416A;
      font-weight: 600;
    }
    button {
      cursor: pointer;
      font-weight: 600;
      background: #F5AF19;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(255,255,255,0.95);
      color: black;
      border-radius: 10px;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th { background: #00416A; color: white; }
    tr:hover { background: #f0f0f0; cursor: pointer; }
  </style>
</head>

<body>
  <div class="card">
    <h2>üì¶ Panel de Control de Inventario Fijado</h2>

    <input id="busqueda" placeholder="Buscar por c√≥digo o concepto (solo activos)">
    <div id="resultados"></div>

    <input id="codigo" placeholder="C√≥digo de barras" disabled>
    <input id="concepto" placeholder="Concepto del art√≠culo" disabled>
    <input id="inventario_fijado" type="number" placeholder="Inventario fijado">
    <input id="inventario_minimo" type="number" placeholder="Inventario m√≠nimo (alerta)">
    <input id="usuario" placeholder="Usuario" value="Gerardo R√≠os">

    <button onclick="guardarArticulo()">üíæ Guardar / Actualizar</button>
    <p id="msg"></p>

    <h3>üìã Art√≠culos Fijados Activos</h3>

    <!-- üî§ Nuevo selector de orden -->
    <label>Ordenar por:</label>
    <select id="selectorOrden">
      <option value="concepto">üî§ Nombre (A ‚Üí Z)</option>
      <option value="codigoBarra">üè∑Ô∏è C√≥digo</option>
    </select>

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Concepto</th>
          <th>Fijado</th>
          <th>M√≠nimo</th>
          <th>Te√≥rico</th>
          <th>√öltima actualizaci√≥n</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</body>
</html>
