<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Control ‚Äì Fijaci√≥n de Art√≠culos | PROVSOFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
<script type="module">
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, collection, query, where, orderBy, getDocs, getDoc, setDoc, doc 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // üîß Configuraci√≥n Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.firebasestorage.app",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== ELEMENTOS DOM =====
  const busqueda = document.getElementById('busqueda');
  const resultados = document.getElementById('resultados');
  const codigo = document.getElementById('codigo');
  const concepto = document.getElementById('concepto');
  const inventario_fijado = document.getElementById('inventario_fijado');
  const inventario_minimo = document.getElementById('inventario_minimo');
  const usuario = document.getElementById('usuario');
  const msg = document.getElementById('msg');
  const tbody = document.getElementById('tbody');

  // ===== BUSCAR PRODUCTO =====
  busqueda.addEventListener('input', async () => {
    const texto = busqueda.value.trim().toLowerCase();
    if (texto.length < 2) { resultados.style.display = 'none'; return; }

    const productosRef = collection(db, "productos");
    const q = query(productosRef, where("activo", "==", true));
    const snap = await getDocs(q);

    resultados.innerHTML = '';
    let encontrados = 0;

    snap.forEach(docSnap => {
      const data = docSnap.data();
      const codigoStr = String(data.codigoBarra || '').toLowerCase();
      const conceptoStr = String(data.concepto || '').toLowerCase();
      const coincide = codigoStr.includes(texto) || conceptoStr.includes(texto);

      if (coincide) {
        encontrados++;
        const div = document.createElement('div');
        div.textContent = `${data.codigoBarra} ‚Äì ${data.concepto}`;
        div.onclick = async () => {
          codigo.value = data.codigoBarra;
          concepto.value = data.concepto;
          busqueda.value = '';
          resultados.style.display = 'none';

          // Verificar si ya est√° fijado
          const segRef = doc(db, "seguimiento_inventario", data.codigoBarra);
          const segSnap = await getDoc(segRef);
          if (segSnap.exists()) {
            const s = segSnap.data();
            inventario_fijado.value = s.inventario_fijado;
            inventario_minimo.value = s.inventario_minimo;
            msg.innerHTML = `üß≠ Art√≠culo ya fijado<br>
              <small>Anterior: ${s.inventario_fijado} | M√≠nimo: ${s.inventario_minimo}</small>`;
          } else {
            msg.innerText = "‚úÖ Nuevo art√≠culo listo para fijar";
          }
        };
        resultados.appendChild(div);
      }
    });

    resultados.style.display = encontrados > 0 ? 'block' : 'none';
  });

  // ===== GUARDAR / ACTUALIZAR =====
  window.guardarArticulo = async function guardarArticulo() {
    const codigoVal = codigo.value.trim();
    const conceptoVal = concepto.value.trim();
    const fijadoVal = parseInt(inventario_fijado.value || 0);
    const minimoVal = parseInt(inventario_minimo.value || 0);
    const usuarioVal = usuario.value.trim() || "Desconocido";
    const ahora = new Date().toISOString();

    if (!codigoVal || isNaN(fijadoVal)) return alert("Completa c√≥digo y cantidad fijada");

    const segRef = doc(db, "seguimiento_inventario", codigoVal);
    const segSnap = await getDoc(segRef);

    let motivo = "fijaci√≥n inicial";
    let diferencia = 0;
    let inventarioAnterior = 0;

    if (segSnap.exists()) {
      const dataPrev = segSnap.data();
      inventarioAnterior = parseInt(dataPrev.inventario_fijado || 0);
      diferencia = fijadoVal - inventarioAnterior;
      motivo = diferencia > 0 ? "reabastecimiento" : (diferencia < 0 ? "ajuste manual" : "sin cambio");
    }

    // Guardar el documento actualizado
    await setDoc(segRef, {
      codigoBarra: codigoVal,
      concepto: conceptoVal,
      inventario_fijado: fijadoVal,
      inventario_minimo: minimoVal,
      activo: true,
      fecha_inicio: segSnap.exists() ? segSnap.data().fecha_inicio : ahora,
      actualizadoEn: ahora
    });

    // Registrar en historial
    const histRef = doc(db, `seguimiento_inventario/${codigoVal}/historial`, ahora);
    await setDoc(histRef, {
      inventario_anterior: inventarioAnterior,
      inventario_nuevo: fijadoVal,
      diferencia: diferencia,
      motivo: motivo,
      usuario: usuarioVal,
      fecha: ahora
    });

    // Mensaje visual seg√∫n tipo de cambio
    if (diferencia > 0) {
      msg.innerHTML = `‚úÖ +${diferencia} reabastecimiento<br><small>Nuevo total: ${fijadoVal}</small>`;
      msg.style.color = "limegreen";
    } else if (diferencia < 0) {
      msg.innerHTML = `‚ö†Ô∏è ${diferencia} ajuste manual<br><small>Nuevo total: ${fijadoVal}</small>`;
      msg.style.color = "orange";
    } else {
      msg.innerHTML = "‚ÑπÔ∏è Sin cambio en el valor fijado";
      msg.style.color = "gray";
    }

    inventario_fijado.value = '';
    inventario_minimo.value = '';
    codigo.value = '';
    concepto.value = '';
    await cargarTabla();
  };

  // ===== CARGAR TABLA =====
  async function cargarTabla() {
    const segRef = collection(db, "seguimiento_inventario");
    const q = query(segRef, where("activo", "==", true), orderBy("codigoBarra"));
    const snap = await getDocs(q);

    tbody.innerHTML = "";
    snap.forEach(docSnap => {
      const data = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.codigoBarra}</td>
        <td>${data.concepto || "-"}</td>
        <td>${data.inventario_fijado}</td>
        <td>${data.inventario_minimo}</td>
        <td>${data.actualizadoEn ? data.actualizadoEn.split("T")[0] : "-"}</td>
      `;
      tr.onclick = () => {
        codigo.value = data.codigoBarra;
        concepto.value = data.concepto;
        inventario_fijado.value = data.inventario_fijado;
        inventario_minimo.value = data.inventario_minimo;
        msg.innerText = "üìù Editando art√≠culo " + data.codigoBarra;
        msg.style.color = "white";
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      tbody.appendChild(tr);
    });
  }

  cargarTabla();
</script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: white;
      padding: 20px;
    }
    h2, h3 {
      text-align: center;
    }
    .card {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 700px;
      margin: auto;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: none;
    }
    button {
      cursor: pointer;
      font-weight: 600;
      background: #F5AF19;
    }
    #resultados {
      background: white;
      color: black;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    #resultados div {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    #resultados div:hover { background: #eee; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(255,255,255,0.95);
      color: black;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #00416A;
      color: white;
    }
    tr:hover { background: #f0f0f0; cursor: pointer; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üì¶ Panel de Control de Inventario Fijado</h2>

    <input id="busqueda" placeholder="Buscar por c√≥digo o concepto (solo activos)">
    <div id="resultados"></div>

    <input id="codigo" placeholder="C√≥digo de barras" disabled>
    <input id="concepto" placeholder="Concepto del art√≠culo" disabled>
    <input id="inventario_fijado" type="number" placeholder="Inventario fijado">
    <input id="inventario_minimo" type="number" placeholder="Inventario m√≠nimo (alerta)">
    <input id="usuario" placeholder="Usuario" value="Gerardo R√≠os">
    <button onclick="guardarArticulo()">üíæ Guardar / Actualizar</button>
    <p id="msg"></p>

    <h3>üìã Art√≠culos Fijados Activos</h3>
    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Concepto</th>
          <th>Fijado</th>
          <th>M√≠nimo</th>
          <th>√öltima actualizaci√≥n</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</body>
</html>
