<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cortes Pendientes ‚Äì PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #222;
    }
    h1 { color: #00416A; text-align:center; margin-bottom:10px; }
    select {
      display:block; margin:0 auto 20px auto;
      padding:8px 12px; border-radius:6px; border:1px solid #ccc;
      font-size:14px;
    }
    table {
      width: 100%; border-collapse: collapse; background:#fff;
      border-radius: 10px; overflow:hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background: #00416A; color: #fff; }
    tr:hover { background: #f1f5f9; }
    button {
      padding: 6px 10px; border:none; border-radius:6px; cursor:pointer;
      background:#0c6cbd; color:white; font-weight:600;
    }
    button[disabled] { background:#999; cursor:not-allowed; }

    #overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:3000;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:18px;
      flex-direction:column;
    }
    .spinner {
      width:60px; height:60px;
      border:6px solid rgba(255,255,255,0.3);
      border-top:6px solid #0c6cbd;
      border-radius:50%;
      animation: spin 1s linear infinite;
      margin-bottom:20px;
    }
    @keyframes spin {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.3.0/dist/dom-to-image-more.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

<h1>Cortes Pendientes</h1>
<select id="selectRuta"><option value="">Selecciona una ruta...</option></select>

<table id="tablaCortes">
  <thead>
    <tr>
      <th>Usuario</th><th>Ruta</th><th>Total D√≠a</th><th>Fecha</th><th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody id="tbodyCortes">
    <tr><td colspan="5" style="text-align:center;">Selecciona una ruta para ver pendientes</td></tr>
  </tbody>
</table>

<div id="overlay">
  <div class="spinner"></div>
  ‚è≥ Procesando corte...
  <div id="overlayText" style="margin-top:10px;"></div>
</div>

<div id="graficaDeptos" style="display:none;width:600px;height:400px;"><canvas id="canvasDeptos"></canvas></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, query, where, addDoc, updateDoc, doc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


document.addEventListener("DOMContentLoaded", async () => {
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const selectRuta = document.getElementById("selectRuta");
  const tbody = document.getElementById("tbodyCortes");
  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");

  async function cargarRutas() {
    const snap = await getDocs(collection(db, "rutas_venta"));
    const rutas = new Map();
    snap.forEach(d => {
      const v = d.data();
      if (v.rutaId) rutas.set(v.rutaId, v.atendio || v.usuarioNombre || "Desconocido");
    });
    rutas.forEach((nombre, id) => {
      const opt = document.createElement("option");
      opt.value = id; opt.textContent = `${nombre} ‚Äì ${id}`;
      selectRuta.appendChild(opt);
    });
  }

  async function cargarPendientes(rutaId) {
    tbody.innerHTML = "<tr><td colspan='5'>Buscando ventas...</td></tr>";

    const qVentas = query(collection(db, "rutas_venta"),
      where("rutaId", "==", rutaId),
      where("cortado", "==", false)
    );
    const snap = await getDocs(qVentas);
    const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    if (!ventas.length) {
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>No hay cortes pendientes</td></tr>";
      return;
    }


// üóìÔ∏è Agrupar ventas por D√çA (ignorando hora)
const grupos = {};
ventas.forEach(v => {
  let fechaBase = "SIN_FECHA";
  if (v.fecha_txt) {
    // Detecta formato "2025-10-11T14:35:00" o "11/10/2025, 2:35:00 p.m."
    if (v.fecha_txt.includes("T")) {
      fechaBase = v.fecha_txt.split("T")[0].trim();
    } else if (v.fecha_txt.includes(",")) {
      fechaBase = v.fecha_txt.split(",")[0].trim();
    } else {
      fechaBase = v.fecha_txt.split(" ")[0].trim();
    }

    // Normaliza formato a yyyy-mm-dd
    if (fechaBase.includes("/")) {
      const [d, m, y] = fechaBase.split("/");
      fechaBase = `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
    }
  }

  if (!grupos[fechaBase]) grupos[fechaBase] = [];
  grupos[fechaBase].push(v);
});

    tbody.innerHTML = "";
    Object.entries(grupos).forEach(([fecha, lista]) => {
      const total = lista.reduce((a, v) => a + (v.resumen_financiero?.total || v.total || 0), 0);
      const utilidad = lista.reduce((a, v) => a + (v.utilidad_total || 0), 0);
      const usuario = lista[0].atendio || lista[0].usuarioNombre || "‚Äî";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${usuario}</td>
        <td>${rutaId}</td>
        <td>$${total.toFixed(2)}</td>
        <td>${fecha}</td>
        <td><button data-ruta="${rutaId}" data-fecha="${fecha}">üìä Cortar ${fecha}</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  selectRuta.addEventListener("change", e => {
    const rutaId = e.target.value;
    if (!rutaId) {
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>Selecciona una ruta</td></tr>";
      return;
    }
    cargarPendientes(rutaId);
  });

  tbody.addEventListener("click", async e => {
    const btn = e.target.closest("button[data-ruta][data-fecha]");
    if (!btn) return;
    const rutaId = btn.dataset.ruta;
    const fecha = btn.dataset.fecha;
    overlay.style.display = "flex";
    overlayText.innerText = `‚è≥ Generando corte del ${fecha}...`;
    generarCorteAnalitico(rutaId, fecha).finally(() => {
      overlay.style.display = "none";
      alert(`‚úÖ Corte del ${fecha} generado correctamente.`);
      selectRuta.value = "";
      tbody.innerHTML = "<tr><td colspan='5'>Selecciona una ruta...</td></tr>";
    });
  });

  async function generarCorteAnalitico(rutaId, fechaSeleccionada) {
    const qVentas = query(collection(db, "rutas_venta"),
      where("rutaId", "==", rutaId),
      where("cortado", "==", false)
    );
    const snap = await getDocs(qVentas);
    const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    
// üîç Filtrar solo las ventas del d√≠a seleccionado (independiente del formato)
const ventasDia = ventas.filter(v => {
  if (!v.fecha_txt) return false;
  let fecha = v.fecha_txt.split(",")[0].trim();

  // Normalizar formato "dd/mm/yyyy" ‚Üí "yyyy-mm-dd"
  if (fecha.includes("/")) {
    const [d, m, y] = fecha.split("/");
    fecha = `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
  }

  return fecha === fechaSeleccionada;
});

if (!ventasDia.length) {
  overlayText.innerText = "‚ö†Ô∏è No hay ventas para esa fecha.";
  console.warn("No se encontraron ventas del d√≠a:", fechaSeleccionada);
  return;
}

    const porDepto = {}, porNota = [], porArticulo = {};
    let totalDia = 0, utilidadTotal = 0;

    for (const v of ventasDia) {
      totalDia += v.resumen_financiero?.total || v.total || 0;
      utilidadTotal += v.utilidad_total || 0;
      const hora = (v.fecha_txt || "").split(",")[1]?.trim() || "";
      porNota.push({ folio: v.folio || "‚Äî", total: v.total || 0, utilidad: v.utilidad_total || 0, hora });

      for (const det of (v.detalle || [])) {
        const nombreArt = det.nombre?.toUpperCase() || "SIN NOMBRE";
        if (!porArticulo[nombreArt]) porArticulo[nombreArt] = { cantidad: 0, importe: 0 };
        porArticulo[nombreArt].cantidad += det.cantidad || 0;
        porArticulo[nombreArt].importe += det.importe || det.precio_unit * det.cantidad || 0;

        const dep = det.departamento_info?.nombre?.toUpperCase() || "SIN DEPTO";
        const venta = det.importe || det.precio_unit * det.cantidad || 0;
        const costo = det.costo_total || det.costo_unit * det.cantidad || 0;
        const util = det.utilidad || (venta - costo);
        if (!porDepto[dep]) porDepto[dep] = { venta: 0, utilidad: 0 };
        porDepto[dep].venta += venta;
        porDepto[dep].utilidad += util;
      }
    }

    const resumen = {
      nombreCorte: ventasDia[0]?.usuarioNombre || ventasDia[0]?.atendio || "Desconocido",
      totalDia, utilidadTotal,
      totalTickets: ventasDia.length,
      porDepto, porNota, porArticulo
    };

    await addDoc(collection(db, "cortes_globales"), {
      rutaId,
      fecha: serverTimestamp(),
      fecha_corte: fechaSeleccionada,
      creado_en: new Date().toISOString(),
      realizado_por: resumen.nombreCorte,
      total_registros: resumen.totalTickets,
      resumen
    });

    for (const v of ventasDia) {
      const ventaRef = doc(db, "rutas_venta", v.id);
      await updateDoc(ventaRef, { cortado: true });
    }

    await generarPDFyEnviar(resumen, rutaId, fechaSeleccionada);
  }

async function generarPDFyEnviar(r, rutaId, fecha) {
  overlayText.innerText = "üßæ Generando PDF...";

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ format: "letter", unit: "mm" });

  // üîπ Logo PROVSOFT (base64)
  const logoProvsoft = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAH0lEQVQYV2NkYGD4z0AeA7EwCkYGigEkqECkQAIAD+0BBdBZ0jUAAAAASUVORK5CYII=";

  // =============================
  // üßæ PAGINA 1: RESUMEN GENERAL
  // =============================
  pdf.addImage(logoProvsoft, "PNG", 10, 8, 10, 10);
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(16);
  pdf.text("PROVSOFT ‚Äì CORTE ANAL√çTICO", 25, 15);
  pdf.setFontSize(12);
  pdf.text(`Ruta: ${rutaId}`, 25, 21);

  pdf.setDrawColor(0);
  pdf.line(10, 25, 200, 25);

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(11);
  let y = 33;
  pdf.text(`Usuario: ${r.nombreCorte}`, 10, y); y += 6;
  pdf.text(`Fecha corte: ${fecha}`, 10, y); y += 6;
  pdf.text(`Generado: ${new Date().toLocaleString()}`, 10, y); y += 10;

  // üîπ Bloque Totales visual
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(13);
  pdf.setDrawColor(0, 102, 204);
  pdf.setFillColor(240, 247, 255);
  pdf.roundedRect(10, y, 190, 30, 3, 3, "FD");
  pdf.text(`Tickets: ${r.totalTickets}`, 15, y + 10);
  pdf.text(`Utilidad Total: $${r.utilidadTotal.toFixed(2)}`, 15, y + 18);
  pdf.text(`Total D√≠a:`, 130, y + 18);
  pdf.setFontSize(18);
  pdf.text(`$${r.totalDia.toFixed(2)}`, 150, y + 18);
  y += 42;

  pdf.setFontSize(11);
  pdf.setFont("helvetica", "italic");
  pdf.text("Resumen general de ventas del d√≠a", 10, y);

  // =============================
  // üìä PAGINA 2: VENTAS POR DEPTO
  // =============================
  pdf.addPage();
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("VENTAS POR DEPARTAMENTO", 70, 15);

  // Encabezados de tabla
  pdf.setFontSize(11);
  pdf.setDrawColor(0);
  pdf.setFillColor(240, 240, 240);
  pdf.rect(10, 25, 190, 8, "F");
  pdf.text("Departamento", 12, 31);
  pdf.text("Venta Total", 100, 31);
  pdf.text("Utilidad Neta", 140, 31);
  pdf.text("% Utilidad", 175, 31);

  y = 39;
  pdf.setFont("helvetica", "normal");
  Object.entries(r.porDepto).forEach(([dep, v]) => {
    if (y > 260) { pdf.addPage(); y = 20; }
    pdf.text(dep.substring(0, 35), 12, y);
    pdf.text(`$${v.venta.toFixed(2)}`, 100, y, { align: "right" });
    pdf.text(`$${v.utilidad.toFixed(2)}`, 145, y, { align: "right" });
    const pct = ((v.utilidad / v.venta) * 100).toFixed(1) + "%";
    pdf.text(pct, 185, y, { align: "right" });
    y += 6;
  });

  pdf.setDrawColor(0);
  pdf.line(10, y + 2, 200, y + 2);
  pdf.setFont("helvetica", "bold");
  y += 8;
  pdf.text("TOTALES:", 12, y);
  pdf.text(`$${r.totalDia.toFixed(2)}`, 100, y, { align: "right" });
  pdf.text(`$${r.utilidadTotal.toFixed(2)}`, 145, y, { align: "right" });

  // =============================
  // üì¶ PAGINA 3: TOP + GRAFICA
  // =============================
  pdf.addPage();
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("TOP 10 ART√çCULOS M√ÅS VENDIDOS", 50, 15);

  // Encabezados tabla top
  pdf.setFontSize(11);
  pdf.setDrawColor(0);
  pdf.setFillColor(240, 240, 240);
  pdf.rect(10, 25, 190, 8, "F");
  pdf.text("Art√≠culo", 12, 31);
  pdf.text("Cant.", 120, 31);
  pdf.text("Importe", 160, 31);

  y = 39;
  const topArticulos = Object.entries(r.porArticulo)
    .sort((a, b) => b[1].importe - a[1].importe)
    .slice(0, 10);

  pdf.setFont("helvetica", "normal");
  topArticulos.forEach(([nombre, datos]) => {
    if (y > 260) { pdf.addPage(); y = 20; }
    pdf.text(nombre.substring(0, 50), 12, y);
    pdf.text(`${datos.cantidad}`, 125, y, { align: "right" });
    pdf.text(`$${datos.importe.toFixed(2)}`, 185, y, { align: "right" });
    y += 6;
  });

// üîπ Insertar gr√°fica circular
overlayText.innerText = "üé® Generando gr√°fica...";
const img1 = await graficaDeptos(r.porDepto);

pdf.addPage();
pdf.setFont("helvetica", "bold");
pdf.setFontSize(14);
pdf.text("GR√ÅFICA POR DEPARTAMENTO", 50, 15);

if (img1 && img1.startsWith("data:image/png")) {
  pdf.addImage(img1, "PNG", 20, 25, 170, 110);
} else {
  console.warn("‚ö†Ô∏è No se pudo generar la gr√°fica, se omitir√° del PDF.");
  pdf.setFont("helvetica", "italic");
  pdf.setFontSize(12);
  pdf.text("‚ö†Ô∏è No se pudo generar la gr√°fica en este corte.", 20, 40);
}

  // =============================
  // üíæ Exportar y enviar
  // =============================
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  const a = document.createElement("a");
  a.href = url;
  a.download = `Corte_${rutaId}_${fecha}.pdf`;
  a.click();

  overlayText.innerText = "üì§ Enviando a Telegram...";

  await enviarTelegram(
    blob,
    `Corte_${rutaId}_${fecha}.pdf`,
    `üì¶ Corte ${rutaId} (${fecha}) Total:$${r.totalDia.toFixed(2)} Utilidad:$${r.utilidadTotal.toFixed(2)}`
  )
    .then(() => (overlayText.innerText = "‚úÖ Enviado a Telegram"))
    .catch(err => {
      overlayText.innerText = "‚ö†Ô∏è Error al enviar";
      console.warn("‚ö†Ô∏è No se pudo enviar a Telegram:", err);
    })
    .finally(() => setTimeout(() => { overlay.style.display = "none"; }, 1500));

  URL.revokeObjectURL(url);
}


async function graficaDeptos(p) {
  const div = document.getElementById("graficaDeptos");
  const canvas = document.getElementById("canvasDeptos");
  const ctx = canvas.getContext("2d");

  // üîπ Forzamos tama√±o visible fuera del viewport
  div.style.position = "absolute";
  div.style.top = "-1000px";
  div.style.left = "-1000px";
  div.style.display = "block";
  div.style.visibility = "visible";
  div.style.width = "600px";
  div.style.height = "400px";
  canvas.width = 600;
  canvas.height = 400;

  // üé® Crear el gr√°fico
  const chart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(p),
      datasets: [{
        data: Object.values(p).map(v => v.venta),
        backgroundColor: [
          "#007bff", "#ff6384", "#ffc107", "#28a745",
          "#17a2b8", "#6610f2", "#fd7e14", "#6f42c1",
          "#20c997", "#e83e8c"
        ]
      }]
    },
    options: {
      animation: false,
      responsive: false,
      plugins: { legend: { position: "right" } }
    }
  });

  // ‚è≥ Esperar render completo con verificaci√≥n
  await new Promise(resolve => setTimeout(resolve, 800));

  let img;
  for (let i = 0; i < 3; i++) { // reintenta hasta 3 veces
    try {
      img = await domtoimage.toPng(div);
      if (img && img.startsWith("data:image/png") && img.length > 1000) break;
    } catch (err) {
      console.warn("Intento fallido al generar PNG:", err);
    }
    await new Promise(resolve => setTimeout(resolve, 500));
  }

  chart.destroy();
  div.style.display = "none";

  if (!img) {
    console.warn("‚ö†Ô∏è No se pudo generar la gr√°fica (imagen vac√≠a o corrupta).");
    return null;
  }

  console.log("‚úÖ Gr√°fica generada correctamente.");
  return img;
}

  async function enviarTelegram(pdfBlob, nombre, texto) {
    try {
      const BOT = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
      const CHAT = "6617988297";
      const f = new FormData();
      f.append("chat_id", CHAT);
      f.append("caption", texto);
      f.append("document", pdfBlob, nombre);
      const res = await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, { method: "POST", body: f });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    } catch (err) {
      console.error("Error al enviar Telegram:", err);
    }
  }

  await cargarRutas();
});
</script>
</body>
</html>
