<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cortes Pendientes ‚Äì PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #222;
    }
    h1 { color: #00416A; text-align:center; margin-bottom:10px; }
    select {
      display:block; margin:0 auto 20px auto;
      padding:8px 12px; border-radius:6px; border:1px solid #ccc;
      font-size:14px;
    }
    table {
      width: 100%; border-collapse: collapse; background:#fff;
      border-radius: 10px; overflow:hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background: #00416A; color: #fff; }
    tr:hover { background: #f1f5f9; }
    button {
      padding: 6px 10px; border:none; border-radius:6px; cursor:pointer;
      background:#0c6cbd; color:white; font-weight:600;
    }
    button[disabled] { background:#999; cursor:not-allowed; }

    #overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:3000;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:18px;
      flex-direction:column;
    }
    .spinner {
      width:60px; height:60px;
      border:6px solid rgba(255,255,255,0.3);
      border-top:6px solid #0c6cbd;
      border-radius:50%;
      animation: spin 1s linear infinite;
      margin-bottom:20px;
    }
    @keyframes spin {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

<h1>Cortes Pendientes</h1>
<select id="selectRuta"><option value="">Selecciona una ruta...</option></select>

<table id="tablaCortes">
  <thead>
    <tr>
      <th>Usuario</th><th>Ruta</th><th>Total D√≠a</th><th>Fecha</th><th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody id="tbodyCortes">
    <tr><td colspan="5" style="text-align:center;">Selecciona una ruta para ver pendientes</td></tr>
  </tbody>
</table>

<div id="overlay">
  <div class="spinner"></div>
  ‚è≥ Procesando corte...
  <div id="overlayText" style="margin-top:10px;"></div>
</div>

<div id="graficaDeptos" style="display:none;width:600px;height:400px;"><canvas id="canvasDeptos"></canvas></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, query, where, addDoc, updateDoc, doc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", async () => {
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const selectRuta = document.getElementById("selectRuta");
  const tbody = document.getElementById("tbodyCortes");
  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");

  console.log({
    jsPDF: !!window.jspdf,
    Chart: !!window.Chart
  });

  async function cargarRutas() {
    const snap = await getDocs(collection(db, "rutas_venta"));
    const rutas = new Map();
    snap.forEach(d => {
      const v = d.data();
      if (v.rutaId) rutas.set(v.rutaId, v.atendio || v.usuarioNombre || "Desconocido");
    });
    rutas.forEach((nombre, id) => {
      const opt = document.createElement("option");
      opt.value = id; opt.textContent = `${nombre} ‚Äì ${id}`;
      selectRuta.appendChild(opt);
    });
  }

  async function cargarPendientes(rutaId) {
    tbody.innerHTML = "<tr><td colspan='5'>Buscando ventas...</td></tr>";
    const qVentas = query(collection(db, "rutas_venta"), where("rutaId", "==", rutaId), where("cortado", "==", false));
    const snap = await getDocs(qVentas);
    const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    if (!ventas.length) {
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>No hay cortes pendientes</td></tr>";
      return;
    }

    const grupos = {};
    ventas.forEach(v => {
      let fechaBase = "SIN_FECHA";
      if (v.fecha_txt) {
        if (v.fecha_txt.includes("T")) fechaBase = v.fecha_txt.split("T")[0].trim();
        else if (v.fecha_txt.includes(",")) fechaBase = v.fecha_txt.split(",")[0].trim();
        else fechaBase = v.fecha_txt.split(" ")[0].trim();
        if (fechaBase.includes("/")) {
          const [d, m, y] = fechaBase.split("/");
          fechaBase = `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
        }
      }
      if (!grupos[fechaBase]) grupos[fechaBase] = [];
      grupos[fechaBase].push(v);
    });

    tbody.innerHTML = "";
    Object.entries(grupos).forEach(([fecha, lista]) => {
      const total = lista.reduce((a, v) => a + (v.resumen_financiero?.total || v.total || 0), 0);
      const usuario = lista[0].atendio || lista[0].usuarioNombre || "‚Äî";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${usuario}</td>
        <td>${rutaId}</td>
        <td>$${total.toFixed(2)}</td>
        <td>${fecha}</td>
        <td><button data-ruta="${rutaId}" data-fecha="${fecha}">üìä Cortar ${fecha}</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  selectRuta.addEventListener("change", e => {
    const rutaId = e.target.value;
    if (!rutaId) {
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#999;'>Selecciona una ruta</td></tr>";
      return;
    }
    cargarPendientes(rutaId);
  });

  tbody.addEventListener("click", async e => {
    const btn = e.target.closest("button[data-ruta][data-fecha]");
    if (!btn) return;
    const rutaId = btn.dataset.ruta;
    const fecha = btn.dataset.fecha;
    overlay.style.display = "flex";
    overlayText.innerText = `‚è≥ Generando corte del ${fecha}...`;
    await generarCorteAnalitico(rutaId, fecha);
  });

async function generarCorteAnalitico(rutaId, fechaSeleccionada) {
  const qVentas = query(collection(db, "rutas_venta"), where("rutaId", "==", rutaId), where("cortado", "==", false));
  const snap = await getDocs(qVentas);
  const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  const ventasDia = ventas.filter(v => {
    if (!v.fecha_txt) return false;
    let fecha = v.fecha_txt.trim();
    if (fecha.includes("T")) fecha = fecha.split("T")[0];
    else if (fecha.includes(",")) fecha = fecha.split(",")[0];
    else if (fecha.includes(" ")) {
      const partes = fecha.split(" ");
      if (partes.length >= 4 && isNaN(partes[0])) {
        try {
          const d = new Date(fecha);
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          fecha = `${yyyy}-${mm}-${dd}`;
        } catch {}
      } else fecha = fecha.split(" ")[0];
    }
    if (fecha.includes("/")) {
      const [d, m, y] = fecha.split("/");
      fecha = `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
    }
    return fecha === fechaSeleccionada;
  });

  if (!ventasDia.length) {
    overlayText.innerText = "‚ö†Ô∏è No hay ventas para esa fecha.";
    return;
  }

let totalDia = 0, utilidadTotal = 0, descuentoTotal = 0, totalCostoDia = 0;
const porDepto = {}, porArticulo = {}, porNota = [];

for (const v of ventasDia) {
  const totalVenta = v.resumen_financiero?.total || v.total || 0;
  const descuentoVenta = v.descuento_monto || v.resumen_financiero?.descuento || 0;
  totalDia += totalVenta;
  descuentoTotal += descuentoVenta;

  let utilidadVentaRecalc = 0;
  let costoVenta = 0;

  for (const det of (v.detalle || [])) {
    const dep = det.departamento_info?.nombre?.toUpperCase() || "SIN DEPTO";
    const ivaPct = det.ivaTasa || det.departamento_info?.iva || 0;
    const iepsPct = det.iepsTasa || det.departamento_info?.ieps || 0;

    const importe = det.importe || det.precioUnit * (det.cantidad || 1) || 0;
    let ventaSinImpuestos = importe;
    let impuestos = 0;

    if (ivaPct > 0 || iepsPct > 0) {
      const base = importe / (1 + ivaPct + iepsPct);
      impuestos = importe - base;
      ventaSinImpuestos = base;
    }

    // üí∞ COSTEO GORDO REAL
    const costoUnit = det.costoUnit || det.costo_unit || det.costo || 0;
    const costo = costoUnit * (det.cantidad || 1);
    const utilidad = ventaSinImpuestos - costo;

    // Acumuladores globales
    utilidadVentaRecalc += utilidad;
    costoVenta += costo;

    // === ACUMULADORES POR DEPARTAMENTO ===
    if (!porDepto[dep]) {
      porDepto[dep] = { venta: 0, impuestos: 0, costo: 0, utilidad: 0 };
    }
    porDepto[dep].venta += ventaSinImpuestos;
    porDepto[dep].impuestos += impuestos;
    porDepto[dep].costo += costo;
    porDepto[dep].utilidad += utilidad;

    // === ACUMULADORES POR ART√çCULO ===
    const art = det.nombre?.toUpperCase() || "SIN NOMBRE";
    if (!porArticulo[art]) porArticulo[art] = { cantidad: 0, importe: 0, costo: 0 };
    porArticulo[art].cantidad += det.cantidad || 0;
    porArticulo[art].importe += ventaSinImpuestos;
    porArticulo[art].costo += costo;
  }

  utilidadTotal += utilidadVentaRecalc;
  totalCostoDia += costoVenta;

  // === ACUMULADORES POR NOTA ===
  const hora = v.fecha_txt?.split("T")[1]?.substring(0,5) || v.fecha_txt || "";
  porNota.push({
    folio: v.folio || v.id,
    hora,
    total: totalVenta,
    costo: costoVenta,
    utilidad: utilidadVentaRecalc,
    ubicacion: v.ubicacion || null
  });
}

// === CIERRE DEL CORTE ===
const resumen = {
  nombreCorte: ventasDia[0]?.usuarioNombre || ventasDia[0]?.atendio || "Desconocido",
  totalDia,
  descuentoTotal,
  utilidadTotal,
  totalTickets: ventasDia.length,
  totalCostoDia,
  margenGlobal: totalDia > 0 ? ((utilidadTotal / totalDia) * 100).toFixed(2) + "%" : "0%",
  porDepto,
  porArticulo,
  porNota
};
const dataCorte = {
  rutaId,
  fecha: serverTimestamp(),
  fecha_corte: fechaSeleccionada,
  creado_en: new Date().toISOString(),
  realizado_por: resumen.nombreCorte,
  total_registros: resumen.totalTickets,
  descuentos_total: resumen.descuentoTotal || 0,
  resumen_completo: resumen,
  costo_global: {
    totalVenta: resumen.totalDia,
    totalCosto: resumen.totalCostoDia,
    utilidadReal: resumen.utilidadTotal,
    margenGlobal: resumen.margenGlobal
  },
  version: "2.2"
};

await addDoc(collection(db, "cortes_globales"), {
  rutaId,
  fecha: serverTimestamp(),
  fecha_corte: fechaSeleccionada,
  creado_en: new Date().toISOString(),
  realizado_por: resumen.nombreCorte,
  total_registros: resumen.totalTickets,
  descuentos_total: resumen.descuentoTotal || 0,
  resumen
});


  for (const v of ventasDia) {
    await updateDoc(doc(db, "rutas_venta", v.id), { cortado: true });
  }

  await generarPDFyEnviar(resumen, rutaId, fechaSeleccionada);
  overlay.style.display = "none";
  alert(`‚úÖ Corte del ${fechaSeleccionada} generado correctamente.`);
}

async function graficaDeptos(porDepto) {
  return new Promise((resolve) => {
    try {
      const canvas = document.getElementById("canvasDeptos");
      const ctx = canvas.getContext("2d");
      const labels = Object.keys(porDepto);
      const data = Object.values(porDepto).map(v => v.venta);

      // Colores din√°micos para el pastel
      const colors = labels.map((_, i) => {
        const hue = (i * 360 / labels.length) % 360;
        return `hsl(${hue}, 70%, 55%)`;
      });

      // Elimina una gr√°fica previa si existe
      if (window.chartDepto) window.chartDepto.destroy();

      window.chartDepto = new Chart(ctx, {
        type: "pie",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderColor: "#fff",
            borderWidth: 1
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: {
              display: true,
              position: "bottom",
              labels: { boxWidth: 12, color: "#222", font: { size: 10 } }
            },
            title: {
              display: true,
              text: "Ventas por Departamento",
              font: { size: 14 }
            }
          }
        }
      });

      // Espera a que renderice y devuelve la imagen PNG
      setTimeout(() => {
        const img = canvas.toDataURL("image/png");
        resolve(img);
      }, 900);

    } catch (err) {
      console.error("Error generando gr√°fica:", err);
      resolve(null);
    }
  });
}

async function generarPDFyEnviar(r, rutaId, fecha) {
  overlayText.innerText = "üßæ Generando PDF...";
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) { console.error("jsPDF no cargado"); return; }
  const pdf = new jsPDF({ format: "letter", unit: "mm" });
// üßÆ Recalcular totales para asegurar que PDF muestre utilidad real
let ventaTotalNeta = 0;
let costoTotalNeto = 0;
let utilidadTotalReal = 0;

for (const dep in r.porDepto) {
  const d = r.porDepto[dep];
  ventaTotalNeta += d.venta || 0;
  costoTotalNeto += d.costo || 0;
  utilidadTotalReal += d.utilidad || 0;
}

r.totalDia = ventaTotalNeta;
r.totalCostoDia = costoTotalNeto;
r.utilidadTotal = utilidadTotalReal;
r.margenGlobal = ventaTotalNeta > 0 ? ((utilidadTotalReal / ventaTotalNeta) * 100).toFixed(2) + "%" : "0%";

  // =============================
  // üìÑ PAGINA 1: RESUMEN GENERAL
  // =============================
  pdf.setFont("helvetica", "bold");
  pdf.text(`PROVSOFT ‚Äì CORTE ${rutaId}`, 15, 15);
  pdf.setFontSize(12);
  pdf.text(`Usuario: ${r.nombreCorte}`, 15, 25);
  // üïì Fecha legible como t√≠tulo
pdf.setFont("helvetica", "bold");
pdf.setFontSize(14);
pdf.text(`Corte del ${r.porNota[0]?.fecha_txt || fecha}`, 15, 20);
pdf.setFontSize(12);
pdf.setFont("helvetica", "normal");

pdf.text(`Total ventas (neto): $${r.totalDia.toFixed(2)}`, 15, 39);
pdf.text(`Costo total: $${r.totalCostoDia.toFixed(2)}   Utilidad real: $${r.utilidadTotal.toFixed(2)}`, 15, 45);
pdf.text(`Margen global: ${r.margenGlobal}`, 15, 51);


  let y = 59;
  pdf.setFontSize(10);
  pdf.text("Departamento", 10, y);
  pdf.text("Venta", 60, y);
  pdf.text("Imp.", 90, y);
  pdf.text("Venta+Imp", 110, y);
  pdf.text("Costo", 140, y);
  pdf.text("Utilidad", 165, y);
  pdf.text("%", 190, y);
  y += 6;

  pdf.setFont("helvetica", "normal");
  let totalVenta = 0, totalImpuestos = 0, totalCosto = 0, totalUtilidad = 0;

  // Ordena por venta descendente
  const departamentosOrdenados = Object.entries(r.porDepto)
    .sort((a, b) => b[1].venta - a[1].venta);

  for (const [dep, v] of departamentosOrdenados) {
    if (y > 260) { pdf.addPage(); y = 20; }
    const venta = v.venta;
    const impuestos = v.impuestos || 0;
    const costo = v.costo || 0;
    const utilidad = v.utilidad;
    const ventaTotal = venta + impuestos;
    const margen = (venta > 0) ? ((utilidad / venta) * 100).toFixed(1) + "%" : "‚Äî";

    pdf.text(dep.substring(0, 28), 10, y);
    pdf.text(`$${venta.toFixed(2)}`, 60, y);
    pdf.text(`$${impuestos.toFixed(2)}`, 90, y);
    pdf.text(`$${ventaTotal.toFixed(2)}`, 110, y);
    pdf.text(`$${costo.toFixed(2)}`, 140, y);
    pdf.text(`$${utilidad.toFixed(2)}`, 165, y);
    pdf.text(margen, 190, y);

    totalVenta += venta;
    totalImpuestos += impuestos;
    totalCosto += costo;
    totalUtilidad += utilidad;
    y += 6;
  }

  // Totales
  if (y > 260) { pdf.addPage(); y = 20; }
  const margenTotal = totalVenta > 0 ? ((totalUtilidad / totalVenta) * 100).toFixed(1) + "%" : "‚Äî";
  pdf.setFillColor(230, 230, 230);
  pdf.rect(8, y - 3, 194, 8, "F");
  pdf.setFont("helvetica", "bold");
  pdf.text("TOTALES", 10, y + 2);
  pdf.text(`$${totalVenta.toFixed(2)}`, 60, y + 2);
  pdf.text(`$${totalImpuestos.toFixed(2)}`, 90, y + 2);
  pdf.text(`$${(totalVenta + totalImpuestos).toFixed(2)}`, 110, y + 2);
  pdf.text(`$${totalCosto.toFixed(2)}`, 140, y + 2);
  pdf.text(`$${totalUtilidad.toFixed(2)}`, 165, y + 2);
  pdf.text(margenTotal, 190, y + 2);

  // =============================
  // üìë PAGINA 2: RESUMEN DE TICKETS
  // =============================
  pdf.addPage();
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("RESUMEN DE TICKETS", 70, 15);
  pdf.setFontSize(10);

  const margenPromedio = (r.totalDia > 0)
    ? ((r.utilidadTotal / r.totalDia) * 100).toFixed(1) + "%"
    : "‚Äî";
  pdf.setFont("helvetica", "normal");
  pdf.text(`Margen promedio neto: ${margenPromedio}`, 15, 22);

  pdf.setFillColor(230, 230, 230);
  pdf.rect(8, 25, 194, 8, "F");
  pdf.setFont("helvetica", "bold");
pdf.text("Folio", 10, 30);
pdf.text("Hora", 35, 30);
pdf.text("Venta", 70, 30);
  pdf.text("Imp.", 95, 30);
  pdf.text("Total", 115, 30);
  pdf.text("Costo", 140, 30);
  pdf.text("Utilidad", 165, 30);
  pdf.text("%", 190, 30);

  y = 38;
  pdf.setFont("helvetica", "normal");

  const tickets = (r.porNota || []).sort((a, b) => (a.folio || "").localeCompare(b.folio || ""));
  if (!tickets.length) {
    pdf.setFont("helvetica", "italic");
    pdf.text("No hay tickets detallados disponibles en este corte.", 15, 45);
  } else {
tickets.forEach((t) => {
  if (y > 270) { pdf.addPage(); y = 20; }

  // üßæ Folio limpio sin prefijo TEMP-
  const folio = (t.folio || "‚Äî").replace(/^TEMP-/, "");

  // üïí Solo la hora del campo fecha_txt
  // üïí Extraer solo hora legible (sin segundos ni zona)
let hora = "";
if (t.fecha_txt) {
  const partes = t.fecha_txt.split(",");
  if (partes.length > 1) {
    hora = partes[1]
      .trim()
      .replace(/(\d{1,2}:\d{2})(:\d{2})?/, "$1") // elimina segundos
      .replace(/\s*UTC.*/i, "") // elimina zona horaria
      .replace(/\s+/g, " "); // limpia espacios
  }
} else if (t.hora) {
  hora = t.hora.replace(/(\d{1,2}:\d{2})(:\d{2})?/, "$1");
}

  const venta = t.venta || (t.total / 1.16) || 0;
  const impuestos = t.total - venta;
  const costo = t.costo || 0;
  const utilidad = t.utilidad || venta - costo;
  const pct = venta > 0 ? ((utilidad / venta) * 100).toFixed(1) + "%" : "‚Äî";

  pdf.text(folio, 15, y);
  pdf.text(hora, 50, y);
  pdf.text(`$${venta.toFixed(2)}`, 70, y);
  pdf.text(`$${impuestos.toFixed(2)}`, 95, y);
  pdf.text(`$${(venta + impuestos).toFixed(2)}`, 115, y);
  pdf.text(`$${costo.toFixed(2)}`, 140, y);
  pdf.text(`$${utilidad.toFixed(2)}`, 165, y);
  pdf.text(pct, 190, y);
  y += 6;
});

  }

  // =============================
  // üìä PAGINA 3: GRAFICA POR DEPTO
  // =============================
  const img1 = await graficaDeptos(r.porDepto);
  pdf.addPage();
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("GR√ÅFICA POR DEPARTAMENTO", 50, 15);

  if (img1) {
    pdf.addImage(img1, "PNG", 25, 25, 150, 100);
  } else {
    pdf.setFont("helvetica", "italic");
    pdf.text("‚ö†Ô∏è No se pudo generar la gr√°fica.", 15, 40);
  }

// =============================
// üì¶ PAGINA 4: TOP 15 ART√çCULOS M√ÅS VENDIDOS (por unidades con utilidad y margen)
// =============================
const topArticulos = Object.entries(r.porArticulo)
  .map(([nombre, data]) => ({
    nombre,
    cantidad: data.cantidad || 0,
    importe: data.importe || 0,
    costo: data.costo || 0,
    utilidad: (data.importe || 0) - (data.costo || 0),
    margen: (data.importe > 0) ? (((data.importe - (data.costo || 0)) / data.importe) * 100) : 0
  }))
  .sort((a, b) => b.cantidad - a.cantidad) // üëà ranking por unidades
  .slice(0, 15);

pdf.addPage();
pdf.setFont("helvetica", "bold");
pdf.setFontSize(14);
pdf.text("TOP 15 ART√çCULOS M√ÅS VENDIDOS (POR UNIDADES)", 25, 15);
pdf.setFontSize(9);
pdf.setFillColor(230, 230, 230);
pdf.rect(8, 20, 194, 8, "F");
pdf.text("Art√≠culo", 10, 25);
pdf.text("Cant.", 80, 25);
pdf.text("Venta", 105, 25);
pdf.text("Costo", 130, 25);
pdf.text("Utilidad", 155, 25);
pdf.text("%", 185, 25);

let yTop = 33;
pdf.setFont("helvetica", "normal");

if (topArticulos.length === 0) {
  pdf.setFont("helvetica", "italic");
  pdf.text("No hay art√≠culos registrados en este corte.", 15, yTop);
} else {
  for (const art of topArticulos) {
    if (yTop > 270) { pdf.addPage(); yTop = 20; }
    pdf.text(art.nombre.substring(0, 65), 10, yTop);
    pdf.text(String(art.cantidad.toFixed(2)), 80, yTop);
    pdf.text(`$${art.importe.toFixed(2)}`, 105, yTop);
    pdf.text(`$${art.costo?.toFixed(2) || "0.00"}`, 130, yTop);
    pdf.text(`$${art.utilidad.toFixed(2)}`, 155, yTop);
    pdf.text(`${art.margen.toFixed(1)}%`, 185, yTop);
    yTop += 6;
  }
}

// =============================
// üó∫Ô∏è PAGINA 5: MAPA DE TRAZABILIDAD (ROBUSTO Y CON LEYENDA)
// =============================
try {
  const puntos = (r.porNota || [])
    .filter(v => v.ubicacion?.lat && v.ubicacion?.lon)
    .map(v => ({
      lat: v.ubicacion.lat,
      lon: v.ubicacion.lon,
      folio: v.folio || "‚Äî",
      cliente: v.cliente || "P√öBLICO",
      direccion: v.ubicacion.direccion || ""
    }));

  if (puntos.length > 0) {
    const latC = puntos.reduce((a, p) => a + p.lat, 0) / puntos.length;
    const lonC = puntos.reduce((a, p) => a + p.lon, 0) / puntos.length;

    const markers = puntos
      .map(p => `markers=color:red%7Clabel:${encodeURIComponent(p.folio?.slice(-2) || "X")}%7C${p.lat},${p.lon}`)
      .join("&");
    const path = `path=color:0x0000ff|weight:3|${puntos.map(p => `${p.lat},${p.lon}`).join("|")}`;

    const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${latC},${lonC}&zoom=13&scale=2&size=640x480&maptype=roadmap&${markers}&${path}&key=AIzaSyDj-feD_jhqKIKgZLHZ9xpejG5Nx4UiiSE`;

    console.log("MAP URL:", mapUrl);
    overlayText.innerText = "üó∫Ô∏è Cargando mapa de trazabilidad...";

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000); // m√°ximo 8 seg
    const response = await fetch(mapUrl, { signal: controller.signal });
    clearTimeout(timeout);

    const blob = await response.blob();
    if (blob.type.startsWith("image/")) {
      const img = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });

      pdf.addPage();
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text("MAPA DE TRAZABILIDAD DE VENTAS", 45, 15);
      pdf.addImage(img, "JPEG", 10, 25, 190, 120);

      pdf.setFontSize(9);
      let yLeyenda = 155;
      for (const p of puntos.slice(0, 10)) {
        pdf.text(`${p.folio.padEnd(8)} ${p.direccion.substring(0, 60)}`, 15, yLeyenda);
        yLeyenda += 5;
      }

      pdf.setFontSize(10);
      pdf.text(`Puntos totales: ${puntos.length}`, 15, yLeyenda + 5);
      pdf.text(`Centro: ${latC.toFixed(4)}, ${lonC.toFixed(4)}`, 15, yLeyenda + 10);
      pdf.text("Cada punto representa una venta registrada con ubicaci√≥n GPS.", 15, yLeyenda + 15);
    } else {
      pdf.addPage();
      pdf.setFont("helvetica", "italic");
      pdf.setFontSize(12);
      pdf.text("‚ö†Ô∏è Error al cargar el mapa desde Google (ver consola).", 20, 50);
    }
  } else {
    pdf.addPage();
    pdf.setFont("helvetica", "italic");
    pdf.setFontSize(12);
    pdf.text("‚ö†Ô∏è No hay ubicaciones registradas para mostrar en el mapa.", 20, 50);
  }
} catch (err) {
  console.error("Error generando mapa:", err);
  pdf.addPage();
  pdf.setFont("helvetica", "italic");
  pdf.setFontSize(12);
  pdf.text("‚ö†Ô∏è No se pudo generar el mapa de trazabilidad.", 20, 50);
}

// =============================
// üí∏ PAGINA 6: TOP 20 ART√çCULOS CON MENOR UTILIDAD (%)
// =============================
try {
  const articulosProcesados = Object.entries(r.porArticulo)
    .map(([nombre, data]) => {
      const importe = data.importe || 0;
      const costo = data.costo || 0;
      const utilidad = importe - costo;
      const margen = (importe > 0) ? ((utilidad / importe) * 100) : 0;
      return { nombre, cantidad: data.cantidad || 0, importe, costo, utilidad, margen };
    })
    .filter(a => a.importe > 0);

  // M√©tricas globales
  const promedioMargen = articulosProcesados.length
    ? (articulosProcesados.reduce((a, b) => a + b.margen, 0) / articulosProcesados.length)
    : 0;
  const bajosMargen = articulosProcesados.filter(a => a.margen < 10).length;
  const negativos = articulosProcesados.filter(a => a.margen < 0).length;

  // Orden ascendente por margen
  const articulosOrdenados = [...articulosProcesados]
    .sort((a, b) => a.margen - b.margen)
    .slice(0, 20);

  // --- Inicio de la p√°gina ---
  pdf.addPage();
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("TOP 20 ART√çCULOS CON MENOR UTILIDAD (%)", 25, 15);
  pdf.setFontSize(10);
  pdf.setFont("helvetica", "normal");
  pdf.text(`Margen promedio general: ${promedioMargen.toFixed(1)}%`, 15, 22);
  pdf.text(`‚ö† Art√≠culos con margen <10%: ${bajosMargen}  |  üî¥ Negativos: ${negativos}`, 15, 28);

  // Encabezado
  pdf.setFontSize(9);
  pdf.setFillColor(230, 230, 230);
  pdf.rect(8, 32, 194, 8, "F");
  pdf.setFont("helvetica", "bold");
  pdf.text("Art√≠culo", 10, 37);
  pdf.text("Cant.", 80, 37);
  pdf.text("Venta", 105, 37);
  pdf.text("Costo", 130, 37);
  pdf.text("Utilidad", 155, 37);
  pdf.text("%", 185, 37);

  let yLow = 45;
  pdf.setFont("helvetica", "normal");

  if (articulosOrdenados.length === 0) {
    pdf.setFont("helvetica", "italic");
    pdf.text("No hay art√≠culos con utilidad registrada para este corte.", 15, yLow);
  } else {
    for (const art of articulosOrdenados) {
      if (yLow > 270) { pdf.addPage(); yLow = 20; }
      pdf.text(art.nombre.substring(0, 65), 10, yLow);
      pdf.text(String(art.cantidad.toFixed(2)), 80, yLow);
      pdf.text(`$${art.importe.toFixed(2)}`, 105, yLow);
      pdf.text(`$${art.costo.toFixed(2)}`, 130, yLow);
      pdf.text(`$${art.utilidad.toFixed(2)}`, 155, yLow);
      pdf.text(`${art.margen.toFixed(1)}%`, 185, yLow);
      yLow += 6;
    }
  }

  // --- Resumen visual al final ---
  if (yLow > 260) { pdf.addPage(); yLow = 20; }
  pdf.setFillColor(255, 250, 200);
  pdf.rect(10, yLow + 4, 180, 12, "F");
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(10);
  pdf.text(`üîé An√°lisis final: Promedio margen ${promedioMargen.toFixed(1)}%.`, 15, yLow + 10);
  pdf.text(`‚ö† ${bajosMargen} art√≠culos por debajo del 10% y ${negativos} con margen negativo.`, 15, yLow + 15);
} catch (err) {
  console.error("Error generando top bajo margen:", err);
  pdf.addPage();
  pdf.setFont("helvetica", "italic");
  pdf.setFontSize(12);
  pdf.text("‚ö†Ô∏è No se pudo generar el listado de art√≠culos con baja utilidad.", 20, 50);
}
// =============================
// üìä PAGINA 7: GRAFICO DE MARGEN DE LOS 20 ARTICULOS MAS BAJOS
// =============================
try {
  // Tomamos los mismos datos ya ordenados
  const articulosTopBajos = Object.entries(r.porArticulo)
    .map(([nombre, data]) => {
      const importe = data.importe || 0;
      const costo = data.costo || 0;
      const utilidad = importe - costo;
      const margen = (importe > 0) ? ((utilidad / importe) * 100) : 0;
      return { nombre, margen };
    })
    .filter(a => a.margen !== 0)
    .sort((a, b) => a.margen - b.margen)
    .slice(0, 20);

  if (articulosTopBajos.length > 0) {
    // Crear un canvas temporal
    const canvas = document.createElement("canvas");
    canvas.width = 800;
    canvas.height = 400;
    const ctx = canvas.getContext("2d");

    // Configurar gr√°fico
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: articulosTopBajos.map(a => a.nombre.substring(0, 20)),
        datasets: [{
          label: "% de Utilidad",
          data: articulosTopBajos.map(a => a.margen.toFixed(1)),
          backgroundColor: articulosTopBajos.map(a =>
            a.margen < 0 ? "rgba(255, 99, 132, 0.7)" :
            a.margen < 10 ? "rgba(255, 205, 86, 0.7)" :
            "rgba(75, 192, 192, 0.7)"
          ),
          borderColor: "rgba(0,0,0,0.1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: false,
        scales: {
          x: { ticks: { color: "#222", font: { size: 9 }, autoSkip: false, maxRotation: 90, minRotation: 90 } },
          y: { ticks: { color: "#222", font: { size: 9 }, callback: v => v + "%" } }
        },
        plugins: {
          legend: { display: false },
          title: { display: true, text: "Art√≠culos con menor margen (%)", font: { size: 14 } }
        }
      }
    });

    // Espera renderizado y convierte a imagen
    await new Promise(r => setTimeout(r, 1200));
    const img = canvas.toDataURL("image/png");

    pdf.addPage();
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(14);
    pdf.text("GRAFICO DE UTILIDAD ‚Äì 20 ART√çCULOS CON MENOR MARGEN", 15, 15);
    pdf.addImage(img, "PNG", 10, 25, 190, 100);
    pdf.setFontSize(9);
    pdf.setFont("helvetica", "normal");
    pdf.text("Colores:", 15, 135);
    pdf.setTextColor(255, 99, 132);
    pdf.text("üî¥ P√©rdida (<0%)", 35, 135);
    pdf.setTextColor(255, 205, 86);
    pdf.text("üü° Margen bajo (<10%)", 75, 135);
    pdf.setTextColor(75, 192, 192);
    pdf.text("üü¢ Margen aceptable (>10%)", 135, 135);
    pdf.setTextColor(0, 0, 0);
  } else {
    pdf.addPage();
    pdf.setFont("helvetica", "italic");
    pdf.setFontSize(12);
    pdf.text("‚ö†Ô∏è No se pudo generar gr√°fico de margen (sin datos suficientes).", 20, 50);
  }
} catch (err) {
  console.error("Error generando gr√°fico de m√°rgenes:", err);
  pdf.addPage();
  pdf.setFont("helvetica", "italic");
  pdf.setFontSize(12);
  pdf.text("‚ö†Ô∏è Error al generar el gr√°fico de m√°rgenes de utilidad.", 20, 50);
pdf.setFontSize(8);
pdf.setTextColor(100);
pdf.text("*Las utilidades y m√°rgenes se calculan sobre base neta (sin IVA ni IEPS).", 15, 280);
pdf.setTextColor(0);

}
  
  // =============================
  // üíæ Exportar y enviar
  // =============================
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");

  const margenTexto = totalVenta > 0
    ? ((totalUtilidad / totalVenta) * 100).toFixed(1)
    : "‚Äî";

  await enviarTelegram(
    blob,
    `Corte_${rutaId}_${fecha}.pdf`,
    `üì¶ Corte ${rutaId} (${fecha})\nTotal: $${r.totalDia.toFixed(2)}\nUtilidad neta: $${r.utilidadTotal.toFixed(2)} (${margenTexto}%)`
  );
}


  async function enviarTelegram(pdfBlob, nombre, texto) {
    try {
      const BOT = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
      const CHAT = "6617988297";
      const f = new FormData();
      f.append("chat_id", CHAT);
      f.append("caption", texto);
      f.append("document", pdfBlob, nombre);
      const res = await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, {
        method: "POST", body: f, headers: { "Accept": "application/json" }
      });
      const data = await res.json();
      console.log("Respuesta Telegram:", data);
    } catch (err) {
      console.error("Error al enviar Telegram:", err);
    }
  }

  await cargarRutas();
});
</script>
</body>
</html>
