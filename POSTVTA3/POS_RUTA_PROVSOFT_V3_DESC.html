<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PROVEEDORA MATRIZ ‚Äì RUTA DE VENTA 3.0 DESCUENTO LIBRE</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="manifest" href="./manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e;
      --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55);
      --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial;
      color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased;
      -webkit-tap-highlight-color:transparent;
    }

    header{
      position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.6); color:#fff;
      padding:10px 14px; display:flex;
      justify-content:center; align-items:center;
      gap:8px; font-weight:700; font-size:18px;
      backdrop-filter:saturate(120%) blur(4px);
      height:50px;
    }
    header img{ height:75px; object-fit:contain; }

    .wrap{flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto;}
    .controls{ display:flex; flex-direction:column; gap:10px; }
    .field{
      display:flex; gap:8px; background:rgba(255,255,255,.12);
      padding:10px; border-radius:var(--radius-sm);
      align-items:center; backdrop-filter:blur(2px);
    }
    .field label{min-width:78px; color:#fff; font-size:13px;}
    .field input{
      flex:1; padding:10px 12px; border:none;
      border-radius:8px; font-size:15px;
      background:#fff; outline:none;
    }

.searchbox{
  position:relative;
  z-index:2000; /* üëà sube la prioridad del contenedor */
}
.search-results{
  position:absolute;
  left:90px;
  right:10px;
  top:calc(100% + 6px);
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 14px rgba(0,0,0,.25);
  max-height:260px;
  overflow-y:auto;
  display:none;
  z-index:3000; /* üëà encima del resto */
  color:#111;
  font-size:14px;
}
.result-item{
  padding:10px 12px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
  background:#fff;
}
.result-item:hover{
  background:#0c6cbd;
  color:#fff;
}

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

    .table-wrap{ max-height:260px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th{ background:var(--azul); color:#fff; padding:10px; font-size:13px; position:sticky; top:0; z-index:100; }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col{ text-align:center; }
    td.del-col .del{
      background:#e74c3c; color:#fff; border:none; border-radius:50%;
      width:22px; height:22px; font-size:14px; line-height:20px; cursor:pointer;
    }
    td.del-col .del:hover{ background:#c0392b; }

    .totals{ display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:15px; }
    .row.muted{ color:var(--muted); }
    .row.big{ font-weight:700; font-size:18px; }

    .actions {
      padding:6px 0 12px;
      display:flex; gap:8px; justify-content:space-between;
    }
    .actions .btn {
      flex:1; font-size:14px; padding:12px 6px;
    }
    .btn{
      width:100%; border:none; padding:14px; border-radius:12px; font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow); cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    /* Login */
    #loginScreen{
      height:100vh;display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      background:#00416A;color:#fff;
    }
    #loginScreen input{padding:10px;border-radius:8px;margin:5px;border:none;}
    #loginMsg{color:#fbb;border-radius:8px;margin-top:8px;}
    #loginLogo {
      width: 120px; height: 120px; margin-bottom: 20px;
      animation: spinY 10s linear infinite;
      transform-style: preserve-3d;
    }
    @keyframes spinY {
      from { transform: rotateY(0deg); }
      to   { transform: rotateY(360deg); }
    }
  </style>
</head>
<body>

<!-- üîë LOGIN -->
<div id="loginScreen">
  <img id="loginLogo" src="logo_proveedora.webp" alt="Logo La Proveedora">
  <h2>PROVEEDORA MATRIZ ‚Äì RUTA DE VENTA 3.0 DESCUENTO LIBRE</h2>
  <input id="loginUsuario" type="text" placeholder="Usuario"/>
  <input id="loginPassword" type="password" placeholder="Contrase√±a"/>
  <button id="btnLogin" class="btn">Entrar</button>
  <div id="loginMsg"></div>
</div>

<!-- üì¶ POS -->
<div id="posApp" style="display:none;">
  <header>
    <span>PROVEEDORA MATRIZ ‚Äì RUTA DE VENTA 3.0 DESCUENTO LIBRE</span>
    <img src="logo_proveedora.webp" alt="Logo">
    <button id="btnLogout" 
      style="position:absolute; right:10px; top:10px; background:#c0392b; color:white;
             border:none; padding:6px 10px; border-radius:8px;
             font-size:14px; font-weight:600; cursor:pointer;">
      üö™ Salir
    </button>
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="field">
        <label>Cliente</label>
        <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
        <datalist id="clientesList"></datalist>
      </div>

      <div class="field searchbox">
        <label>Buscar</label>
        <input id="buscador" type="text" placeholder="Escribe o escanea c√≥digo‚Ä¶">
        <button id="btnCam" class="cam-btn" type="button">üì∑</button>
        <div id="resultados" class="search-results"></div>
      </div>

      <div class="field">
        <label>Cantidad</label>
        <input id="cantidadInput" type="number" step="0.01" min="0.01" value="1">
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Importe</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="totals">
        <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
        <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
    </section>

    <section class="actions">
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnResumen" style="background:linear-gradient(180deg,#0c6cbd,#00416A);">
        üìä Ver Resumen Diario
      </button>
    </section>
  </main>
</div>

<!-- üì∏ Librer√≠a QR -->

<!-- üì¶ Librer√≠a PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- üß† SCRIPT PRINCIPAL -->
<script type="module">
"use strict";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, serverTimestamp, runTransaction, doc,
  getDocs, getDoc, query, where, orderBy, Timestamp, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { obtenerUbicacionRobusta } from "./geoHelper.js";

// üîß Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
enableIndexedDbPersistence(db).catch(err => {
  console.warn("‚ö†Ô∏è Firestore offline persistence desactivado:", err);
});

async function buscarPorEquivalente(db, codigo) {
  const q = query(collection(db, "productos"),
                  where("codigosEquivalentes", "array-contains", String(codigo).trim()));
  const snap = await getDocs(q);
  if (!snap.empty) {
    const docu = snap.docs[0];
    const d = docu.data();
    return {
      id: docu.id,
      concepto: d.concepto || "Sin descripci√≥n",
      codigoBarra: d.codigoBarra || "",
      precioPublico: Number(d.precioPublico || 0),
      costoUnit: Number(d.costoSinImpuesto || d.costo || 0),
      ivaTasa: Number(d.ivaTasa || 0),
      iepsTasa: Number(d.iepsTasa || 0)
    };
  }
  return null;
}
// üîπ Variables globales
window.USUARIO_LOGUEADO = null;
window.UBICACION_ACTUAL = { lat: null, lon: null, precision: null, direccion: null };
let rutaId = null;
let carrito = [];
let clientes = [];
window.catalogo = []; // üëâ visible desde consola
window.codeIndex = new Map();
const money = (n)=>'$'+(Number(n)||0).toFixed(2);
  window.money = money; // ‚úÖ hace visible la funci√≥n en todos los scripts

// =======================================================
// üîê LOGIN
// =======================================================
async function loginUsuario() {
  const u = document.querySelector("#loginUsuario").value.trim();
  const p = document.querySelector("#loginPassword").value.trim();
  const msg = document.querySelector("#loginMsg");
  msg.textContent = "Verificando...";
  try {
    const ref = collection(db, "usuarios_ruta");
    const q = query(ref, where("usuario", "==", u), where("password", "==", p), where("activo", "==", true));
    const snap = await getDocs(q);
    if (snap.empty) {
      msg.textContent = "Usuario o contrase√±a incorrectos";
      return;
    }
    const data = snap.docs[0].data();
    USUARIO_LOGUEADO = { id: snap.docs[0].id, ...data };
    rutaId = data.rutaId;

    document.querySelector("#loginScreen").style.display = "none";
    document.querySelector("#posApp").style.display = "block";

    try {
      mostrarToast("Activando geolocalizaci√≥n üì°");
      window.UBICACION_ACTUAL = await obtenerUbicacionRobusta();
    } catch (e) {
      console.warn("‚ö†Ô∏è GPS:", e.message);
    }

    await cargarCatalogoDesdeFirestore();
    await cargarDepartamentos();
    render();
    await sincronizarVentasPendientes();
    await fijarClientePublico();

    localStorage.setItem("usuario_ruta", JSON.stringify(USUARIO_LOGUEADO));
  } catch (e) {
    msg.textContent = "Error de conexi√≥n";
    console.error(e);
  }
}
document.getElementById("btnLogin").onclick = loginUsuario;

// =======================================================
// üîÅ CACHE / INDEXEDDB
// =======================================================
function openLocalDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('posDB', 1);
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('ventasPendientes')) {
        db.createObjectStore('ventasPendientes', { keyPath: 'folio' });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror  = () => reject(request.error);
  });
}
async function guardarVentaOffline(venta) {
  const db = await openLocalDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('ventasPendientes', 'readwrite');
    tx.objectStore('ventasPendientes').put(venta);
    tx.oncomplete = () => resolve(true);
    tx.onerror    = () => reject(tx.error);
  });
}

// =======================================================
// üì¶ CATALOGO Y CLIENTES
// =======================================================
async function cargarCatalogoDesdeFirestore() {
  try {
    const cache = localStorage.getItem("catalogo_cache");
    const hoy = new Date().toDateString();
    const fechaCache = localStorage.getItem("catalogo_fecha");

    if (cache && fechaCache === hoy) {
      catalogo = JSON.parse(cache);
      catalogo.forEach(p => { if (p.codigo) codeIndex.set(p.codigo.trim(), p.id); });
      console.log("üì¶ Cat√°logo desde cache local");
      return;
    }

    const ref = collection(db, "productos");
    const q = query(ref, where("activo", "==", true));
    const snap = await getDocs(q);
    catalogo = []; codeIndex.clear();
    snap.forEach(d => {
      const x = d.data();
      const prod = {
        id: d.id,
        nombre: x.concepto || "SIN NOMBRE",
        codigo: (x.codigoBarra || "").toString(),
        precioPublico: Number(x.precioPublico || 0),
        costoUnit: Number(x.costoSinImpuesto || x.costo || 0),
        ivaTasa: Number(x.ivaTasa || 0),
        iepsTasa: Number(x.iepsTasa || 0),
        departamento_id: x.departamento_id || null,
        equivalentes: Array.isArray(x.codigosEquivalentes) ? x.codigosEquivalentes.map(String) : []
      };
      catalogo.push(prod);
      if (prod.codigo) codeIndex.set(prod.codigo.trim(), prod.id);
      prod.equivalentes.forEach(eq => { if (eq) codeIndex.set(eq.trim(), prod.id); });  // ‚úÖ AGREGA ESTA L√çNEA
    });
    localStorage.setItem("catalogo_cache", JSON.stringify(catalogo));
    localStorage.setItem("catalogo_fecha", hoy);
    console.log(`‚úÖ Cat√°logo actualizado (${catalogo.length} productos)`);
  } catch (err) { console.error("‚ùå Cat√°logo:", err); }
}

let departamentos = {};
async function cargarDepartamentos() {
  const snap = await getDocs(collection(db, "departamentos_venta"));
  snap.forEach(d => {
    const data = d.data();
    departamentos[d.id] = {
      id: Number(data.id || d.id),
      nombre: data.nombre || "SIN DEPTO",
      iva: Number(data.iva || 0),
      ieps: Number(data.ieps || 0)
    };
  });
}

// =======================================================
// üßæ FUNCIONES DE CARRITO Y TOTALES
// =======================================================
function delItem(id){ carrito=carrito.filter(x=>x.id!==id); render(); }
window.delItem = delItem;

function addProduct(prod,cantidad=1){
  if(!prod)return;
  const cant=Math.max(0.01,Number(cantidad)||1);
  const precio=Number(prod.precioPublico||0);
  const ex=carrito.find(x=>x.id===prod.id);
  if(ex){ex.cantidad+=cant; ex.importe=ex.cantidad*precio;}
  else{carrito.push({...prod,cantidad:cant,precioUnit:precio,importe:cant*precio});}
  render();
}
window.addProduct = addProduct; // ‚úÖ permite usarla desde fuera
  // =======================================================
// üîç BUSCADOR LOCAL CON EQUIVALENTES Y C√ìDIGOS DE BALANZA
// =======================================================
function decodificarCodigoBalanza(codigo) {
  if (!codigo || codigo.length < 13) return null;
  if (!codigo.startsWith("2")) return null;

  const base = codigo.substring(0, 7);
  const pesoStr = codigo.substring(7, 12);
  const peso = parseFloat(pesoStr) / 1000;

  return { base, peso };
}
// =======================================================
// üîç RESOLVER PRODUCTO (detecta peso y equivalentes)
// =======================================================
async function resolverProducto(codigoInput) {
  const codigoStr = String(codigoInput).trim();
  if (!codigoStr) throw new Error("C√≥digo vac√≠o");

  // 1Ô∏è‚É£ Detectar c√≥digo de balanza
  const det = decodificarCodigoBalanza(codigoStr);
  if (det) {
    const eq = await buscarPorEquivalente(db, det.base);
    if (eq) {
      return {
        id: eq.id,
        nombre: eq.concepto,
        codigo: eq.codigoBarra,
        precioPublico: eq.precioPublico,
        costoUnit: eq.costoUnit,
        ivaTasa: eq.ivaTasa,
        iepsTasa: eq.iepsTasa,
        _pesoDetectado: det.peso
      };
    }
  }

  // 2Ô∏è‚É£ Buscar en cat√°logo local
  let idByCode = codeIndex.get(codigoStr);
  if (!idByCode) {
    const prodEq = catalogo.find(p =>
      (p.equivalentes || []).some(eq => eq.trim() === codigoStr)
    );
    idByCode = prodEq ? prodEq.id : null;
  }
  if (idByCode) {
    const p = catalogo.find(x => x.id === idByCode);
    return p || null;
  }

  // 3Ô∏è‚É£ Buscar remoto por equivalentes
  const remoto = await buscarPorEquivalente(db, codigoStr);
  if (remoto) {
    return {
      id: remoto.id,
      nombre: remoto.concepto,
      codigo: remoto.codigoBarra,
      precioPublico: remoto.precioPublico,
      costoUnit: remoto.costoUnit,
      ivaTasa: remoto.ivaTasa,
      iepsTasa: remoto.iepsTasa
    };
  }

  // 4Ô∏è‚É£ Nada encontrado
  throw new Error("Producto no encontrado");
}
function calcularTotalesConImpuestosIncluidos() {
  let subtotal = 0, totalIva = 0, totalIeps = 0, total = 0;

  carrito.forEach(it => {
    const importe = it.cantidad * it.precioUnit;
    const dep = departamentos[it.departamento_id?.toString()] || { iva: 0, ieps: 0 };
    const ivaTasa = dep.iva / 100;
    const iepsTasa = dep.ieps / 100;

    let base = importe, iva = 0, ieps = 0;

    // Calcular desglose con impuestos incluidos
    if (iepsTasa > 0 && ivaTasa > 0) {
      base = importe / (1 + iepsTasa + ivaTasa * (1 + iepsTasa));
      ieps = base * iepsTasa;
      iva = (base + ieps) * ivaTasa;
    } else if (iepsTasa > 0) {
      base = importe / (1 + iepsTasa);
      ieps = base * iepsTasa;
    } else if (ivaTasa > 0) {
      base = importe / (1 + ivaTasa);
      iva = base * ivaTasa;
    }

    subtotal += base;
    totalIva += iva;
    totalIeps += ieps;
    total += importe;
  });

  const impuestosTotales = totalIva + totalIeps;

  return {
    subtotal: +subtotal.toFixed(2),
    iva: +totalIva.toFixed(2),
    ieps: +totalIeps.toFixed(2),
    impuestos: +impuestosTotales.toFixed(2),
    total: +total.toFixed(2)
  };
}

  window.calcularTotalesConImpuestosIncluidos = calcularTotalesConImpuestosIncluidos;

// =======================================================
// üí∏ DESCUENTO GLOBAL ‚Äì c√°lculo din√°mico
// =======================================================
function actualizarTotalesCobro() {
  const { total } = calcularTotalesConImpuestosIncluidos();
  const descuentoPorc = parseFloat(document.getElementById('descuentoPorcentaje')?.value || 0);
  const descuentoMonto = total * (descuentoPorc / 100);
  const totalConDescuento = total - descuentoMonto;
  const recibido = parseFloat(document.getElementById('montoRecibido')?.value || 0);
  const cambio = Math.max(0, recibido - totalConDescuento);

  document.getElementById('cobroTotal').textContent = money(totalConDescuento);
  document.getElementById('montoCambio').textContent = money(cambio);
}
window.actualizarTotalesCobro = actualizarTotalesCobro;
// =======================================================
// üßæ COBRO Y REGISTRO DE VENTA
// =======================================================
async function confirmarCobro() {
  try {
    const { subtotal, impuestos, total } = calcularTotalesConImpuestosIncluidos();
    const descuentoPorc = parseFloat(document.getElementById('descuentoPorcentaje')?.value || 0);
    const descuentoMonto = total * (descuentoPorc / 100);
    const totalConDescuento = total - descuentoMonto;

    const recibido = parseFloat(montoRecibido.value || "0");
    if (recibido < totalConDescuento && (metodoPago.value === "efectivo" || metodoPago.value === "mixto")) {
      alert("Pago insuficiente");
      return;
    }

    const cambio = Math.max(0, recibido - totalConDescuento);
    const notas = (notasCobro.value || "").trim();
    const folio = await getNextFolio(db);
    const fecha = new Date();
    const fechaTxt = fecha.toLocaleString();
    const ubicacion = await obtenerUbicacionRobusta();

    // =========================
    // üíæ Construir venta
    // =========================
    const venta = {
      folio,
      rutaId,
      usuario: USUARIO_LOGUEADO?.usuario || "",
      atendio: USUARIO_LOGUEADO?.nombre || "",
      fecha: serverTimestamp(),
      fecha_txt: fechaTxt,
      cliente: document.getElementById("cliente").value || "Mostrador",
      metodo_pago: metodoPago.value,
      recibido, cambio, notas,
      cortado: false,
      ubicacion,
      descuento: { // üí∏ DESCUENTO GLOBAL
        tipo: "global",
        porcentaje: descuentoPorc,
        monto: +descuentoMonto.toFixed(2),
        total_con_descuento: +totalConDescuento.toFixed(2),
        autorizado_por: USUARIO_LOGUEADO?.usuario || "vendedor",
        timestamp: new Date().toISOString()
      },
      detalle: carrito.map(it => {
        const depId = it.departamento_id?.toString() || "0";
        const depInfo = departamentos[depId] || { nombre: "SIN DEPTO", iva: 0, ieps: 0 };
        const costoUnit = Number(it.costoUnit || 0);
        const costoTotal = costoUnit * it.cantidad;
        const utilidad = it.importe - costoTotal;
        return {
          id: it.id, nombre: it.nombre, cantidad: it.cantidad,
          precio_unit: it.precioUnit, importe: it.importe,
          costo_unit: costoUnit, costo_total: +costoTotal.toFixed(2),
          utilidad: +utilidad.toFixed(2),
          departamento_info: depInfo
        };
      })
    };

    // Calcular utilidad neta
    const costoTotalVenta = venta.detalle.reduce((acc, d) => acc + d.costo_total, 0);
    const utilidadTotal = venta.detalle.reduce((acc, d) => acc + d.utilidad, 0);
    const utilidadNeta = utilidadTotal - descuentoMonto;
    const margenNeto = totalConDescuento > 0 ? ((utilidadNeta / totalConDescuento) * 100).toFixed(2) : 0;

    venta.resumen_financiero = {
      subtotal, impuestos, total,
      descuento_porcentaje: descuentoPorc,
      descuento_monto: descuentoMonto,
      total_final: totalConDescuento,
      costo_total: +costoTotalVenta.toFixed(2),
      utilidad_total_bruta: +utilidadTotal.toFixed(2),
      utilidad_total_neta: +utilidadNeta.toFixed(2),
      margen_porcentaje_neto: +margenNeto
    };

    // Guardar en Firestore
    const ref = collection(db, "rutas_venta");
    await addDoc(ref, venta);
    console.log("‚úÖ Venta registrada:", venta.folio);
    // üßæ Generar ticket f√≠sico
window.ULTIMA_VENTA = venta;
rellenarTicket(venta);
imprimirTicketEstilado();

    // =======================================================
    // üìÑ Ticket PDF + Telegram
    // =======================================================
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFont("courier", "bold");
    pdf.text("PROVEEDORA MATRIZ", 105, 15, { align: "center" });
    pdf.text("RUTA DE VENTA 3.0 ‚Äì DESCUENTO LIBRE", 105, 22, { align: "center" });
    pdf.line(10, 25, 200, 25);
    let y = 32;

    pdf.setFont("courier", "normal");
    pdf.text(`Folio: ${venta.folio}`, 10, y);
    y += 5; pdf.text(`Fecha: ${venta.fecha_txt}`, 10, y);
    y += 8; pdf.line(10, y, 200, y); y += 6;

    (venta.detalle || []).forEach(it => {
      pdf.text(it.nombre.substring(0, 40), 10, y); y += 4;
      pdf.text(`Cant: ${it.cantidad.toFixed(3)}  ${it.precio_unit.toFixed(2)}  ${it.importe.toFixed(2)}`, 10, y);
      y += 5; if (y > 260) { pdf.addPage(); y = 20; }
    });
    y += 6; pdf.line(10, y, 200, y); y += 6;

    const formatoNum = n => (Number(n || 0)).toLocaleString("es-MX", { minimumFractionDigits: 2 });
    if (venta.descuento?.monto > 0) {
      pdf.text(`Descuento ${venta.descuento.porcentaje}% : -${formatoNum(venta.descuento.monto)}`, 10, y);
      y += 5;
    }
    pdf.text(`Total : ${formatoNum(venta.descuento.total_con_descuento)}`, 10, y);
    y += 10; pdf.text("¬°Gracias por su compra!", 105, y, { align: "center" });

   // Generar y mostrar ticket en nueva pesta√±a
const pdfBlob = pdf.output("blob");
const url = URL.createObjectURL(pdfBlob);

    // Enviar a LOBA Telegram
    try {
      const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
      const CHAT_ID = "6617988297";
      const mensaje = `
üßæ *Nueva Venta Registrada*
üë§ *Vendedor:* ${venta.atendio}
üí∞ *Total sin descuento:* $${venta.resumen_financiero.total.toFixed(2)}
üîª *Descuento:* ${venta.descuento.porcentaje}% (-$${venta.descuento.monto.toFixed(2)})
üíµ *Total cobrado:* $${venta.resumen_financiero.total_final.toFixed(2)}
üìà *Utilidad neta:* $${venta.resumen_financiero.utilidad_total_neta.toFixed(2)} (${venta.resumen_financiero.margen_porcentaje_neto}%)
üìç *Ubicaci√≥n:* ${venta.ubicacion?.direccion || "Sin direcci√≥n"}
üåé [Ver en mapa](https://www.google.com/maps?q=${venta.ubicacion?.lat},${venta.ubicacion?.lon})
`.trim();

      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: CHAT_ID, text: mensaje, parse_mode: "Markdown" })
      });

      const formData = new FormData();
      formData.append("chat_id", CHAT_ID);
      formData.append("document", pdfBlob, `Ticket_${venta.folio}.pdf`);
      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method: "POST", body: formData });
    } catch (err) { console.error("‚ùå Telegram error:", err); }

mostrarToast("‚úÖ Venta completada y enviada a LOBA");
carrito = [];
render();

// üîÑ restablecer campos despu√©s de cobrar
document.getElementById("buscador").value = "";
document.getElementById("cantidadInput").value = 1; // o 0 si prefieres
document.getElementById("cliente").readOnly = true; // mantiene cliente fijo
productoSeleccionado = null;

cerrarCobro();

  } catch (err) { console.error("‚ùå Error en cobro:", err); alert("Error al guardar venta"); }
}

// =======================================================
// ‚úÖ UTILIDADES VARIAS
// =======================================================
function mostrarToast(mensaje){
  const toast=document.createElement("div");
  toast.textContent=mensaje;
  Object.assign(toast.style,{
    position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",
    background:"rgba(0,128,0,0.9)",color:"#fff",padding:"12px 20px",
    borderRadius:"10px",fontWeight:"600",zIndex:"3000",
    boxShadow:"0 3px 12px rgba(0,0,0,0.3)",opacity:"1",transition:"opacity 0.5s"
  });
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity="0",2500);
  setTimeout(()=>toast.remove(),3000);
}
// =======================================================
// ‚öôÔ∏è PLACEHOLDERS TEMPORALES
// =======================================================
async function render() {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = carrito.map(it => `
    <tr>
      <td>${it.nombre}</td>
      <td style="text-align:center">${it.cantidad.toFixed(2)}</td>
      <td style="text-align:right">${money(it.importe)}</td>
      <td class="del-col"><button class="del" onclick="delItem('${it.id}')">√ó</button></td>
    </tr>
  `).join('');

  const { subtotal, impuestos, total } = calcularTotalesConImpuestosIncluidos();
  document.getElementById("lblSubtotal").textContent = money(subtotal);
  document.getElementById("lblImpuestos").textContent = money(impuestos);
  document.getElementById("lblTotal").textContent = money(total);
}
async function sincronizarVentasPendientes() {
  console.log("Sincronizando ventas pendientes...");
}
  async function fijarClientePublico() {
  try {
    const ref = collection(db, "clientes");
    const q = query(ref, where("nombre", "==", "PUBLICO EN GENERAL"));
    const snap = await getDocs(q);
    if (!snap.empty) {
      const data = snap.docs[0].data();
      const input = document.getElementById("cliente");
      input.value = data.nombre;
      input.dataset.id = snap.docs[0].id;
      input.readOnly = true; // ‚úÖ bloquea edici√≥n
      console.log("‚úÖ Cliente p√∫blico fijado:", data.nombre);
    } else {
      console.warn("‚ö†Ô∏è Cliente p√∫blico no encontrado");
    }
  } catch (err) {
    console.error("‚ùå Error fijando cliente p√∫blico:", err);
  }
}

async function getNextFolio() {
  const n = localStorage.getItem("ultimoFolio") || 0;
  const nuevo = Number(n) + 1;
  localStorage.setItem("ultimoFolio", nuevo);
  return nuevo;
}

function cerrarCobro() {
  document.getElementById("modalCobro").style.display = "none";
}
window.confirmarCobro = confirmarCobro;
window.cerrarCobro = cerrarCobro;

// =======================================================
// üñ®Ô∏è Modal de Cobro (con descuento)
// =======================================================
</script>

<!-- üí≥ MODAL DE COBRO -->
<div id="modalCobro" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; align-items:center; justify-content:center;">
  <div class="modal-card" style="width:min(420px,92vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden;">
    <div class="modal-h" style="padding:12px 16px; background:#0c6cbd; color:#fff; font-weight:700;">Cobro</div>
    <div class="modal-b" style="padding:14px 16px; display:flex; flex-direction:column; gap:10px;">
      <div class="row big" style="justify-content:space-between">
        <span>Total a pagar:</span>
        <span id="cobroTotal">$0.00</span>
      </div>

      <!-- üí∏ DESCUENTO GLOBAL -->
      <label for="descuentoPorcentaje">Descuento (%)</label>
      <input id="descuentoPorcentaje" type="number" step="0.01" min="0" value="0" oninput="actualizarTotalesCobro()">

      <label for="metodoPago">M√©todo de pago</label>
      <select id="metodoPago" onchange="actualizarTotalesCobro()">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="transferencia">Transferencia</option>
        <option value="mixto">Mixto</option>
      </select>

      <div id="bloqueEfectivo">
        <label for="montoRecibido">Monto recibido</label>
        <input id="montoRecibido" type="number" step="0.01" min="0" oninput="actualizarTotalesCobro()">
        <div class="row" style="justify-content:space-between">
          <span>Cambio:</span><span id="montoCambio">$0.00</span>
        </div>
      </div>

      <label for="notasCobro">Notas</label>
      <textarea id="notasCobro" rows="2" style="resize:none"></textarea>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn" id="btnCancelarCobro" style="background:#aaa;" onclick="cerrarCobro()">Cancelar</button>
        <button class="btn" id="btnConfirmarCobro" onclick="confirmarCobro()">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js")
  .then(reg => console.log("‚úÖ SW registrado:", reg.scope))
  .catch(err => console.error("‚ùå Error SW:", err));
}

document.addEventListener("DOMContentLoaded", () => {
  const btnLogout=document.getElementById("btnLogout");
  if(btnLogout){
    btnLogout.addEventListener("click",()=>{
      localStorage.removeItem("usuario_ruta");
      localStorage.removeItem("catalogo_cache");
      localStorage.removeItem("catalogo_fecha");
      document.getElementById("posApp").style.display="none";
      document.getElementById("loginScreen").style.display="flex";
      document.getElementById("loginUsuario").value="";
      document.getElementById("loginPassword").value="";
      mostrarToast("Sesi√≥n cerrada correctamente ‚úÖ");
    });
  }
});
  // =======================================================
// üéØ BOT√ìN COBRAR ‚Äì abre modal
// =======================================================
document.getElementById("btnCobrar").addEventListener("click", ()=>{
  const { subtotal, impuestos, total } = window.calcularTotalesConImpuestosIncluidos();
  document.getElementById("cobroTotal").textContent = money(total);
  document.getElementById("lblSubtotal").textContent = money(subtotal);
  document.getElementById("lblImpuestos").textContent = money(impuestos);
  document.getElementById("lblTotal").textContent = money(total);
  document.getElementById("modalCobro").style.display = "flex";
}); // ‚úÖ cierre del bot√≥n Cobrar


// =======================================================
// üîç B√öSQUEDA DE PRODUCTO + CANTIDAD + ENTER AGREGA
// =======================================================
const inputBuscador = document.getElementById("buscador");
const inputCantidad = document.getElementById("cantidadInput");
const resultados = document.getElementById("resultados");
let productoSeleccionado = null;

inputBuscador.addEventListener("input", () => {
  const texto = inputBuscador.value.trim().toLowerCase();
  productoSeleccionado = null;
  if (texto.length < 2) {
    resultados.style.display = "none";
    return;
  }

  const normalizar = s => s?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

  const coincidencias = catalogo.filter(p => {
    const nombre = normalizar(p.nombre || "");
    const codigo = normalizar(p.codigo || "");
    return nombre.includes(texto) || codigo.includes(texto);
  }).slice(0, 15);

  if (coincidencias.length === 0) {
    resultados.style.display = "none";
    return;
  }

  resultados.innerHTML = coincidencias.map(p => `
    <div class="result-item" data-id="${p.id}">
      <span>${p.nombre}</span>
      <small>$${p.precioPublico.toFixed(2)}</small>
    </div>
  `).join('');
  resultados.style.display = "block";
});

resultados.addEventListener("click", (e) => {
  const item = e.target.closest(".result-item");
  if (!item) return;
  const id = item.dataset.id;
  productoSeleccionado = catalogo.find(p => p.id === id);
  inputBuscador.value = productoSeleccionado.nombre;
  resultados.style.display = "none";
  inputCantidad.focus();
});

// üëâ ENTER en cantidad agrega al carrito
inputCantidad.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && productoSeleccionado) {
    const cantidad = parseFloat(inputCantidad.value) || 1;
    addProduct(productoSeleccionado, cantidad);
    productoSeleccionado = null;
    inputBuscador.value = "";
    inputCantidad.value = 1;
    inputBuscador.focus();
  }
});
// =======================================================
// üì∏ ESC√ÅNER QR / C√ìDIGO DE BARRAS CON BALANZA Y EQUIVALENTES
// =======================================================
const btnCam = document.getElementById("btnCam");
let html5Qr = null;
let scannerActivo = false;

btnCam.addEventListener("click", async () => {
  try {
    if (!scannerActivo) {
      const contenedor = document.createElement("div");
      contenedor.id = "lectorQR";
      Object.assign(contenedor.style, {
        position: "fixed", inset: "0", background: "rgba(0,0,0,0.9)",
        display: "flex", flexDirection: "column", alignItems: "center",
        justifyContent: "center", zIndex: "5000"
      });

      const btnCerrar = document.createElement("button");
      btnCerrar.textContent = "‚úñ Cerrar c√°mara";
      Object.assign(btnCerrar.style, {
        position: "absolute", top: "12px", right: "12px",
        background: "#c0392b", color: "#fff", border: "none",
        borderRadius: "8px", padding: "8px 12px",
        fontSize: "14px", fontWeight: "600", cursor: "pointer"
      });
      btnCerrar.onclick = async () => {
        try { await html5Qr.stop(); } catch {}
        contenedor.remove();
        scannerActivo = false;
      };

      const visor = document.createElement("div");
      visor.id = "visorCam";
      visor.style.width = "90%";
      visor.style.maxWidth = "340px";
      visor.style.borderRadius = "12px";
      visor.style.overflow = "hidden";
      visor.style.background = "#000";

      contenedor.appendChild(visor);
      contenedor.appendChild(btnCerrar);
      document.body.appendChild(contenedor);

      // üîπ AQUI VA EL BLOQUE NUEVO
      if (!window.Html5Qrcode) {
        mostrarToast("Librer√≠a de c√°mara no cargada");
        contenedor.remove();
        return;
      }

      const { Html5QrcodeSupportedFormats } = window;
      html5Qr = new Html5Qrcode("visorCam", {
        formatsToSupport: [
          Html5QrcodeSupportedFormats?.QR_CODE,
          Html5QrcodeSupportedFormats?.EAN_13,
          Html5QrcodeSupportedFormats?.CODE_128
        ].filter(Boolean)
      });
      const cams = await Html5Qrcode.getCameras();
      if (!cams.length) {
        mostrarToast("No se detectaron c√°maras disponibles");
        contenedor.remove();
        return;
      }

      const camTrasera = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
      await html5Qr.start(
        camTrasera.id,
        { fps: 10, qrbox: 250 },
        async (texto) => {
          const codigo = texto.trim();
          console.log("üì¶ Escaneado:", codigo);

          try {
            const prod = await resolverProducto(codigo);
            const cantidad = prod._pesoDetectado || 1;
            addProduct(prod, cantidad);
            mostrarToast(`‚úÖ ${prod.nombre}`);
          } catch {
            mostrarToast(`‚ö†Ô∏è No encontrado (${codigo})`);
          }

          try { await html5Qr.stop(); } catch {}
          contenedor.remove();
          scannerActivo = false;
        },
        (err) => console.warn("üì∑ Error lectura:", err)
      );

      scannerActivo = true;
    } else {
      await html5Qr.stop();
      document.getElementById("lectorQR")?.remove();
      scannerActivo = false;
    }
  } catch (err) {
    console.error("‚ùå Error iniciando c√°mara:", err);
    mostrarToast("No se pudo acceder a la c√°mara");
    scannerActivo = false;
  }
});

  function rellenarTicket(venta) {
  document.getElementById('tFolio').textContent = `Folio: ${venta.folio}`;
  document.getElementById('tFecha').textContent = venta.fecha_txt;
  document.getElementById('tAtendio').textContent = `Atendi√≥: ${venta.atendio}`;
  document.getElementById('tCliente').textContent = `Cliente: ${venta.cliente || "Mostrador"}`;

  const tLineas = document.getElementById('tLineas');
  tLineas.innerHTML = '';
  (venta.detalle || []).forEach(it => {
    const fila = document.createElement('div');
    fila.style.display = 'flex';
    fila.style.justifyContent = 'space-between';
    fila.innerHTML = `<span>${it.cantidad.toFixed(2)} ${it.nombre}</span><span>$${it.importe.toFixed(2)}</span>`;
    tLineas.appendChild(fila);
  });

  const rf = venta.resumen_financiero || {};
  document.getElementById('tSubtotal').textContent = money(rf.subtotal);
  document.getElementById('tDesc').textContent = `-${money(rf.descuento_monto || 0)}`;
  document.getElementById('tImpuestos').textContent = money(rf.impuestos);
    document.getElementById('tIva').textContent = money(rf.iva || 0);
document.getElementById('tIeps').textContent = money(rf.ieps || 0);
  document.getElementById('tTotal').textContent = money(rf.total_final || rf.total);

  document.getElementById('tMetodo').textContent = venta.metodo_pago;
  document.getElementById('tRecibido').textContent = money(venta.recibido || 0);
  document.getElementById('tCambio').textContent = money(venta.cambio || 0);
}

function imprimirTicketEstilado() {
  const ticket = document.getElementById("ticketArea");

  // üñ®Ô∏è Impresora interna H10 / Sunmi
  if (window.InnerPrinter && typeof window.InnerPrinter.printHtml === "function") {
    try {
      const html = `<html><head><meta charset="utf-8"><style>
        body{font-family:'Courier New',monospace;font-size:14px;margin:0;padding:0;}
        #ticket{width:72mm;margin:0 auto;}
      </style></head><body>${ticket.innerHTML}</body></html>`;
      window.InnerPrinter.printHtml(html);
      return;
    } catch(e){ console.error("Error InnerPrinter:", e); }
  }

  // üñ®Ô∏è RawBT
  try {
    if (/Android/i.test(navigator.userAgent)) {
      const texto = generarTextoSimpleRawBT(window.ULTIMA_VENTA || {});
      window.open("rawbt:print?data=" + encodeURIComponent(texto + "\n\n\n"), "_blank");
      return;
    }
  } catch(e){ console.error("Error RawBT:", e); }

  // üñ®Ô∏è Fallback navegador
  ticket.style.display = "block";
  window.print();
  ticket.style.display = "none";
}

function generarTextoSimpleRawBT(venta){
  const formatoNum = n => (Number(n||0)).toLocaleString("es-MX",{minimumFractionDigits:2});
  const rf = venta.resumen_financiero || {};
  const impuestos = formatoNum(rf.impuestos || 0);
  const totalFinal = formatoNum(rf.total_final || rf.total || 0);
  const recibido = formatoNum(venta.recibido || 0);
  const cambio = formatoNum(venta.cambio || 0);
  const totalArt = (venta.detalle || []).length;

  let texto = `
PROVEEDORA MATRIZ
MADERO 690 SUR, CENTRO
LINARES, NUEVO LEON, 67700
RFC: PDD-031204-KL5
TEL: (821) 2121805
R√âGIMEN GENERAL DE LEY
PERSONAS MORALES
--------------------------------
# Venta: RV-${String(venta.folio).padStart(6,"0")}
Fecha: ${venta.fecha_txt}
--------------------------------
`;

  (venta.detalle||[]).forEach(it=>{
    texto += `${it.nombre}\nCant:${it.cantidad.toFixed(2)}  ${it.precio_unit.toFixed(2)}  ${it.importe.toFixed(2)}\n`;
  });

texto += `
Subtotal: ${formatoNum(rf.subtotal || 0)}
Desc.: -${formatoNum(rf.descuento_monto || 0)}
Total : ${formatoNum(rf.total_final || rf.total || 0)}
Pago  : ${formatoNum(venta.recibido || 0)}   Cambio: ${formatoNum(venta.cambio || 0)}
--------------------------------
Art√≠culos vendidos: ${(venta.detalle || []).length}
Incluye ${formatoNum(rf.impuestos || 0)} de Impuestos
Cajero: ${venta.atendio}
--------------------------------
¬°Gracias por su compra!
`;
  return texto;
}
window.decodificarCodigoBalanza = (window.decodificarCodigoBalanza || function(codigo){
    if (!codigo || codigo.length < 13) return null;
  if (!codigo.startsWith("2")) return null;
  const base = codigo.substring(0,7);
  const pesoStr = codigo.substring(7,12);
  const peso = parseFloat(pesoStr) / 1000;
  return { base, peso };
});
console.log("‚úÖ Funci√≥n global lista para pruebas");
</script>
  <!-- üîπ √Årea Ticket Imprimible -->
<div id="ticketArea" style="display:none;">
  <div id="ticket" class="ticket">
    <div style="text-align:center;">
      <img src="logo_proveedora.webp" alt="Logo" style="max-width:140px; height:auto;">
      <div style="font-weight:700;">PROVEEDORA MATRIZ</div>
      <div style="font-size:13px;">RUTA DE VENTA 3.0 ‚Äì DESCUENTO LIBRE</div>
    </div>
    <hr style="border:none; border-top:1px dashed #999; margin:6px 0;">

    <div id="tFolio" style="font-size:12px;"></div>
    <div id="tFecha" style="font-size:12px;"></div>
    <div id="tAtendio" style="font-size:12px;"></div>
    <div id="tCliente" style="font-size:12px;"></div>

    <hr style="border:none; border-top:1px dashed #999; margin:6px 0;">
    <div id="tLineas"></div>

    <hr style="border:none; border-top:1px dashed #999; margin:6px 0;">
    <div style="text-align:right; font-size:12px;">
      <div>Subtotal: <span id="tSubtotal"></span></div>
      <div>Descuento: <span id="tDesc"></span></div>
      <div>Impuestos: <span id="tImpuestos"></span></div>
      <div style="font-weight:bold;">Total: <span id="tTotal"></span></div>
      <div>IVA: <span id="tIva"></span></div>
<div>IEPS: <span id="tIeps"></span></div>
    </div>

    <hr style="border:none; border-top:1px dashed #999; margin:6px 0;">
    <div style="font-size:12px;">M√©todo: <span id="tMetodo"></span></div>
    <div style="font-size:12px;">Pago: <span id="tRecibido"></span> ¬∑ Cambio: <span id="tCambio"></span></div>

    <div style="text-align:center; margin-top:8px; font-size:12px;">
      ¬°Gracias por su compra!
    </div>
  </div>
</div>
<script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>
</body>
</html>
