<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Resumen de Ventas ‚Äì Ruta de Venta</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      margin:0;padding:20px;color:#111;
    }
    h2{color:white;text-align:center;margin-bottom:8px;}
    #fechaDia{color:#fff;text-align:center;margin:0 0 14px;font-weight:600;}
    .card{
      background:rgba(255,255,255,0.9);
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.2);
      padding:16px;max-width:720px;margin:0 auto;
    }
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:8px;border-bottom:1px solid #ddd;font-size:14px;}
    th{background:#00416A;color:#fff;}
    tr:hover{background:#f1f5f9;}
    .btnReimp{
      background:#0c6cbd;color:#fff;border:none;
      padding:6px 10px;border-radius:8px;font-weight:600;
      cursor:pointer;transition:.15s;
    }
    .btnReimp:hover{background:#0078d4;transform:scale(1.05);}
    .volver{
      display:block;text-align:center;margin:20px auto 0;
      background:#0c6cbd;color:#fff;padding:10px 16px;
      border-radius:10px;text-decoration:none;font-weight:600;max-width:720px;
    }
    .dashboard{
      max-width:720px;margin:0 auto 10px;
      background:rgba(255,255,255,0.9);
      border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.15);
      display:flex;justify-content:space-around;align-items:center;
      padding:12px;font-weight:600;font-size:16px;
    }
    #loading{text-align:center;padding:10px;color:#00416A;font-weight:600;}
    .total{font-weight:bold;text-align:right;margin-top:12px;font-size:18px;}
  </style>
</head>
<body>
  <h2>üìã Resumen de Ventas</h2>
  <p id="fechaDia"></p>

  <div class="dashboard">
    <div>üßæ Ventas del d√≠a: <span id="lblConteo">0</span></div>
    <div>üí∞ Total acumulado: <span id="lblTotalDash">$0.00</span></div>
  </div>

  <div class="card">
    <p><b>Vendedor:</b> <span id="lblUsuario">Cargando...</span></p>
    <table id="tabla">
      <thead>
        <tr><th>Folio</th><th>Hora</th><th>Total</th><th>Reimpresi√≥n</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="loading">Cargando ventas...</div>
    <div class="total">Total del D√≠a: <span id="lblTotal">$0.00</span></div>
  </div>

  <a class="volver" href="POS_RUTA_PROVSOFT_V3_DESC.html">‚¨ÖÔ∏è Volver al POS</a>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    const { jsPDF } = window.jspdf;

    // üîß Configuraci√≥n Firebase (misma del POS)
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Usuario actual
    const user = JSON.parse(localStorage.getItem("usuario_ruta") || "{}");
    const nombreUsuario = user?.nombre || "Desconocido";
    document.getElementById("lblUsuario").textContent = nombreUsuario;

    // Fecha actual
    const hoy = new Date();
    const fechaMX = hoy.toLocaleDateString("es-MX",{day:'2-digit',month:'2-digit',year:'numeric'});
    document.getElementById("fechaDia").textContent = `üóìÔ∏è Ventas del d√≠a ${fechaMX}`;

    // === Cargar ventas del d√≠a ===
    async function cargarVentas() {
      const tabla = document.querySelector("#tabla tbody");
      const totalEl = document.getElementById("lblTotal");
      const totalDash = document.getElementById("lblTotalDash");
      const conteoEl = document.getElementById("lblConteo");
      const loading = document.getElementById("loading");
      tabla.innerHTML = ""; totalEl.textContent = "$0.00"; totalDash.textContent = "$0.00"; conteoEl.textContent="0";
      loading.style.display = "block"; loading.textContent = "Cargando ventas...";

      try {
        const ventasRef = collection(db, "rutas_venta");
        const q = query(ventasRef, where("usuarioNombre", "==", nombreUsuario), where("cortado","==",false));
        const snap = await getDocs(q);

        let ventas = [];
snap.forEach(d => {
  const v = d.data();
  if (v.fecha_txt && v.resumen_financiero?.total) {
    const fechaVenta = v.fecha_txt.split(",")[0].trim(); // "1/11/2025"
    const [dia, mes, a√±o] = fechaVenta.split("/").map(n => parseInt(n));
    const hoy = new Date();
    if (dia === hoy.getDate() && mes === hoy.getMonth() + 1 && a√±o === hoy.getFullYear()) {
      ventas.push({ id: d.id, ...v });
    }
  }
});

        // ordenar por hora descendente
        ventas.sort((a,b)=>{
          const hA=a.fecha_txt.split(",")[1]?.trim()||"";
          const hB=b.fecha_txt.split(",")[1]?.trim()||"";
          return hB.localeCompare(hA);
        });

        let totalDia=0;
        ventas.forEach(v=>{
          const hora=v.fecha_txt.split(",")[1]?.trim()||"";
          const tot=Number(v.resumen_financiero.total||0);
          totalDia+=tot;
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${v.folio}</td>
            <td>${hora}</td>
            <td style="text-align:right">$${tot.toFixed(2)}</td>
            <td style="text-align:center"><button class="btnReimp">üñ®Ô∏è Reimprimir</button></td>`;
          tabla.appendChild(tr);
          tr.querySelector(".btnReimp").addEventListener("click",()=>reimprimirTicket(v.id));
        });

        totalEl.textContent="$"+totalDia.toFixed(2);
        totalDash.textContent="$"+totalDia.toFixed(2);
        conteoEl.textContent=ventas.length;
        loading.textContent = ventas.length ? "" : "Sin ventas registradas.";
      }catch(e){
        console.error(e);
        loading.textContent="‚ö†Ô∏è Error al cargar ventas.";
      }
    }

    cargarVentas();

    // === Reimpresi√≥n ===
    async function reimprimirTicket(id){
      try{
        const docRef=doc(db,"rutas_venta",id);
        const snap=await getDoc(docRef);
        if(!snap.exists()){alert("Venta no encontrada.");return;}
        const v=snap.data();
        const total=v.resumen_financiero.total||0;
        const sub=v.resumen_financiero.subtotal||0;
        const desc=v.descuento_monto||0;
        const imp=v.resumen_financiero.impuestos||0;
        const folio=v.folio;
        const cliente=v.cliente||"P√öBLICO EN GENERAL";
        const cajero=v.usuarioNombre||"‚Äî";
        const fecha=v.fecha_txt;

        let ticket="";
        ticket+="PROVEEDORA MATRIZ\n";
        ticket+="MADERO 690 SUR, CENTRO\n";
        ticket+="LINARES, N.L. 67700\n";
        ticket+="RFC: PDD031204KL5\n";
        ticket+="TEL: (821) 212-1805\n";
        ticket+="--------------------------------\n";
        ticket+=`# Venta: ${folio}\nFecha: ${fecha}\nCliente: ${cliente}\n--------------------------------\n`;
        (v.detalle||[]).forEach(it=>{
          ticket+=`${(it.nombre||"").substring(0,18).padEnd(18)}${it.cantidad.toFixed(2).padStart(5)}${(it.importe||0).toFixed(2).padStart(9)}\n`;
        });
        ticket+="--------------------------------\n";
        ticket+=`Subtotal: ${sub.toFixed(2)}\nDescuento: ${desc.toFixed(2)}\nImpuestos: ${imp.toFixed(2)}\nTotal: ${total.toFixed(2)}\n--------------------------------\nCajero: ${cajero}\n¬°Gracias por su compra!\n\n`;

        if(/Android/i.test(navigator.userAgent)){
          const encoded=encodeURIComponent(ticket);
          window.location.href=`rawbt:text,${encoded}`;
        }else{
          const pdf=new jsPDF({unit:"mm",format:[80,297]});
          pdf.setFont("courier","normal");
          let y=10;
          ticket.split("\n").forEach(line=>{pdf.text(line,4,y);y+=5;});
          pdf.output("dataurlnewwindow");
        }
      }catch(e){
        console.error(e);
        alert("Error al reimprimir.");
      }
    }
  </script>
</body>
</html>
