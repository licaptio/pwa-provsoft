<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FACTURACI√ìN ‚Äì PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap">

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #eef2f6;
  margin: 0;
}

header {
  background: #00416A;
  color: white;
  padding: 15px;
  font-size: 20px;
  font-weight: 600;
  text-align: center;
}

.container {
  max-width: 900px;
  margin: auto;
  padding: 15px;
}

.card {
  background: white;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  margin-bottom: 20px;
}

label { font-size: 15px; font-weight: 600; }

select, input[type="date"], button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #bbb;
  margin-top: 8px;
  font-size: 15px;
}

button {
  background: #0c6cbd;
  color: white;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

button:hover { background: #00416A; }

table { width: 100%; border-collapse: collapse; margin-top: 15px; }

th, td {
  border-bottom: 1px solid #ddd;
  padding: 10px;
  font-size: 14px;
}

th { background: #00416A; color: white; }
td { background: white; }

.facturada { color: green; font-weight: 600; }
.pendiente { color: red; font-weight: 600; }

.actions { display: flex; gap: 10px; }

.footer {
  margin-top: 30px;
  padding: 18px;
  text-align: center;
  color: #ffffff;
  background: linear-gradient(90deg, #00416A, #0c6cbd);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  letter-spacing: .5px;
}

/* Pantallas del wizard */
.wizard { display:none; }
.wizard.active { display:block; }
</style>
</head>

<body>

<header>üìÑ FACTURACI√ìN ‚Äì PROVSOFT</header>

<div class="container">

<!-- ===================================================== -->
<!-- PANTALLA 1: FILTRO Y VENTAS                           -->
<!-- ===================================================== -->
<div id="p1" class="wizard active">

  <div class="card">
    <label>Ruta:</label>
    <select id="rutaSelect">
      <option value="">Cargando usuarios‚Ä¶</option>
    </select>

    <label>Fecha:</label>
    <input type="date" id="fechaInput">

    <button id="btnCargar">Cargar ventas</button>
  </div>

  <div class="card">
    <h3>Ventas encontradas</h3>
    <table id="tablaVentas">
      <thead>
        <tr>
          <th>Sel</th>
          <th>Folio</th>
          <th>Cliente</th>
          <th>Total</th>
          <th>Usuario</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="actions">
    <button id="btnContinuar">Continuar ‚Üí</button>
  </div>

</div>


<!-- ===================================================== -->
<!-- PANTALLA 2: SELECCI√ìN CLIENTE O GLOBAL               -->
<!-- ===================================================== -->
<div id="p2" class="wizard">

  <div class="card">
    <h3>Selecciona el tipo de factura</h3>

    <label><input type="radio" name="tipoFactura" value="GLOBAL"> Factura GLOBAL</label><br>
    <label><input type="radio" name="tipoFactura" value="CLIENTE"> Factura a CLIENTE</label>

    <div id="clienteForm" style="display:none; margin-top:20px;">
      <label>Cliente:</label>
      <select id="selectCliente"></select>

      <div id="datosCliente" style="background:#f3f3f3; padding:12px; border-radius:10px; margin-top:10px;">
        <p><strong>RFC:</strong> <span id="cliRFC"></span></p>
        <p><strong>Nombre:</strong> <span id="cliNombre"></span></p>
        <p><strong>CP:</strong> <span id="cliCP"></span></p>

        <label>Uso CFDI:</label>
        <select id="cliUso">
          <option value="G01">G01 Adquisici√≥n</option>
          <option value="G03">G03 Gastos</option>
          <option value="S01">S01 Sin Efectos Fiscales</option>
        </select>
      </div>
    </div>
  </div>

  <div class="actions">
    <button id="btnAtras1">‚Üê Regresar</button>
    <button id="btnContinuar2">Continuar ‚Üí</button>
  </div>

</div>


<!-- ===================================================== -->
<!-- PANTALLA 3: CONFIRMACI√ìN FINAL                       -->
<!-- ===================================================== -->
<div id="p3" class="wizard">

  <div class="card">
    <h3>Confirmaci√≥n de factura</h3>

    <p><strong>Ventas seleccionadas:</strong></p>
    <ul id="listaConfirmacion"></ul>

    <p id="tipoResumen"></p>
  </div>

  <div class="actions">
    <button id="btnAtras2">‚Üê Regresar</button>
    <button id="btnGenerar">Generar CFDI</button>
  </div>

</div>

</div> <!-- container -->

<footer class="footer">
  ¬© 2025 PROVSOFT ¬∑ Sistema de Facturaci√≥n - V1.0 - 6cfb086
</footer>


<!-- ========================================================= -->
<!-- ======================= SCRIPT =========================== -->
<!-- ========================================================= -->
<script>
/* ============================================================
   FIREBASE
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============================================================
   UTILIDADES
============================================================ */
function show(p) {
  document.querySelectorAll(".wizard").forEach(x => x.classList.remove("active"));
  document.getElementById(p).classList.add("active");
}

/* ============================================================
   CARGAR USUARIOS RUTA
============================================================ */
async function cargarSelectorUsuarios() {
  const select = document.getElementById("rutaSelect");
  select.innerHTML = "<option value=''>Seleccione usuario‚Ä¶</option>";

  const snap = await db.collection("usuarios_ruta").get();

  snap.forEach(doc => {
    const u = doc.data();
    if (!u.activo) return;
    if (!u.rutaId) return;

    const nombre = u.nombre ?? u.usuario ?? "SIN NOMBRE";
    select.innerHTML += `<option value="${u.rutaId}">${nombre} ‚Äî ${u.rutaId}</option>`;
  });
}
cargarSelectorUsuarios();

/* ============================================================
   CARGAR CLIENTES
============================================================ */
let CLIENTES = {};

async function cargarClientes() {
  const snap = await db.collection("clientes").get();
  const select = document.getElementById("selectCliente");
  select.innerHTML = "<option value=''>Seleccione cliente‚Ä¶</option>";

  snap.forEach(doc => {
    CLIENTES[doc.id] = doc.data();
    select.innerHTML += `<option value="${doc.id}">${CLIENTES[doc.id].nombre}</option>`;
  });
}
cargarClientes();

/* ============================================================
   CARGAR VENTAS
============================================================ */
let VENTAS = [];

async function cargarVentas() {
  const ruta = rutaSelect.value;
  const fecha = fechaInput.value;

  if (!ruta || !fecha) {
    alert("Seleccione ruta y fecha");
    return;
  }

  tablaVentas.querySelector("tbody").innerHTML =
    "<tr><td colspan='6'>Cargando‚Ä¶</td></tr>";

  const inicio = new Date(fecha + "T00:00:00");
  const fin = new Date(fecha + "T23:59:59");

  const snap = await db.collection("ventas_rutav2")
    .where("rutaId", "==", ruta)
    .where("fecha", ">=", inicio)
    .where("fecha", "<=", fin)
    .get();

  VENTAS = [];
  let html = "";

  snap.forEach(doc => {
    const v = doc.data();
    v.id = doc.id;
    VENTAS.push(v);

    const estado = v.facturada
      ? `<span class='facturada'>FACTURADA</span>`
      : `<span class='pendiente'>PENDIENTE</span>`;

    const chk = !v.facturada ? `<input type='checkbox' data-id='${v.id}'>` : "";

    html += `
      <tr>
        <td>${chk}</td>
        <td>${v.folio}</td>
        <td>${v.cliente}</td>
        <td>$${v.resumen_financiero.total.toFixed(2)}</td>
        <td>${v.usuarioNombre}</td>
        <td>${estado}</td>
      </tr>`;
  });

  tablaVentas.querySelector("tbody").innerHTML = html;
}

btnCargar.onclick = cargarVentas;

/* ============================================================
   PASO 1 ‚Üí PASO 2
============================================================ */
btnContinuar.onclick = () => {
  const seleccionadas = [...document.querySelectorAll("input[type=checkbox]:checked")]
    .map(chk => chk.dataset.id);

  if (seleccionadas.length === 0) {
    alert("Seleccione al menos una venta.");
    return;
  }

  window.VENTAS_SELECCIONADAS = seleccionadas;
  show("p2");
};

/* ============================================================
   PANTALLA 2: SELECCI√ìN TIPO DE FACTURA
============================================================ */
document.getElementsByName("tipoFactura").forEach(r => {
  r.addEventListener("change", e => {
    if (e.target.value === "CLIENTE") {
      clienteForm.style.display = "block";
    } else {
      clienteForm.style.display = "none";
    }
  });
});

selectCliente.onchange = () => {
  const cli = CLIENTES[selectCliente.value];
  if (!cli) return;

  cliRFC.textContent = cli.rfc;
  cliNombre.textContent = cli.nombre;
  cliCP.textContent = cli.cp;
};

/* ============================================================
   PASO 2 ‚Üí PASO 3
============================================================ */
btnContinuar2.onclick = () => {
  const tipo = [...document.getElementsByName("tipoFactura")]
    .find(x => x.checked);

  if (!tipo) {
    alert("Seleccione GLOBAL o CLIENTE");
    return;
  }

  window.TIPO_FACTURA = tipo.value;

  if (tipo.value === "CLIENTE" && !selectCliente.value) {
    alert("Seleccione un cliente.");
    return;
  }

  // Mostrar ventas seleccionadas
  listaConfirmacion.innerHTML = "";
  window.VENTAS_SELECCIONADAS.forEach(id => {
    const v = VENTAS.find(x => x.id === id);
    listaConfirmacion.innerHTML += `<li>${v.folio} - $${v.resumen_financiero.total}</li>`;
  });

  tipoResumen.textContent =
    tipo.value === "GLOBAL"
      ? "Factura global de p√∫blico en general"
      : `Factura para cliente: ${CLIENTES[selectCliente.value].nombre}`;

  show("p3");
};

/* ============================================================
   PASO 3 ‚Üí GENERAR CFDI
============================================================ */
btnGenerar.onclick = () => {
  alert("Aqu√≠ generaremos el XML, TXT y timbrado final.");
};

/* ============================================================
   BOTONES DE RETROCESO
============================================================ */
btnAtras1.onclick = () => show("p1");
btnAtras2.onclick = () => show("p2");

</script>

</body>
</html>
