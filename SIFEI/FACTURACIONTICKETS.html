<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FACTURACIÃ“N â€“ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap">

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #eef2f6;
  margin: 0;
}

header {
  background: #00416A;
  color: white;
  padding: 15px;
  font-size: 20px;
  font-weight: 600;
  text-align: center;
}

.container {
  max-width: 900px;
  margin: auto;
  padding: 15px;
}

.hidden { display: none; }

.card {
  background: white;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  margin-bottom: 20px;
}

label {
  font-size: 15px;
  font-weight: 600;
}

select, input[type="date"], button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #bbb;
  margin-top: 8px;
  font-size: 15px;
}

button {
  background: #0c6cbd;
  color: white;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

button:hover {
  background: #00416A;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

th, td {
  border-bottom: 1px solid #ddd;
  padding: 10px;
  font-size: 14px;
}

th {
  background: #00416A;
  color: white;
}

td { background: white; }

.facturada { color: green; font-weight: 600; }
.pendiente { color: red; font-weight: 600; }

.actions {
  display: flex;
  gap: 10px;
}

.footer {
  margin-top: 30px;
  padding: 18px;
  text-align: center;
  color: #ffffff;
  background: linear-gradient(90deg, #00416A, #0c6cbd);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  letter-spacing: .5px;
}

textarea {
  width: 100%;
  height: 350px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #aaa;
  font-family: monospace;
  font-size: 12px;
}
</style>
</head>

<body>

<header>ðŸ“„ FACTURACIÃ“N â€“ PROVSOFT</header>

<div class="container">

<!-- ============= PANTALLA 1: SELECCIÃ“N DE VENTAS ============= -->
<div id="pantalla1">

  <div class="card">
    <label>Ruta:</label>
    <select id="rutaSelect"><option value="">Cargando usuariosâ€¦</option></select>

    <label>Fecha:</label>
    <input type="date" id="fechaInput">

    <button id="btnCargar">Cargar ventas</button>
  </div>

  <div class="card">
    <h3>Ventas encontradas</h3>
    <table id="tablaVentas">
      <thead>
        <tr>
          <th>Sel</th>
          <th>Folio</th>
          <th>Cliente</th>
          <th>Total</th>
          <th>Usuario</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="actions">
    <button id="btnContinuar">Continuar</button>
  </div>

</div>

<!-- ============= PANTALLA 2: SELECCIÃ“N DEL TIPO DE FACTURA ============= -->
<div id="pantalla2" class="hidden">
  <div class="card">
    <h3>Tipo de facturaciÃ³n</h3>

    <select id="tipoFacturaSelect">
      <option value="">Seleccione...</option>
      <option value="global">Factura Global (PÃºblico en general)</option>
      <option value="cliente">Factura a Cliente</option>
    </select>

    <button id="btnContinuarTipo">Siguiente</button>
  </div>
</div>

<!-- ============= PANTALLA 3: SELECCIÃ“N DE CLIENTE (SI APLICA) ============= -->
<div id="pantalla3" class="hidden">
  <div class="card">
    <h3>Seleccionar cliente</h3>

    <select id="clienteSelect">
      <option value="">Seleccione clienteâ€¦</option>
    </select>

    <button id="btnGenerarXMLCliente">Generar XML Cliente</button>
  </div>
</div>

<!-- ============= PANTALLA 4: RESULTADO XML ============= -->
<div id="pantallaXML" class="hidden">
  <div class="card">
    <h3>XML Generado (CFDI 4.0)</h3>
    <textarea id="xmlOutput"></textarea>
  </div>
</div>

</div> <!-- container -->

<footer class="footer">
  <p>Â© 2025 PROVSOFT Â· Sistema de FacturaciÃ³n - V1.0 Â· by Gerardo & ChatGPT</p>
</footer>


<!-- ============================================================
     ðŸ”¥ FIREBASE + CONTROL DE FLUJOS
     ============================================================ -->
<script>
/* -------- ðŸ”¥ CONFIG FIREBASE -------- */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- VARIABLES GLOBALES ---------- */
let VENTAS = [];
let VENTAS_SELECCIONADAS = [];

/* ============================================================
   1. Cargar Usuarios de Ruta para selector
   ============================================================ */
async function cargarSelectorUsuarios() {
  const select = document.getElementById("rutaSelect");
  select.innerHTML = "<option value=''>Seleccione rutaâ€¦</option>";

  const snap = await db.collection("usuarios_ruta").get();

  snap.forEach(doc => {
    const u = doc.data();
    if (!u.activo || !u.rutaId) return;

    select.innerHTML += `
      <option value="${u.rutaId}">
        ${u.nombre} â€” ${u.rutaId}
      </option>
    `;
  });
}
cargarSelectorUsuarios();

/* ============================================================
   2. Cargar ventas por ruta + fecha
   ============================================================ */
const tabla = document.querySelector("#tablaVentas tbody");

async function cargarVentas() {
  tabla.innerHTML = "<tr><td colspan='6'>Cargandoâ€¦</td></tr>";

  const ruta = document.getElementById("rutaSelect").value;
  const fecha = document.getElementById("fechaInput").value;

  if (!ruta || !fecha) {
    alert("Seleccione ruta y fecha");
    return;
  }

  const inicio = new Date(fecha + "T00:00:00");
  const fin = new Date(fecha + "T23:59:59");

  const snap = await db.collection("ventas_rutav2")
    .where("rutaId", "==", ruta)
    .where("fecha", ">=", inicio)
    .where("fecha", "<=", fin)
    .get();

  tabla.innerHTML = "";
  VENTAS = [];

  snap.forEach(doc => {
    const v = doc.data();
    v.id = doc.id;
    VENTAS.push(v);

    const estado = v.facturada
      ? `<span class='facturada'>FACTURADA</span>`
      : `<span class='pendiente'>PENDIENTE</span>`;

    const chk = !v.facturada ? `<input type='checkbox' data-id='${v.id}'>` : "";

    tabla.innerHTML += `
      <tr>
        <td>${chk}</td>
        <td>${v.folio}</td>
        <td>${v.cliente}</td>
        <td>$${v.resumen_financiero.total.toFixed(2)}</td>
        <td>${v.usuarioNombre ?? "SIN USUARIO"}</td>
        <td>${estado}</td>
      </tr>
    `;
  });
}

document.getElementById("btnCargar").onclick = cargarVentas;

/* ============================================================
   3. Continuar a pantalla de tipo de factura
   ============================================================ */
document.getElementById("btnContinuar").onclick = () => {
  const checks = [...document.querySelectorAll("input[type=checkbox]:checked")];
  if (checks.length === 0) return alert("Seleccione al menos una venta");

  VENTAS_SELECCIONADAS = checks.map(c => c.dataset.id);

  pantalla1.classList.add("hidden");
  pantalla2.classList.remove("hidden");
};

/* ============================================================
   4. Elegir tipo de factura
   ============================================================ */
document.getElementById("btnContinuarTipo").onclick = () => {
  const tipo = document.getElementById("tipoFacturaSelect").value;

  if (!tipo) return alert("Seleccione un tipo de factura");

  if (tipo === "global") {
    generarXMLGlobalUI();
  } else {
    pantalla2.classList.add("hidden");
    pantalla3.classList.remove("hidden");
    cargarClientes();
  }
};

/* ============================================================
   5. Cargar clientes
   ============================================================ */
async function cargarClientes() {
  const select = document.getElementById("clienteSelect");
  select.innerHTML = "<option value=''>Seleccioneâ€¦</option>";

  const snap = await db.collection("clientes").get();

  snap.forEach(doc => {
    const c = doc.data();
    select.innerHTML += `<option value="${doc.id}">${c.nombre} â€” ${c.rfc}</option>`;
  });
}

/* ============================================================
   6. BotÃ³n generar XML cliente
   ============================================================ */
document.getElementById("btnGenerarXMLCliente").onclick = async () => {
  const id = document.getElementById("clienteSelect").value;
  if (!id) return alert("Seleccione un cliente");

  const clienteDoc = await db.collection("clientes").doc(id).get();
  const cliente = clienteDoc.data();

  const venta = VENTAS.find(v => v.id === VENTAS_SELECCIONADAS[0]);

  const xml = generarXMLCliente(venta, EMISOR, cliente);

  mostrarXML(xml);
};

/* ============================================================
   ðŸ”¥ GENERADORES XML (GLOBAL / CLIENTE)
   ============================================================ */

const EMISOR = {
  rfc: "PDD031204KL5",
  nombre: "PROVEEDORA DE DULCES Y DESECHABLES",
  regimen_fiscal: "601",
  cp_fiscal: "64000"
};

/* ---------- GLOBAL ---------- */
function generarXMLGlobalUI() {
  const ventas = VENTAS.filter(v => VENTAS_SELECCIONADAS.includes(v.id));
  const xml = generarXMLGlobal(ventas, EMISOR);
  mostrarXML(xml);
}

function generarXMLGlobal(ventas, emisorInfo) {
  let subtotal = 0;
  let total = 0;
  let conceptosXML = "";

  ventas.forEach(v => {
    subtotal += v.resumen_financiero.subtotal;
    total += v.resumen_financiero.total;

    v.detalle.forEach(item => {
      conceptosXML += `
        <cfdi:Concepto 
          ClaveProdServ="${item.claveSat}"
          Cantidad="${item.cantidad}"
          ClaveUnidad="${item.unidadSat || 'H87'}"
          Descripcion="${item.nombre}"
          ValorUnitario="${item.precio_unit}"
          Importe="${item.importe}"
        ></cfdi:Concepto>
      `;
    });
  });

  const fecha = new Date().toISOString().slice(0, 19);

  return `
<cfdi:Comprobante Version="4.0" Serie="GLO" Fecha="${fecha}"
  Moneda="MXN" SubTotal="${subtotal.toFixed(2)}" Total="${total.toFixed(2)}"
  TipoDeComprobante="I" Exportacion="01" LugarExpedicion="${emisorInfo.cp_fiscal}"
  xmlns:cfdi="http://www.sat.gob.mx/cfd/4"
>
  <cfdi:Emisor 
    Rfc="${emisorInfo.rfc}"
    Nombre="${emisorInfo.nombre}"
    RegimenFiscal="${emisorInfo.regimen_fiscal}"
  />

  <cfdi:Receptor 
    Rfc="XAXX010101000"
    Nombre="PUBLICO EN GENERAL"
    DomicilioFiscalReceptor="${emisorInfo.cp_fiscal}"
    RegimenFiscalReceptor="616"
    UsoCFDI="S01"
  />

  <cfdi:Conceptos>
    ${conceptosXML}
  </cfdi:Conceptos>

  <cfdi:Impuestos TotalImpuestosTrasladados="0.00"></cfdi:Impuestos>

</cfdi:Comprobante>
  `;
}

/* ---------- CLIENTE ---------- */
function generarXMLCliente(venta, emisorInfo, clienteInfo) {
  let conceptosXML = "";
  let subtotal = venta.resumen_financiero.subtotal;
  let total = venta.resumen_financiero.total;

  venta.detalle.forEach(item => {
    conceptosXML += `
      <cfdi:Concepto 
        ClaveProdServ="${item.claveSat}"
        Cantidad="${item.cantidad}"
        ClaveUnidad="${item.unidadSat || 'H87'}"
        Descripcion="${item.nombre}"
        ValorUnitario="${item.precio_unit}"
        Importe="${item.importe}">
      </cfdi:Concepto>
    `;
  });

  const fecha = new Date().toISOString().slice(0, 19);

  return `
<cfdi:Comprobante Version="4.0" Serie="CLI" Fecha="${fecha}"
  Moneda="MXN" SubTotal="${subtotal.toFixed(2)}" Total="${total.toFixed(2)}"
  TipoDeComprobante="I" Exportacion="01" LugarExpedicion="${emisorInfo.cp_fiscal}"
  xmlns:cfdi="http://www.sat.gob.mx/cfd/4"
>
  <cfdi:Emisor 
    Rfc="${emisorInfo.rfc}"
    Nombre="${emisorInfo.nombre}"
    RegimenFiscal="${emisorInfo.regimen_fiscal}"
  />

  <cfdi:Receptor 
    Rfc="${clienteInfo.rfc}"
    Nombre="${clienteInfo.nombre}"
    DomicilioFiscalReceptor="${clienteInfo.cp}"
    RegimenFiscalReceptor="${clienteInfo.regimen}"
    UsoCFDI="${clienteInfo.uso_cfdi}"
  />

  <cfdi:Conceptos>
    ${conceptosXML}
  </cfdi:Conceptos>

  <cfdi:Impuestos TotalImpuestosTrasladados="0.00"></cfdi:Impuestos>

</cfdi:Comprobante>
  `;
}

/* ============================================================
   Mostrar XML en pantalla
   ============================================================ */
function mostrarXML(xml) {
  pantalla1.classList.add("hidden");
  pantalla2.classList.add("hidden");
  pantalla3.classList.add("hidden");

  pantallaXML.classList.remove("hidden");
  document.getElementById("xmlOutput").value = xml.trim();
}

</script>

</body>
</html>
