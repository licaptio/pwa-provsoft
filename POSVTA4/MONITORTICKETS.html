<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Ventas ‚Äì Ruta M√≥vil | PROVSOFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =====================================================
       üß© BLOQUE 1: FUENTES Y LIBRER√çAS FIREBASE
       ===================================================== -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- =====================================================
       üé® BLOQUE 2: ESTILOS VISUALES DEL PANEL + MODAL
       ===================================================== -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      padding: 20px;
      margin: 0;
    }
    h2 {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .filtro-fecha {
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="date"], select, button, input[type="password"] {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
    }
    input[type="date"], select { margin-right: 10px; }
    button {
      background: #00416A;
      color: white;
      transition: 0.2s;
    }
    button:hover { background: #002b4c; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ccc;
    }
    th { background: #00416A; color: white; }
    tr:hover { background: #f3f3f3; }
    .btn-delete {
      background: #e53935;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-delete:hover { background: #b71c1c; }
    #totalVentas {
      text-align: right;
      margin-top: 10px;
      font-weight: bold;
      color: white;
      font-size: 1.1em;
    }
    .footer {
      text-align: center;
      color: rgba(255,255,255,0.8);
      font-size: 0.9em;
      margin-top: 20px;
    }

    /* ============================
       ESTILOS DEL MODAL (CONFIRM PW)
       ============================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none; /* se muestra via JS */
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      padding: 18px;
      border-radius: 10px;
      width: 320px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      font-family: 'Poppins', sans-serif;
    }
    .modal h3 { margin: 0 0 10px 0; font-size: 16px; color: #00416A; }
    .modal p { margin: 0 0 12px 0; font-size: 13px; color: #333; }
    .modal .row { display:flex; gap:8px; }
    .modal input[type="password"] { flex:1; }
    .modal .small { font-size:12px; color:#666; margin-top:8px; }
    .hidden { display:none; }
.btn-undo {
  background: #0c6cbd;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  margin-left: 5px;
  transition: 0.2s;
}
.btn-undo:hover { background: #00416A; }

  </style>
</head>

<body>

  <!-- =====================================================
       üßæ BLOQUE 3: ENCABEZADO PRINCIPAL
       ===================================================== -->
  <h2>üßæ Monitor de Ventas ‚Äì Ruta M√≥vil | PROVSOFT</h2>

  <!-- =====================================================
       üîç BLOQUE 4: FILTROS (FECHA ‚ûú USUARIO ‚ûú RESULTADOS)
       ===================================================== -->
  <div class="filtro-fecha">
    <label>üìÖ Fecha: </label>
    <input type="date" id="fechaFiltro">

    <label>üë§ Usuario: </label>
    <select id="usuarioFiltro" disabled>
      <option value="">Seleccione una fecha primero</option>
    </select>

    <button id="btnFiltrar" disabled>Filtrar Ventas</button>
  </div>

  <!-- =====================================================
       üìã BLOQUE 5: TABLA DE RESULTADOS DE VENTAS
       ===================================================== -->
  <table id="tablaVentas">
<thead>
  <tr>
    <th>Cliente</th>
    <th>Usuario</th>
    <th>Total</th>
    <th>Fecha</th>
    <th>Hora</th>
    <th>Acci√≥n</th>
  </tr>
</thead>
    <tbody></tbody>
  </table>

  <!-- =====================================================
       üí∞ BLOQUE 6: TOTAL INFORMATIVO
       ===================================================== -->
  <div id="totalVentas"></div>

  <!-- =====================================================
       üß© BLOQUE 7: PIE DE P√ÅGINA
       ===================================================== -->
  <div class="footer">
    PROVSOFT ¬© 2025 ‚Äì Sistema Monitor de Ventas Ruta M√≥vil
  </div>

  <!-- =====================================================
       üîê BLOQUE 8: MODAL DE CONTRASE√ëA (OCULTO POR DEFECTO)
       ===================================================== -->
  <div id="pwOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h3 id="pwTitle">Confirmar eliminaci√≥n</h3>
      <p>Ingrese la contrase√±a para eliminar la venta.</p>

      <div class="row">
        <input id="pwInput" type="password" placeholder="Contrase√±a" autocomplete="new-password">
        <button id="pwSubmit">OK</button>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="pwCancel" style="background:#ccc;color:#111;border-radius:8px;padding:6px 10px;">Cancelar</button>
      </div>

      <div id="pwError" class="small hidden" style="color:#b71c1c;">Contrase√±a incorrecta</div>
    </div>
  </div>

  <!-- =====================================================
       ‚öôÔ∏è BLOQUE 9: L√ìGICA JAVASCRIPT PRINCIPAL (con petici√≥n de contrase√±a)
       ===================================================== -->
  <script>
    // =====================================================
    // üî• SECCI√ìN 1: CONFIGURACI√ìN FIREBASE
    // =====================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =====================================================
    // üîê SECCI√ìN 1.1: CONTRASE√ëA (SIMPLE) - ATENCI√ìN A SEGURIDAD
    // =====================================================
    // Nota: esta contrase√±a est√° en el cliente (JS). Cualquiera que vea el c√≥digo
    // puede descubrirla. En producci√≥n usar Auth + reglas / Cloud Function.
    const ADMIN_PASSWORD = "131282"; // <--- tu contrase√±a "simple"

    // =====================================================
    // üß† SECCI√ìN 2: REFERENCIAS DEL DOM
    // =====================================================
    const tablaBody = document.querySelector("#tablaVentas tbody");
    const fechaInput = document.getElementById("fechaFiltro");
    const usuarioSelect = document.getElementById("usuarioFiltro");
    const totalDiv = document.getElementById("totalVentas");
    const btnFiltrar = document.getElementById("btnFiltrar");

    // Modal elements
    const pwOverlay = document.getElementById("pwOverlay");
    const pwInput = document.getElementById("pwInput");
    const pwSubmit = document.getElementById("pwSubmit");
    const pwCancel = document.getElementById("pwCancel");
    const pwError = document.getElementById("pwError");

    // Variable para almacenar temporalmente el id a eliminar
    let pendingDeleteId = null;
    let pendingAction = null;

    // =====================================================
    // üßæ SECCI√ìN 3: OBTENER USUARIOS POR FECHA SELECCIONADA
    // =====================================================
    fechaInput.addEventListener("change", async () => {
      const fechaSeleccionada = fechaInput.value;
      usuarioSelect.innerHTML = "<option value=''>Cargando usuarios...</option>";
      usuarioSelect.disabled = true;
      btnFiltrar.disabled = true;

      if (!fechaSeleccionada) {
        usuarioSelect.innerHTML = "<option value=''>Seleccione una fecha primero</option>";
        return;
      }

      // Limpiar tabla y total
      tablaBody.innerHTML = "";
      totalDiv.textContent = "";

      // Traer solo la colecci√≥n y filtrar localmente por la fecha seleccionada
      // (Se puede optimizar con queries por rango si la colecci√≥n es enorme)
      const snapshot = await db.collection("ventas_rutav2").get();
      const usuariosUnicos = new Set();

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.fecha && data.fecha.toDate) {
          const fechaDoc = data.fecha.toDate();
          const a√±o = fechaDoc.getFullYear();
          const mes = String(fechaDoc.getMonth() + 1).padStart(2, "0");
          const dia = String(fechaDoc.getDate()).padStart(2, "0");
          const fechaStr = `${a√±o}-${mes}-${dia}`;

          if (fechaStr === fechaSeleccionada) {
            usuariosUnicos.add(data.usuarioNombre || data.usuario || "‚Äî");
          }
        }
      });

      // Mostrar lista de usuarios (solo los que vendieron esa fecha)
      usuarioSelect.innerHTML = "<option value=''>Seleccione un usuario</option>";
      usuariosUnicos.forEach(usuario => {
        const opt = document.createElement("option");
        opt.value = usuario;
        opt.textContent = usuario;
        usuarioSelect.appendChild(opt);
      });

      usuarioSelect.disabled = usuariosUnicos.size === 0;
      btnFiltrar.disabled = usuariosUnicos.size === 0;

      if (usuariosUnicos.size === 0) {
        usuarioSelect.innerHTML = "<option value=''>Sin ventas en esa fecha</option>";
      }
    });

    // =====================================================
    // üì¶ SECCI√ìN 4: CARGAR VENTAS POR USUARIO Y FECHA
    // =====================================================
    btnFiltrar.addEventListener("click", cargarVentas);

    async function cargarVentas() {
      const fechaFiltro = fechaInput.value;
      const usuarioFiltro = usuarioSelect.value;

      if (!fechaFiltro || !usuarioFiltro) {
        alert("Seleccione una fecha y un usuario");
        return;
      }

      tablaBody.innerHTML = "<tr><td colspan='5'>Cargando ventas...</td></tr>";
      totalDiv.textContent = "";

      let totalGeneral = 0;
      tablaBody.innerHTML = "";

      // Traemos solo documentos del usuario (optimizable por √≠ndices)
const snapshot = await db.collection("ventas_rutav2")
  .where("usuarioNombre", "==", usuarioFiltro)
  .orderBy("fecha", "asc")
  .get();


      snapshot.forEach(doc => {
        const data = doc.data();
        if (!data.fecha || !data.fecha.toDate) return;

        const fechaDoc = data.fecha.toDate();
        const a√±o = fechaDoc.getFullYear();
        const mes = String(fechaDoc.getMonth() + 1).padStart(2, "0");
        const dia = String(fechaDoc.getDate()).padStart(2, "0");
        const fechaStr = `${a√±o}-${mes}-${dia}`;

        if (fechaStr !== fechaFiltro) return;

        const total = parseFloat(data.total || data.resumen_financiero?.total || 0);
        totalGeneral += total;

const horaStr = fechaDoc.toLocaleTimeString("es-MX", {
  hour: "2-digit", minute: "2-digit", second: "2-digit"
});

const row = document.createElement("tr");
row.innerHTML = `
  <td>${data.cliente || data.nombre || "‚Äî"}</td>
  <td>${data.usuarioNombre || data.usuario || "‚Äî"}</td>
  <td>$${total.toFixed(2)}</td>
  <td>${fechaStr}</td>
  <td>${horaStr}</td>
<td>
  <button class="btn-delete" onclick="solicitarPwYEliminar('${doc.id}')">Eliminar</button>

  <button class="btn-undo"
    onclick="solicitarPwAccion('${doc.id}', '${data.cortado ? "descortar" : "cortar"}')">
    ${data.cortado ? "Descortar" : "Cortar"}
  </button>

  <button class="btn-undo"
    onclick="solicitarPwAccion('${doc.id}', '${data.facturada_global ? "desfacturar" : "facturar"}')">
    ${data.facturada_global ? "Quitar Factura" : "Marcar Facturada"}
  </button>
</td>
if (data.facturada_global) {
  row.style.borderLeft = "6px solid #2ecc71"; // verde
} else {
  row.style.borderLeft = "6px solid #f1c40f"; // amarillo
}
  
`;
if (data.cortado) {
  row.style.backgroundColor = "#d1ffd6"; // verde claro para cortadas
} else {
  row.style.backgroundColor = "#ffe6e6"; // rojo claro para no cortadas
}

tablaBody.appendChild(row);

      });

      if (tablaBody.innerHTML === "") {
        tablaBody.innerHTML = "<tr><td colspan='5'>No hay ventas para ese usuario</td></tr>";
      }

      totalDiv.textContent = `üí∞ Subtotal del usuario ${usuarioFiltro}: $${totalGeneral.toFixed(2)}`;
    }

// =====================================================
// üîê SECCI√ìN 5 REVISADA: CONTROL MODAL Y ACCIONES
// =====================================================

// Mostrar modal seg√∫n acci√≥n (eliminar, cortar o descortar)
function solicitarPwYEliminar(id) {
  pendingDeleteId = id;
  pendingAction = "eliminar";
  mostrarModal("Confirmar eliminaci√≥n", "Ingrese la contrase√±a para eliminar la venta.");
}

function solicitarPwAccion(id, accion) {
  pendingDeleteId = id;
  pendingAction = accion; // "cortar" o "descortar"
  const textoAccion =
  accion === "cortar" ? "Confirmar corte de venta" :
  accion === "descortar" ? "Confirmar descorte de venta" :
  accion === "facturar" ? "Confirmar facturaci√≥n" :
  "Confirmar quitar facturaci√≥n";

const textoDetalle =
  accion === "cortar" ? "Ingrese la contrase√±a para marcar la venta como CORTADA." :
  accion === "descortar" ? "Ingrese la contrase√±a para marcar la venta como NO cortada." :
  accion === "facturar" ? "Ingrese la contrase√±a para marcar la venta como FACTURADA." :
  "Ingrese la contrase√±a para quitar la facturaci√≥n del ticket.";
}

// Mostrar modal din√°mico
function mostrarModal(titulo, mensaje) {
  document.getElementById("pwTitle").textContent = titulo;
  document.querySelector("#pwOverlay p").textContent = mensaje;
  pwInput.value = "";
  pwError.classList.add("hidden");
  pwOverlay.style.display = "flex";
  pwOverlay.setAttribute("aria-hidden", "false");
  pwInput.focus();
}

// Ocultar modal
function esconderModal() {
  pwOverlay.style.display = "none";
  pwOverlay.setAttribute("aria-hidden", "true");
}

// Bot√≥n cancelar
pwCancel.addEventListener("click", esconderModal);

// Confirmar contrase√±a y ejecutar acci√≥n
pwSubmit.addEventListener("click", async () => {
  const pw = pwInput.value.trim();
  if (pw !== ADMIN_PASSWORD) {
    pwError.classList.remove("hidden");
    pwError.textContent = "Contrase√±a incorrecta";
    pwInput.focus();
    return;
  }

  esconderModal();

  if (!pendingDeleteId) return;

  try {
    const ref = db.collection("ventas_rutav2").doc(pendingDeleteId);
if (pendingAction === "facturar") {
  await ref.update({
    facturada_global: true,
    facturada_at: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("üßæ Venta marcada como FACTURADA.");
}

else if (pendingAction === "desfacturar") {
  await ref.update({
    facturada_global: false,
    facturada_at: null,
    folio_fiscal: null,
    serie_fiscal: null
  });
  alert("‚ö†Ô∏è Facturaci√≥n removida del ticket.");
}

    if (pendingAction === "cortar") {
      await ref.update({ cortado: true });
      alert("üì¶ Venta marcada como CORTADA.");
    } else if (pendingAction === "descortar") {
      await ref.update({ cortado: false });
      alert("‚úÖ Venta marcada como NO cortada.");
    } else if (pendingAction === "eliminar") {
      await ref.delete();
      alert("üóëÔ∏è Venta eliminada correctamente.");
    }

    // üîÑ Limpiar y refrescar
    pendingDeleteId = null;
    pendingAction = null;

    await new Promise(r => setTimeout(r, 300));
    cargarVentas();
  } catch (err) {
    console.error("Error ejecutando acci√≥n:", err);
    alert("‚ùå No se pudo completar la acci√≥n.");
  }
});

// Permitir ENTER o ESC
pwInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    pwSubmit.click();
  } else if (e.key === "Escape") {
    esconderModal();
  }
});

    // =====================================================
    // üóëÔ∏è SECCI√ìN 6: FUNCI√ìN QUE BORRA REALMENTE (CONFIRMADA)
    // =====================================================
    async function eliminarVentaConfirmada(id) {
      try {
        await db.collection("ventas_rutav2").doc(id).delete();
        alert("‚úÖ Venta eliminada correctamente");
        // recargar los resultados actuales (si hay fecha+usuario seleccionados)
        cargarVentas();
      } catch (e) {
        console.error(e);
        alert("‚ùå Error al eliminar la venta");
      }
    }
// =====================================================
// üîÑ SECCI√ìN 6.1: FUNCI√ìN PARA DESCORTAR UNA VENTA
// =====================================================
async function descortarVenta(id) {
  const confirmar = confirm("¬øSeguro que deseas DESCORTAR esta venta?");
  if (!confirmar) return;

  try {
    await db.collection("ventas_rutav2").doc(id).update({
      cortado: false
    });
    alert("‚úÖ Venta marcada como NO cortada (descortada).");
    cargarVentas(); // refrescar vista
  } catch (err) {
    console.error(err);
    alert("‚ùå Error al descortar la venta.");
  }
}

    // =====================================================
    // ‚ö° SECCI√ìN 7: INICIALIZACI√ìN AUTOM√ÅTICA
    // =====================================================
    window.onload = () => {
      tablaBody.innerHTML = "<tr><td colspan='5'>Seleccione una fecha para comenzar</td></tr>";
    };

    // Hacemos disponible la funci√≥n solicitarPwYEliminar en global para onclick inline
    window.solicitarPwYEliminar = solicitarPwYEliminar;
    window.solicitarPwAccion = solicitarPwAccion;

  </script>
</body>
</html>
