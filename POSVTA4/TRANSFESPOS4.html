
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Traspaso entre Almacenes</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------- CONFIG FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- VARIABLES ----------
    let carrito = [];
    let resultadosBusqueda = [];
    let paginaActual = 0;
    const porPagina = 10;

    const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
    const CHAT_ID   = "6617988297";

    // ---------- INDEXEDDB ----------
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("provsoftDB", 1);
        request.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("productos")) {
            db.createObjectStore("productos", { keyPath: "codigoBarra" });
          }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e);
      });
    }

    async function saveProductos(lista) {
      const db = await openDB();
      const tx = db.transaction("productos", "readwrite");
      const store = tx.objectStore("productos");
      lista.forEach(p => store.put(p));
      return new Promise(resolve => tx.oncomplete = resolve);
    }

    async function getAllProductos() {
      const db = await openDB();
      return new Promise(resolve => {
        const tx = db.transaction("productos", "readonly");
        const store = tx.objectStore("productos");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
      });
    }

    // ---------- SINCRONIZACI√ìN ----------
async function syncProductos() {
  try {
    const q = query(collection(db, "productos"), where("activo", "==", true));
    const snap = await getDocs(q);
    if (!snap.empty) {
      const lista = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      await saveProductos(lista);
      localStorage.setItem("ultimaSync", new Date().toISOString());
      console.log(`Cat√°logo actualizado: ${lista.length} productos`);
    } else {
      console.log("No hay productos activos");
    }
  } catch (err) {
    console.warn("Error al sincronizar:", err.message);
  }
}

    // ---------- B√öSQUEDAS ----------
async function buscarPorCodigo() {
  let codigo = document.getElementById("buscador").value.trim();
  if (!codigo) return;

  let pesoDetectado = null;

  // Detecta c√≥digos de balanza: 20 + producto + peso + verificador
  if (codigo.length === 13 && codigo.startsWith("20")) {
    const base = codigo.substring(0, 7); // "2000004"
    const pesoStr = codigo.substring(7, 12); // "24560"
    pesoDetectado = parseFloat(pesoStr) / 1000; // ‚Üí 24.560
    codigo = base;
  }

  const productos = await getAllProductos();

  const encontrado = productos.find(p => {
    const codBarra = String(p.codigoBarra || "");
    const equivalentes = Array.isArray(p.codigosEquivalentes)
      ? p.codigosEquivalentes.map(String)
      : [];
    return codBarra === codigo || equivalentes.includes(codigo);
  });

  if (encontrado) {
    const textoExtra = String(encontrado.codigoBarra) !== codigo
      ? ` (equivalente de ${encontrado.codigoBarra})`
      : "";

    document.getElementById("preview").innerText =
      `‚úÖ ${encontrado.concepto}${textoExtra}`;

    seleccionarProducto(encontrado);

    // si hay peso en el c√≥digo, autollenar la cantidad
    if (pesoDetectado) {
      document.getElementById("cantidad").value = pesoDetectado.toFixed(3);
    }
  } else {
    document.getElementById("preview").innerText = "‚ùå No encontrado";
  }

  document.getElementById("buscador").value = "";
}
    async function buscarPorNombre() {
      document.getElementById("modalResultados").style.display = "block";
      document.getElementById("busquedaNombre").focus();
    }

    function mostrarPagina() {
      const lista = document.getElementById("listaResultados");
      lista.innerHTML = "";
      const inicio = paginaActual * porPagina;
      const fin = inicio + porPagina;
      const pagina = resultadosBusqueda.slice(inicio, fin);

      pagina.forEach(data => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;
        item.onclick = () => { seleccionarProducto(data); cerrarModal(); };
        lista.appendChild(item);
      });

      document.getElementById("paginacion").innerText =
        `P√°gina ${paginaActual+1} de ${Math.ceil(resultadosBusqueda.length/porPagina)}`;
    }

    function siguientePagina() {
      if ((paginaActual+1)*porPagina < resultadosBusqueda.length) {
        paginaActual++;
        mostrarPagina();
      }
    }
    function anteriorPagina() {
      if (paginaActual > 0) {
        paginaActual--;
        mostrarPagina();
      }
    }

    // ---------- PRODUCTO ----------
    function seleccionarProducto(data) {
      document.getElementById("codigoSel").value = data.codigoBarra;
      document.getElementById("conceptoSel").value = data.concepto;
      document.getElementById("precioSel").value = data.precioPublico;
      document.getElementById("preview").innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;

      const cantidadInput = document.getElementById("cantidad");
      cantidadInput.focus();
      cantidadInput.select();
    }

    function agregarItem() {
      const codigo = document.getElementById("codigoSel").value;
      const concepto = document.getElementById("conceptoSel").value;
      const precio = parseFloat(document.getElementById("precioSel").value);
      let cantidad = parseInt(document.getElementById("cantidad").value);

      if (!codigo) return;
      if (!cantidad || cantidad < 1) cantidad = 1;

      const existente = carrito.find(i => i.codigo === codigo);
      if (existente) existente.cantidad += cantidad;
      else carrito.push({ codigo, concepto, precio, cantidad });

      renderTabla();

      document.getElementById("cantidad").value = "1";
      document.getElementById("preview").innerText = "";
      document.getElementById("codigoSel").value = "";
      document.getElementById("conceptoSel").value = "";
      document.getElementById("precioSel").value = "";
      document.getElementById("buscador").focus();
    }

    function renderTabla() {
      const tabla = document.getElementById("tabla");
      tabla.innerHTML = "";
      let total = 0;
      carrito.forEach((item, i) => {
        const subtotal = item.cantidad * item.precio;
        total += subtotal;
        tabla.innerHTML += `
          <tr>
            <td>${item.codigo}</td>
            <td>${item.concepto}</td>
            <td>${item.cantidad}</td>
            <td>$${item.precio.toFixed(2)}</td>
            <td><button onclick="eliminarItem(${i})">‚ùå</button></td>
          </tr>`;
      });
      if (carrito.length)
        tabla.innerHTML += `<tr><td colspan="3"><b>Total</b></td><td colspan="2"><b>$${total.toFixed(2)}</b></td></tr>`;
    }

    function eliminarItem(index) {
      carrito.splice(index, 1);
      renderTabla();
    }
    // ---------- TRASPASO ----------
    async function finalizarTraspaso() {
      const ruta = document.getElementById("ruta").value;
      const vendedor = document.getElementById("vendedor").value;
      if (carrito.length === 0 || !ruta) return alert("Faltan datos");

      const folio = generarFolio(ruta);
      await addDoc(collection(db, `almacenes/${ruta}/entradas`), { folio, vendedor, items: carrito });
      await addDoc(collection(db, `almacenes/ALMACENCENTRALPDD/salidas`), { folio, vendedor, items: carrito });
      await enviarTelegram(folio, ruta, vendedor, carrito);
      abrirComprobante(folio, ruta, vendedor, carrito);
      carrito = [];
      renderTabla();
    }

    function generarFolio(ruta) {
      const hoy = new Date();
      const dd = String(hoy.getDate()).padStart(2, "0");
      const mm = String(hoy.getMonth() + 1).padStart(2, "0");
      const yy = String(hoy.getFullYear()).slice(-2);
      const fecha = `${dd}${mm}${yy}`;
      const consecutivo = String(Math.floor(Math.random() * 999)).padStart(3, "0");
      return `${ruta}-${fecha}-${consecutivo}`;
    }

    async function enviarTelegram(folio, destino, vendedor, items) {
      const total = items.length;
      const bloques = [];
      for (let i = 0; i < items.length; i += 20) bloques.push(items.slice(i, i + 20));

      for (let i = 0; i < bloques.length; i++) {
        let mensaje = `üì¶ *Nuevo Traspaso*\n`;
        if (i === 0)
          mensaje += `Folio: ${folio}\nDestino: ${destino}\nVendedor: ${vendedor}\nTotal de productos: ${total}\n`;
        mensaje += `üìã *Bloque ${i + 1}/${bloques.length}:*\n`;
        bloques[i].forEach(it => (mensaje += `- ${it.cantidad} x ${it.concepto}\n`));

        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: CHAT_ID, text: mensaje, parse_mode: "Markdown" })
        });
      }
    }

    function abrirComprobante(folio, ruta, vendedor, items) {
      const fecha = new Date().toLocaleDateString();
      let tabla = "";
      items.forEach(it => {
        tabla += `<tr><td>${it.codigo}</td><td>${it.concepto}</td><td>${it.cantidad}</td><td>$${it.precio}</td></tr>`;
      });

      const win = window.open("", "_blank");
      win.document.write(`
        <html><head><title>Comprobante ${folio}</title>
        <style>
          body{font-family:Arial;margin:20px;}
          h2{text-align:center;color:#00416A;}
          table{width:100%;border-collapse:collapse;margin-top:15px;}
          th,td{border:1px solid #ccc;padding:6px;}
          th{background:#eee;}
        </style></head><body>
        <h2>üì¶ PROVEEDORA DE DULCES Y DESECHABLES</h2>
        <p><b>Folio:</b> ${folio}<br><b>Fecha:</b> ${fecha}<br><b>Destino:</b> ${ruta}<br><b>Vendedor:</b> ${vendedor}</p>
        <table><thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th></tr></thead>
        <tbody>${tabla}</tbody></table>
        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </body></html>`);
      win.document.close();
    }

    async function cargarVendedor() {
      const ruta = document.getElementById("ruta").value;
      if (!ruta) return;
      const q = query(collection(db, "usuarios_ruta"), where("rutaId", "==", ruta), where("activo", "==", true));
      const snap = await getDocs(q);
      if (!snap.empty)
        snap.forEach(doc => (document.getElementById("vendedor").value = doc.data().nombre));
      else document.getElementById("vendedor").value = "No asignado";
    }

    function cerrarModal() {
      document.getElementById("modalResultados").style.display = "none";
    }

    // ---------- INIT ----------
    document.addEventListener("DOMContentLoaded", async () => {
      await syncProductos();
      document.getElementById("ruta").addEventListener("change", cargarVendedor);
      document.getElementById("btnBuscarCodigo").addEventListener("click", buscarPorCodigo);
      document.getElementById("btnBuscarNombre").addEventListener("click", buscarPorNombre);
      document.getElementById("cerrarModal").addEventListener("click", cerrarModal);
      document.getElementById("btnAnterior").addEventListener("click", anteriorPagina);
      document.getElementById("btnSiguiente").addEventListener("click", siguientePagina);
      document.getElementById("btnTraspaso").addEventListener("click", finalizarTraspaso);

      document.getElementById("buscador").addEventListener("keypress", e => {
        if (e.key === "Enter") { e.preventDefault(); buscarPorCodigo(); }
      });
      document.getElementById("cantidad").addEventListener("keypress", e => {
        if (e.key === "Enter") { e.preventDefault(); agregarItem(); }
      });

      // b√∫squeda dentro del modal
      document.getElementById("busquedaNombre").addEventListener("input", async e => {
        const termino = e.target.value.trim().toLowerCase();
        if (!termino) { document.getElementById("listaResultados").innerHTML = ""; return; }
        const productos = await getAllProductos();
        resultadosBusqueda = productos.filter(p => p.concepto && p.concepto.toLowerCase().includes(termino));
        paginaActual = 0;
        mostrarPagina();
      });

      // Enter selecciona primer resultado
      document.getElementById("busquedaNombre").addEventListener("keypress", e => {
        if (e.key === "Enter" && resultadosBusqueda.length > 0) {
          seleccionarProducto(resultadosBusqueda[0]);
          cerrarModal();
        }
      });
    });

    window.agregarItem = agregarItem;
    window.eliminarItem = eliminarItem;
    window.getAllProductos = getAllProductos;
  </script>

  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;}
    .panel{max-width:800px;margin:auto;background:white;padding:20px;border-radius:10px;
      box-shadow:0 3px 8px rgba(0,0,0,.15);}
    label{display:block;margin-top:10px;font-weight:bold;}
    input,select{padding:8px;border:1px solid #ccc;border-radius:6px;}
    #buscador{width:70%;}
    #btnBuscarCodigo,#btnBuscarNombre{padding:8px 12px;margin-left:6px;cursor:pointer;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #ccc;padding:6px;text-align:left;}
    th{background:#eee;}
    button{margin-top:10px;padding:10px 16px;border:none;border-radius:6px;cursor:pointer;}
    .btn{background:#007bff;color:white;}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);}
    .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:10px;
      width:80%;max-width:600px;max-height:70%;overflow-y:auto;}
    .close{float:right;font-size:28px;cursor:pointer;}
    #listaResultados .item{padding:8px;border-bottom:1px solid #eee;cursor:pointer;}
    #listaResultados .item:hover{background:#f0f0f0;}
    .footer{text-align:center;margin-top:20px;font-size:14px;color:#555;}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px 30px;}
    .buscador-group,.cantidad-group{display:flex;gap:8px;align-items:center;}
    .buscador-group input{flex:1;}
    .cantidad-group input{width:80px;}

    
  </style>
</head>
<body>
  <div class="panel">
    <h2>‚¨áÔ∏è Traspaso a Vendedores</h2>
    <div class="form-grid">
      <div>
        <label>Ruta destino:</label>
        <select id="ruta">
          <option value="">-- Seleccionar --</option>
          <option value="Almacen_Ruta_1">Ruta 1</option>
          <option value="Almacen_Ruta_2">Ruta 2</option>
        </select>
      </div>

      <div>
        <label>Vendedor:</label>
        <input type="text" id="vendedor" readonly />
      </div>

      <div>
        <label>Captura producto:</label>
        <div class="buscador-group">
          <input type="text" id="buscador" placeholder="Escanea c√≥digo de barras..." />
          <button id="btnBuscarCodigo">‚úîÔ∏è Capturar</button>
          <button id="btnBuscarNombre">üîç Buscar</button>
        </div>
        <div id="preview" style="margin:10px 0;font-weight:bold;color:#003366;"></div>
        <input type="hidden" id="codigoSel">
        <input type="hidden" id="conceptoSel">
        <input type="hidden" id="precioSel">
      </div>

      <div>
        <label>Cantidad:</label>
        <div class="cantidad-group">
          <input type="number" id="cantidad" value="1" min="1"/>
          <button class="btn" onclick="agregarItem()">‚ûï Agregar a Lista</button>
        </div>
      </div>
    </div>

    <table>
      <thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th><th></th></tr></thead>
      <tbody id="tabla"></tbody>
    </table>
    <button class="btn" id="btnTraspaso">üì§ Finalizar Traspaso</button>
  </div>

  <!-- Modal -->
  <div id="modalResultados" class="modal">
    <div class="modal-content">
      <span id="cerrarModal" class="close">&times;</span>
      <h3>Resultados de b√∫squeda</h3>
      <input type="text" id="busquedaNombre" placeholder="Escribe nombre..." style="width:100%;margin-bottom:10px;">
      <div id="listaResultados"></div>
      <div style="margin-top:10px;text-align:center;">
        <button id="btnAnterior">‚¨ÖÔ∏è Anterior</button>
        <span id="paginacion"></span>
        <button id="btnSiguiente">Siguiente ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <div class="footer">Powered by <b>PROVSOFT</b></div>
</body>
</html>
