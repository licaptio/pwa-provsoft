<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Traspaso entre Almacenes</title>

  <script type="module">

/* ==========================================================
   üü¶ BLOQUE 1 ‚Äî CONFIGURACI√ìN DE FIREBASE
========================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, addDoc }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let carrito = [];
let resultadosBusqueda = [];
let paginaActual = 0;
const porPagina = 10;

const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
const CHAT_ID   = "6617988297";



/* ==========================================================
   üü© BLOQUE 2 ‚Äî INDEXEDDB (CAT√ÅLOGO OFFLINE)
========================================================== */
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("provsoftDB", 1);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains("productos")) {
        db.createObjectStore("productos", { keyPath: "codigoBarra" });
      }
    };
    request.onsuccess = e => resolve(e.target.result);
    request.onerror = e => reject(e);
  });
}

async function saveProductos(lista) {
  const db = await openDB();
  const tx = db.transaction("productos", "readwrite");
  const store = tx.objectStore("productos");
  lista.forEach(p => store.put(p));
  return new Promise(resolve => tx.oncomplete = resolve);
}

async function getAllProductos() {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction("productos", "readonly");
    const store = tx.objectStore("productos");
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result);
  });
}

async function syncProductos() {
  try {
    const q = query(collection(db, "productos"), where("activo", "==", true));
    const snap = await getDocs(q);
    if (!snap.empty) {
      const lista = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      await saveProductos(lista);
      localStorage.setItem("ultimaSync", new Date().toISOString());
      console.log(`Cat√°logo actualizado: ${lista.length} productos`);
    } else {
      console.log("No hay productos activos");
    }
  } catch (err) {
    console.warn("Error al sincronizar:", err.message);
  }
}



/* ==========================================================
   üü® BLOQUE 3 ‚Äî FUNCIONES: EQUIVALENTES + BALANZA
========================================================== */
function decodificarBalanza(codigo) {
  if (codigo.length === 13 && codigo.startsWith("20")) {
    const codigoProducto = codigo.substring(0, 7);
    const pesoBruto = codigo.substring(7, 12);
    const pesoKg = parseFloat(pesoBruto) / 1000;

    return { esBalanza: true, codigoProducto, pesoKg };
  }
  return { esBalanza: false };
}

function normalizarCodigo(producto, codigoEscaneado) {
  const principal = String(producto.codigoBarra || "");
  const equivalentes = Array.isArray(producto.codigosEquivalentes)
    ? producto.codigosEquivalentes.map(String)
    : [];

  if (principal === codigoEscaneado) return principal;
  if (equivalentes.includes(codigoEscaneado)) return principal;

  return null;
}



/* ==========================================================
   üüß BLOQUE 4 ‚Äî B√öSQUEDAS (C√ìDIGO / NOMBRE)
========================================================== */
async function buscarPorCodigo() {
  let codigo = document.getElementById("buscador").value.trim();
  if (!codigo) return;

  const balanza = decodificarBalanza(codigo);
  let pesoDetectado = null;

  if (balanza.esBalanza) {
    codigo = balanza.codigoProducto;
    pesoDetectado = balanza.pesoKg;
  }

  const productos = await getAllProductos();

  const encontrado = productos.find(p => normalizarCodigo(p, codigo) !== null);

  if (encontrado) {
    const textoExtra =
      String(encontrado.codigoBarra) !== codigo
        ? ` (equivalente de ${encontrado.codigoBarra})`
        : "";

    document.getElementById("preview").innerText =
      `‚úÖ ${encontrado.concepto}${textoExtra}`;

    seleccionarProducto(encontrado);

    if (pesoDetectado !== null) {
      document.getElementById("cantidad").value = pesoDetectado.toFixed(3);
    }
  } else {
    document.getElementById("preview").innerText = "‚ùå No encontrado";
  }

  document.getElementById("buscador").value = "";
}

async function buscarPorNombre() {
  document.getElementById("modalResultados").style.display = "block";
  document.getElementById("busquedaNombre").focus();
}



/* ==========================================================
   üü• BLOQUE 5 ‚Äî SELECCI√ìN DE PRODUCTO + CARRITO
========================================================== */
function seleccionarProducto(data) {
  document.getElementById("codigoSel").value = data.codigoBarra;
  document.getElementById("conceptoSel").value = data.concepto;
  document.getElementById("precioSel").value = data.precioPublico;
  document.getElementById("preview").innerText =
    `${data.concepto} ‚Äî $${data.precioPublico}`;

  const cantidadInput = document.getElementById("cantidad");
  cantidadInput.focus();
  cantidadInput.select();
}

function agregarItem() {
  const codigo = document.getElementById("codigoSel").value;
  const concepto = document.getElementById("conceptoSel").value;
  const precio = parseFloat(document.getElementById("precioSel").value);
  let cantidad = parseFloat(document.getElementById("cantidad").value);

  if (!codigo) return;
  if (!cantidad || cantidad <= 0) return alert("Cantidad inv√°lida");

  const existente = carrito.find(i => i.codigo === codigo);
  if (existente) existente.cantidad += cantidad;
  else carrito.push({ codigo, concepto, precio, cantidad });

  renderTabla();

  document.getElementById("cantidad").value = "1";
  document.getElementById("preview").innerText = "";
  document.getElementById("codigoSel").value = "";
  document.getElementById("conceptoSel").value = "";
  document.getElementById("precioSel").value = "";
  document.getElementById("buscador").focus();
}

function renderTabla() {
  const tabla = document.getElementById("tabla");
  tabla.innerHTML = "";
  let total = 0;

  carrito.forEach((item, i) => {
    const subtotal = item.cantidad * item.precio;
    total += subtotal;

    tabla.innerHTML += `
      <tr>
        <td>${item.codigo}</td>
        <td>${item.concepto}</td>
        <td>${item.cantidad}</td>
        <td>$${item.precio.toFixed(2)}</td>
        <td><button onclick="eliminarItem(${i})">‚ùå</button></td>
      </tr>`;
  });

  if (carrito.length)
    tabla.innerHTML += `
      <tr>
        <td colspan="3"><b>Total</b></td>
        <td colspan="2"><b>$${total.toFixed(2)}</b></td>
      </tr>`;
}

function eliminarItem(index) {
  carrito.splice(index, 1);
  renderTabla();
}



/* ==========================================================
   üü™ BLOQUE 6 ‚Äî TRASPASO / TELEGRAM / COMPROBANTE
========================================================== */
async function finalizarTraspaso() {
  const ruta = document.getElementById("ruta").value;
  const vendedor = document.getElementById("vendedor").value;
  if (carrito.length === 0 || !ruta) return alert("Faltan datos");

  const folio = generarFolio(ruta);

  await addDoc(collection(db, `almacenes/${ruta}/entradas`),
    { folio, vendedor, items: carrito });

  await addDoc(collection(db, `almacenes/ALMACENCENTRALPDD/salidas`),
    { folio, vendedor, items: carrito });

  await enviarTelegram(folio, ruta, vendedor, carrito);

  abrirComprobante(folio, ruta, vendedor, carrito);

  carrito = [];
  renderTabla();
}

function generarFolio(ruta) {
  const hoy = new Date();
  const dd = String(hoy.getDate()).padStart(2, "0");
  const mm = String(hoy.getMonth() + 1).padStart(2, "0");
  const yy = String(hoy.getFullYear()).slice(-2);
  const fecha = `${dd}${mm}${yy}`;
  const consecutivo = String(Math.floor(Math.random() * 999)).padStart(3, "0");
  return `${ruta}-${fecha}-${consecutivo}`;
}

async function enviarTelegram(folio, destino, vendedor, items) {
  const total = items.length;
  const bloques = [];
  for (let i = 0; i < items.length; i += 20)
    bloques.push(items.slice(i, i + 20));

  for (let i = 0; i < bloques.length; i++) {
    let mensaje = `üì¶ *Nuevo Traspaso*\n`;

    if (i === 0)
      mensaje += `Folio: ${folio}\nDestino: ${destino}\nVendedor: ${vendedor}\nTotal de productos: ${total}\n`;

    mensaje += `üìã *Bloque ${i + 1}/${bloques.length}:*\n`;

    bloques[i].forEach(it =>
      mensaje += `- ${it.cantidad} x ${it.concepto}\n`
    );

    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: CHAT_ID, text: mensaje, parse_mode: "Markdown" })
    });
  }
}

function abrirComprobante(folio, ruta, vendedor, items) {
  const fecha = new Date().toLocaleDateString();
  let tabla = "";

  items.forEach(it => {
    tabla += `
      <tr>
        <td>${it.codigo}</td>
        <td>${it.concepto}</td>
        <td>${it.cantidad}</td>
        <td>$${it.precio}</td>
      </tr>`;
  });

  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>Comprobante ${folio}</title>
    <style>
      body{font-family:Arial;margin:20px;}
      h2{text-align:center;color:#00416A;}
      table{width:100%;border-collapse:collapse;margin-top:15px;}
      th,td{border:1px solid #ccc;padding:6px;}
      th{background:#eee;}
    </style></head><body>
    <h2>üì¶ PROVEEDORA DE DULCES Y DESECHABLES</h2>

    <p>
      <b>Folio:</b> ${folio}<br>
      <b>Fecha:</b> ${fecha}<br>
      <b>Destino:</b> ${ruta}<br>
      <b>Vendedor:</b> ${vendedor}
    </p>

    <table>
      <thead>
        <tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th></tr>
      </thead>
      <tbody>${tabla}</tbody>
    </table>
    <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
    </body></html>
  `);
  win.document.close();
}

async function cargarVendedor() {
  const ruta = document.getElementById("ruta").value;
  if (!ruta) return;

  const q = query(
    collection(db, "usuarios_ruta"),
    where("rutaId", "==", ruta),
    where("activo", "==", true)
  );

  const snap = await getDocs(q);

  if (!snap.empty) {
    snap.forEach(doc => {
      document.getElementById("vendedor").value = doc.data().nombre;
    });
  } else {
    document.getElementById("vendedor").value = "No asignado";
  }
}


/* ==========================================================
   ‚¨õ BLOQUE 7 ‚Äî MODAL DE RESULTADOS
========================================================== */
function mostrarPagina() {
  const lista = document.getElementById("listaResultados");
  lista.innerHTML = "";
  const inicio = paginaActual * porPagina;
  const fin = inicio + porPagina;
  const pagina = resultadosBusqueda.slice(inicio, fin);

  pagina.forEach(data => {
    const item = document.createElement("div");
    item.className = "item";
    item.innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;
    item.onclick = () => { seleccionarProducto(data); cerrarModal(); };
    lista.appendChild(item);
  });

  document.getElementById("paginacion").innerText =
    `P√°gina ${paginaActual+1} de ${Math.ceil(resultadosBusqueda.length/porPagina)}`;
}

function siguientePagina() {
  if ((paginaActual+1)*porPagina < resultadosBusqueda.length) {
    paginaActual++;
    mostrarPagina();
  }
}

function anteriorPagina() {
  if (paginaActual > 0) {
    paginaActual--;
    mostrarPagina();
  }
}

function cerrarModal() {
  document.getElementById("modalResultados").style.display = "none";
}



/* ==========================================================
   üü´ BLOQUE 8 ‚Äî INIT (EVENTOS Y CARGA INICIAL)
========================================================== */
document.addEventListener("DOMContentLoaded", async () => {
  await syncProductos();

  document.getElementById("ruta").addEventListener("change", cargarVendedor);
  document.getElementById("btnBuscarCodigo").addEventListener("click", buscarPorCodigo);
  document.getElementById("btnBuscarNombre").addEventListener("click", buscarPorNombre);
  document.getElementById("cerrarModal").addEventListener("click", cerrarModal);
  document.getElementById("btnAnterior").addEventListener("click", anteriorPagina);
  document.getElementById("btnSiguiente").addEventListener("click", siguientePagina);
  document.getElementById("btnTraspaso").addEventListener("click", finalizarTraspaso);

  document.getElementById("buscador").addEventListener("keypress", e => {
    if (e.key === "Enter") { e.preventDefault(); buscarPorCodigo(); }
  });

  document.getElementById("cantidad").addEventListener("keypress", e => {
    if (e.key === "Enter") { e.preventDefault(); agregarItem(); }
  });

  document.getElementById("busquedaNombre").addEventListener("input", async e => {
    const termino = e.target.value.trim().toLowerCase();
    if (!termino) { document.getElementById("listaResultados").innerHTML = ""; return; }

    const productos = await getAllProductos();
    resultadosBusqueda = productos.filter(p => p.concepto &&
      p.concepto.toLowerCase().includes(termino));

    paginaActual = 0;
    mostrarPagina();
  });

  document.getElementById("busquedaNombre").addEventListener("keypress", e => {
    if (e.key === "Enter" && resultadosBusqueda.length > 0) {
      seleccionarProducto(resultadosBusqueda[0]);
      cerrarModal();
    }
  });
});

window.agregarItem = agregarItem;
window.eliminarItem = eliminarItem;
window.getAllProductos = getAllProductos;

  </script>
