<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#0c6cbd">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporte de Ventas Cortadas ‚Äì PROVSOFT</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body{font-family:'Poppins',sans-serif;background:#f5f7fa;color:#222;margin:0;padding:0;}
    header{background:linear-gradient(to right,#00416A,#0c6cbd);color:#fff;padding:15px;text-align:center;}
    h1{margin:0;font-size:22px;}
    main{padding:15px;}
    .filtros{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:15px;}
    input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #ccc;font-family:inherit;font-size:14px;}
    button{background:#0c6cbd;color:white;border:none;cursor:pointer;transition:background .3s;}
    button:hover{background:#00416A;}
    #map{height:420px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.1);margin-bottom:20px;}
    table{width:100%;border-collapse:collapse;background:white;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;}
    th{background:#00416A;color:white;}
    tr:hover{background:#f0f4ff;}
    .info-box{text-align:right;margin-bottom:10px;font-weight:600;color:#00416A;}
  </style>
</head>
<body>
  <header>
    <h1>Ventas Cortadas por Usuario ‚Äì PROVSOFT</h1>
  </header>
  <main>
    <div class="filtros">
      <label>Usuario: 
        <select id="usuario"></select>
      </label>
      <label>Fecha: <input type="date" id="fecha"></label>
      <button id="consultar">Consultar Cortes</button>
    </div>

    <div id="map"></div>
    <div class="info-box" id="resumen"></div>

    <table>
      <thead>
        <tr><th>Usuario</th><th>Hora</th><th>Total</th><th>Pago</th><th>Cliente</th></tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Inicializar mapa
const map = L.map('map').setView([24.857, -99.57], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

let markers = [];

// üîπ Cargar lista de usuarios que tienen ventas cortadas
async function cargarUsuarios() {
  const ref = collection(db, "ventas_rutav2");
  const q = query(ref, where("cortado", "==", true));
  const snapshot = await getDocs(q);
  const usuarios = new Set();
  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.usuarioNombre) usuarios.add(data.usuarioNombre);
  });
  const sel = document.getElementById('usuario');
  sel.innerHTML = '<option value="">-- Selecciona --</option>';
  [...usuarios].sort().forEach(u => {
    sel.innerHTML += `<option value="${u}">${u}</option>`;
  });
}
await cargarUsuarios();

// üîç Consultar ventas del d√≠a (cortadas + no cortadas)
async function consultarVentas() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  document.getElementById('tabla').innerHTML = '';
  document.getElementById('resumen').innerHTML = '';

  const usuarioSel = document.getElementById('usuario').value;
  const fechaSel = document.getElementById('fecha').value;
  if (!usuarioSel || !fechaSel) { 
    alert("Selecciona usuario y fecha."); 
    return; 
  }

  const ref = collection(db, "ventas_rutav2");
  // ‚ùå Quitamos cortado == true
  const q = query(ref, where("usuarioNombre", "==", usuarioSel));
  const snapshot = await getDocs(q);

  const partes = fechaSel.split("-");
  const fechaRef = `${parseInt(partes[2])}/${parseInt(partes[1])}/${partes[0]}`;

  const ventas = [];
  snapshot.forEach(doc => {
    const v = doc.data();
    if (v.fecha_txt?.includes(fechaRef)) ventas.push(v);
  });

  if (ventas.length === 0) {
    alert("No hay ventas de ese usuario en esa fecha.");
    return;
  }
// üïí ORDENAR DE M√ÅS ANTIGUA ‚Üí M√ÅS RECIENTE
ventas.sort((a, b) => {
  const da = new Date(a.fecha_txt.replace(" a. m.", " AM").replace(" p. m.", " PM"));
  const db = new Date(b.fecha_txt.replace(" a. m.", " AM").replace(" p. m.", " PM"));
  return da - db; // ascendente
});

  let totalDia = 0;
  let hayUbicaciones = false;

  ventas.forEach(v => {
    const totalVenta = Number(v.resumen_financiero?.total || 0);
    totalDia += totalVenta;

    // üó∫Ô∏è marcador en el mapa
    if (v.ubicacion?.lat && v.ubicacion?.lon) {
      const marker = L.marker([v.ubicacion.lat, v.ubicacion.lon]).addTo(map);
      marker.bindPopup(`
        <b>${v.usuarioNombre}</b><br>
        ${v.fecha_txt}<br>
        <b>$${totalVenta.toLocaleString('es-MX')}</b><br>
        Pago: ${v.metodo_pago || ''}<br>
        Cliente: ${v.cliente || ''}<br>
        <span style="color:${v.cortado ? 'green' : 'red'}">
          ${v.cortado ? 'CORTADA' : 'NO CORTADA'}
        </span>
      `);
      markers.push(marker);
      hayUbicaciones = true;
    }

    // üßæ tabla
    const row = `<tr>
      <td>${v.usuarioNombre}</td>
      <td>${v.fecha_txt}</td>
      <td>$${totalVenta.toLocaleString('es-MX')}</td>
      <td>${v.metodo_pago || ''}</td>
      <td>${v.cliente || ''}</td>
    </tr>`;
    document.getElementById('tabla').insertAdjacentHTML('beforeend', row);
  });

  document.getElementById('resumen').innerHTML = 
    `Total del d√≠a: <span style="color:#0c6cbd">$${totalDia.toLocaleString('es-MX')}</span>`;

  if (hayUbicaciones) {
    const primera = ventas.find(v => v.ubicacion?.lat);
    if (primera) map.setView([primera.ubicacion.lat, primera.ubicacion.lon], 13);
  } else {
    alert("No hay coordenadas registradas. Se muestran solo en tabla.");
  }
}

// Cambiar el listener:
document.getElementById('consultar').addEventListener('click', consultarVentas);
</script>
</body>
</html>
