<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>REIMPRESI√ìN DE CORTES ‚Äì PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #222;
    }
    h1 {
      color: #00416A;
      text-align: center;
      margin-bottom: 10px;
    }
    select, input {
      display: block;
      margin: 10px auto 15px auto;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }
    th { background: #00416A; color: white; }
    button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #0c6cbd;
      color: white;
      font-weight: 600;
    }
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-direction: column;
    }
    .spinner {
      width: 60px; height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid #0c6cbd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  </style>

  <!-- üß© Librer√≠as externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <h1>REIMPRESI√ìN DE CORTES ‚Äì PROVSOFT</h1>
  <input type="date" id="fechaFiltro">
  <select id="rutaFiltro"><option value="">Selecciona una ruta...</option></select>

  <table>
    <thead>
      <tr><th>Ruta</th><th>Usuario</th><th>Fecha</th><th>Acci√≥n</th></tr>
    </thead>
    <tbody id="tbodyCortes">
      <tr><td colspan="4" style="text-align:center;">Selecciona filtros para buscar cortes</td></tr>
    </tbody>
  </table>

  <div id="overlay"><div class="spinner"></div>Generando reimpresi√≥n...</div>

<script type="module">
// =============================================
// üöÄ BLOQUE 1 ‚Äî CONEXI√ìN FIREBASE
// =============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// =============================================
// üìã BLOQUE 2 ‚Äî CARGAR CORTES DESDE Firestore
// =============================================
const fechaFiltro = document.getElementById("fechaFiltro");
const rutaFiltro = document.getElementById("rutaFiltro");
const tbody = document.getElementById("tbodyCortes");
const overlay = document.getElementById("overlay");

function resolverRuta(doc) {
  return (
    doc.rutaId ||
    doc.resumen?.rutaId ||
    doc.ruta ||
    doc.ruta_nombre ||
    ""
  ).toString().trim();
}

function resolverUsuario(doc) {
  return (
    doc.realizado_por ||
    doc.resumen?.creado_por ||
    doc.usuarioNombre ||
    doc.usuario ||
    "‚Äî"
  ).toString().trim();
}

function resolverFecha(doc) {
  return normalizarFechaCorte(
    doc.fecha_corte ||   // ‚úÖ PRIORIDAD
    doc.fecha ||
    doc.fecha_txt ||
    ""
  );
}


// Cargar lista de rutas distintas
async function cargarRutas() {
  const snap = await getDocs(collection(db, "cortes_globalesV4"));
  const rutas = new Set();
  snap.forEach(d => {
  const ruta = resolverRuta(d.data());
  if (ruta) rutas.add(ruta);
});
  
  rutas.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    rutaFiltro.appendChild(opt);
  });
}
await cargarRutas();

fechaFiltro.addEventListener("change", listarCortes);
rutaFiltro.addEventListener("change", listarCortes);
// =============================================
// üß© NORMALIZAR FECHA DE CORTE (OPCI√ìN A)
// =============================================
function normalizarFechaCorte(fecha) {
  if (!fecha) return "";

  // üî• Timestamp Firestore ‚Üí FECHA LOCAL
  if (typeof fecha === "object" && fecha.seconds) {
    const d = new Date(fecha.seconds * 1000);

    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");

    return `${year}-${month}-${day}`;
  }

  // üî• String
  if (typeof fecha === "string") {
    fecha = fecha.trim();

    // DD/MM/YYYY
    if (fecha.includes("/")) {
      const [d, m, y] = fecha.split("/");
      return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
      return fecha;
    }
  }

  return "";
}

async function listarCortes() {
  tbody.innerHTML = "<tr><td colspan='4'>Buscando cortes...</td></tr>";

  const snap = await getDocs(collection(db, "cortes_globalesV4"));

  const cortes = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(c => {
      const okRuta =
        !rutaFiltro.value ||
        resolverRuta(c) === rutaFiltro.value.trim();

.filter(c => {
  const okRuta =
    !rutaFiltro.value ||
    resolverRuta(c) === rutaFiltro.value.trim();

  return okRuta;
})

    .sort((a, b) =>
      resolverFecha(b).localeCompare(resolverFecha(a))
    );

  if (!cortes.length) {
    tbody.innerHTML =
      "<tr><td colspan='4' style='text-align:center;'>Sin resultados</td></tr>";
    return;
  }

  tbody.innerHTML = "";
  cortes.forEach(c => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${resolverRuta(c) || "‚Äî"}</td>
      <td>${resolverUsuario(c)}</td>
      <td>${resolverFecha(c) || "‚Äî"}</td>
      <td><button>üßæ Reimprimir</button></td>
    `;
    fila.querySelector("button").onclick = () => reimprimirCorte(c);
    tbody.appendChild(fila);
  });
}

// =============================================
// üßæ BLOQUE 3 ‚Äî FUNCI√ìN DE REIMPRESI√ìN
// =============================================
async function reimprimirCorte(corteDoc) {
  overlay.style.display = "flex";

  if (!corteDoc.resumen) {
    overlay.style.display = "none";
    alert("‚ùå Este corte no tiene resumen guardado");
    return;
  }

  await generarPDF(corteDoc.resumen);
  overlay.style.display = "none";
}
// =============================================
// üß≠ BLOQUE 4 ‚Äî REUTILIZAR FUNCI√ìN generarPDF()
// =============================================

// ‚ö†Ô∏è Usa exactamente la misma funci√≥n generarPDF() que en tu m√≥dulo principal.
// Copia y pega aqu√≠ la funci√≥n generarPDF() (Bloque 6) y las auxiliares (Bloque 7).
// No necesitas modificar nada, porque 'resumen' tiene toda la estructura V4 completa.
// Ejemplo de c√≥mo invocarlo:

async function generarPDF(r) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ format: "letter", unit: "mm" });

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("CORTE DE RUTAS ‚Äì PROVEEDORA DE DULCES Y DESECHABLES", 10, 15);
  pdf.setFontSize(12);
  pdf.text(`Usuario: ${r.usuario}`, 15, 25);
  pdf.text(`Ruta: ${r.rutaId}`, 15, 32);
  pdf.text(`Fecha: ${r.fecha}`, 15, 39);
  pdf.text(`Total D√≠a: $${r.totalDia.toFixed(2)}`, 15, 46);
  pdf.text(`Descuento: $${r.totalDescuento.toFixed(2)}`, 15, 53);
  pdf.text(`Utilidad: $${r.utilidadTotal.toFixed(2)}`, 15, 60);
  pdf.text(`Margen Global: ${r.margenGlobal}%`, 15, 67);
  let y = 75;
  
if (r.porDepto && Object.keys(r.porDepto).length) {
  pdf.setFont("helvetica", "bold");
  pdf.text("VENTAS POR DEPARTAMENTO", 10, y);
  y += 6;

  pdf.setFont("helvetica", "normal");
  Object.entries(r.porDepto).forEach(([dep, d]) => {
    const margen = d.venta > 0
      ? ((d.utilidad / d.venta) * 100).toFixed(2)
      : "0.00";

    pdf.text(
      `${dep} | Venta: $${d.venta.toFixed(2)} | Utilidad: $${d.utilidad.toFixed(2)} | Margen: ${margen}%`,
      12,
      y
    );
    y += 5;
  });
}

  // ‚öôÔ∏è Puedes reusar aqu√≠ los gr√°ficos, top art√≠culos, mapa, etc.
  // Por brevedad no se repite todo el Bloque 6 aqu√≠, pero copia literalmente
  // la misma funci√≥n generarPDF completa del archivo principal.
  
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
}
</script>
</body>
</html>
