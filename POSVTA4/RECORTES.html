<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>REIMPRESIÃ“N DE CORTES â€“ PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #222;
    }
    h1 {
      color: #00416A;
      text-align: center;
      margin-bottom: 10px;
    }
    select, input {
      display: block;
      margin: 10px auto 15px auto;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }
    th { background: #00416A; color: white; }
    button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #0c6cbd;
      color: white;
      font-weight: 600;
    }
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-direction: column;
    }
    .spinner {
      width: 60px; height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid #0c6cbd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  </style>

  <!-- ðŸ§© LibrerÃ­as externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <h1>REIMPRESIÃ“N DE CORTES â€“ PROVSOFT</h1>
  <input type="date" id="fechaFiltro">
  <select id="rutaFiltro"><option value="">Selecciona una ruta...</option></select>

  <table>
    <thead>
      <tr><th>Ruta</th><th>Usuario</th><th>Fecha</th><th>AcciÃ³n</th></tr>
    </thead>
    <tbody id="tbodyCortes">
      <tr><td colspan="4" style="text-align:center;">Selecciona filtros para buscar cortes</td></tr>
    </tbody>
  </table>

  <div id="overlay"><div class="spinner"></div>Generando reimpresiÃ³n...</div>

<script type="module">
// =============================================
// ðŸš€ BLOQUE 1 â€” CONEXIÃ“N FIREBASE
// =============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// =============================================
// ðŸ“‹ BLOQUE 2 â€” CARGAR CORTES DESDE Firestore
// =============================================
const fechaFiltro = document.getElementById("fechaFiltro");
const rutaFiltro = document.getElementById("rutaFiltro");
const tbody = document.getElementById("tbodyCortes");
const overlay = document.getElementById("overlay");

  function resolverRuta(doc) {
  return (
    doc.rutaId ||
    doc.ruta ||
    doc.ruta_nombre ||
    ""
  ).toString().trim();
}
function resolverUsuario(doc) {
  return (
    doc.usuarioNombre ||
    doc.usuario ||
    doc.realizado_por ||
    doc.creado_por ||
    doc.resumen?.creado_por ||
    doc.encargado ||
    "â€”"
  ).toString().trim();
}

function resolverFecha(doc) {
  return normalizarFechaCorte(
    doc.fecha ||          // ðŸ”¥ Timestamp REAL
    doc.fecha_corte ||    // respaldo
    doc.fecha_txt ||
    ""
  );
}



// Cargar lista de rutas distintas
async function cargarRutas() {
  const snap = await getDocs(collection(db, "cortes_globalesV4"));
  const rutas = new Set();
  snap.forEach(d => {
  const ruta = resolverRuta(d.data());
  if (ruta) rutas.add(ruta);
});
  
  rutas.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    rutaFiltro.appendChild(opt);
  });
}
await cargarRutas();

fechaFiltro.addEventListener("change", listarCortes);
rutaFiltro.addEventListener("change", listarCortes);
// =============================================
// ðŸ§© NORMALIZAR FECHA DE CORTE (OPCIÃ“N A)
// =============================================
function normalizarFechaCorte(fecha) {
  if (!fecha) return "";

  // ðŸ”¥ Timestamp Firestore â†’ FECHA LOCAL
  if (typeof fecha === "object" && fecha.seconds) {
    const d = new Date(fecha.seconds * 1000);

    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");

    return `${year}-${month}-${day}`;
  }

  // ðŸ”¥ String
  if (typeof fecha === "string") {
    fecha = fecha.trim();

    // DD/MM/YYYY
    if (fecha.includes("/")) {
      const [d, m, y] = fecha.split("/");
      return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
      return fecha;
    }
  }

  return "";
}

async function listarCortes() {
  tbody.innerHTML = "<tr><td colspan='4'>Buscando cortes...</td></tr>";

  const snap = await getDocs(collection(db, "cortes_globalesV4"));

  const cortes = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(c => {
      const okRuta =
        !rutaFiltro.value ||
        resolverRuta(c) === rutaFiltro.value.trim();

      const okFecha =
        !fechaFiltro.value ||
        resolverFecha(c) === fechaFiltro.value;

      return okRuta && okFecha;
    })
    .sort((a, b) =>
      resolverFecha(b).localeCompare(resolverFecha(a))
    );

  if (!cortes.length) {
    tbody.innerHTML =
      "<tr><td colspan='4' style='text-align:center;'>Sin resultados</td></tr>";
    return;
  }

  tbody.innerHTML = "";
  cortes.forEach(c => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${resolverRuta(c) || "â€”"}</td>
      <td>${resolverUsuario(c)}</td>
      <td>${resolverFecha(c) || "â€”"}</td>
      <td><button>ðŸ§¾ Reimprimir</button></td>
    `;
    fila.querySelector("button").onclick = () => reimprimirCorte(c);
    tbody.appendChild(fila);
  });
}

// =============================================
// ðŸ§¾ BLOQUE 3 â€” FUNCIÃ“N DE REIMPRESIÃ“N
// =============================================
async function reimprimirCorte(corteDoc) {
  overlay.style.display = "flex";

  // ðŸ”¹ Caso 1: cortes antiguos (ya traen resumen)
  let resumen = corteDoc.resumen;

  // ðŸ”¹ Caso 2: cortes nuevos (armar resumen desde raÃ­z)
  if (!resumen) {
    if (!corteDoc.totales) {
      overlay.style.display = "none";
      alert("âš ï¸ Este corte no tiene datos suficientes para reimprimir.");
      return;
    }

const usuarioResumen = resolverUsuario(corteDoc);

resumen = {
  usuario: usuarioResumen,
  rutaId: resolverRuta(corteDoc),
  fecha: resolverFecha(corteDoc),
  totalDia: corteDoc.totales?.totalDia || 0,
  totalDescuento: corteDoc.totales?.totalDescuento || 0,
  utilidadTotal: corteDoc.totales?.utilidadTotal || 0,
  margenGlobal: corteDoc.totales?.utilidadPorcentaje || "0",
};
    
  }

  await generarPDF(resumen, corteDoc);
  overlay.style.display = "none";
}


// =============================================
// ðŸ§­ BLOQUE 4 â€” REUTILIZAR FUNCIÃ“N generarPDF()
// =============================================

// âš ï¸ Usa exactamente la misma funciÃ³n generarPDF() que en tu mÃ³dulo principal.
// Copia y pega aquÃ­ la funciÃ³n generarPDF() (Bloque 6) y las auxiliares (Bloque 7).
// No necesitas modificar nada, porque 'resumen' tiene toda la estructura V4 completa.
// Ejemplo de cÃ³mo invocarlo:

async function generarPDF(r, corte) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ format: "letter", unit: "mm" });

  let y = 15;

  // ==================================
  // ðŸ§¾ ENCABEZADO
  // ==================================
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("CORTE DE RUTA â€“ PROVEEDORA DE DULCES Y DESECHABLES", 105, y, { align: "center" });

  y += 10;
  pdf.setFontSize(11);
  pdf.text(`Usuario: ${r.usuario}`, 15, y);
  pdf.text(`Ruta: ${r.rutaId}`, 120, y);

  y += 6;
  pdf.text(`Fecha: ${r.fecha}`, 15, y);

  y += 10;

  // ==================================
  // ðŸ“Š RESUMEN GENERAL (TABLA)
  // ==================================
  pdf.setFont("helvetica", "bold");
  pdf.text("RESUMEN GENERAL", 15, y);
  y += 5;

  const resumen = [
    ["Total del DÃ­a", `$${r.totalDia.toFixed(2)}`],
    ["Total Descuento", `$${r.totalDescuento.toFixed(2)}`],
    ["Utilidad Total", `$${r.utilidadTotal.toFixed(2)}`],
    ["Margen Global", `${r.margenGlobal}%`]
  ];

  pdf.setFont("helvetica", "normal");

  resumen.forEach(([label, val]) => {
    pdf.rect(15, y, 80, 8);
    pdf.rect(95, y, 40, 8);
    pdf.text(label, 17, y + 5);
    pdf.text(val, 97, y + 5);
    y += 8;
  });

  y += 8;

  // ==================================
  // ðŸ·ï¸ VENTAS POR DEPARTAMENTO (TABLA)
  // ==================================
  if (corte.vista?.deptosOrdenados?.length) {
    pdf.setFont("helvetica", "bold");
    pdf.text("VENTAS POR DEPARTAMENTO", 15, y);
    y += 6;

    // Encabezados
    const headers = ["Departamento", "Venta", "Utilidad", "Margen %"];
    const colX = [15, 95, 125, 155];

    pdf.setFontSize(10);
    headers.forEach((h, i) => {
      pdf.rect(colX[i], y, i === 0 ? 80 : 30, 8);
      pdf.text(h, colX[i] + 2, y + 5);
    });

    y += 8;
    pdf.setFont("helvetica", "normal");

    corte.vista.deptosOrdenados.forEach(d => {
      const margen = d.venta > 0 ? ((d.utilidad / d.venta) * 100).toFixed(2) : "0.00";

      const row = [
        d.departamento,
        `$${d.venta.toFixed(2)}`,
        `$${d.utilidad.toFixed(2)}`,
        `${margen}%`
      ];

      row.forEach((val, i) => {
        pdf.rect(colX[i], y, i === 0 ? 80 : 30, 8);
        pdf.text(String(val), colX[i] + 2, y + 5);
      });

      y += 8;
      if (y > 260) {
        pdf.addPage();
        y = 20;
      }
    });

    y += 10;
  }

  // ==================================
  // ðŸ” TOP ARTÃCULOS MÃS VENDIDOS
  // ==================================
  if (corte.vista?.topArticulos?.length) {
    pdf.setFont("helvetica", "bold");
    pdf.text("TOP ARTÃCULOS MÃS VENDIDOS", 15, y);
    y += 6;

    const headers = ["ArtÃ­culo", "Cantidad", "Venta", "Margen %"];
    const colX = [15, 95, 120, 155];

    pdf.setFontSize(10);
    headers.forEach((h, i) => {
      pdf.rect(colX[i], y, i === 0 ? 80 : 25, 8);
      pdf.text(h, colX[i] + 2, y + 5);
    });

    y += 8;
    pdf.setFont("helvetica", "normal");

    corte.vista.topArticulos.slice(0, 10).forEach(a => {
      const margen = a.importe > 0 && a.utilidad
        ? ((a.utilidad / a.importe) * 100).toFixed(2)
        : "0.00";

      const row = [
        a.articulo,
        a.cantidad,
        `$${a.importe.toFixed(2)}`,
        `${margen}%`
      ];

      row.forEach((val, i) => {
        pdf.rect(colX[i], y, i === 0 ? 80 : 25, 8);
        pdf.text(String(val), colX[i] + 2, y + 5);
      });

      y += 8;
      if (y > 260) {
        pdf.addPage();
        y = 20;
      }
    });
  }

  // ==================================
  // ðŸ“„ MOSTRAR PDF
  // ==================================
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
}
</script>
</body>
</html>
