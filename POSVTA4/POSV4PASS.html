<!DOCTYPE html>
<html lang="es">
<head>
  <!-- üß± BLOQUE 1: CABECERA Y CONFIGURACI√ìN GLOBAL -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0c6cbd">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>POS ‚Äì Ruta de Venta con Descuento</title>

  <!-- üß© FUENTE PRINCIPAL -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- üß© ESTILOS GLOBALES -->
<style>
:root{
--azul:#00416A;--res:#0c6cbd;--ok:#1e8e3e;--card:rgba(255,255,255,.9);
--muted:rgba(0,0,0,.55);--shadow:0 6px 18px rgba(0,0,0,.18);--r:14px;--rs:10px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
height:100vh;
display:flex;
flex-direction:column;
font-family:'Poppins',sans-serif;
background:#00416A;
color:#111;
}

header{
position:sticky;top:0;z-index:50;background:rgba(0,0,0,.6);color:#fff;
padding:8px 10px;display:flex;justify-content:center;align-items:center;
gap:8px;font-weight:700;font-size:17px;height:48px;backdrop-filter:blur(4px);
}
header img{height:65px;object-fit:contain}

.main-content{flex:1;overflow-y:auto;padding:8px}

#carrito-container{
position:sticky;bottom:0;background:#fff;border-radius:14px 14px 0 0;
box-shadow:0 -2px 8px rgba(0,0,0,.25);max-height:42vh;overflow-y:auto;padding:10px;
}
.carrito-item{
display:flex;justify-content:space-between;border-bottom:1px solid #eee;
padding:5px 0;font-size:.88rem;
}
.carrito-item:last-child{border:none}

.field{
display:flex;gap:8px;background:rgba(255,255,255,.15);padding:8px;
border-radius:var(--rs);align-items:center;backdrop-filter:blur(2px);
}
.field label{min-width:70px;color:#fff;font-size:12px}
.field input{
flex:1;padding:10px;border:none;border-radius:8px;font-size:15px;outline:none;
}

.searchbox{position:relative;z-index:300}
.search-results{
position:absolute;left:90px;right:10px;top:calc(100% + 4px);background:#fff;
border-radius:12px;box-shadow:var(--shadow);max-height:240px;overflow:auto;
display:none;z-index:350;
}
.result-item{
padding:10px;cursor:pointer;display:flex;justify-content:space-between;gap:6px;
}
.result-item small{color:var(--muted)}
.result-item:hover{background:#f0f2f5}

.card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow)}
.table-wrap{max-height:230px;overflow:auto}
table{width:100%;border-collapse:collapse}
thead th{
background:var(--azul);color:#fff;padding:8px;font-size:12px;position:sticky;
top:0;z-index:80;text-align:center;
}
thead th:nth-child(1){width:55%;text-align:left}
thead th:nth-child(2){width:15%}
thead th:nth-child(3){width:20%}
thead th:nth-child(4){width:10%}
td{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
td.del-col{text-align:center}
td.del-col .del{
background:#e74c3c;color:#fff;border:none;border-radius:50%;
width:20px;height:20px;font-size:13px;cursor:pointer;
}
td.del-col .del:active{transform:scale(.92)}

.totals{display:flex;flex-direction:column;gap:5px;padding:10px;background:#fff}
.row{display:flex;justify-content:space-between;font-size:15px}
.row.muted{color:var(--muted)}
.row.big{font-weight:700;font-size:18px}

.btn{
width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;
font-weight:700;color:#fff;background:linear-gradient(180deg,var(--res),#094d85);
box-shadow:var(--shadow);cursor:pointer;
}
.btn:active{transform:translateY(1px)}

#loginScreen{
height:100vh;display:flex;flex-direction:column;align-items:center;
justify-content:center;background:#00416A;color:#fff;
}
#loginScreen input{padding:10px;border-radius:8px;margin:5px;border:none}
#loginMsg{color:#fbb;margin-top:8px}

.cam-btn{
position:absolute;right:10px;top:50%;transform:translateY(-50%);
background:#0c6cbd;color:#fff;border:none;padding:8px 10px;border-radius:10px;
font-size:15px;cursor:pointer;
}
.cam-btn:active{transform:translateY(-49%)}

#loginLogo{
width:110px;height:110px;margin-bottom:18px;animation:spinY 10s linear infinite;
}
@keyframes spinY{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}

@media print{
body *{visibility:hidden!important}
#ticketArea,#ticketArea *{visibility:visible!important}
#ticketArea{display:block!important;width:100%;background:#fff}
#ticket{
width:72mm!important;margin:0 auto!important;padding:0 2mm!important;
font-size:14px!important;line-height:1.45;
}
header,#loginScreen,.btn,#modalCobro,#qrReaderContainer{display:none!important}
}
@page{size:72mm auto;margin:0}

#pantallaVenta,#pantallaCarrito{transition:.25s}
#pantallaCarrito{margin-top:10px}
#btnRegresar{background:linear-gradient(180deg,#888,#666);color:#fff}
</style>

</head>

<body>
  <!-- üîë BLOQUE 2: LOGIN DE USUARIO -->
  <div id="loginScreen">
    <img id="loginLogo" src="logo_proveedora.webp" alt="Logo La Proveedora">
    <h2>Acceso Ruta de Venta</h2>
    <input id="loginUsuario" type="text" placeholder="Usuario"/>
    <input id="loginPassword" type="password" placeholder="Contrase√±a"/>
    <button id="btnLogin" class="btn">Entrar</button>
    
    <div id="loginMsg"></div>
  </div>

<!-- üì¶ BLOQUE 3: INTERFAZ PRINCIPAL DEL POS -->
<div id="posApp" style="display:none;">

  <!-- üß≠ ENCABEZADO FIJO SUPERIOR -->
<header>
  <span>POS ‚Äì Ruta de Venta / Descuento</span>
  <img src="logo_proveedora.webp" alt="Logo">


</header>
<!-- üß© CUERPO PRINCIPAL -->
<div class="main-content">

  <!-- üéØ BLOQUE 3.1 ‚Äî CONTROLES SUPERIORES -->
<section id="pantallaVenta" class="controls">

  <!-- üßç‚Äç‚ôÇÔ∏è CAMPO CLIENTE -->
  <div class="field">
    <label>Cliente</label>
    <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
    <datalist id="clientesList"></datalist>
  </div>

  <!-- üîç BUSCADOR DE PRODUCTOS CON C√ÅMARA -->
  <div class="field searchbox">
    <label>Buscar</label>
    <input id="buscador" type="text" placeholder="Escribe o escanea c√≥digo‚Ä¶">
    <button id="btnBuscarManual" class="cam-btn" type="button" style="right:60px;">üîç</button>
    <button id="btnCam" class="cam-btn" type="button">üì∑</button>
    <div id="resultados" class="search-results"></div>
  </div>

</section> <!-- üëà AQUI TERMINA LA PANTALLA DE VENTA -->


<!-- üß™ PANTALLA DE PRUEBAS DEL POS (CORRECTAMENTE FUERA DE VENTAS) -->
<section id="pantallaTest" style="
  display:none;
  padding:15px;
  background:#ffffff;
  border-radius:14px;
  margin:15px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
">

  <h2 style="text-align:center;color:#0c6cbd;margin-bottom:12px;">
    üîß Panel de Pruebas ‚Äì PROVSOFT POS
  </h2>

  <!-- üñ® PRUEBA DE IMPRESORA -->
  <button id="btnTestPrinter" class="btn" style="background:#0c6cbd;margin:6px 0;">
    üñ® Probar Impresora
  </button>

  <!-- üìç PRUEBA GPS -->
  <button id="btnTestGPS" class="btn" style="background:#f59e0b;margin:6px 0;">
    üìç Probar GPS
  </button>

  <!-- üìä CORTE DE RUTA -->
  <button id="btnCorteRuta" class="btn" style="background:#1e8e3e;margin:6px 0;">
    üìä Corte de Ruta
  </button>

  <!-- RESULTADOS -->
  <div id="testResult" style="
    margin-top:12px;
    padding:12px;
    font-size:14px;
    color:#333;
    text-align:center;
    background:#f3f4f6;
    border-radius:8px;
    display:block;
  "></div>

  <!-- üîÑ VOLVER A VENTAS -->
  <button id="btnVolverVenta" class="btn" style="margin-top:15px;background:#444;">
    ‚¨ÖÔ∏è Volver al POS
  </button>

</section>


<!-- üßæ BLOQUE NUEVO ‚Äî CARRITO FIJO -->
<div id="carrito-container">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cant.</th>
          <th>Importe</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- üî¢ TOTALES -->
<div class="totals">
  <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
  <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
  <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
</div>

<div class="actions">
  <button class="btn" id="btnCobrar">Cobrar</button>
</div>

<!-- üì± BARRA INFERIOR FIJA PARA BOTONES -->
<div id="bottomBar">
  <button id="btnVerCarrito" class="bar-btn"> Test Funcion </button>
  <button id="btnResumen" class="bar-btn azul">üìä Resumen</button>
  <button id="btnLogout" class="bar-btn rojo">üö™ Salir</button>
</div>
</div> <!-- üëà cierre de #posApp --> 
<!-- üì∏ LIBRER√çAS EXTERNAS -->

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="./html5-qrcode.min.js"></script> <!-- üëà Aseg√∫rate de que esta ruta sea correcta -->

<!-- üí≥ MODAL DE COBRO CON AUTORIZACI√ìN DE DESCUENTO -->
<div id="modalCobro"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
            z-index:1200;align-items:center;justify-content:center;">
  <div class="modal-card"
       style="width:min(420px,92vw);background:#fff;border-radius:14px;
              box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
    <div class="modal-h"
         style="padding:12px 16px;background:#0c6cbd;color:#fff;font-weight:700;">
      Cobro
    </div>
<div class="modal-b"
     style="padding:18px;display:flex;flex-direction:column;gap:14px;font-size:16px;">

  <!-- üí∞ Total -->
  <div class="row big" style="justify-content:space-between;font-size:22px;">
    <span>Total a pagar:</span>
    <span id="cobroTotal" 
          style="font-weight:700;color:#0c6cbd;font-size:24px;">$0.00</span>
  </div>

  <!-- üíµ Monto recibido -->
  <label for="montoRecibido" style="font-weight:600;">Monto recibido</label>
  <input id="montoRecibido" type="number" step="0.01" min="0" inputmode="decimal"
         placeholder="Ej. 7000.00"
         style="padding:16px 12px;border-radius:10px;border:1px solid #ccc;
                font-size:22px;text-align:center;font-weight:700;
                background:#f9f9f9;">

  <!-- üí∏ Cambio -->
  <div class="row big" 
       style="justify-content:space-between;align-items:center;
              padding:10px 0;border-top:2px dashed #ddd;
              border-bottom:2px dashed #ddd;">
    <span style="font-size:22px;font-weight:700;color:#111;">Cambio:</span>
    <span id="montoCambio"
          style="font-size:26px;font-weight:800;color:#1e8e3e;">$0.00</span>
  </div>

  <!-- üóíÔ∏è Notas -->
  <label for="notasCobro" style="font-weight:600;">Notas (opcional)</label>
  <textarea id="notasCobro" rows="2" style="resize:none;padding:10px;
            border-radius:10px;border:1px solid #ccc;font-size:15px;"></textarea>

  <!-- üßæ Descuento aplicado -->
  <div id="descuentoInfo"
       style="font-size:15px;color:#00416A;font-weight:600;
              text-align:right;display:none;">
    Descuento aplicado: <span id="descuentoResumen">$0.00</span>
  </div>

  <!-- üîò Botones principales -->
  <div style="display:flex;gap:10px;justify-content:space-between;margin-top:10px;">
    <button class="btn" id="btnSolicitarDescuento"
            style="flex:1;background:linear-gradient(180deg,#888,#666);
                   font-size:16px;">üßæ Descuento</button>
    <button class="btn" id="btnCancelarCobro" 
            style="flex:1;background:#aaa;font-size:16px;">Cancelar</button>
  <button class="btn" id="btnConfirmarCobro" type="button"
        style="flex:1;background:linear-gradient(180deg,#0c6cbd,#094d85);
              font-size:16px;">Confirmar</button>
  </div>
  <!-- FIN DE BOTONES -->
  </div> <!-- cierre de .modal-b -->

</div> <!-- cierre de .modal-card -->

</div> <!-- cierre de #modalCobro -->
<!-- üî• Firebase Core + Firestore -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<!-- M√ìDULOS PROVSOFT POS -->
<script defer src="./js/pos-core.js"></script>
<script defer src="./js/pos-busqueda.js"></script>
<script defer src="./js/pos-firebase.js"></script>
<script defer src="./js/pos-ticket.js"></script>
<script defer src="./js/pos-qr.js"></script>
<script defer src="./js/pos-offline.js"></script>
<script defer src="./js/pos-modals.js"></script>
<script defer src="./js/pos-test.js"></script>

</body>
</html>
