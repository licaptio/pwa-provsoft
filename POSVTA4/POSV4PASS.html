<!DOCTYPE html>
<html lang="es">
<head>
  <!-- üß± BLOQUE 1: CABECERA Y CONFIGURACI√ìN GLOBAL -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0c6cbd">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>POS ‚Äì Ruta de Venta con Descuento</title>

  <!-- üß© FUENTE PRINCIPAL -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- üß© ESTILOS GLOBALES -->
  <style>
    /* üé® VARIABLES GENERALES */
    :root {
      --azul:#00416A;--resalte:#0c6cbd;--ok:#1e8e3e;
      --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card:rgba(255,255,255,.9);--muted:rgba(0,0,0,.55);
      --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px;--radius-sm:10px;
    }

    /* üß© RESETEO Y ESTILO BASE */
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0; font-family:'Poppins',system-ui,Arial;
      color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased;
      -webkit-tap-highlight-color:transparent;
    }

    /* üß≠ ENCABEZADO PRINCIPAL */
    header {
      position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.6); color:#fff;
      padding:10px 14px;
      display:flex; justify-content:center; align-items:center; gap:8px;
      font-weight:700; font-size:18px;
      backdrop-filter:saturate(120%) blur(4px);
      height:50px;
    }
    header img { height:75px; object-fit:contain; }

    /* üß© CONTENEDORES GENERALES */
    .wrap { flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto; }
    .controls { display:flex; flex-direction:column; gap:10px; }

    /* üß± CAMPOS DE FORMULARIO */
    .field {
      display:flex; gap:8px; background:rgba(255,255,255,.12);
      padding:10px; border-radius:var(--radius-sm);
      align-items:center; backdrop-filter:blur(2px);
    }
    .field label { min-width:78px; color:#fff; font-size:13px; }
    .field input {
      flex:1; padding:10px 12px; border:none;
      border-radius:8px; font-size:15px;
      background:#fff; outline:none;
    }

    /* üîç RESULTADOS DE B√öSQUEDA */
    .searchbox { position:relative; z-index:300; }
    .search-results {
      position:absolute; left:90px; right:10px; top:calc(100% + 6px);
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      max-height:260px; overflow:auto; display:none; z-index:310;
    }
    .result-item { padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px; }
    .result-item small { color:var(--muted); }
    .result-item:hover { background:#f2f4f7; }

    /* üßæ TABLAS Y TOTALES */
    .card { background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .table-wrap { max-height:260px; overflow:auto; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th {
      background:var(--azul); color:#fff;
      padding:10px; font-size:13px; position:sticky; top:0; z-index:100;
    }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col { text-align:center; }
    td.del-col .del {
      background:#e74c3c; color:#fff; border:none; border-radius:50%;
      width:22px; height:22px; font-size:14px; line-height:20px; cursor:pointer;
    }
    td.del-col .del:hover { background:#c0392b; }

    /* üßæ TOTALES */
    .totals { display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row { display:flex; justify-content:space-between; align-items:center; font-size:15px; }
    .row.muted { color:var(--muted); }
    .row.big { font-weight:700; font-size:18px; }

    /* üîò BOTONES GENERALES */
    .btn {
      width:100%; border:none; padding:14px; border-radius:12px;
      font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85);
      box-shadow:var(--shadow); cursor:pointer;
    }
    .btn:active { transform:translateY(1px); }

    /* üîê PANTALLA DE LOGIN */
    #loginScreen {
      height:100vh; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:#00416A; color:#fff;
    }
    #loginScreen input { padding:10px; border-radius:8px; margin:5px; border:none; }
    #loginMsg { color:#fbb; border-radius:8px; margin-top:8px; }

    /* üì∑ BOT√ìN DE C√ÅMARA */
    .cam-btn {
      position:absolute; right:14px; top:50%; transform:translateY(-50%);
      border:none; padding:8px 10px; border-radius:10px; cursor:pointer;
      background:#0c6cbd; color:#fff; font-size:16px;
    }
    .cam-btn:active { transform:translateY(-49%); }

    /* üåÄ ANIMACI√ìN LOGO LOGIN */
    #loginLogo {
      width:120px; height:120px; margin-bottom:20px;
      animation:spinY 10s linear infinite; transform-style:preserve-3d;
    }
    @keyframes spinY { from{transform:rotateY(0deg);} to{transform:rotateY(360deg);} }

    /* üßæ IMPRESI√ìN PARA TICKET T√âRMICO */
    @media print {
      body * { visibility:hidden!important; }
      #ticketArea, #ticketArea * { visibility:visible!important; }
      #ticketArea {
        display:block!important; position:relative!important;
        margin:0 auto!important; padding:0; width:100%; background:#fff;
      }
      #ticket {
        width:72mm!important; margin:0 auto!important; padding:0 2mm!important;
        font-size:14px!important; line-height:1.45; color:#000;
        transform:none!important; page-break-inside:avoid!important;
      }
      header, .btn, .actions, #loginScreen, #modalCobro, #qrReaderContainer { display:none!important; }
    }
    @page { size:72mm auto; margin:0; }
#pantallaVenta, #pantallaCarrito {
  transition: all 0.3s ease-in-out;
}
#pantallaCarrito {
  margin-top: 10px;
}
#btnRegresar {
  background: linear-gradient(180deg, #888, #666);
  color: #fff;
}

  </style>
</head>

<body>
  <!-- üîë BLOQUE 2: LOGIN DE USUARIO -->
  <div id="loginScreen">
    <img id="loginLogo" src="logo_proveedora.webp" alt="Logo La Proveedora">
    <h2>Acceso Ruta de Venta</h2>
    <input id="loginUsuario" type="text" placeholder="Usuario"/>
    <input id="loginPassword" type="password" placeholder="Contrase√±a"/>
    <button id="btnLogin" class="btn">Entrar</button>
    <div id="loginMsg"></div>
  </div>

<!-- üì¶ BLOQUE 3: INTERFAZ PRINCIPAL DEL POS -->
<div id="posApp" style="display:none;">

  <!-- üß≠ ENCABEZADO FIJO SUPERIOR -->
<header>
  <span>POS ‚Äì Ruta de Venta / Descuento</span>
  <img src="logo_proveedora.webp" alt="Logo">


</header>

  <!-- üß© CUERPO PRINCIPAL -->
  <!-- üéØ BLOQUE 3.1 ‚Äî CONTROLES SUPERIORES -->
<section id="pantallaVenta" class="controls">
  <!-- üßç‚Äç‚ôÇÔ∏è CAMPO CLIENTE -->
  <div class="field">
    <label>Cliente</label>
    <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
    <datalist id="clientesList"></datalist>
  </div>

  <!-- üîç BUSCADOR DE PRODUCTOS CON C√ÅMARA -->
  <div class="field searchbox">
    <label>Buscar</label>
    <input id="buscador" type="text" placeholder="Escribe o escanea c√≥digo‚Ä¶">
    <button id="btnCam" class="cam-btn" type="button">üì∑</button>
    <div id="resultados" class="search-results"></div>
  </div>

</section>

<!-- üßæ BLOQUE NUEVO ‚Äî CARRITO OCULTO -->
<section id="pantallaCarrito" class="card" style="display:none;">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cant.</th>
          <th>Importe</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="totals">
    <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
    <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
    <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
  </div>

  <div class="actions">
    <button class="btn" id="btnCobrar">Cobrar</button>
    <button class="btn" id="btnRegresar" style="background:#aaa;">üîô Regresar</button>
  </div>
</section>
<!-- üì± BARRA INFERIOR FIJA PARA BOTONES -->
<div id="bottomBar">
  <button id="btnVerCarrito" class="bar-btn">üõí Ver Carrito</button>
  <button id="btnResumen" class="bar-btn azul">üìä Resumen</button>
  <button id="btnLogout" class="bar-btn rojo">üö™ Salir</button>
</div>
</div> <!-- üëà cierre de #posApp --> 
<!-- üì∏ LIBRER√çAS EXTERNAS -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>


<!-- üí≥ MODAL DE COBRO CON AUTORIZACI√ìN DE DESCUENTO -->
<div id="modalCobro"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
            z-index:1200;align-items:center;justify-content:center;">
  <div class="modal-card"
       style="width:min(420px,92vw);background:#fff;border-radius:14px;
              box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
    <div class="modal-h"
         style="padding:12px 16px;background:#0c6cbd;color:#fff;font-weight:700;">
      Cobro
    </div>
<div class="modal-b"
     style="padding:18px;display:flex;flex-direction:column;gap:14px;font-size:16px;">

  <!-- üí∞ Total -->
  <div class="row big" style="justify-content:space-between;font-size:22px;">
    <span>Total a pagar:</span>
    <span id="cobroTotal" 
          style="font-weight:700;color:#0c6cbd;font-size:24px;">$0.00</span>
  </div>

  <!-- üíµ Monto recibido -->
  <label for="montoRecibido" style="font-weight:600;">Monto recibido</label>
  <input id="montoRecibido" type="number" step="0.01" min="0" inputmode="decimal"
         placeholder="Ej. 7000.00"
         style="padding:16px 12px;border-radius:10px;border:1px solid #ccc;
                font-size:22px;text-align:center;font-weight:700;
                background:#f9f9f9;">

  <!-- üí∏ Cambio -->
  <div class="row big" 
       style="justify-content:space-between;align-items:center;
              padding:10px 0;border-top:2px dashed #ddd;
              border-bottom:2px dashed #ddd;">
    <span style="font-size:22px;font-weight:700;color:#111;">Cambio:</span>
    <span id="montoCambio"
          style="font-size:26px;font-weight:800;color:#1e8e3e;">$0.00</span>
  </div>

  <!-- üóíÔ∏è Notas -->
  <label for="notasCobro" style="font-weight:600;">Notas (opcional)</label>
  <textarea id="notasCobro" rows="2" style="resize:none;padding:10px;
            border-radius:10px;border:1px solid #ccc;font-size:15px;"></textarea>

  <!-- üßæ Descuento aplicado -->
  <div id="descuentoInfo"
       style="font-size:15px;color:#00416A;font-weight:600;
              text-align:right;display:none;">
    Descuento aplicado: <span id="descuentoResumen">$0.00</span>
  </div>

  <!-- üîò Botones principales -->
  <div style="display:flex;gap:10px;justify-content:space-between;margin-top:10px;">
    <button class="btn" id="btnSolicitarDescuento"
            style="flex:1;background:linear-gradient(180deg,#888,#666);
                   font-size:16px;">üßæ Descuento</button>
    <button class="btn" id="btnCancelarCobro" 
            style="flex:1;background:#aaa;font-size:16px;">Cancelar</button>
    <button class="btn" id="btnConfirmarCobro" 
            style="flex:1;background:linear-gradient(180deg,#0c6cbd,#094d85);
                   font-size:16px;">Confirmar</button>
  </div>
</div>
  </div>
</div>

<script type="text/javascript">
"use strict";

// ‚ö†Ô∏è Cargar m√≥dulos Firebase con import din√°mico (compatible m√≥viles)
(async () => {
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
  const { 
    getFirestore, collection, addDoc, setDoc, serverTimestamp,
    runTransaction, doc, getDocs, query, where, limit 
  } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const { enableIndexedDbPersistence } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const { obtenerUbicacionRobusta } = await import("./geoHelper.js");

// ‚öôÔ∏è BLOQUE 5: SCRIPT PRINCIPAL (FIREBASE + L√ìGICA POS)

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
enableIndexedDbPersistence(db).catch(err => console.warn("‚ö†Ô∏è Persistence off:", err));

/* ===========================================================
   üîß SECCI√ìN 2: VARIABLES GLOBALES
   =========================================================== */
const $ = s => document.querySelector(s);
let carrito = [];
let catalogo = [];
let departamentos = {};
let rutaId = null;
let USUARIO_LOGUEADO = null;
let clienteSeleccionado = null;
const money = n => '$' + (Number(n) || 0).toFixed(2);
const codeIndex = new Map();

/* ===========================================================
   üí∏ SECCI√ìN 3: PRODUCTOS DE MAYOREO (CIGARROS)
   =========================================================== */
const productosMayoreo = [
  "08339412","08346917","75001315","75001322","75001476","75016777",
  "75021597","75031053","75035259","75046521","75046781","75052836",
  "75056308","75059514","75063801","75064648","75066345","75068738",
  "75068745","75068776","75068783","75068844","75069902","75071295",
  "75071776","75080495"
];

// üßÆ Funci√≥n que selecciona precio seg√∫n cantidad
function obtenerPrecioSegunCantidad(prod, cantidad) {
  if (!productosMayoreo.includes(String(prod.codigo))) {
    return Number(prod.precioPublico || 0);
  }
  if (cantidad >= 5 && prod.mayoreo) {
    console.log("üí∏ Mayoreo aplicado:", prod.nombre);
    return Number(prod.mayoreo);
  }
  return Number(prod.precioPublico || 0);
}

/* ===========================================================
   üîë SECCI√ìN 4: LOGIN Y CARGA INICIAL (OPTIMIZADO)
   =========================================================== */
async function loginUsuario() {
  const u = $("#loginUsuario").value.trim();
  const p = $("#loginPassword").value.trim();
  const msg = $("#loginMsg");

  // üî∏ Validaci√≥n b√°sica
  if (!u || !p) {
    msg.textContent = "Por favor, introduce usuario y contrase√±a.";
    return;
  }

  // üé¨ Animaci√≥n visual de progreso
  msg.textContent = "üîÑ Verificando usuario...";
  msg.style.background = "rgba(255,255,255,.15)";
  msg.style.padding = "6px 10px";
  msg.style.borderRadius = "6px";
  msg.style.transition = "all 0.3s ease";

  try {
    const q = query(
      collection(db, "usuarios_ruta"),
      where("usuario", "==", u),
      where("password", "==", p),
      where("activo", "==", true)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      msg.textContent = "‚ùå Usuario o contrase√±a incorrectos";
      msg.style.background = "rgba(255,50,50,.3)";
      return;
    }

    const data = snap.docs[0].data();
    USUARIO_LOGUEADO = { id: snap.docs[0].id, ...data };
    rutaId = data.rutaId || null;

    // üßπ Limpia cache de cat√°logo al cambiar usuario
    localStorage.removeItem("catalogo_cache");

    // üíæ Guarda sesi√≥n para acceso r√°pido
    localStorage.setItem("usuario_ruta", JSON.stringify(USUARIO_LOGUEADO));

    // üü¢ Mostrar transici√≥n visual
    msg.textContent = "‚úÖ Bienvenido " + (data.nombre || u);
    msg.style.background = "rgba(0,150,80,.4)";

    // üåÄ Cargar datos principales
    $("#loginScreen").style.display = "none";
    $("#posApp").style.display = "block";

    // Carga simult√°nea
    await Promise.all([
      cargarCatalogo(),
      cargarDepartamentos(),
      fijarClientePublico()
    ]);

    console.log("‚úÖ Sesi√≥n iniciada:", USUARIO_LOGUEADO);
    msg.textContent = "";

  } catch (e) {
    console.error("‚ùå Error en login:", e);
    msg.textContent = "‚ö†Ô∏è Error de conexi√≥n con el servidor.";
    msg.style.background = "rgba(255,150,0,.3)";
  }
}

$("#btnLogin").onclick = loginUsuario;
/* ===========================================================
   üîÅ SECCI√ìN 4.1: RECUPERAR SESI√ìN AUTOM√ÅTICA
   =========================================================== */
window.addEventListener("DOMContentLoaded", async () => {
  const guardado = localStorage.getItem("usuario_ruta");
  if (!guardado) return;

  try {
    USUARIO_LOGUEADO = JSON.parse(guardado);
    rutaId = USUARIO_LOGUEADO?.rutaId || null;
    console.log("üîê Sesi√≥n restaurada:", USUARIO_LOGUEADO.nombre || USUARIO_LOGUEADO.usuario);

    $("#loginScreen").style.display = "none";
    $("#posApp").style.display = "block";

    await Promise.all([
      cargarCatalogo(),
      cargarDepartamentos(),
      fijarClientePublico()
    ]);
  } catch (err) {
    console.warn("‚ö†Ô∏è No se pudo restaurar sesi√≥n previa:", err);
    localStorage.removeItem("usuario_ruta");
  }
});

/* ===========================================================
   üßæ SECCI√ìN 5: CARGA DE CAT√ÅLOGO Y DEPARTAMENTOS (OPTIMIZADO)
   =========================================================== */

async function cargarCatalogo() {
  const cacheKey = "catalogo_cache";
  const cache = JSON.parse(localStorage.getItem(cacheKey) || "{}");
  const unDia = 24 * 60 * 60 * 1000;
  const statusBox = document.createElement("div");

  // üü¶ Muestra un mensaje flotante mientras carga
  statusBox.textContent = "üîÑ Cargando cat√°logo de productos...";
  statusBox.style.cssText = `
    position:fixed;top:10px;left:50%;transform:translateX(-50%);
    background:#00416A;color:#fff;padding:10px 16px;
    border-radius:10px;z-index:5000;font-size:14px;
    box-shadow:0 2px 6px rgba(0,0,0,.2);
  `;
  document.body.appendChild(statusBox);

  try {
    // ‚ö° Si hay cache v√°lido de menos de 24 h
    if (cache.fecha && (Date.now() - cache.fecha < unDia) && Array.isArray(cache.data)) {
      catalogo = cache.data;
      codeIndex.clear();

      catalogo.forEach(p => {
        if (p.codigo) codeIndex.set(p.codigo, p.id);
        if (Array.isArray(p.equivalentes)) {
          p.equivalentes.forEach(eq => { if (eq) codeIndex.set(eq, p.id); });
        }
      });

      console.log("‚ö° Cat√°logo cargado desde cache:", catalogo.length);
      statusBox.textContent = `‚ö° Cat√°logo cargado (${catalogo.length} productos, desde cache)`;
      setTimeout(() => statusBox.remove(), 2000);
      return;
    }

    // üîÑ Cargar desde Firestore si no hay cache o est√° vencido
    const ref = collection(db, "productos");
    const q = query(ref, where("activo", "==", true));
    const snap = await getDocs(q);
    catalogo = [];
    codeIndex.clear();

    snap.forEach(d => {
      const x = d.data();
      const p = {
        id: d.id,
        nombre: x.concepto || "SIN NOMBRE",
        codigo: String(x.codigoBarra || ""),
        precioPublico: Number(x.precioPublico || 0),
        mayoreo: Number(x.mayoreo || 0),
        costoUnit: Number(x.costoSinImpuesto || x.costo || 0),
        ivaTasa: Number(x.ivaTasa || 0),
        iepsTasa: Number(x.iepsTasa || 0),
        departamento_id: x.departamento_id || null,
        equivalentes: Array.isArray(x.codigosEquivalentes)
          ? x.codigosEquivalentes.map(String)
          : []
      };
      catalogo.push(p);
      if (p.codigo) codeIndex.set(p.codigo, p.id);
      if (Array.isArray(p.equivalentes)) {
        p.equivalentes.forEach(eq => { if (eq) codeIndex.set(eq, p.id); });
      }
    });

    // üíæ Guardar cache local por 24 h
    localStorage.setItem(cacheKey, JSON.stringify({
      fecha: Date.now(),
      data: catalogo
    }));

    console.log("üì¶ Cat√°logo cargado desde Firestore:", catalogo.length);
    statusBox.textContent = `üì¶ Cat√°logo cargado (${catalogo.length} productos, guardado en cache)`;
    setTimeout(() => statusBox.remove(), 2500);

  } catch (err) {
    console.error("‚ùå Error cargando cat√°logo:", err);
    statusBox.textContent = "‚ö†Ô∏è Error al cargar cat√°logo. Intenta recargar o verifica conexi√≥n.";
    statusBox.style.background = "#c0392b";
  }
}

/* ===========================================================
   üè∑Ô∏è CARGA DE DEPARTAMENTOS (CON CONTROL DE ERRORES)
   =========================================================== */
async function cargarDepartamentos() {
  const statusBox = document.createElement("div");
  statusBox.textContent = "üîÑ Cargando departamentos...";
  statusBox.style.cssText = `
    position:fixed;top:50px;left:50%;transform:translateX(-50%);
    background:#0c6cbd;color:#fff;padding:8px 14px;
    border-radius:10px;z-index:5000;font-size:13px;
    box-shadow:0 2px 6px rgba(0,0,0,.2);
  `;
  document.body.appendChild(statusBox);

  try {
    const snap = await getDocs(collection(db, "departamentos_venta"));
    departamentos = {};

    snap.forEach(d => {
      const x = d.data();
      departamentos[d.id] = {
        id: Number(x.id || d.id),
        nombre: x.nombre || "SIN DEP",
        iva: Number(x.iva || 0),
        ieps: Number(x.ieps || 0)
      };
    });

    console.log("üè∑Ô∏è Departamentos cargados:", Object.keys(departamentos).length);
    statusBox.textContent = `üè∑Ô∏è ${Object.keys(departamentos).length} departamentos cargados`;
    setTimeout(() => statusBox.remove(), 1500);

  } catch (err) {
    console.error("‚ùå Error cargando departamentos:", err);
    statusBox.textContent = "‚ö†Ô∏è Error al cargar departamentos";
    statusBox.style.background = "#c0392b";
  }
}


/* ===========================================================
   üîç SECCI√ìN 6: B√öSQUEDA LOCAL DE PRODUCTOS
   =========================================================== */
function buscarLocal(qraw) {
  const q = (qraw || "").trim().toLowerCase();
  if (!q) return [];

  // 1Ô∏è‚É£ Etiquetas de b√°scula (7 d√≠gitos + peso)
  if (/^2\d{12,}$/.test(q)) {
    const codigoBase = q.substring(0, 7);
    const pesoStr = q.substring(7, 12);
    const peso = parseFloat(pesoStr) / 1000;
    const idMatch = Array.from(codeIndex.entries()).find(([cod]) =>
      cod.startsWith(codigoBase)
    );
    if (idMatch) {
      const p = catalogo.find(x => x.id === idMatch[1]);
      if (p) {
        $("#cantidadInput").value = peso.toFixed(3);
        return [p];
      }
    }
  }

  // 2Ô∏è‚É£ Coincidencia exacta
  const idByCode = codeIndex.get(q);
  if (idByCode) {
    const p = catalogo.find(x => x.id === idByCode);
    if (p) return [p];
  }

  // 3Ô∏è‚É£ Coincidencia parcial por equivalentes
  const matchEq = catalogo.find(p => {
    if (!Array.isArray(p.equivalentes)) return false;
    return p.equivalentes.some(eq => eq && q.startsWith(eq.toLowerCase()));
  });
  if (matchEq) return [matchEq];

  // 4Ô∏è‚É£ Coincidencia por nombre
  return catalogo.filter(p => (p.nombre || "").toLowerCase().includes(q));
}

/* ===========================================================
   üßÆ SECCI√ìN 7: CARRITO DE COMPRAS
   =========================================================== */
function addProduct(prod, cant = 1) {
  if (!prod) return;
  const existente = carrito.find(x => x.id === prod.id);
  const cantidadNueva = existente ? existente.cantidad + cant : cant;
  const precioUnit = obtenerPrecioSegunCantidad(prod, cantidadNueva);

  if (existente) {
  existente.cantidad = cantidadNueva;
  existente.precioUnit = precioUnit;
  existente.importe = existente.cantidad * precioUnit;
} else {
  carrito.push({...prod,cantidad:cant,precioUnit,importe:cant*precioUnit});
}
renderDebounced(); // üëà Nueva versi√≥n optimizada
}
function delItem(id){ carrito=carrito.filter(x=>x.id!==id); renderDebounced(); }
window.delItem=delItem;

/* ===========================================================
   üßÆ SECCI√ìN 8: C√ÅLCULO DE TOTALES CON DESCUENTO (OPTIMIZADO)
   =========================================================== */
function calcularTotales(descPorc = 0) {
  let subtotal = 0, iva = 0, ieps = 0, total = 0;
  let subtotalElegible = 0, subtotalNoElegible = 0;

  // üí∞ Asegura que el porcentaje de descuento sea v√°lido (0‚Äì100)
  const descuento = Math.min(100, Math.max(0, descPorc || 0)) / 100;

  // üî¢ Recorre todos los productos del carrito
  carrito.forEach(it => {
    const imp = it.cantidad * it.precioUnit;
    const dep = departamentos[it.departamento_id] || { iva: 0, ieps: 0 };

    const ivaT = dep.iva / 100;
    const iepsT = dep.ieps / 100;
    let base = imp;

    // Descompone el precio si ya incluye IVA o IEPS
    if (iepsT > 0 && ivaT > 0) base = imp / (1 + iepsT + ivaT * (1 + iepsT));
    else if (iepsT > 0) base = imp / (1 + iepsT);
    else if (ivaT > 0) base = imp / (1 + ivaT);

    subtotal += base;
    iva += base * ivaT;
    ieps += base * iepsT;
    total += imp;

    // Clasifica productos elegibles o no para descuento
    if (productosMayoreo.includes(String(it.codigo))) subtotalNoElegible += base;
    else subtotalElegible += base;
  });

  // üßÆ C√°lculo seguro de descuentos (sin dividir por cero)
  const montoDesc = subtotalElegible * descuento;
  const proporci√≥n = subtotal > 0 ? montoDesc / subtotal : 0;

  // üí∏ Totales finales
  const subtotalFinal = subtotal - montoDesc;
  const ivaFinal = iva - (iva * proporci√≥n);
  const iepsFinal = ieps - (ieps * proporci√≥n);
  const totalFinal = subtotalFinal + ivaFinal + iepsFinal;

  return {
    subtotal: +subtotal.toFixed(2),
    descuento: +montoDesc.toFixed(2),
    impuestos: +(ivaFinal + iepsFinal).toFixed(2),
    total: +totalFinal.toFixed(2)
  };
}


  /* ===========================================================
   üñ•Ô∏è SECCI√ìN 9: RENDER Y ACTUALIZACI√ìN VISUAL DEL CARRITO
   =========================================================== */
function render(){
  const tbody=$("#tbody"); tbody.innerHTML="";
  carrito.forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${it.nombre}</td>
      <td style="text-align:center">${it.cantidad.toFixed(2)}</td>
      <td style="text-align:right">${money(it.importe)}</td>
      <td class='del-col'><button class='del' onclick="delItem('${it.id}')">√ó</button></td>`;
    tbody.appendChild(tr);
  });
  const desc=Number(localStorage.getItem("desc_porcentaje")||0);
  const {subtotal,descuento,impuestos,total}=calcularTotales(desc);
  $("#lblSubtotal").textContent=money(subtotal);
  $("#lblImpuestos").textContent=money(impuestos);
  $("#lblTotal").textContent=money(total);
}
/* ===========================================================
   ‚öôÔ∏è SECCI√ìN 9.1: RENDER OPTIMIZADO CON DEBOUNCE
   =========================================================== */
let renderTimer;

function renderDebounced() {
  clearTimeout(renderTimer);      // Cancelar render pendiente
  renderTimer = setTimeout(render, 100); // Esperar 100 ms antes de ejecutar
}

/* ===========================================================
   ‚å®Ô∏è SECCI√ìN 10: FLUJO DE ENTRADA (BUSCADOR + CANTIDAD)
   =========================================================== */
window.addProduct = addProduct;
window.render = render;
let productoTemporal = null;

function seleccionarProducto(prod) {
  productoTemporal = null; // ya no se usa el input cantidad
  solicitarCantidadYAgregar(prod);

  // üßπ Limpieza visual y cierre de sugerencias
  resultadosDiv.style.display = "none";
  buscador.value = "";
  buscador.focus();
}

// üì± Modal con teclado num√©rico en m√≥viles + beep al abrir
function solicitarCantidadYAgregar(prod) {
  const modal = document.getElementById("modalCantidad");
  const input = document.getElementById("inputCantidadModal");
  const btnAceptar = document.getElementById("btnAceptarCant");
  const btnCancelar = document.getElementById("btnCancelarCant");

  // üéµ Beep al solicitar cantidad
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = "sine"; osc.frequency.value = 950;
    osc.start(); gain.gain.setValueAtTime(0.15, ctx.currentTime);
    osc.stop(ctx.currentTime + 0.15);
  } catch (err) { console.warn("No se pudo reproducir beep:", err); }

  modal.style.display = "flex";
  input.value = "1";
  input.focus();

  function cerrar() {
    modal.style.display = "none";
    btnAceptar.removeEventListener("click", confirmar);
    btnCancelar.removeEventListener("click", cancelar);
  }

  function confirmar() {
    const cantidad = parseFloat(input.value.replace(",", "."));
    if (isNaN(cantidad) || cantidad <= 0) {
      alert("Introduce una cantidad v√°lida (solo n√∫meros).");
      return;
    }
    addProduct(prod, cantidad);
    $("#buscador").value = "";
    $("#buscador").focus();
    cerrar();
  }

  function cancelar() {
    cerrar();
    $("#buscador").focus();
  }

  btnAceptar.addEventListener("click", confirmar);
  btnCancelar.addEventListener("click", cancelar);

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") confirmar();
  });
}
/* ===========================================================
   üîé B√öSQUEDA POR C√ìDIGO, PALABRA Y ESC√ÅNER (MEJORADA)
   =========================================================== */
const buscador = document.getElementById("buscador");
const resultadosDiv = document.getElementById("resultados");

// üéµ Beep reutilizable
function beep(freq = 800, duration = 0.1) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = "sine"; osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    osc.start(); osc.stop(ctx.currentTime + duration);
  } catch (err) {}
}

// üîç Funci√≥n central que ejecuta la b√∫squeda y muestra resultados
function ejecutarBusqueda(texto) {
  const resultados = buscarLocal(texto);
  resultadosDiv.innerHTML = "";

  if (resultados.length === 1) {
    beep(950);
    seleccionarProducto(resultados[0]);
    resultadosDiv.style.display = "none";
  } else if (resultados.length > 1) {
    resultados.forEach(p => {
      const item = document.createElement("div");
      item.className = "result-item";

      // Resalta coincidencias (p. ej. CONVERMEX ‚Üí <strong>CONVERMEX</strong>)
      const regex = new RegExp(texto, "ig");
      const nombreResaltado = p.nombre.replace(regex, m => `<strong style="color:#0c6cbd">${m}</strong>`);

      item.innerHTML = `<span>${nombreResaltado}</span><small>${money(p.precioPublico)}</small>`;
      item.addEventListener("click", () => {
        beep(950);
        seleccionarProducto(p);
        resultadosDiv.style.display = "none";
      });
      resultadosDiv.appendChild(item);
    });
    resultadosDiv.style.display = "block";
    beep(700);
  } else {
    resultadosDiv.innerHTML = "<div style='padding:10px;color:#999;'>Sin coincidencias</div>";
    resultadosDiv.style.display = "block";
    beep(500);
  }
}

// üöÄ B√∫squeda directa con Enter (esc√°ner o c√≥digo)
buscador.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const texto = buscador.value.trim();
    if (texto) ejecutarBusqueda(texto);
  }
});

// ‚úçÔ∏è B√∫squeda en vivo por nombre (al escribir)
buscador.addEventListener("input", () => {
  const texto = buscador.value.trim();
  if (texto.length >= 3) {  // desde 3 letras
    ejecutarBusqueda(texto);
  } else {
    resultadosDiv.style.display = "none";
  }
});

/* ===========================================================
   üí≥ SECCI√ìN 11: MODAL DE COBRO CON AUTORIZACI√ìN DE DESCUENTO
   =========================================================== */
const modalCobro = $("#modalCobro");
const cobroTotal = $("#cobroTotal");
const montoRecibido = $("#montoRecibido");
const montoCambio = $("#montoCambio");
const descuentoInfo = $("#descuentoInfo");
const descuentoResumen = $("#descuentoResumen");

let descuentoAutorizado = 0;

function abrirCobro() {
  if (carrito.length === 0) {
    alert("Agrega productos antes de cobrar.");
    return;
  }

  const tot = calcularTotales(0);
  cobroTotal.textContent = money(tot.total);
  montoRecibido.value = "";
  montoCambio.textContent = "$0.00";
  descuentoInfo.style.display = "none";
  descuentoAutorizado = 0;

  modalCobro.style.display = "flex";
  $("#montoRecibido").focus();
}

function cerrarCobro() {
  modalCobro.style.display = "none";
  descuentoAutorizado = 0;
}

$("#btnCobrar").onclick = abrirCobro;
$("#btnCancelarCobro").onclick = cerrarCobro;

// üíµ Calcular cambio autom√°ticamente
montoRecibido.addEventListener("input", () => {
  const valRec = parseFloat(montoRecibido.value) || 0;
  const tot = calcularTotales(descuentoAutorizado);
  const cambio = valRec - tot.total;
  montoCambio.textContent = money(cambio > 0 ? cambio : 0);
});

// üîê Aplicar descuento con contrase√±a ‚Äú‚Äù
// üîê Aplicar descuento con contrase√±a ‚ÄúMADERO690*‚Äù
$("#btnSolicitarDescuento").addEventListener("click", async () => {
  const porcStr = prompt("Introduce el descuento (%)");
  const porc = parseFloat(porcStr);
  if (isNaN(porc) || porc <= 0 || porc > 100) {
    alert("Porcentaje inv√°lido."); return;
  }

  const pass = prompt("Introduce la contrase√±a de autorizaci√≥n");
  const CLAVE_DESCUENTO = "MADERO690*";

  if (pass !== CLAVE_DESCUENTO) {
    alert("‚ùå Contrase√±a incorrecta. No se aplic√≥ el descuento.");
    return;
  }

  // ‚úÖ Descuento autorizado
  descuentoAutorizado = porc;
  const tot = calcularTotales(porc);

  // üîÅ Actualiza visualmente total y resumen
  cobroTotal.textContent = money(tot.total);
  descuentoResumen.textContent = money(tot.descuento);
  descuentoInfo.style.display = "block";

  // üíµ Si ya hay monto recibido, recalcula el cambio con el nuevo total
  const pago = parseFloat(montoRecibido.value) || 0;
  if (pago > 0) {
    const cambio = pago - tot.total;
    montoCambio.textContent = money(cambio > 0 ? cambio : 0);
  } else {
    // si no hay pago todav√≠a, simplemente resetea el cambio
    montoCambio.textContent = "$0.00";
  }

  alert(`‚úÖ Descuento del ${porc}% aplicado correctamente.`);
});

// ‚úÖ Confirmar y guardar venta con o sin descuento
$("#btnConfirmarCobro").onclick = async () => {
  // üöß VALIDACIONES PREVIAS A LA VENTA
  if (carrito.length === 0) {
    alert("No hay productos en el carrito.");
    return;
  }
  if (!rutaId || !USUARIO_LOGUEADO) {
    alert("‚ö†Ô∏è Usuario o ruta no detectados. Vuelve a iniciar sesi√≥n.");
    return;
  }
const tot = calcularTotales(descuentoAutorizado);
const pago = parseFloat($("#montoRecibido").value) || 0;
const cambio = pago - tot.total;
if (cambio < 0) {
  alert("‚ö†Ô∏è El monto recibido es menor al total a pagar.");
  return;
}

const folio = "VENTA-" + Date.now();

// üßæ Venta con detalle contable completo
const venta = {
  folio,
  rutaId,
  cliente: $("#cliente").value || "P√öBLICO EN GENERAL",
  cortado: false,
  descuento_porcentaje: descuentoAutorizado,
  descuento_monto: tot.descuento,
  resumen_financiero: {
    subtotal: tot.subtotal,
    descuento: tot.descuento,
    impuestos: tot.impuestos,
    total: tot.total,
    // üîπ C√°lculo adicional para reportes contables
    costo_total: carrito.reduce((s, x) => s + (x.costoUnit || 0) * x.cantidad, 0).toFixed(2),
    utilidad_total: carrito.reduce((s, x) => s + ((x.importe || 0) - (x.costoUnit || 0) * x.cantidad), 0).toFixed(2),
    margen_porcentaje: (() => {
      const utilidad = carrito.reduce((s, x) => s + ((x.importe || 0) - (x.costoUnit || 0) * x.cantidad), 0);
      return tot.total > 0 ? ((utilidad / tot.total) * 100).toFixed(2) : 0;
    })()
  },
  fecha: serverTimestamp(),
  fecha_txt: new Date().toLocaleString("es-MX", { hour12: true }),
  usuarioId: USUARIO_LOGUEADO?.id || "",
  usuarioNombre: USUARIO_LOGUEADO?.nombre || "",
  notas: $("#notasCobro").value || "",
  autorizado_por: descuentoAutorizado > 0 ? "Gerente autorizado" : null,
  ubicacion: await obtenerUbicacionRobusta().catch(() => null),

  // üíº DETALLE COMPLETO DE CADA PRODUCTO
  detalle: carrito.map(it => {
    const depId = it.departamento_id?.toString() || "0";
    const depInfo = departamentos[depId] || { nombre: "SIN DEP", iva: 0, ieps: 0 };

    const costoUnit = Number(it.costoUnit || 0);
    const costoTotal = it.cantidad * costoUnit;
    const utilidad = it.importe - costoTotal;

    return {
      id: it.id,
      nombre: it.nombre,
      codigo: it.codigo,
      cantidad: it.cantidad,
      precio_unit: it.precioUnit,
      importe: it.importe,
      costo_unit: +costoUnit.toFixed(2),
      costo_total: +costoTotal.toFixed(2),
      utilidad: +utilidad.toFixed(2),
      departamento_id: depId,
      departamento_info: depInfo
    };
  })
};


  await guardarVentaEnFirestore(venta);
  enviarTelegram(venta);
  rellenarTicket(venta);
  imprimirTicketEstilado();
  carrito = [];
  render();
  cerrarCobro();
};
async function guardarVentaEnFirestore(v) {
  try {
const ref = collection(db, "ventas_rutav2");
await addDoc(ref, v);
    console.log("‚úÖ Venta guardada:", v.folio);
  } catch (e) {
    console.error("‚ùå Error guardando venta:", e);
  }
}

/* ===========================================================
   üì≤ SECCI√ìN 13: ENV√çO A TELEGRAM (ROBUSTO CON FALLBACK)
   =========================================================== */
async function enviarTelegram(v) {
  try {
    const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
    const CHAT_ID = "6617988297";
    const formatoNum = n => (Number(n || 0)).toLocaleString("es-MX", {
      minimumFractionDigits: 2, maximumFractionDigits: 2
    });

    // üì¶ Datos base
    const folio = v.folio;
    const total = formatoNum(v.resumen_financiero?.total);
    const subtotal = formatoNum(v.resumen_financiero?.subtotal);
    const desc = formatoNum(v.descuento_monto || 0);
    const imp = formatoNum(v.resumen_financiero?.impuestos || 0);
    const pago = formatoNum(v.recibido || v.resumen_financiero?.total || 0);
    const cambio = formatoNum(v.cambio || 0);
    const articulos = (v.detalle || []).reduce((a, b) => a + Number(b.cantidad || 0), 0);
    const cajero = v.usuarioNombre || "‚Äî";
    const cliente = v.cliente || "P√öBLICO EN GENERAL";
    const descPorc = v.descuento_porcentaje || 0;

    // üßæ Construir texto t√©rmico para Telegram (id√©ntico a impresi√≥n)
    let ticket = `
PROVEEDORA MATRIZ
MADERO 690 SUR, CENTRO
LINARES, NUEVO LE√ìN, 67700
RFC: PDD-031204-KL5
TEL: (821) 212-1805
R√âGIMEN GENERAL DE LEY
PERSONAS MORALES
--------------------------------
# Venta : ${folio}
Fecha   : ${v.fecha_txt}
Cliente : ${cliente}
--------------------------------
`;

    (v.detalle || []).forEach(it => {
      const nombre = (it.nombre || "").substring(0, 32);
      const cant = it.cantidad.toFixed(3).padStart(5, " ");
      const prec = it.precio_unit.toFixed(2).padStart(8, " ");
      const imp = it.importe.toFixed(2).padStart(9, " ");
      ticket += `${nombre}\n`;
      ticket += `Cant:${cant}  ${prec}  ${imp}\n`;
    });

    ticket += `--------------------------------
Subtotal : $${subtotal}
Desc. ${descPorc}% : $${desc}
Impuestos: $${imp}
Total    : $${total}
Su Pago  : $${pago}
Cambio   : $${cambio}
--------------------------------
Art√≠culos vendidos: ${articulos}
Incluye ${imp} de Impuestos
Cajero: ${cajero}
--------------------------------
¬°Gracias por su compra!
`;

    // ‚úâÔ∏è Enviar texto del ticket
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: CHAT_ID,
        text: "```" + ticket + "```",
        parse_mode: "Markdown"
      })
    });

    // üßæ Generar PDF opcional (para respaldo)
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFont("courier", "bold");
    pdf.setFontSize(11);
    let y = 10;
    ticket.split("\n").forEach(linea => {
      pdf.text(linea, 10, y);
      y += 5;
      if (y > 280) { pdf.addPage(); y = 10; }
    });
    const pdfBlob = pdf.output("blob");

    // üìé Enviar PDF como respaldo (no obligatorio)
    const formData = new FormData();
    formData.append("chat_id", CHAT_ID);
    formData.append("document", pdfBlob, `Ticket_${folio}.pdf`);
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, {
      method: "POST",
      body: formData
    });

    console.log("‚úÖ Ticket enviado a Telegram:", folio);
  } catch (err) {
    console.error("‚ùå Error enviando a Telegram:", err);
    alert("‚ö†Ô∏è No se pudo enviar el ticket a Telegram.");
  }
}

/* ===========================================================
   üì¶ SECCI√ìN 13.1: MODO OFFLINE ‚Äì COLA DE ENV√çO TELEGRAM
   =========================================================== */

/**
 * Guarda una venta pendiente de enviar a Telegram.
 */
function guardarVentaPendiente(v) {
  try {
    const pendientes = JSON.parse(localStorage.getItem("ventas_pendientes_telegram") || "[]");
    pendientes.push(v);
    localStorage.setItem("ventas_pendientes_telegram", JSON.stringify(pendientes));
    console.warn("üì¶ Venta guardada en cola offline:", v.folio);
  } catch (err) {
    console.error("‚ùå Error guardando venta pendiente:", err);
  }
}

/**
 * Intenta reenviar todas las ventas pendientes cuando hay conexi√≥n.
 */
async function reenviarVentasPendientes() {
  const pendientes = JSON.parse(localStorage.getItem("ventas_pendientes_telegram") || "[]");
  if (pendientes.length === 0) return;

  console.log(`üì® Intentando reenviar ${pendientes.length} ventas pendientes...`);

  for (const v of pendientes) {
    try {
      await enviarTelegram(v);
      console.log("‚úÖ Venta reenviada:", v.folio);
    } catch (err) {
      console.error("‚ö†Ô∏è Fallo al reenviar:", v.folio, err);
      // Si vuelve a fallar, no la eliminamos a√∫n
      return;
    }
  }

  // Si todo sali√≥ bien, limpiamos la cola
  localStorage.removeItem("ventas_pendientes_telegram");
  console.log("üßπ Cola de ventas pendiente vaciada.");
}

/**
 * Detecta cuando vuelve la conexi√≥n y reintenta los env√≠os.
 */
window.addEventListener("online", () => {
  toast("‚úÖ Conexi√≥n restaurada. Reenviando ventas pendientes...", "#1e8e3e");
  setTimeout(reenviarVentasPendientes, 1000);
});

/* ===========================================================
   üßæ SECCI√ìN 14: TICKET VISUAL E IMPRESI√ìN
   =========================================================== */
function rellenarTicket(v){
  const t=v.resumen_financiero;
  const pago=parseFloat($("#montoRecibido").value)||0;
  const cambio=pago - t.total;
  $("#tFolio").textContent=v.folio;
  $("#tFecha").textContent=v.fecha_txt;
  $("#tCliente").textContent=v.cliente||"P√öBLICO EN GENERAL";
  $("#tSubtotal").textContent=money(t.subtotal);
  $("#tDescPorc").textContent=v.descuento_porcentaje+"%";
  $("#tDescMonto").textContent=money(v.descuento_monto);
  $("#tTotal").textContent=money(t.total);
  $("#tPago").textContent=money(pago);
  $("#tCambio").textContent=money(cambio>0?cambio:0);
  $("#tImpuestos").textContent=money(t.impuestos);
  $("#tArticulos").textContent=carrito.reduce((a,b)=>a+b.cantidad,0);
  $("#tCajero").textContent=USUARIO_LOGUEADO?.nombre || "‚Äî";

  const tbody=document.getElementById("tLineas");
  tbody.innerHTML="";
  v.detalle.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.nombre}</td>
      <td style="text-align:center">${p.cantidad.toFixed(2)}</td>
      <td style="text-align:right">${p.precioUnit.toFixed(2)}</td>
      <td style="text-align:right">${(p.cantidad*p.precioUnit).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

function imprimirTicketEstilado() {
  try {
    // üßÆ Funci√≥n auxiliar para formatear n√∫meros
    const formatoNum = n => (Number(n || 0)).toLocaleString("es-MX", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

    // üì¶ Obtener datos de la venta actual
    const folio = $("#tFolio").textContent.trim();
    const fecha = $("#tFecha").textContent.trim();
    const cliente = $("#tCliente").textContent.trim();
    const subtotal = $("#tSubtotal").textContent.trim();
    const descPorc = $("#tDescPorc").textContent.trim();
    const descMonto = $("#tDescMonto").textContent.trim();
    const total = $("#tTotal").textContent.trim();
    const pago = $("#tPago").textContent.trim();
    const cambio = $("#tCambio").textContent.trim();
    const impuestos = $("#tImpuestos").textContent.trim();
    const articulos = $("#tArticulos").textContent.trim();
    const cajero = $("#tCajero").textContent.trim();

    // üßæ Construir texto del ticket en formato t√©rmico
    let ticket = `
PROVEEDORA MATRIZ
MADERO 690 SUR, CENTRO
LINARES, NUEVO LE√ìN, 67700
RFC: PDD-031204-KL5
TEL: (821) 212-1805
R√âGIMEN GENERAL DE LEY
PERSONAS MORALES
--------------------------------
# Venta : ${folio}
Fecha   : ${fecha}
Cliente : ${cliente}
--------------------------------
`;

    // üìã Detalle de productos
    const filas = document.querySelectorAll("#tLineas tr");
    filas.forEach(f => {
      const cols = f.querySelectorAll("td");
      if (cols.length >= 4) {
        const nombre = (cols[0].textContent || "").substring(0, 32);
        const cant = (cols[1].textContent || "").padStart(5, " ");
        const prec = (cols[2].textContent || "").padStart(8, " ");
        const imp = (cols[3].textContent || "").padStart(9, " ");
        ticket += `${nombre}\n`;
        ticket += `Cant:${cant}  ${prec}  ${imp}\n`;
      }
    });

    // üíµ Totales
    ticket += `--------------------------------
Subtotal: ${subtotal}
Desc. ${descPorc}: ${descMonto}
Total: ${total}
Su Pago: ${pago}
Cambio: ${cambio}
--------------------------------
Art√≠culos vendidos: ${articulos}
Incluye ${impuestos} de Impuestos
Cajero: ${cajero}
--------------------------------
¬°Gracias por su compra!
`;

    // üñ®Ô∏è Prioridad 1: InnerPrinter
    if (window.InnerPrinter) {
      try {
        if (typeof window.InnerPrinter.printText === "function") {
          window.InnerPrinter.printText(ticket);
          return;
        }
        if (typeof window.InnerPrinter.printHtml === "function") {
          window.InnerPrinter.printHtml(`<pre>${ticket}</pre>`);
          return;
        }
      } catch (err) {
        console.error("‚ùå Error con InnerPrinter:", err);
      }
    }

    // üñ®Ô∏è Prioridad 2: RawBT (Android)
    if (/Android/i.test(navigator.userAgent)) {
      try {
        const encoded = encodeURIComponent(ticket);
        window.location.href = `rawbt:print?data=${encoded}`;
        return;
      } catch (err) {
        console.error("‚ùå Error con RawBT:", err);
      }
    }

    // üñ®Ô∏è Prioridad 3: Impresi√≥n navegador (fallback)
    const w = window.open("", "_blank");
    w.document.write(`<pre style="font-family:monospace;font-size:13px;">${ticket}</pre>`);
    w.document.close();
    w.print();

  } catch (err) {
    console.error("‚ùå Error generando ticket:", err);
    alert("Error al generar ticket t√©rmico.");
  }
}

/* ===========================================================
   üôã‚Äç‚ôÇÔ∏è SECCI√ìN 15: CLIENTE P√öBLICO AUTOM√ÅTICO
   =========================================================== */
async function fijarClientePublico(){
  try{
    const q=query(collection(db,"clientes"),where("nombre","==","PUBLICO EN GENERAL"));
    const snap=await getDocs(q);
    if(!snap.empty){
      const c=snap.docs[0].data();
      clienteSeleccionado={id:snap.docs[0].id,nombre:c.nombre};
      const el=$("#cliente");
      el.value=c.nombre; el.readOnly=true;
      el.style.background="#e5e7eb"; el.style.color="#555";
    }
  }catch(e){console.warn("Cliente p√∫blico no encontrado");}
}
// üëá AGREGA ESTO AL FINAL
/* ===========================================================
   üåê SECCI√ìN 16: CONTROL DE CONEXI√ìN OFFLINE / ONLINE
   =========================================================== */
window.addEventListener("offline", () => {
  const aviso = document.createElement("div");
  aviso.textContent = "‚ö†Ô∏è Est√°s sin conexi√≥n. Las ventas se guardar√°n localmente.";
aviso.style.cssText = `
  position:fixed;top:0;left:0;right:0;
  background:#c0392b;color:#fff;padding:8px;text-align:center;
  font-size:13px;z-index:9999;transition:opacity .3s ease;
`;
  document.body.appendChild(aviso);
  setTimeout(()=>aviso.style.opacity=1,50);
  setTimeout(()=>{aviso.style.opacity=0;setTimeout(()=>aviso.remove(),400)},4000);

  console.warn("üö´ Sin conexi√≥n: las operaciones se almacenar√°n en IndexedDB");
});

window.addEventListener("online", () => {
  const aviso = document.createElement("div");
  aviso.textContent = "‚úÖ Conexi√≥n restaurada. Sincronizando ventas pendientes...";
  aviso.style.cssText = `
    position:fixed;bottom:15px;left:50%;transform:translateX(-50%);
    background:#1e8e3e;color:#fff;padding:10px 18px;
    border-radius:10px;font-size:14px;z-index:9999;
    box-shadow:0 2px 8px rgba(0,0,0,.3);opacity:0;
    transition:opacity .3s ease;
  `;
  document.body.appendChild(aviso);
  setTimeout(()=>aviso.style.opacity=1,50);
  setTimeout(()=>{aviso.style.opacity=0;setTimeout(()=>aviso.remove(),400)},4000);

  console.log("‚úÖ Conexi√≥n restaurada, Firestore volver√° a sincronizar autom√°ticamente.");
});

})(); // ‚úÖ cierre del async

</script>

<!-- üßæ BLOQUE 6: PLANTILLA DEL TICKET DE VENTA -->
<div id="ticketArea" style="display:none;">
  <div id="ticket" class="ticket" style="font-family:monospace;width:72mm;">
    <div style="text-align:center;margin-bottom:4px;">
      <div style="font-weight:bold;font-size:16px;">PROVEEDORA MATRIZ</div>
      <div style="font-size:13px;">MADERO 690 SUR, CENTRO</div>
      <div style="font-size:13px;">LINARES, NUEVO LEON, 67700</div>
      <div style="font-size:13px;">RFC: PDD-031204-KL5</div>
      <div style="font-size:13px;">TEL: (821) 212-1805</div>
      <div style="font-size:13px;">R√âGIMEN GENERAL DE LEY</div>
      <div style="font-size:13px;">PERSONAS MORALES</div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <div style="font-size:13px;">
      <div># Venta: <span id="tFolio"></span></div>
      <div>Fecha: <span id="tFecha"></span></div>
      <div>Cliente: <span id="tCliente">P√öBLICO EN GENERAL</span></div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <!-- üìã Tabla del ticket -->
    <table style="width:100%;font-size:13px;">
      <thead>
        <tr>
          <th style="text-align:left;">Descripci√≥n</th>
          <th style="text-align:center;">Cant</th>
          <th style="text-align:right;">P.Unit</th>
          <th style="text-align:right;">Importe</th>
        </tr>
      </thead>
      <tbody id="tLineas"></tbody>
    </table>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <!-- üíµ Totales -->
    <div style="font-size:13px;text-align:right;">
      <div>Subtotal: <span id="tSubtotal">$0.00</span></div>
      <div>Descuento <span id="tDescPorc">0%</span>: <span id="tDescMonto">$0.00</span></div>
      <div>Total: <span id="tTotal">$0.00</span></div>
      <div>Su Pago: <span id="tPago">$0.00</span></div>
      <div>Cambio: <span id="tCambio">$0.00</span></div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <!-- üßæ Informaci√≥n adicional -->
    <div style="font-size:13px;">
      <div>Art√≠culos vendidos: <span id="tArticulos">0</span></div>
      <div>Incluye <span id="tImpuestos">$0.00</span> de Impuestos</div>
      <div>Cajero: <span id="tCajero">‚Äî</span></div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">
    <div style="text-align:center;font-size:13px;">¬°Gracias por su compra!</div>
  </div>
</div>

<!-- üì∑ BLOQUE 7: LECTOR DE C√ìDIGO QR -->
<div id="qrReaderContainer"
     style="display:none;flex-direction:column;align-items:center;justify-content:center;
            position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:3000;">
  <div id="reader"
       style="width:90%;max-width:360px;margin:auto;background:#fff;border-radius:12px;padding:8px;">
  </div>
  <button id="cerrarCam" class="btn" style="margin-top:12px;background:#c0392b;">Cerrar c√°mara</button>
</div>

<!-- üîπ BLOQUE 8: SERVICE WORKER Y LOGOUT -->
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js")
  .then(r=>console.log("‚úÖ Service Worker registrado:",r.scope))
  .catch(e=>console.error("‚ùå Error registrando SW:",e));
}

document.addEventListener("DOMContentLoaded",()=>{
  const b=document.getElementById("btnLogout");
  if(b){
    b.addEventListener("click",()=>{
      localStorage.removeItem("usuario_ruta");
      localStorage.removeItem("catalogo_cache");
      localStorage.removeItem("catalogo_fecha");
      document.getElementById("posApp").style.display="none";
      document.getElementById("loginScreen").style.display="flex";
      document.getElementById("loginUsuario").value="";
      document.getElementById("loginPassword").value="";
      document.getElementById("loginMsg").textContent="";
      alert("Sesi√≥n cerrada correctamente.");
    });
  }
});
  // üìä Acceso r√°pido al Resumen Diario
const btnResumen = document.getElementById("btnResumen");
if (btnResumen) {
  btnResumen.addEventListener("click", () => {
    window.location.href = "resumen.html";
  });
}

</script>

<!-- üì∑ BLOQUE 9: CONTROL DE ESC√ÅNER QR -->
<script>
window.addEventListener("load",()=>{
  const btnCam=document.getElementById("btnCam");
  const camDiv=document.getElementById("qrReaderContainer");
  const cerrarCam=document.getElementById("cerrarCam");
  let html5QrCode=null;

  btnCam.addEventListener("click",()=>{
    camDiv.style.display="flex";
    const readerDiv=document.getElementById("reader");
    if(!readerDiv){ alert("No se encontr√≥ el contenedor del lector (#reader)"); return; }

    html5QrCode=new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode:"environment" },
      { fps:10, qrbox:250 },
      (decodedText)=>{
        console.log("üì¶ C√≥digo detectado:",decodedText);
        const buscador=document.getElementById("buscador");
        buscador.value=decodedText;
        camDiv.style.display="none";
        html5QrCode.stop().then(()=>{
          const enterEvent=new KeyboardEvent("keydown",{key:"Enter"});
          buscador.dispatchEvent(enterEvent);
        });
      },
      (errorMessage)=>console.log("‚ö†Ô∏è",errorMessage)
    ).catch(err=>{
      alert("No se pudo abrir la c√°mara: "+err);
      camDiv.style.display="none";
    });
  });

  cerrarCam.addEventListener("click",()=>{
    if(html5QrCode) html5QrCode.stop().then(()=>camDiv.style.display="none");
    else camDiv.style.display="none";
  });
});
</script>

<!-- üõ°Ô∏è BLOQUE 10: BLOQUEO DE SALIDA Y REFRESCO ACCIDENTAL -->
<script>
let bloqueoSalida=true;

// üö´ Bloquear F5 y Ctrl+R
window.addEventListener("keydown",e=>{
  if(e.key==="F5" || (e.ctrlKey && e.key.toLowerCase()==="r")){
    e.preventDefault();
    alert("Usa el bot√≥n üö™ Salir para cerrar sesi√≥n correctamente.");
  }
});

// ‚ö†Ô∏è Confirmar antes de salir o recargar
window.addEventListener("beforeunload",e=>{
  if(bloqueoSalida){
    e.preventDefault();
    e.returnValue="¬øDeseas salir del sistema?";
    return "¬øDeseas salir del sistema?";
  }
});

// ‚úÖ Al cerrar sesi√≥n, desbloquear salida
document.getElementById("btnLogout").addEventListener("click",()=>{
  bloqueoSalida=false;
});
// üéõÔ∏è Alternar entre Pantalla de Venta y Pantalla de Carrito
const pantallaVenta = document.getElementById("pantallaVenta");
const pantallaCarrito = document.getElementById("pantallaCarrito");
const btnVerCarrito = document.getElementById("btnVerCarrito");
const btnRegresar = document.getElementById("btnRegresar");

btnVerCarrito.addEventListener("click", () => {
  pantallaVenta.style.display = "none";
  pantallaCarrito.style.display = "block";
  renderDebounced(); // Versi√≥n optimizada
});


btnRegresar.addEventListener("click", () => {
  pantallaCarrito.style.display = "none";
  pantallaVenta.style.display = "flex";
  document.getElementById("buscador").focus();
});

</script>
<!-- üî¢ MODAL CANTIDAD PERSONALIZADO -->
<div id="modalCantidad" 
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
            z-index:4000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;width:80%;max-width:320px;
              text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.2);">
    <h3 style="margin-bottom:10px;color:#00416A;">Cantidad</h3>
    <input id="inputCantidadModal" type="number" inputmode="decimal" min="0" step="0.01"
           style="width:100%;padding:10px;font-size:18px;border-radius:8px;border:1px solid #ccc;text-align:center;">
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button id="btnCancelarCant" class="btn" style="background:#aaa;">Cancelar</button>
      <button id="btnAceptarCant" class="btn">Aceptar</button>
    </div>
  </div>
</div>

<style>
  /* üéØ Barra inferior fija profesional */
  #bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(90deg, #003366, #0c6cbd);
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
    box-shadow: 0 -3px 10px rgba(0,0,0,0.25);
    z-index: 9999;
  }
  .bar-btn {
    flex: 1;
    margin: 0 6px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    color: white;
    background: linear-gradient(180deg, #0c6cbd, #00416A);
    font-size: 16px;
    padding: 10px 8px;
    transition: transform .15s ease, opacity .15s ease;
  }
  .bar-btn:active { transform: scale(0.95); opacity: 0.85; }
  .bar-btn.azul { background: linear-gradient(180deg, #0c6cbd, #00416A); }
  .bar-btn.rojo { background: linear-gradient(180deg, #c0392b, #8e2620); }
  #btnVerCarrito { background: linear-gradient(180deg, #00416A, #0c6cbd); }
  
  /* üì± Adaptaci√≥n a m√≥vil */
  @media (max-width: 600px) {
    #bottomBar { padding: 8px 0; }
    .bar-btn { font-size: 14px; padding: 8px 4px; }
  }
 /* üö´ Ocultar barra inferior cuando el POS est√© oculto */
  #posApp[style*="display: none"] #bottomBar {
    display: none !important;
  }

</style>

</body>
</html>

