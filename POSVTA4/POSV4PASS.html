<!DOCTYPE html>
<html lang="es">
<head>
  <!-- üß± BLOQUE 1: CABECERA Y CONFIGURACI√ìN GLOBAL -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0c6cbd">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>POS ‚Äì Ruta de Venta con Descuento</title>

  <!-- üß© FUENTE PRINCIPAL -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- üß© ESTILOS GLOBALES -->
<style>
:root{
--azul:#00416A;--res:#0c6cbd;--ok:#1e8e3e;--card:rgba(255,255,255,.9);
--muted:rgba(0,0,0,.55);--shadow:0 6px 18px rgba(0,0,0,.18);--r:14px;--rs:10px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
height:100vh;display:flex;flex-direction:column;font-family:'Poppins',sans-serif;
background:linear-gradient(to bottom right,#00416A,#E4E5E6);color:#111;
}
header{
position:sticky;top:0;z-index:50;background:rgba(0,0,0,.6);color:#fff;
padding:8px 10px;display:flex;justify-content:center;align-items:center;
gap:8px;font-weight:700;font-size:17px;height:48px;backdrop-filter:blur(4px);
}
header img{height:65px;object-fit:contain}

.main-content{flex:1;overflow-y:auto;padding:8px}

#carrito-container{
position:sticky;bottom:0;background:#fff;border-radius:14px 14px 0 0;
box-shadow:0 -2px 8px rgba(0,0,0,.25);max-height:42vh;overflow-y:auto;padding:10px;
}
.carrito-item{
display:flex;justify-content:space-between;border-bottom:1px solid #eee;
padding:5px 0;font-size:.88rem;
}
.carrito-item:last-child{border:none}

.field{
display:flex;gap:8px;background:rgba(255,255,255,.15);padding:8px;
border-radius:var(--rs);align-items:center;backdrop-filter:blur(2px);
}
.field label{min-width:70px;color:#fff;font-size:12px}
.field input{
flex:1;padding:10px;border:none;border-radius:8px;font-size:15px;outline:none;
}

.searchbox{position:relative;z-index:300}
.search-results{
position:absolute;left:90px;right:10px;top:calc(100% + 4px);background:#fff;
border-radius:12px;box-shadow:var(--shadow);max-height:240px;overflow:auto;
display:none;z-index:350;
}
.result-item{
padding:10px;cursor:pointer;display:flex;justify-content:space-between;gap:6px;
}
.result-item small{color:var(--muted)}
.result-item:hover{background:#f0f2f5}

.card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow)}
.table-wrap{max-height:230px;overflow:auto}
table{width:100%;border-collapse:collapse}
thead th{
background:var(--azul);color:#fff;padding:8px;font-size:12px;position:sticky;
top:0;z-index:80;text-align:center;
}
thead th:nth-child(1){width:55%;text-align:left}
thead th:nth-child(2){width:15%}
thead th:nth-child(3){width:20%}
thead th:nth-child(4){width:10%}
td{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
/* Limitar ancho del nombre en el carrito para evitar que empuje columnas */
#tbody td:first-child {
  max-width: 90px;   /* Ajusta seg√∫n el celular */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

td.del-col{text-align:center}
td.del-col .del{
background:#e74c3c;color:#fff;border:none;border-radius:50%;
width:20px;height:20px;font-size:13px;cursor:pointer;
}
td.del-col .del:active{transform:scale(.92)}

.totals{display:flex;flex-direction:column;gap:5px;padding:10px;background:#fff}
.row{display:flex;justify-content:space-between;font-size:15px}
.row.muted{color:var(--muted)}
.row.big{font-weight:700;font-size:18px}

.btn{
width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;
font-weight:700;color:#fff;background:linear-gradient(180deg,var(--res),#094d85);
box-shadow:var(--shadow);cursor:pointer;
}
.btn:active{transform:translateY(1px)}

#loginScreen{
height:100vh;display:flex;flex-direction:column;align-items:center;
justify-content:center;background:#00416A;color:#fff;
}
#loginScreen input{padding:10px;border-radius:8px;margin:5px;border:none}
#loginMsg{color:#fbb;margin-top:8px}

.cam-btn{
position:absolute;right:10px;top:50%;transform:translateY(-50%);
background:#0c6cbd;color:#fff;border:none;padding:8px 10px;border-radius:10px;
font-size:15px;cursor:pointer;
}
.cam-btn:active{transform:translateY(-49%)}

#loginLogo{
width:110px;height:110px;margin-bottom:18px;animation:spinY 10s linear infinite;
}
@keyframes spinY{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}

@media print{
body *{visibility:hidden!important}
#ticketArea,#ticketArea *{visibility:visible!important}
#ticketArea{display:block!important;width:100%;background:#fff}
#ticket{
width:72mm!important;margin:0 auto!important;padding:0 2mm!important;
font-size:14px!important;line-height:1.45;
}
header,#loginScreen,.btn,#modalCobro,#qrReaderContainer{display:none!important}
}
@page{size:72mm auto;margin:0}

#pantallaVenta,#pantallaCarrito{transition:.25s}
#pantallaCarrito{margin-top:10px}
#btnRegresar{background:linear-gradient(180deg,#888,#666);color:#fff}
/* ‚≠ê Asegurar que los resultados SIEMPRE queden por encima del carrito */
.search-results {
  z-index: 99999 !important;
  position: absolute !important;
}
#carrito-container {
  bottom: -65px !important;     /* üî• baja m√°s el carrito */
  margin-top: 25px !important;  /* espacio visual extra */
}
.snow{
  pointer-events: none;
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  z-index: 999; /* üëà CLAVE */

  background-image:
    radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.9) 50%, transparent),
    radial-gradient(1.5px 1.5px at 70% 40%, rgba(255,255,255,.8) 50%, transparent),
    radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,.7) 50%, transparent);

  background-size: 300px 300px; /* üëà CLAVE */
  animation: snowMove 18s linear infinite;
  opacity: .4;
}

@keyframes snowMove{
  from{
    background-position: 0 -300px;
  }
  to{
    background-position: 0 600px;
  }
}


</style>
</head>
<body>
  <!-- üîë BLOQUE 2: LOGIN DE USUARIO -->
  <div id="loginScreen">
    <img id="loginLogo" src="logo_proveedora.webp" alt="Logo La Proveedora">
    <h2>Acceso Ruta de Venta</h2>
    <input id="loginUsuario" type="text" placeholder="Usuario"/>
    <input id="loginPassword" type="password" placeholder="Contrase√±a"/>
    <button id="btnLogin" class="btn">Entrar</button>
    
    <div id="loginMsg"></div>
  </div>

<!-- üì¶ BLOQUE 3: INTERFAZ PRINCIPAL DEL POS -->
<div id="posApp" style="display:none;">

  <!-- üß≠ ENCABEZADO FIJO SUPERIOR -->
<header>
  <span>POS ‚Äì Ruta de Venta / Descuento</span>
  <img src="logo_proveedora.webp" alt="Logo">
</header>

<div id="usuarioBar" style="
  background:#0c6cbd;
  color:#fff;
  font-size:13px;
  padding:4px 10px;
  text-align:center;
  font-weight:600;
  letter-spacing:.3px;
">
  Usuario: ‚Äî
</div>

<!-- üß© CUERPO PRINCIPAL -->
<div class="main-content">

  <!-- üéØ BLOQUE 3.1 ‚Äî CONTROLES SUPERIORES -->
  <section id="pantallaVenta" class="controls">
    <!-- üßç‚Äç‚ôÇÔ∏è CAMPO CLIENTE -->
    <div class="field">
      <label>Cliente</label>
      <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
      <datalist id="clientesList"></datalist>
    </div>

    <!-- üîç BUSCADOR DE PRODUCTOS CON C√ÅMARA -->
    <div class="field searchbox">
      <label>Buscar</label>
      <input id="buscador" type="text" placeholder="Escribe o escanea c√≥digo‚Ä¶">
      <button id="btnBuscarManual" class="cam-btn" type="button" style="right:60px;">üîç</button>
      <button id="btnCam" class="cam-btn" type="button">üì∑</button>
      <div id="resultados" class="search-results"></div>
    </div>
  </section>

</div>

<!-- üßæ BLOQUE NUEVO ‚Äî CARRITO FIJO -->
<div id="carrito-container">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cant.</th>
          <th>Importe</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>


  <div class="totals">
    <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
    <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
    <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      <div class="actions">
    <button class="btn" id="btnCobrar">Cobrar</button>
  </div>

  </div>
</div>

<div id="bottomBar">
  <button id="btnCorteRuta" class="bar-btn azul">üìä Corte</button>
  <button id="btnResumen" class="bar-btn azul">üìä Resumen</button>
  <button id="btnLogout" class="bar-btn rojo">üö™ Salir</button>
</div>
</div> <!-- üëà cierre de #posApp --> 
<!-- üì∏ LIBRER√çAS EXTERNAS -->

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="./html5-qrcode.min.js"></script> <!-- üëà Aseg√∫rate de que esta ruta sea correcta -->

<!-- üí≥ MODAL DE COBRO CON AUTORIZACI√ìN DE DESCUENTO -->
<div id="modalCobro"
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
            z-index:1200;align-items:center;justify-content:center;">
  <div class="modal-card"
       style="width:min(420px,92vw);background:#fff;border-radius:14px;
              box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
    <div class="modal-h"
         style="padding:12px 16px;background:#0c6cbd;color:#fff;font-weight:700;">
      Cobro
    </div>
<div class="modal-b"
     style="padding:18px;display:flex;flex-direction:column;gap:14px;font-size:16px;">

  <!-- üí∞ Total -->
  <div class="row big" style="justify-content:space-between;font-size:22px;">
    <span>Total a pagar:</span>
    <span id="cobroTotal" 
          style="font-weight:700;color:#0c6cbd;font-size:24px;">$0.00</span>
  </div>

  <!-- üíµ Monto recibido -->
  <label for="montoRecibido" style="font-weight:600;">Monto recibido</label>
  <input id="montoRecibido" type="number" step="0.01" min="0" inputmode="decimal"
         placeholder="Ej. 7000.00"
         style="padding:16px 12px;border-radius:10px;border:1px solid #ccc;
                font-size:22px;text-align:center;font-weight:700;
                background:#f9f9f9;">

  <!-- üí∏ Cambio -->
  <div class="row big" 
       style="justify-content:space-between;align-items:center;
              padding:10px 0;border-top:2px dashed #ddd;
              border-bottom:2px dashed #ddd;">
    <span style="font-size:22px;font-weight:700;color:#111;">Cambio:</span>
    <span id="montoCambio"
          style="font-size:26px;font-weight:800;color:#1e8e3e;">$0.00</span>
  </div>

  <!-- üóíÔ∏è Notas -->
  <label for="notasCobro" style="font-weight:600;">Notas (opcional)</label>
  <textarea id="notasCobro" rows="2" style="resize:none;padding:10px;
            border-radius:10px;border:1px solid #ccc;font-size:15px;"></textarea>

  <!-- üßæ Descuento aplicado -->
  <div id="descuentoInfo"
       style="font-size:15px;color:#00416A;font-weight:600;
              text-align:right;display:none;">
    Descuento aplicado: <span id="descuentoResumen">$0.00</span>
  </div>

  <!-- üîò Botones principales -->
  <div style="display:flex;gap:10px;justify-content:space-between;margin-top:10px;">
    <button class="btn" id="btnSolicitarDescuento"
            style="flex:1;background:linear-gradient(180deg,#888,#666);
                   font-size:16px;">üßæ Descuento</button>
    <button class="btn" id="btnCancelarCobro" 
            style="flex:1;background:#aaa;font-size:16px;">Cancelar</button>
    <button class="btn" id="btnConfirmarCobro" 
            style="flex:1;background:linear-gradient(180deg,#0c6cbd,#094d85);
                   font-size:16px;">Confirmar</button>
  </div>
</div>
  </div>
</div>

<script type="text/javascript">
"use strict";

// ‚ö†Ô∏è Cargar m√≥dulos Firebase con import din√°mico (compatible m√≥viles)
(async () => {
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
const { 
  getFirestore, collection, addDoc, setDoc, serverTimestamp,
  runTransaction, doc, getDoc, getDocs, getDocFromServer, query, where, limit 
} = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const { enableIndexedDbPersistence } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const { obtenerUbicacionRobusta } = await import("./geoHelper.js");
// üîß FLAG GLOBAL: apagar/encender geolocalizaci√≥n sin tocar el resto del POS
const GEO_ACTIVO = false; // false = NO pedir ubicaci√≥n
async function obtenerUbicacionSegura() {
  if (!GEO_ACTIVO) return null;
  try {
    return await obtenerUbicacionRobusta();
  } catch (e) {
    console.warn("‚ö†Ô∏è Geolocalizaci√≥n desactivada por error:", e);
    return null;
  }
}

// ‚öôÔ∏è BLOQUE 5: SCRIPT PRINCIPAL (FIREBASE + L√ìGICA POS)

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
enableIndexedDbPersistence(db).catch(err => console.warn("‚ö†Ô∏è Persistence off:", err));


/* ===========================================================
   üîß SECCI√ìN 2: VARIABLES GLOBALES
   =========================================================== */
const $ = s => document.querySelector(s);
let carrito = [];
let catalogo = [];
let rutaId = null;
let USUARIO_LOGUEADO = null;
let clienteSeleccionado = null;
let origenEscaneo = null; // "camara" | "hid" üëà AQU√ç
// üîí Anti-doble-disparo de esc√°ner
let ultimoProductoAgregado = null;
let tiempoUltimoAgregado = 0;
// üîí Bloqueo duro para evitar reprocesar input
let procesandoAddProducto = false;

const money = n => '$' + (Number(n) || 0).toFixed(2);
const codeIndex = new Map();
const catalogoById = new Map();
  


/* ===========================================================
   üîî UTILIDAD GLOBAL: BEEP
   =========================================================== */
function beep(freq = 800, duration = 0.1) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = "sine";
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    osc.start();
    osc.stop(ctx.currentTime + duration);
  } catch (e) {}
}
/* ===========================================================
   üí∏ SECCI√ìN 3: PRODUCTOS DE MAYOREO (CIGARROS)
   =========================================================== */
const productosMayoreo = [
  "08339412","08346917","75001315","75001322","75001476","75016777",
  "75021597","75031053","75035259","75046521","75046781","75052836",
  "75056308","75059514","75063801","75064648","75066345","75068738",
  "75068745","75068776","75068783","75068844","75069902","75071295",
  "75071776","75080495","7501020540666"   // üëà AGREGADO Y LISTO
];

function permiteDescuentoPorCodigo(prod) {
  const codigo = String(prod.codigo || "").trim();

  // ‚ùå Si est√° en mayoreo ‚Üí NO descuento
  if (productosMayoreo.includes(codigo)) return false;

  // ‚úÖ Solo si el flag es true expl√≠cito
  return prod.permite_descuento === true;
}

// üßÆ Funci√≥n que selecciona precio seg√∫n cantidad
function obtenerPrecioSegunCantidad(prod, cantidad) {
  if (!productosMayoreo.includes(String(prod.codigo))) {
    return Number(prod.precioPublico || 0);
  }
  if (cantidad >= 5 && prod.mayoreo) {
    console.log("üí∏ Mayoreo aplicado:", prod.nombre);
    return Number(prod.mayoreo);
  }
  return Number(prod.precioPublico || 0);
}

/* ===========================================================
   üîë SECCI√ìN 4: LOGIN Y CARGA INICIAL (OPTIMIZADO)
   =========================================================== */
async function loginUsuario() {
const u = document.getElementById("loginUsuario").value.trim();
const p = document.getElementById("loginPassword").value.trim();
const msg = document.getElementById("loginMsg");

  // üî∏ Validaci√≥n b√°sica
  if (!u || !p) {
    msg.textContent = "Por favor, introduce usuario y contrase√±a.";
    return;
  }

  // üé¨ Animaci√≥n visual de progreso
  msg.textContent = "üîÑ Verificando usuario...";
  msg.style.background = "rgba(255,255,255,.15)";
  msg.style.padding = "6px 10px";
  msg.style.borderRadius = "6px";
  msg.style.transition = "all 0.3s ease";

  try {
    const q = query(
      collection(db, "usuarios_ruta"),
      where("usuario", "==", u),
      where("password", "==", p),
      where("activo", "==", true)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      msg.textContent = "‚ùå Usuario o contrase√±a incorrectos";
      msg.style.background = "rgba(255,50,50,.3)";
      return;
    }

    const data = snap.docs[0].data();
    USUARIO_LOGUEADO = { id: snap.docs[0].id, ...data };
    rutaId = data.rutaId || null;
    document.getElementById("usuarioBar").textContent =
  `Usuario: ${USUARIO_LOGUEADO.nombre || USUARIO_LOGUEADO.usuario}`;


    // üíæ Guarda sesi√≥n para acceso r√°pido
    localStorage.setItem("usuario_ruta", JSON.stringify(USUARIO_LOGUEADO));

    // üü¢ Mostrar transici√≥n visual
    msg.textContent = "‚úÖ Bienvenido " + (data.nombre || u);
    msg.style.background = "rgba(0,150,80,.4)";

    // üåÄ Cargar datos principales
document.getElementById("loginScreen").style.display = "none";
document.getElementById("posApp").style.display = "block";
document.body.classList.add("sesion-activa");



    // Carga simult√°nea
    await Promise.all([
      cargarCatalogo(),
      fijarClientePublico()
    ]);

    console.log("‚úÖ Sesi√≥n iniciada:", USUARIO_LOGUEADO);
    msg.textContent = "";

  } catch (e) {
    console.error("‚ùå Error en login:", e);
    msg.textContent = "‚ö†Ô∏è Error de conexi√≥n con el servidor.";
    msg.style.background = "rgba(255,150,0,.3)";
  }
}

$("#btnLogin").onclick = loginUsuario;
/* ===========================================================
   üîÅ SECCI√ìN 4.1: RECUPERAR SESI√ìN AUTOM√ÅTICA
   =========================================================== */
(async () => {
  const guardado = localStorage.getItem("usuario_ruta");
  if (!guardado) return;

  try {
    USUARIO_LOGUEADO = JSON.parse(guardado);
    rutaId = USUARIO_LOGUEADO?.rutaId || null;
    document.getElementById("usuarioBar").textContent =
  `Usuario: ${USUARIO_LOGUEADO.nombre || USUARIO_LOGUEADO.usuario}`;


    console.log("üîê Sesi√≥n restaurada:", USUARIO_LOGUEADO.nombre || USUARIO_LOGUEADO.usuario);

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("posApp").style.display = "block";
document.body.classList.add("sesion-activa");

    

    await Promise.all([
      cargarCatalogo(),
      fijarClientePublico()
    ]);
  } catch (err) {
    console.warn("‚ö†Ô∏è No se pudo restaurar sesi√≥n previa:", err);
    localStorage.removeItem("usuario_ruta");
  }
});
/* ===========================================================
   üì¶ CACHE DIN√ÅMICO‚ÄìPROVSOFT (SW)
   =========================================================== */

// üîπ Guarda datos en el cach√© del Service Worker
async function cachearDatos(ruta, data) {
  try {
    const url = location.origin + ruta;
    const res = new Response(JSON.stringify(data), {
      headers: { "Content-Type": "application/json" }
    });
    const cache = await caches.open("provsoft-pos-v10");
    await cache.put(url, res);
    console.log("üíæ Guardado en cach√© SW:", ruta);
  } catch (err) {
    console.warn("‚ö†Ô∏è No se pudo cachear:", ruta, err);
  }
}

// üîπ Lee datos del cach√© del Service Worker
async function leerCache(ruta) {
  try {
    const url = location.origin + ruta;
    const cache = await caches.open("provsoft-pos-v10");
    const res = await cache.match(url);
    if (!res) return null;
    const json = await res.json();
    console.log("‚ö° Le√≠do desde cache SW:", ruta, json.length || Object.keys(json).length);
    return json;
  } catch (err) {
    console.warn("‚ö†Ô∏è No se pudo leer cache:", ruta);
    return null;
  }
}

/* ===========================================================
   üßæ SECCI√ìN 5: CARGA DE CAT√ÅLOGO Y DEPARTAMENTOS (OPTIMIZADO)
   =========================================================== */

async function cargarCatalogo() {
  const cacheKey = "catalogo_cache";
  const cache = JSON.parse(localStorage.getItem(cacheKey) || "{}");
  const unDia = 24 * 60 * 60 * 1000;
  const statusBox = document.createElement("div");

  // üü¶ Muestra un mensaje flotante mientras carga
  statusBox.textContent = "üîÑ Cargando cat√°logo de productos...";
  statusBox.style.cssText = `
    position:fixed;top:10px;left:50%;transform:translateX(-50%);
    background:#00416A;color:#fff;padding:10px 16px;
    border-radius:10px;z-index:5000;font-size:14px;
    box-shadow:0 2px 6px rgba(0,0,0,.2);
  `;
  document.body.appendChild(statusBox);
// =====================================================
// üü¢ 1) Intentar cargar desde cache del Service Worker
// =====================================================
const catalogoSW = await leerCache("/catalogo");

if (catalogoSW && Array.isArray(catalogoSW) && catalogoSW.length > 0) {

  catalogo = catalogoSW.map(x => ({
    id: x.id,
    nombre: x.nombre || x.concepto || "SIN NOMBRE",
    codigo: String(x.codigo || x.codigoBarra || ""),
    precioPublico: Number(x.precioPublico || 0),
    mayoreo: Number(x.mayoreo || 0),
    medioMayoreo: Number(x.medioMayoreo || 0),
    ivaTasa: Number(x.ivaTasa || 0),
    iepsTasa: Number(x.iepsTasa || 0),
    equivalentes: Array.isArray(x.equivalentes) ? x.equivalentes : [],
    claveSat: x.claveSat || null,
    unidadMedidaSat: x.unidadSat || x.unidadMedidaSat || null,
    departamento_id: x.departamento_id || null,
    departamento: x.departamento || null, // üî• FIX
    costoUnit: Number(x.costoUnit || x.costoSinImpuesto || 0),
    permite_descuento: x.permite_descuento === true,
  }));

  // üîÅ RECONSTRUIR √çNDICES
  codeIndex.clear();
  catalogoById.clear();

  catalogo.forEach(p => {
   catalogoById.set(p.id, p);
    if (p.codigo) codeIndex.set(p.codigo.trim(), p.id);
    if (Array.isArray(p.equivalentes)) {
      p.equivalentes.forEach(eq => {
        if (eq) codeIndex.set(eq.trim(), p.id);
      });
    }
  });

  console.log("‚ö° Cat√°logo cargado OFFLINE desde SW");
  statusBox.textContent = `‚ö° Cat√°logo cargado offline (${catalogo.length})`;
  setTimeout(() => statusBox.remove(), 1500);
  return;
}
// üî¥ 3) CARGAR DESDE FIRESTORE (SOLO ACTIVOS)
console.log("üåê Cargando cat√°logo desde Firestore (solo activos)...");

const q = query(
  collection(db, "productos"),
  where("activo", "==", true)
);

const snap = await getDocs(q);

catalogo = snap.docs.map(doc => {
  const x = doc.data();
  return {
    id: doc.id,
    nombre: x.nombre || x.concepto || "SIN NOMBRE",
    codigo: String(x.codigo || x.codigoBarra || "").trim(),
    precioPublico: Number(x.precioPublico || 0),
    mayoreo: Number(x.mayoreo || 0),
    medioMayoreo: Number(x.medioMayoreo || 0),
    ivaTasa: Number(x.ivaTasa || 0),
    iepsTasa: Number(x.iepsTasa || 0),
    equivalentes: Array.isArray(x.equivalentes) ? x.equivalentes : [],
    departamento_id: x.departamento_id || null,
    departamento: x.departamento || null,   // üî• ESTE FALTABA
    costoUnit: Number(x.costoUnit || x.costoSinImpuesto || 0),
    permite_descuento: x.permite_descuento === true
  };
});

// üîÅ RECONSTRUIR √çNDICES
codeIndex.clear();
catalogoById.clear();

catalogo.forEach(p => {
  catalogoById.set(p.id, p);
  if (p.codigo) codeIndex.set(p.codigo.trim(), p.id);
  if (Array.isArray(p.equivalentes)) {
    p.equivalentes.forEach(eq => {
      if (eq) codeIndex.set(String(eq).trim(), p.id);
    });
  }
});

// üíæ Guardar SOLO metadata en localStorage (ligero)
localStorage.setItem("catalogo_cache_meta", JSON.stringify({
  fecha: Date.now(),
  total: catalogo.length
}));

// üíæ Cat√°logo completo ‚Üí SOLO en cache SW
await cachearDatos("/catalogo", catalogo);

statusBox.textContent = `‚úÖ Cat√°logo cargado (${catalogo.length} productos)`;
setTimeout(() => statusBox.remove(), 2000);

console.log("‚úÖ Cat√°logo cargado desde Firestore:", catalogo.length);
  }
/* ===========================================================
   üîç SECCI√ìN 6: B√öSQUEDA LOCAL DE PRODUCTOS
   =========================================================== */
function resolverProductoPorCodigo(codigo) {
  const key = String(codigo || "").trim();
  const id = codeIndex.get(key);
  if (!id) return null;
  return catalogoById.get(id) || null;
}

  function buscarLocal(qraw) {
  const q = (qraw || "").trim().toLowerCase();
  if (!q) return [];

  // 1Ô∏è‚É£ Etiquetas de b√°scula (7 d√≠gitos + peso)
  if (/^2\d{12,}$/.test(q)) {
    const codigoBase = q.substring(0, 7);
    const pesoStr = q.substring(7, 12);
    const peso = parseFloat(pesoStr) / 1000;
    const idMatch = Array.from(codeIndex.entries()).find(([cod]) =>
      cod.startsWith(codigoBase)
    );
    if (idMatch) {
      const p = catalogo.find(x => x.id === idMatch[1]);
      if (p) {
        $("#cantidadInput").value = peso.toFixed(3);
        return [p];
      }
    }
  }

  // 2Ô∏è‚É£ Coincidencia exacta
const p = resolverProductoPorCodigo(q);
if (p) return [p];

           
  // 4Ô∏è‚É£ Coincidencia por nombre
  return catalogo.filter(p => (p.nombre || "").toLowerCase().includes(q));
}
/* ===========================================================
   üîó SECCI√ìN 6.1: CONSULTA DE EQUIVALENCIAS EN FIRESTORE (FIX)
   =========================================================== */
async function buscarEquivalenteRemoto(codigo) {
  try {
    const equivalentesCol = collection(db, "equivalentes");

    // Buscar equivalentes donde *este c√≥digo* sea el equivalente
    const q1 = query(
      equivalentesCol,
      where("codigo_equivalente", "==", codigo)
    );
    const snap1 = await getDocs(q1);

    // Buscar equivalentes donde *este c√≥digo* sea el origen
    const q2 = query(
      equivalentesCol,
      where("codigo_origen", "==", codigo)
    );
    const snap2 = await getDocs(q2);

    // Construimos todos los c√≥digos v√°lidos para buscar
    let codigosBusqueda = [codigo];

    snap1.forEach(doc => {
      const o = doc.data().codigo_origen;
      if (o && !codigosBusqueda.includes(o)) codigosBusqueda.push(o);
    });

    snap2.forEach(doc => {
      const eq = doc.data().codigo_equivalente;
      if (eq && !codigosBusqueda.includes(eq)) codigosBusqueda.push(eq);
    });

const resultados = catalogo.filter(p => {
  const codPrincipal = String(p.codigo || "").trim();
  const eqs = Array.isArray(p.equivalentes) ? p.equivalentes : [];

  return codigosBusqueda.includes(codPrincipal) ||
         eqs.some(e => codigosBusqueda.includes(String(e).trim()));
});


    return resultados;

  } catch (err) {
    console.error("‚ùå Error buscando equivalencia remota:", err);
    return [];
  }
}

/* ===========================================================
   ‚öñÔ∏è SECCI√ìN 6.2: DECODIFICAR C√ìDIGOS DE BALANZA
   =========================================================== */
function decodificarBalanza(codigo) {

  if (!codigo.startsWith("2")) return { esBalanza: false };

  // aceptar c√≥digos 2xxxxxxxxxxxxx de 13 a 15 d√≠gitos
  if (codigo.length < 13 || codigo.length > 15) {
    return { esBalanza: false };
  }

  const codigoProducto = codigo.substring(0, 7);  
  const pesoBruto = codigo.substring(7, 12);      
  const pesoKg = parseFloat(pesoBruto) / 1000;    

  return { esBalanza: true, codigoProducto, pesoKg };
}

/* ===========================================================
   üßÆ SECCI√ìN 7: CARRITO DE COMPRAS
   =========================================================== */
function addProduct(prod, cant = 1) {
  if (!prod) return;

  // üö´ BLOQUEO DURO
  if (procesandoAddProducto) return;
  procesandoAddProducto = true;

  const prodReal = catalogoById.get(prod.id);
  if (prodReal) {
    prod.departamento_id = prodReal.departamento_id;
    prod.departamento = prodReal.departamento;
  }

  const existente = carrito.find(x => x.id === prod.id);

  // -------------------------------
  // üö® PRODUCTO DE BALANZA
  // -------------------------------
  if (String(prod.codigo || "").startsWith("2")) {
    carrito.push({
      ...prod,
      codigo: prod.codigo || prod.codigoBarra || "",
      cantidad: cant,
      precioUnit: Number(prod.precioPublico || 0),
      importe: cant * Number(prod.precioPublico || 0),
      departamento: prod.departamento || null,
      departamento_id: prod.departamento_id || null,
      claveSat: prod.claveSat || null,
      unidadSat: prod.unidadMedidaSat || null,
      ivaTasa: prod.ivaTasa ?? 0,
      iepsTasa: prod.iepsTasa ?? 0,
      permite_descuento: permiteDescuentoPorCodigo(prod),
    });

    renderDebounced();
    liberarAddProducto();
    return;
  }

  // -------------------------------
  // üßÆ PRODUCTO NORMAL (PZ)
  // -------------------------------
  const cantidadNueva = existente ? existente.cantidad + cant : cant;
  const precioCorrecto = obtenerPrecioSegunCantidad(prod, cantidadNueva);

  if (existente) {
    existente.cantidad = cantidadNueva;
    existente.precioUnit = precioCorrecto;
    existente.importe = cantidadNueva * precioCorrecto;
  } else {
    carrito.push({
      ...prod,
      codigo: prod.codigo || prod.codigoBarra || "",
      cantidad: cant,
      precioUnit: precioCorrecto,
      importe: cant * precioCorrecto,
      departamento: prod.departamento || null,
      departamento_id: prod.departamento_id || null,
      claveSat: prod.claveSat || null,
      unidadSat: prod.unidadMedidaSat || null,
      ivaTasa: prod.ivaTasa ?? 0,
      iepsTasa: prod.iepsTasa ?? 0,
      permite_descuento: permiteDescuentoPorCodigo(prod),
    });
  }

  mostrarConfirmacionProducto(prod, cant, precioCorrecto);
  renderDebounced();
  liberarAddProducto();
}
function liberarAddProducto() {
  const buscador = document.getElementById("buscarProducto");
  if (buscador) buscador.value = "";

  setTimeout(() => {
    procesandoAddProducto = false;
  }, 150);
}

/* ===========================================================
   üß≠ FUNCI√ìN VISUAL: CONFIRMACI√ìN DE PRODUCTO ESCANEADO
   =========================================================== */
function mostrarConfirmacionProducto(prod, cant, precioUnit) {
  // Borra avisos anteriores si a√∫n est√°n visibles
  const avisoPrevio = document.getElementById("toastProducto");
  if (avisoPrevio) avisoPrevio.remove();

  const total = (cant * precioUnit).toFixed(2);
  const aviso = document.createElement("div");
  aviso.id = "toastProducto";
  aviso.innerHTML = `
    ‚úÖ ${cant} √ó <strong>${prod.nombre}</strong><br>
    üí∞ $${total}
  `;
  aviso.style.cssText = `
    position:fixed;bottom:75px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:10px 16px;
    border-radius:12px;text-align:center;z-index:9999;
    font-size:15px;font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,.4);
    opacity:0;transition:opacity .3s ease;
  `;

  document.body.appendChild(aviso);
  setTimeout(() => aviso.style.opacity = 1, 80);
  setTimeout(() => {
    aviso.style.opacity = 0;
    setTimeout(() => aviso.remove(), 400);
  }, 2500);
}
  
  
function delItem(id){ carrito=carrito.filter(x=>x.id!==id); render(); }
window.delItem=delItem;

/* ===========================================================
   üßÆ SECCI√ìN 8: C√ÅLCULO DE TOTALES CON DESCUENTO (OPTIMIZADO)
   =========================================================== */
function calcularTotales(descPorc = 0) {
  let subtotal = 0, iva = 0, ieps = 0, total = 0;
  let subtotalElegible = 0, subtotalNoElegible = 0;

  // üí∞ Asegura que el porcentaje de descuento sea v√°lido (0‚Äì100)
  const descuento = Math.min(100, Math.max(0, descPorc || 0)) / 100;

  // üî¢ Recorre todos los productos del carrito
carrito.forEach(it => {
  const imp = it.cantidad * it.precioUnit;

  const ivaT  = Number(it.ivaTasa || 0);
  const iepsT = Number(it.iepsTasa || 0);

  let base = imp;
  if (iepsT > 0 && ivaT > 0) base = imp / (1 + iepsT + ivaT * (1 + iepsT));
  else if (iepsT > 0) base = imp / (1 + iepsT);
  else if (ivaT > 0) base = imp / (1 + ivaT);

  const ivaCalc  = +(base * ivaT).toFixed(2);
  const iepsCalc = +(base * iepsT).toFixed(2);

  it.iva_calculado  = ivaCalc;
  it.ieps_calculado = iepsCalc;

  subtotal += base;
  iva += ivaCalc;
  ieps += iepsCalc;
  total += imp;

  // üî• AQU√ç SE DEFINE QUI√âN RECIBE DESCUENTO
  if (it.permite_descuento) {
    subtotalElegible += base;
  } else {
    subtotalNoElegible += base;
  }
});

  // üßÆ C√°lculo seguro de descuentos (sin dividir por cero)
  const montoDesc = subtotalElegible * descuento;
  const proporci√≥n = subtotal > 0 ? montoDesc / subtotal : 0;

  // üí∏ Totales finales
  const subtotalFinal = subtotal - montoDesc;
  const ivaFinal = iva - (iva * proporci√≥n);
  const iepsFinal = ieps - (ieps * proporci√≥n);
  const totalFinal = subtotalFinal + ivaFinal + iepsFinal;

  return {
    subtotal: +subtotal.toFixed(2),
    descuento: +montoDesc.toFixed(2),
    impuestos: +(ivaFinal + iepsFinal).toFixed(2),
    total: +totalFinal.toFixed(2)
  };
}

function acortarNombre(nombre) {
  if (!nombre) return "";
  const max = 10; // c√°mbialo a 7 si quieres m√°s compacto
  return nombre.length > max
    ? nombre.substring(0, max) + "‚Ä¶"
    : nombre;
}
  /* ===========================================================
   üñ•Ô∏è SECCI√ìN 9: RENDER Y ACTUALIZACI√ìN VISUAL DEL CARRITO
   =========================================================== */
function render(desc = 0) {
  const tbody = $("#tbody");
  tbody.innerHTML = "";

  carrito.forEach(it => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${acortarNombre(it.nombre)}</td>
      <td style="text-align:center">
        <input type="number" min="0" step="0.01" value="${it.cantidad}"
          style="width:70px;text-align:center;padding:4px;border-radius:6px;
          border:1px solid #ccc;font-size:14px;"
          onchange="actualizarCantidad('${it.id}', this.value)"
          oninput="actualizarCantidad('${it.id}', this.value)">
      </td>
      <td style="text-align:right">${money(it.importe)}</td>
      <td class='del-col'>
        <button class='del' onclick="delItem('${it.id}')">√ó</button>
      </td>`;
    tbody.appendChild(tr);
  });

const { subtotal, descuento, impuestos, total } = calcularTotales(desc);

$("#lblSubtotal").textContent = money(subtotal);
$("#lblImpuestos").textContent = money(impuestos);
$("#lblTotal").textContent = money(total);

if (descuento > 0) {
  descuentoInfo.textContent = `Descuento aplicado: ${money(descuento)}`;
  descuentoInfo.style.display = "block";
} else {
  descuentoInfo.textContent = "Descuento aplicado: $0.00";
}

/* ===========================================================
   ‚öôÔ∏è SECCI√ìN 9.1: Nueva funci√≥n para manejar los spinners
   =========================================================== */  

function actualizarCantidad(id, nuevaCant) {
  const item = carrito.find(x => x.id === id);
  if (!item) return;

  const cant = parseFloat(nuevaCant);
  if (isNaN(cant) || cant < 0) return;

  const precioAnterior = item.precioUnit;

  item.cantidad = cant;
  item.precioUnit = obtenerPrecioSegunCantidad(item, cant);
  item.importe = item.cantidad * item.precioUnit;

  if (productosMayoreo.includes(String(item.codigo))) {
    if (cant >= 5 && item.precioUnit !== precioAnterior) {
      beep(600, 0.15);
      toast(`üí∏ Mayoreo aplicado a ${item.nombre}`, "#1e8e3e");
    } else if (cant < 5 && item.precioUnit !== precioAnterior) {
      beep(400, 0.15);
      toast(`üîÅ Precio p√∫blico restaurado (${item.nombre})`, "#c0392b");
    }
  }

  // üßÆ Mantener descuento activo autom√°ticamente
  const desc = Number(localStorage.getItem("desc_porcentaje") || 0);
  render(desc);
}
  
/* ===========================================================
   ‚öôÔ∏è SECCI√ìN 9.2: RENDER OPTIMIZADO CON DEBOUNCE
   =========================================================== */
let renderTimer;

function renderDebounced() {
  clearTimeout(renderTimer);

  const desc = Number(
  localStorage.getItem("desc_porcentaje") ??
  descuentoAutorizado ??
  0
);

  renderTimer = setTimeout(() => {
    render(desc);
  }, 100);
}

/* ===========================================================
   ‚å®Ô∏è SECCI√ìN 10: FLUJO DE ENTRADA (BUSCADOR + CANTIDAD)
   =========================================================== */
window.addProduct = addProduct;
window.render = render;
let productoTemporal = null;

// üîÅ Escaneo continuo: cada c√≥digo se agrega directo al carrito
function seleccionarProducto(prod, pedirCantidad = false) {
  prod.codigo = prod.codigo || prod.codigoBarra || "";

  if (pedirCantidad) {
    solicitarCantidadYAgregar(prod);
    return;
  }

  // flujo r√°pido (scanner / enter)
  addProduct(prod, 1);
  beep(950, 0.12);
  resultadosDiv.style.display = "none";
  buscador.value = "";
  buscador.focus();
}

// üì± Modal con teclado num√©rico en m√≥viles + beep al abrir
function solicitarCantidadYAgregar(prod) {
  const modal = document.getElementById("modalCantidad");
  const input = document.getElementById("inputCantidadModal");
  const btnAceptar = document.getElementById("btnAceptarCant");
  const btnCancelar = document.getElementById("btnCancelarCant");

   // üî• FIX CLAVE
  modal.style.display = "flex";

  beep(950, 0.15);

  input.value = "1";
  input.focus();

  function cerrar() {
    modal.style.display = "none";
    btnAceptar.removeEventListener("click", confirmar);
    btnCancelar.removeEventListener("click", cancelar);
  }

  function confirmar() {
    const cantidad = parseFloat(input.value.replace(",", "."));
    if (isNaN(cantidad) || cantidad <= 0) {
      alert("Introduce una cantidad v√°lida (solo n√∫meros).");
      return;
    }
    addProduct(prod, cantidad);
    $("#buscador").value = "";
    $("#buscador").focus();
    cerrar();
  }

  function cancelar() {
    cerrar();
    $("#buscador").focus();
  }

  btnAceptar.addEventListener("click", confirmar);
  btnCancelar.addEventListener("click", cancelar);

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") confirmar();
  });
}
/* ===========================================================
   üîé B√öSQUEDA POR C√ìDIGO, PALABRA Y ESC√ÅNER (MEJORADA)
   =========================================================== */
const buscador = document.getElementById("buscador");
const resultadosDiv = document.getElementById("resultados");

// Permitir que el esc√°ner la use
  
// üîç Funci√≥n central que ejecuta la b√∫squeda y muestra resultados
async function ejecutarBusqueda(texto) {
  const balanza = decodificarBalanza(texto);

  // ‚öñÔ∏è Caso 1: C√≥digo de balanza detectado
  if (balanza.esBalanza) {
    console.log("‚öñÔ∏è C√≥digo de balanza detectado:", balanza);

    // 1Ô∏è‚É£ Buscar en equivalentes si ese c√≥digo est√° vinculado
    const ref = collection(db, "equivalentes");
    const q = query(ref, where("codigo_equivalente", "==", balanza.codigoProducto));
    const snap = await getDocs(q);

    let codigoBase = balanza.codigoProducto;
    if (!snap.empty) {
      codigoBase = snap.docs[0].data().codigo_origen;
      console.log("üîÅ Equivalente de balanza encontrado:", codigoBase);
    }

    // 2Ô∏è‚É£ Buscar el producto real
const p = resolverProductoPorCodigo(codigoBase);
if (!p) {
  toast("‚ùå Producto de balanza no registrado", "#dc2626");
  return;
}

const peso = parseFloat(balanza.pesoKg.toFixed(3));
p.codigo = p.codigo || p.codigoBarra || "";

addProduct(p, peso);

beep(950);
toast(`‚öñÔ∏è ${p.nombre} (${peso.toFixed(3)} kg) ‚Äì $${(p.precioPublico * peso).toFixed(2)}`, "#16a34a");
return;

  }

  // üßæ Caso 2: C√≥digo normal
  let resultados = buscarLocal(texto);

if (resultados.length === 0) {
  toast("‚ùå C√≥digo no registrado", "#dc2626");
  resetScanner();
  return;
}

  resultadosDiv.innerHTML = "";
// üîß Restaurar estilo original para resultados normales
resultadosDiv.style.position = "absolute";
resultadosDiv.style.top = "";
resultadosDiv.style.left = "";
resultadosDiv.style.transform = "";
resultadosDiv.style.width = "";

  if (resultados.length === 1) {
    beep(950);
    seleccionarProducto(resultados[0]);
    resultadosDiv.style.display = "none";
  } else if (resultados.length > 1) {
    resultados.forEach(p => {
      const item = document.createElement("div");
      item.className = "result-item";
      const regex = new RegExp(texto, "ig");
      const nombreResaltado = p.nombre.replace(regex, m => `<strong style="color:#0c6cbd">${m}</strong>`);
      item.innerHTML = `<span>${nombreResaltado}</span><small>${money(p.precioPublico)}</small>`;
      item.addEventListener("click", () => {
        beep(950);
        seleccionarProducto(p, true); // ‚úÖ PEDIR CANTIDAD
        resultadosDiv.style.display = "none";
      });
      resultadosDiv.appendChild(item);
    });
    resultadosDiv.style.display = "block";
    beep(700);
  } else {
// ===============================
// üöÄ MENSAJE DE SIN COINCIDENCIAS (VERSI√ìN FINAL)
// ===============================

resultadosDiv.innerHTML = `
  <div style="
    padding:12px;
    background:#fff;
    color:#444;
    border-radius:10px;
    box-shadow:0 4px 14px rgba(0,0,0,.25);
    font-size:15px;
    font-weight:600;
    text-align:center;
  ">
    üîç Sin coincidencias
  </div>
`;

// üî• Mostrar tarjeta flotante ARRIBA del carrito
resultadosDiv.style.position = "fixed";
resultadosDiv.style.top = "65px";              // se ve debajo del header
resultadosDiv.style.left = "50%";
resultadosDiv.style.transform = "translateX(-50%)";
resultadosDiv.style.width = "max-content";
resultadosDiv.style.maxWidth = "90vw";
resultadosDiv.style.zIndex = "999999";          // nada lo puede tapar
resultadosDiv.style.display = "block";

beep(500);

// ‚è≥ Ocultar despu√©s de 1 segundo
setTimeout(() => {
  resultadosDiv.style.display = "none";
  resultadosDiv.innerHTML = "";
}, 1000);

// üßπ Limpiar input SIEMPRE (evita que se ‚Äúmuera‚Äù el scanner)
buscador.value = "";

// üîÑ Reset completo del scanner (buffer + estado + focus)
resetScanner();

  }
}
window.ejecutarBusquedaOriginal = ejecutarBusqueda;
/* ===========================================================
   üîé DETECTOR UNIVERSAL DE ESC√ÅNER (v4.1 h√≠brido Android/PC)
   =========================================================== */
let scanBuffer = "";
let scanTimer = null;
let modoScanner = false;

function resetScanner() {
  scanBuffer = "";
  modoScanner = false;
  clearTimeout(scanTimer);

  // üî• Correcci√≥n clave
  if (buscador) {
    buscador.value = "";
    buscador.blur();       // resetea m√≥viles
    setTimeout(() => buscador.focus(), 30); // reactiva HID
  }
}

function procesarCodigoEscaneado(codigo) {
  const limpio = codigo.trim();
  if (!limpio) return;

  console.log("üì¶ C√≥digo detectado:", limpio);
  beep(950, 0.1);
  ejecutarBusqueda(limpio);
  buscador.value = "";
  scanBuffer = "";
  modoScanner = false;
}

/* üß© MODO PC (keydown HID) */
buscador.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && scanBuffer.length > 0) {
    e.preventDefault();
    origenEscaneo = "hid";
    procesarCodigoEscaneado(scanBuffer);
    return;
  }

  if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
    scanBuffer += e.key;
    modoScanner = true;
    clearTimeout(scanTimer);
    scanTimer = setTimeout(() => procesarCodigoEscaneado(scanBuffer), 400);
  }
});

/* üß© MODO ANDROID (evento input HID-Bluetooth) */
buscador.addEventListener("input", (e) => {
  const valor = e.target.value.trim();
  if (!valor) return;

  modoScanner = true;
  scanBuffer = valor;
  clearTimeout(scanTimer);

  // Espera 300 ms sin nuevos caracteres antes de procesar
  scanTimer = setTimeout(() => {
    procesarCodigoEscaneado(scanBuffer);
  }, 300);
});

/* üîπ Procesar tambi√©n si el input pierde el foco */
buscador.addEventListener("blur", () => {
  if (modoScanner && scanBuffer.length > 0) procesarCodigoEscaneado(scanBuffer);
});

/* ===========================================================
   üîç BUSCADOR MANUAL INDEPENDIENTE (no ligado al caj√≥n)
   =========================================================== */
const btnBuscarManual = document.getElementById("btnBuscarManual");

btnBuscarManual.addEventListener("click", async () => {
  // ü™ü Modal contenedor
  const modal = document.createElement("div");
  modal.style.cssText = `
    position:fixed;inset:0;z-index:9999;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    background:#fff;border-radius:14px;padding:16px;width:90%;
    max-width:400px;max-height:80vh;display:flex;flex-direction:column;
  `;
  box.innerHTML = `
    <h3 style="margin:0 0 10px;text-align:center;color:#00416A">
      üîç Buscar producto
    </h3>
    <input id="inputBusquedaManual" type="text" placeholder="Nombre o c√≥digo..."
      style="padding:10px;border-radius:8px;border:1px solid #ccc;
             font-size:16px;margin-bottom:10px;">
    <div id="resultadosManual"
      style="flex:1;overflow-y:auto;border-top:1px solid #ddd;
             padding-top:10px;font-size:15px;"></div>
    <button id="cerrarBusquedaManual" class="btn"
      style="margin-top:10px;background:#c0392b;">Cerrar</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);

  const inputManual = box.querySelector("#inputBusquedaManual");
  const resultadosManual = box.querySelector("#resultadosManual");
  const cerrarBtn = box.querySelector("#cerrarBusquedaManual");

  inputManual.focus();

  // üß† Escucha escritura dentro del input del modal
  inputManual.addEventListener("input", async () => {
    const texto = inputManual.value.trim().toLowerCase();
    resultadosManual.innerHTML = "";
    if (texto.length < 2) return;

    let resultados = buscarLocal(texto);
    if (resultados.length === 0) resultados = await buscarEquivalenteRemoto(texto);

    if (resultados.length === 0) {
      resultadosManual.innerHTML = `<div style="padding:8px;color:#777;">Sin coincidencias</div>`;
      return;
    }

    resultados.forEach(p => {
      const item = document.createElement("div");
      item.style.cssText = `
        padding:8px;border-bottom:1px solid #eee;cursor:pointer;
        display:flex;justify-content:space-between;align-items:center;
      `;
      item.innerHTML = `
        <span>${p.nombre}</span>
        <strong style="color:#0c6cbd">${money(p.precioPublico)}</strong>
      `;
item.addEventListener("click", () => {
    p.codigo = p.codigo || p.codigoBarra || "";
  solicitarCantidadYAgregar(p); // abre el modal de cantidad
  modal.remove();
});

      resultadosManual.appendChild(item);
    });
  });

  cerrarBtn.addEventListener("click", () => modal.remove());
});




/* ===========================================================
   üí≥ SECCI√ìN 11: MODAL DE COBRO CON AUTORIZACI√ìN DE DESCUENTO
   =========================================================== */
const modalCobro = $("#modalCobro");
const cobroTotal = $("#cobroTotal");
const montoRecibido = $("#montoRecibido");
const montoCambio = $("#montoCambio");
const descuentoInfo = $("#descuentoInfo");
const descuentoResumen = $("#descuentoResumen");

let descuentoAutorizado = 0;

function abrirCobro() {
  if (carrito.length === 0) {
    alert("Agrega productos antes de cobrar.");
    return;
  }

  localStorage.removeItem("desc_porcentaje"); // üî• A√ëADIR
  descuentoAutorizado = 0;

  const tot = calcularTotales(0);
  cobroTotal.textContent = money(tot.total);

  montoRecibido.value = "";
  montoCambio.textContent = "$0.00";
  descuentoInfo.style.display = "none";

  modalCobro.style.display = "flex";
  $("#montoRecibido").focus();
}

function cerrarCobro() {
  modalCobro.style.display = "none";
  descuentoAutorizado = 0;
  localStorage.removeItem("desc_porcentaje"); // üî• A√ëADIR
}


$("#btnCobrar").onclick = abrirCobro;
$("#btnCancelarCobro").onclick = cerrarCobro;

// üíµ Calcular cambio autom√°ticamente
montoRecibido.addEventListener("input", () => {
  const valRec = parseFloat(montoRecibido.value) || 0;
  const tot = calcularTotales(descuentoAutorizado);
  const cambio = valRec - tot.total;
  montoCambio.textContent = money(cambio > 0 ? cambio : 0);
});
// üîê Aplicar descuento con contrase√±a ‚ÄúMADERO690*‚Äù
$("#btnSolicitarDescuento").addEventListener("click", async () => {
  const porc = parseFloat(prompt("Introduce el descuento (%)"));
  if (isNaN(porc) || porc <= 0 || porc > 100) {
    alert("Porcentaje inv√°lido."); return;
  }

  if (prompt("Introduce la contrase√±a de autorizaci√≥n") !== "MADERO690*") {
    alert("‚ùå Contrase√±a incorrecta."); return;
  }

  descuentoAutorizado = porc;
  localStorage.setItem("desc_porcentaje", porc);

  const tot = calcularTotales(porc);
  descuentoInfo.textContent = `Descuento aplicado: ${money(tot.descuento)}`;
descuentoInfo.style.display = "block";

  cobroTotal.textContent = money(tot.total);
  descuentoResumen.textContent = money(tot.descuento);
  descuentoInfo.style.display = "block";

  render(porc);

  const pago = parseFloat(montoRecibido.value) || 0;
  montoCambio.textContent = money(pago > 0 ? Math.max(0, pago - tot.total) : 0);

  alert(`‚úÖ Descuento del ${porc}% aplicado correctamente.`);
});

// ‚úÖ REEMPLAZAR ESTA SECCI√ìN EN EL C√ìDIGO ORIGINAL

/* ===========================================================
   ‚úÖ SECCI√ìN 11.1: CONFIRMAR VENTA (VERSI√ìN CORREGIDA)
   =========================================================== */
$("#btnConfirmarCobro").onclick = async () => {
  try {
    // üöß Bloqueo visual temporal
    const overlay = document.createElement("div");
    overlay.id = "overlayBloqueo";
    overlay.innerHTML = `
      <div style="
        position:fixed;inset:0;background:rgba(0,0,0,.75);
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        color:#fff;z-index:99999;font-size:20px;font-weight:600;">
        <div style="animation:spin 1s linear infinite;border:5px solid #fff;
          border-top-color:#0c6cbd;border-radius:50%;width:70px;height:70px;margin-bottom:16px;">
        </div>
        <div>GENERANDO TICKET<br>FAVOR DE ESPERAR...</div>

<div style="
  margin-top:18px;
  font-size:18px;
  
  font-weight:700;
  color:#ffd700;
  text-align:center;
  text-shadow:0 0 5px rgba(0,0,0,0.6);
">
  ‚ö†Ô∏è RECUERDA PREGUNTARLE AL CLIENTE:<br>
  <span style="font-size:17px; color:#fff;">
    ‚Ä¢ ¬øREQUIERE FACTURA?<br>
    ‚Ä¢ ¬øPROPORCIONAR DATOS FISCALES?<br>
  </span>
  <br>
  <span style="font-size:18px; color:#9eff9e;">
    NO OLVIDES EL "BUENOS D√çAS" Y "FELIZ NAVIDAD" üôå
  </span>
</div>

        
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg);}}</style>
    `;
    document.body.appendChild(overlay);

    // üîí Deshabilitar botones para evitar doble clic
    document.querySelectorAll("button").forEach(b => b.disabled = true);

    // üöß VALIDACIONES
    if (carrito.length === 0) {
      alert("No hay productos en el carrito.");
      return;
    }  
    if (!rutaId || !USUARIO_LOGUEADO) {
      alert("‚ö†Ô∏è Usuario o ruta no detectados. Vuelve a iniciar sesi√≥n.");
      return;
    }

    const tot = calcularTotales(descuentoAutorizado);
    const pago = parseFloat($("#montoRecibido").value) || 0;
    const cambio = pago - tot.total;
    if (cambio < 0) {
      alert("‚ö†Ô∏è El monto recibido es menor al total a pagar.");
      return;
    }

    // üßÆ Folio incremental por usuario y fecha
    let folio = "";
    const hoy = new Date();
    const fechaTag = hoy.toISOString().slice(0, 10).replace(/-/g, "");
    const usuarioTag = (USUARIO_LOGUEADO.usuario || "USR").toUpperCase().replace(/\s+/g, "").slice(0, 8);
    const folioId = `${usuarioTag}_${fechaTag}`;
    const folioRef = doc(db, "contadores", folioId);

    await runTransaction(db, async (tx) => {
      const snap = await tx.get(folioRef);
      let consecutivo = snap.exists() ? (snap.data().ultimo || 0) + 1 : 1;
      tx.set(folioRef, { ultimo: consecutivo, fecha: fechaTag });
      folio = `${usuarioTag}-${fechaTag}-${String(consecutivo).padStart(4, "0")}`;
    });

// üßæ ARMAR VENTA COMPLETA (ESTE BLOQUE NO EXIST√çA BIEN)
const venta = {
  folio,
  rutaId,
  cliente: $("#cliente").value || "P√öBLICO EN GENERAL",

  // üîπ CFDI READY
  moneda: "MXN",
  tipoCambio: 1,

  cortado: false,
  descuento_porcentaje: descuentoAutorizado,
  descuento_monto: tot.descuento,

  resumen_financiero: {
    subtotal: tot.subtotal,
    descuento: tot.descuento,
    impuestos: tot.impuestos,
    total: tot.total,
    costo_total: carrito.reduce(
      (s, x) => s + (x.costoUnit || 0) * x.cantidad, 0
    ).toFixed(2),
    utilidad_total: carrito.reduce(
      (s, x) => s + ((x.importe || 0) - (x.costoUnit || 0) * x.cantidad), 0
    ).toFixed(2),
    margen_porcentaje: (() => {
      const utilidad = carrito.reduce(
        (s, x) => s + ((x.importe || 0) - (x.costoUnit || 0) * x.cantidad), 0
      );
      return tot.total > 0 ? ((utilidad / tot.total) * 100).toFixed(2) : 0;
    })()
  },

  fecha: serverTimestamp(),
  fecha_txt: new Date().toLocaleString("es-MX", { hour12: true }),

  usuarioId: USUARIO_LOGUEADO.id,
  usuarioNombre: USUARIO_LOGUEADO.nombre,

  notas: $("#notasCobro").value || "",
  autorizado_por: descuentoAutorizado > 0 ? "Gerente autorizado" : null,
  ubicacion: await obtenerUbicacionSegura(),

  // ‚úÖ AQU√ç VA EL DETALLE (NO SUELTO)
  detalle: carrito.map(it => ({
    id: it.id,
    nombre: it.nombre,
    codigo: it.codigo,
    cantidad: it.cantidad,
    precio_unit: it.precioUnit,
    importe: it.importe,

    costo_unit: +(it.costoUnit || 0).toFixed(2),
    costo_total: +(it.cantidad * (it.costoUnit || 0)).toFixed(2),

    claveSat: it.claveSat,
    unidadSat: it.unidadSat,

    ivaTasa: it.ivaTasa,       // 0.16
    iepsTasa: it.iepsTasa,     // 0
    iva_calculado: it.iva_calculado,
    ieps_calculado: it.ieps_calculado,

    departamento_id: it.departamento_id,
  departamento_info: {
  id: it.departamento_id,
  nombre: it.departamento || catalogoById.get(it.id)?.departamento || "DESCONOCIDO",
  iva: Math.round(it.ivaTasa * 100),
  ieps: Math.round(it.iepsTasa * 100)
}
}))
};

    // üíæ GUARDAR VENTA UNA SOLA VEZ
    console.log("üíæ Guardando venta en Firestore...");
    await guardarVentaEnFirestore(venta);
    
    // üì≤ Enviar a Telegram
    console.log("üì≤ Enviando a Telegram...");
    await enviarTelegram(venta);
    
    // üßæ Generar e imprimir ticket
    console.log("üßæ Generando ticket...");
    rellenarTicket(venta);
window.__ULTIMOS_TOTALES = calcularTotales(descuentoAutorizado);

    imprimirTicketEstilado();


    // üßπ Limpieza y regreso
    console.log("‚úÖ Venta completada, limpiando carrito...");
    carrito = [];
    renderDebounced();
    cerrarCobro();
// üî• Ya no existe pantallaCarrito ‚Üí usar carrito-container
const carritoContainer = document.getElementById("carrito-container");

// Evitar errores si no existe
if (carritoContainer) carritoContainer.style.display = "";

const pantallaVenta = document.getElementById("pantallaVenta");


const busc = document.getElementById("buscador");
if (busc) busc.focus();

  } catch (err) {
    console.error("‚ùå Error al confirmar venta:", err);
    alert("Error al generar venta. Intenta de nuevo.");
  } finally {
    // üîì Reactivar todo y quitar overlay
    document.querySelectorAll("button").forEach(b => b.disabled = false);
    const overlay = document.getElementById("overlayBloqueo");
    if (overlay) overlay.remove();
  }
};

/* ===========================================================
   üíæ FUNCI√ìN GUARDAR VENTA (SIMPLIFICADA)
   =========================================================== */
async function guardarVentaEnFirestore(v) {
  try {
    const ref = collection(db, "ventas_rutav2");
        // üßÆ C√°lculo de impuestos por art√≠culo antes de guardar

    // üßæ Sumar total de impuestos al resumen financiero
    const totalIVA = v.detalle.reduce((acc, x) => acc + (x.iva_calculado || 0), 0);
    const totalIEPS = v.detalle.reduce((acc, x) => acc + (x.ieps_calculado || 0), 0);
    v.resumen_financiero.impuestos = +(totalIVA + totalIEPS).toFixed(2);

    const docRef = await addDoc(ref, v);
    console.log("‚úÖ Venta guardada UNA VEZ en Firestore:", v.folio, "ID:", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("‚ùå Error guardando venta:", e);
    throw e; // Propagar el error para manejarlo arriba
  }
}
/* ===========================================================
   üì≤ SECCI√ìN 13: ENV√çO A TELEGRAM (CON UBICACI√ìN)
   =========================================================== */
async function enviarTelegram(v) {
  try {
    const BOT_TOKEN = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
    const CHAT_ID = "6617988297";
    const formatoNum = n => (Number(n || 0)).toLocaleString("es-MX", {
      minimumFractionDigits: 2, maximumFractionDigits: 2
    });

    // üì¶ Datos base
    const folio = v.folio;
    const total = formatoNum(v.resumen_financiero?.total);
    const subtotal = formatoNum(v.resumen_financiero?.subtotal);
    const desc = formatoNum(v.descuento_monto || 0);
    const imp = formatoNum(v.resumen_financiero?.impuestos || 0);
    const pago = formatoNum(v.recibido || v.resumen_financiero?.total || 0);
    const cambio = formatoNum(v.cambio || 0);
    const articulos = (v.detalle || []).reduce((a, b) => a + Number(b.cantidad || 0), 0);
    const cajero = v.usuarioNombre || "‚Äî";
    const cliente = v.cliente || "P√öBLICO EN GENERAL";
    const descPorc = v.descuento_porcentaje || 0;

    // üìç Informaci√≥n de ubicaci√≥n
    let ubicacionInfo = "üìç Ubicaci√≥n no disponible";
    let mapsUrl = null;
    
    if (v.ubicacion) {
      if (v.ubicacion.direccion) {
        ubicacionInfo = `üìç ${v.ubicacion.direccion}`;
        if (v.ubicacion.metodo) {
          ubicacionInfo += ` (${v.ubicacion.metodo})`;
        }
      } else if (v.ubicacion.lat && v.ubicacion.lng) {
        ubicacionInfo = `üìç Coordenadas: ${v.ubicacion.lat.toFixed(6)}, ${v.ubicacion.lng.toFixed(6)}`;
        if (v.ubicacion.metodo) {
          ubicacionInfo += ` (${v.ubicacion.metodo})`;
        }
        // Crear URL de Google Maps
        mapsUrl = `https://www.google.com/maps?q=${v.ubicacion.lat},${v.ubicacion.lng}`;
      }
    }

    // üßæ Construir texto t√©rmico para Telegram (incluyendo ubicaci√≥n)
    let ticket = `
PROVEEDORA MATRIZ
MADERO 690 SUR, CENTRO
LINARES, NUEVO LE√ìN, 67700
RFC: PDD-031204-KL5
TEL: (821) 212-1805
R√âGIMEN GENERAL DE LEY
PERSONAS MORALES
--------------------------------
# Venta : ${folio}
Fecha   : ${v.fecha_txt}
Cliente : ${cliente}
--------------------------------
`;

    (v.detalle || []).forEach(it => {
      const nombre = (it.nombre || "").substring(0, 32);
      const cant = it.cantidad.toFixed(3).padStart(5, " ");
      const prec = it.precio_unit.toFixed(2).padStart(8, " ");
      const imp = it.importe.toFixed(2).padStart(9, " ");
      ticket += `${nombre}\n`;
      ticket += `Cant:${cant}  ${prec}  ${imp}\n`;
    });

    ticket += `--------------------------------
Subtotal : $${subtotal}
Desc. ${descPorc}% : $${desc}
Impuestos: $${imp}
Total    : $${total}
Su Pago  : $${pago}
Cambio   : $${cambio}
--------------------------------
Art√≠culos vendidos: ${articulos}
Incluye ${imp} de Impuestos
Cajero: ${cajero}
--------------------------------
${ubicacionInfo}
--------------------------------
¬°Gracias por su compra!
`;

    // ‚úâÔ∏è Enviar texto del ticket
    const ticketResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: CHAT_ID,
        text: "```" + ticket + "```",
        parse_mode: "Markdown"
      })
    });

    if (!ticketResponse.ok) {
      throw new Error(`Error enviando ticket: ${ticketResponse.status}`);
    }

    console.log("‚úÖ Ticket enviado a Telegram");

    // üìç Enviar ubicaci√≥n en Google Maps como mensaje SEPARADO si hay coordenadas
    if (mapsUrl) {
      console.log("üìç Enviando enlace de Google Maps:", mapsUrl);
      
      // Peque√±a pausa para evitar rate limiting
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const mapsResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: CHAT_ID,
          text: `üó∫Ô∏è *Ubicaci√≥n de la venta:*\n[Ver en Google Maps](${mapsUrl})`,
          parse_mode: "Markdown",
          disable_web_page_preview: false
        })
      });

      if (!mapsResponse.ok) {
        console.warn("‚ö†Ô∏è No se pudo enviar el enlace de Google Maps, pero el ticket se envi√≥ correctamente");
      } else {
        console.log("‚úÖ Enlace de Google Maps enviado");
      }
    }

    // üßæ Generar PDF opcional (para respaldo)
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      pdf.setFont("courier", "bold");
      pdf.setFontSize(11);
      let y = 10;
      ticket.split("\n").forEach(linea => {
        pdf.text(linea, 10, y);
        y += 5;
        if (y > 280) { pdf.addPage(); y = 10; }
      });
      const pdfBlob = pdf.output("blob");

      // Peque√±a pausa para evitar rate limiting
      await new Promise(resolve => setTimeout(resolve, 500));

      // üìé Enviar PDF como respaldo (opcional)
      const formData = new FormData();
      formData.append("chat_id", CHAT_ID);
      formData.append("document", pdfBlob, `Ticket_${folio}.pdf`);
      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, {
        method: "POST",
        body: formData
      });

      console.log("‚úÖ PDF enviado a Telegram");
    } catch (pdfErr) {
      console.warn("‚ö†Ô∏è Error generando/enviando PDF:", pdfErr);
    }

    console.log("‚úÖ Todo enviado correctamente a Telegram:", folio);
    
  } catch (err) {
    console.error("‚ùå Error enviando a Telegram:", err);

    // üö® NUEVO BLOQUE: si hay error, guardamos la venta pendiente
    if (!navigator.onLine || err.message.includes("Failed to fetch")) {
      guardarVentaPendiente(v);
      console.warn("üì¶ Venta guardada para reintento al reconectarse:", v.folio);
      toast("üì¶ Venta guardada localmente (sin conexi√≥n)", "#f59e0b");
    } else {
      console.warn("‚ö†Ô∏è Error no relacionado con conexi√≥n:", err.message);
    }
  }
}

/* ===========================================================
   üì¶ SECCI√ìN 13.1: MODO OFFLINE ‚Äì COLA DE ENV√çO TELEGRAM
   =========================================================== */

/**
 * Guarda una venta pendiente de enviar a Telegram.
 */
function guardarVentaPendiente(v) {
  try {
    const pendientes = JSON.parse(localStorage.getItem("ventas_pendientes_telegram") || "[]");
    pendientes.push(v);
    localStorage.setItem("ventas_pendientes_telegram", JSON.stringify(pendientes));
    console.warn("üì¶ Venta guardada en cola offline:", v.folio);
  } catch (err) {
    console.error("‚ùå Error guardando venta pendiente:", err);
  }
}

/**
 * Intenta reenviar todas las ventas pendientes cuando hay conexi√≥n.
 */
async function reenviarVentasPendientes() {
  const pendientes = JSON.parse(localStorage.getItem("ventas_pendientes_telegram") || "[]");
  if (pendientes.length === 0) return;

  console.log(`üì® Intentando reenviar ${pendientes.length} ventas pendientes...`);

  for (const v of pendientes) {
    try {
      await enviarTelegram(v);
      console.log("‚úÖ Venta reenviada:", v.folio);
    } catch (err) {
      console.error("‚ö†Ô∏è Fallo al reenviar:", v.folio, err);
      // Si vuelve a fallar, no la eliminamos a√∫n
      return;
    }
  }

  // Si todo sali√≥ bien, limpiamos la cola
  localStorage.removeItem("ventas_pendientes_telegram");
  console.log("üßπ Cola de ventas pendiente vaciada.");
}

/**
 * Detecta cuando vuelve la conexi√≥n y reintenta los env√≠os.
 */
window.addEventListener("online", () => {
  toast("‚úÖ Conexi√≥n restaurada. Reenviando ventas pendientes...", "#1e8e3e");
  setTimeout(reenviarVentasPendientes, 1000);
});

/* ===========================================================
   üßæ SECCI√ìN 14: TICKET VISUAL E IMPRESI√ìN
   =========================================================== */
function rellenarTicket(v){
  const t=v.resumen_financiero;
  const pago=parseFloat($("#montoRecibido").value)||0;
  const cambio=pago - t.total;
  $("#tFolio").textContent=v.folio;
  $("#tFecha").textContent=v.fecha_txt;
  $("#tCliente").textContent=v.cliente||"P√öBLICO EN GENERAL";
  $("#tSubtotal").textContent=money(t.subtotal);
  $("#tDescPorc").textContent=v.descuento_porcentaje+"%";
  $("#tDescMonto").textContent=money(v.descuento_monto);
  $("#tTotal").textContent=money(t.total);
  $("#tPago").textContent=money(pago);
  $("#tCambio").textContent=money(cambio>0?cambio:0);
  $("#tImpuestos").textContent=money(t.impuestos);
  $("#tArticulos").textContent=carrito.reduce((a,b)=>a+b.cantidad,0);
  $("#tCajero").textContent=USUARIO_LOGUEADO?.nombre || "‚Äî";

  const tbody=document.getElementById("tLineas");
  tbody.innerHTML="";
v.detalle.forEach(p => {
  const tr = document.createElement("tr");
const cantidad = p.cantidad ?? 0;
const precioUnit = p.precioUnit ?? p.precio_unit ?? 0;

// üí∏ Calcular precio unitario con descuento prorrateado
let precioConDesc = precioUnit;
if (v.descuento_porcentaje > 0) {
  const descFactor = (100 - v.descuento_porcentaje) / 100;
  precioConDesc = (precioUnit * descFactor);
}

// üí≤ Importe correcto
const importe = cantidad * precioConDesc;

  tr.innerHTML = `
    <td>${p.nombre}</td>
    <td style="text-align:center">${cantidad.toFixed(2)}</td>
    <td style="text-align:right">${precioUnit.toFixed(2)}</td>
    <td style="text-align:right">${importe.toFixed(2)}</td>`;
  tbody.appendChild(tr);
});

}

function imprimirTicketEstilado() {
  try {
    // üßÆ Funci√≥n auxiliar para formatear n√∫meros
    const formatoNum = n => (Number(n || 0)).toLocaleString("es-MX", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

// üì¶ Obtener datos de la venta actual
const folio = $("#tFolio").textContent.trim();
const fecha = $("#tFecha").textContent.trim();
const cliente = $("#tCliente").textContent.trim();

// üßÆ Totales reales provenientes del c√°lculo interno
const t = window.__ULTIMOS_TOTALES || {};
const subtotal = formatoNum(t.subtotal || 0);
const descPorc = $("#tDescPorc").textContent.trim();
const descMonto = formatoNum(t.descuento || 0);
const total = formatoNum(t.total || 0);
const impuestos = formatoNum(t.impuestos || 0);

const pago = $("#tPago").textContent.trim();
const cambio = $("#tCambio").textContent.trim();
const articulos = $("#tArticulos").textContent.trim();
const cajero = $("#tCajero").textContent.trim();

    // üßæ Construir texto del ticket en formato t√©rmico
    let ticket = `
PROVEEDORA MATRIZ
MADERO 690 SUR, CENTRO
LINARES, NUEVO LE√ìN, 67700
RFC: PDD-031204-KL5
TEL: (821) 212-1805
R√âGIMEN GENERAL DE LEY
PERSONAS MORALES
--------------------------------
# Venta : ${folio}
Fecha   : ${fecha}
Cliente : ${cliente}
--------------------------------
`;

    // üìã Detalle de productos
carrito.forEach(p => {
  const nombre = p.nombre.substring(0, 32);
  const cant = p.cantidad;
  const precioUnit = p.precioUnit;
  const importe = cant * precioUnit;

  // aplicar descuento igual que antes:
  let precioConDescuento = precioUnit;
  if (descPorc !== "0%") {
    const porc = parseFloat(descPorc.replace("%","")) || 0;
    precioConDescuento = precioUnit * ((100 - porc) / 100);
  }

  const impFinal = cant * precioConDescuento;

  ticket += `${nombre}\n`;
  ticket += `Cant:${String(cant).padStart(5)}  `
         + `${precioConDescuento.toFixed(2).padStart(8)}  `
         + `${impFinal.toFixed(2).padStart(9)}\n`;
});



    // üíµ Totales
    ticket += `--------------------------------
Subtotal: ${subtotal}
Desc. ${descPorc}: ${descMonto}
Total: ${total}
Su Pago: ${pago}
Cambio: ${cambio}
--------------------------------
Art√≠culos vendidos: ${articulos}
Incluye ${impuestos} de Impuestos
Cajero: ${cajero}
--------------------------------
¬°Gracias por su compra!
`;

    // üñ®Ô∏è Prioridad 1: InnerPrinter
    if (window.InnerPrinter) {
      try {
        if (typeof window.InnerPrinter.printText === "function") {
          window.InnerPrinter.printText(ticket);
          return;
        }
        if (typeof window.InnerPrinter.printHtml === "function") {
          window.InnerPrinter.printHtml(`<pre>${ticket}</pre>`);
          return;
        }
      } catch (err) {
        console.error("‚ùå Error con InnerPrinter:", err);
      }
    }

    // üñ®Ô∏è Prioridad 2: RawBT (Android)
    if (/Android/i.test(navigator.userAgent)) {
      try {
        const encoded = encodeURIComponent(ticket);
        window.location.href = `rawbt:print?data=${encoded}`;
        return;
      } catch (err) {
        console.error("‚ùå Error con RawBT:", err);
      }
    }

    // üñ®Ô∏è Prioridad 3: Impresi√≥n navegador (fallback)
    const w = window.open("", "_blank");
    w.document.write(`<pre style="font-family:monospace;font-size:13px;">${ticket}</pre>`);
    w.document.close();
    w.print();

  } catch (err) {
    console.error("‚ùå Error generando ticket:", err);
    alert("Error al generar ticket t√©rmico.");
  }
}

/* ===========================================================
   üôã‚Äç‚ôÇÔ∏è SECCI√ìN 15: CLIENTE P√öBLICO AUTOM√ÅTICO
   =========================================================== */
async function fijarClientePublico(){
  try{
    const q=query(collection(db,"clientes"),where("nombre","==","PUBLICO EN GENERAL"));
    const snap=await getDocs(q);
    if(!snap.empty){
      const c=snap.docs[0].data();
      clienteSeleccionado={id:snap.docs[0].id,nombre:c.nombre};
      const el=$("#cliente");
      el.value=c.nombre; el.readOnly=true;
      el.style.background="#e5e7eb"; el.style.color="#555";
    }
  }catch(e){console.warn("Cliente p√∫blico no encontrado");}
}
// üëá AGREGA ESTO AL FINAL
/* ===========================================================
   üåê SECCI√ìN 16: CONTROL DE CONEXI√ìN OFFLINE / ONLINE
   =========================================================== */
window.addEventListener("offline", () => {
  const aviso = document.createElement("div");
  aviso.textContent = "‚ö†Ô∏è Est√°s sin conexi√≥n. Las ventas se guardar√°n localmente.";
aviso.style.cssText = `
  position:fixed;top:0;left:0;right:0;
  background:#c0392b;color:#fff;padding:8px;text-align:center;
  font-size:13px;z-index:9999;transition:opacity .3s ease;
`;
  document.body.appendChild(aviso);
  setTimeout(()=>aviso.style.opacity=1,50);
  setTimeout(()=>{aviso.style.opacity=0;setTimeout(()=>aviso.remove(),400)},4000);

  console.warn("üö´ Sin conexi√≥n: las operaciones se almacenar√°n en IndexedDB");
});

window.addEventListener("online", () => {
  const aviso = document.createElement("div");
  aviso.textContent = "‚úÖ Conexi√≥n restaurada. Sincronizando ventas pendientes...";
  aviso.style.cssText = `
    position:fixed;bottom:15px;left:50%;transform:translateX(-50%);
    background:#1e8e3e;color:#fff;padding:10px 18px;
    border-radius:10px;font-size:14px;z-index:9999;
    box-shadow:0 2px 8px rgba(0,0,0,.3);opacity:0;
    transition:opacity .3s ease;
  `;
  document.body.appendChild(aviso);
  setTimeout(()=>aviso.style.opacity=1,50);
  setTimeout(()=>{aviso.style.opacity=0;setTimeout(()=>aviso.remove(),400)},4000);

  console.log("‚úÖ Conexi√≥n restaurada, Firestore volver√° a sincronizar autom√°ticamente.");
});
function toast(msg, color = "#0c6cbd") {
  const aviso = document.createElement("div");
  aviso.textContent = msg;
  aviso.style.cssText = `
    position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
    background:${color};color:#fff;padding:8px 14px;border-radius:10px;
    font-size:14px;z-index:9999;opacity:0;transition:opacity .3s ease;
    box-shadow:0 2px 8px rgba(0,0,0,.3);
  `;
  document.body.appendChild(aviso);
  setTimeout(()=>aviso.style.opacity=1,50);
  setTimeout(()=>{aviso.style.opacity=0;setTimeout(()=>aviso.remove(),400)},2500);
}
// ‚úÖ cierre del async
})(); 

</script>

<!-- üßæ BLOQUE 6: PLANTILLA DEL TICKET DE VENTA -->
<div id="ticketArea" style="display:none;">
  <div id="ticket" class="ticket" style="font-family:monospace;width:72mm;">
    <div style="text-align:center;margin-bottom:4px;">
      <div style="font-weight:bold;font-size:16px;">PROVEEDORA MATRIZ</div>
      <div style="font-size:13px;">MADERO 690 SUR, CENTRO</div>
      <div style="font-size:13px;">LINARES, NUEVO LEON, 67700</div>
      <div style="font-size:13px;">RFC: PDD-031204-KL5</div>
      <div style="font-size:13px;">TEL: (821) 212-1805</div>
      <div style="font-size:13px;">R√âGIMEN GENERAL DE LEY</div>
      <div style="font-size:13px;">PERSONAS MORALES</div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <div style="font-size:13px;">
      <div># Venta: <span id="tFolio"></span></div>
      <div>Fecha: <span id="tFecha"></span></div>
      <div>Cliente: <span id="tCliente">P√öBLICO EN GENERAL</span></div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <!-- üìã Tabla del ticket -->
    <table style="width:100%;font-size:13px;">
      <thead>
        <tr>
          <th style="text-align:left;">Descripci√≥n</th>
          <th style="text-align:center;">Cant</th>
          <th style="text-align:right;">P.Unit</th>
          <th style="text-align:right;">Importe</th>
        </tr>
      </thead>
      <tbody id="tLineas"></tbody>
    </table>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <!-- üíµ Totales -->
    <div style="font-size:13px;text-align:right;">
      <div>Subtotal: <span id="tSubtotal">$0.00</span></div>
      <div>Descuento <span id="tDescPorc">0%</span>: <span id="tDescMonto">$0.00</span></div>
      <div>Total: <span id="tTotal">$0.00</span></div>
      <div>Su Pago: <span id="tPago">$0.00</span></div>
      <div>Cambio: <span id="tCambio">$0.00</span></div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">

    <!-- üßæ Informaci√≥n adicional -->
    <div style="font-size:13px;">
      <div>Art√≠culos vendidos: <span id="tArticulos">0</span></div>
      <div>Incluye <span id="tImpuestos">$0.00</span> de Impuestos</div>
      <div>Cajero: <span id="tCajero">‚Äî</span></div>
    </div>

    <hr style="border:none;border-top:1px dashed #000;margin:6px 0;">
    <div style="text-align:center;font-size:13px;">¬°Gracias por su compra!</div>
  </div>
</div>

<!-- üì∑ BLOQUE 7: LECTOR DE C√ìDIGO QR -->
<div id="qrReaderContainer"
     style="display:none;flex-direction:column;align-items:center;justify-content:center;
            position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:3000;">
  <div id="reader"
       style="width:90%;max-width:360px;margin:auto;background:#fff;border-radius:12px;padding:8px;">
  </div>
  <button id="cerrarCam" class="btn" style="margin-top:12px;background:#c0392b;">Cerrar c√°mara</button>
  
</div>

<!-- üîπ BLOQUE 8: SERVICE WORKER Y LOGOUT -->
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js?v=8")
  .then(r=>console.log("‚úÖ Service Worker registrado:",r.scope))
  .catch(e=>console.error("‚ùå Error registrando SW:",e));
}

document.addEventListener("DOMContentLoaded",()=> {
  const b = document.getElementById("btnLogout");
  if (b) {
b.addEventListener("click", () => {

  // üõë PROTECCI√ìN: no permitir cerrar sesi√≥n durante cobro
  if (bloquearSiCobroActivo()) return;

  // SOLO BORRAR LA SESI√ìN
  localStorage.removeItem("usuario_ruta");
  document.body.classList.remove("sesion-activa");
  // üî• OCULTAR POS COMPLETO
  document.getElementById("posApp").style.display = "none";

  // üî• OCULTAR BARRA INFERIOR
  document.getElementById("bottomBar").style.display = "none";

  // üî• OCULTAR CARRITO FIJO
  document.getElementById("carrito-container").style.display = "none";

  // MOSTRAR LOGIN
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("loginUsuario").value = "";
  document.getElementById("loginPassword").value = "";
  document.getElementById("loginMsg").textContent = "";
  alert("Sesi√≥n cerrada correctamente.");
});

  }
});

  // üìä Acceso r√°pido al Resumen Diario
const btnResumen = document.getElementById("btnResumen");
if (btnResumen) {
  btnResumen.addEventListener("click", () => {

    if (bloquearSiCobroActivo()) return;

    const u = JSON.parse(localStorage.getItem("usuario_ruta") || "{}");

    if (!u || !u.id) {
      alert("‚ö†Ô∏è No hay usuario activo");
      return;
    }

    // üî• PASAMOS EL UID EXPL√çCITO
window.location.href = "ticketsresumen.html";

  });
}


</script>
<script>
// =====================================================
// üîÑ Reintento autom√°tico de sincronizaci√≥n de ventas
// =====================================================

// Cuando el navegador recupere conexi√≥n
window.addEventListener('online', async () => {
  try {
    // Verifica que existan SW y Background Sync
    if ('serviceWorker' in navigator && 'SyncManager' in window) {
      const reg = await navigator.serviceWorker.ready;
      await reg.sync.register('sync-ventas-pendientes');
      console.log('üì° Evento de sincronizaci√≥n registrado');
    } else {
      // Si el navegador no soporta SyncManager, fuerza reenv√≠o inmediato
      console.warn('‚ö†Ô∏è Background Sync no soportado, reenviando manualmente');
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ action: 'sincronizar' });
      }
    }
  } catch (err) {
    console.error('‚ùå Error al registrar sincronizaci√≥n:', err);
  }
});
</script>
<script>
// =====================================================
// üì¨ Receptor de mensajes del Service Worker
// =====================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.action === 'sincronizar') {
      console.log('üì¶ Orden recibida: sincronizar ventas pendientes');
      if (typeof reenviarVentasPendientes === 'function') {
        reenviarVentasPendientes(); // Llama tu funci√≥n de reenv√≠o
      } else {
        console.warn('‚ö†Ô∏è Funci√≥n reenviarVentasPendientes() no encontrada');
      }
    }
  });
}
</script>

<script>
/* ===========================================================
   üì∑ ESC√ÅNER QR CORREGIDO - FUNCIONAMIENTO COMPLETO
   =========================================================== */
document.addEventListener("DOMContentLoaded", function() {
  const btnCam = document.getElementById("btnCam");
  const camDiv = document.getElementById("qrReaderContainer");
  const cerrarCam = document.getElementById("cerrarCam");
  
  let html5QrCode = null;
  let escaneoExitoso = false;

// üöÄ Abrir c√°mara
  btnCam.addEventListener("click", async () => {
  if (bloquearSiCobroActivo()) return; // üõë Nuevo candado
    try {
      escaneoExitoso = false;
      camDiv.style.display = "flex";

      // üîπ Limpiar instancia previa
      if (html5QrCode) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
        } catch (e) {
          console.log("üßπ Limpiando instancia previa...");
        }
        html5QrCode = null;
      }

      // üïê Peque√±o delay para renderizado
      await new Promise(resolve => setTimeout(resolve, 100));

      // Verificar que la librer√≠a est√© cargada
      if (typeof Html5Qrcode === 'undefined') {
        alert("‚ùå Librer√≠a de esc√°ner no cargada. Verifica html5-qrcode.min.js");
        cerrarCamara();
        return;
      }

      html5QrCode = new Html5Qrcode("reader");

      // üîç Detectar c√°maras
      const devices = await Html5Qrcode.getCameras();
      if (!devices || devices.length === 0) {
        alert("‚ùå No se detect√≥ c√°mara disponible.");
        cerrarCamara();
        return;
      }

      // üé• Seleccionar c√°mara trasera o primera disponible
      const backCam = devices.find(d => /back|rear|environment/gi.test(d.label));
      const cameraId = backCam ? backCam.id : devices[0].id;

      // ‚öôÔ∏è Configuraci√≥n optimizada
      const config = {
        fps: 15,
        qrbox: { 
          width: 250, 
          height: 250 
        },
        aspectRatio: 1.0,
        focusMode: "continuous"
      };

      // üé¨ Iniciar esc√°ner
await html5QrCode.start(
  cameraId,
  config,
  async (decodedText) => {
    // ‚öôÔ∏è Bloqueo contra escaneos m√∫ltiples
    if (escaneoExitoso) return;
    escaneoExitoso = true;
    origenEscaneo = "camara"; // üî• CLAVE
    try {
      await html5QrCode.stop();
      html5QrCode.clear();
    } catch (e) {
      console.warn("‚ö†Ô∏è Error al detener lector:", e);
    }

    console.log("‚úÖ C√≥digo escaneado:", decodedText);
   if (escaneoExitoso) return;
escaneoExitoso = true;

origenEscaneo = "camara"; // üî• CLAVE

try {
  await html5QrCode.stop();
  html5QrCode.clear();
} catch (e) {}

beep(950, 0.1);

// ‚õî procesar UNA sola vez
procesarCodigoEscaneado(decodedText);

setTimeout(cerrarCamara, 500);

},
  (errorMessage) => {
    if (!errorMessage.includes("No QR code found")) {
      console.log("üîç Escaneando...", errorMessage);
    }
  }
);

      console.log("üì∑ C√°mara iniciada correctamente");

    } catch (err) {
      console.error("‚ùå Error iniciando c√°mara:", err);
      alert("No se pudo abrir la c√°mara: " + (err.message || err));
      cerrarCamara();
    }
  });

  // üö™ Funci√≥n para cerrar c√°mara correctamente
  async function cerrarCamara() {
    try {
      if (html5QrCode) {
        console.log("üõë Deteniendo c√°mara...");
        await html5QrCode.stop();
        html5QrCode.clear();
        html5QrCode = null;
      }
    } catch (stopErr) {
      console.log("‚ö†Ô∏è Error al detener c√°mara:", stopErr);
    } finally {
      camDiv.style.display = "none";
      escaneoExitoso = false;
      console.log("üì∑ C√°mara cerrada");
      
      // üîÑ Enfocar el buscador para continuar trabajando
      setTimeout(() => {
        if (buscador) buscador.focus();
      }, 300);
    }
  }

  // ‚ùå Cerrar manualmente
  if (cerrarCam) {
    cerrarCam.addEventListener("click", cerrarCamara);
  }

  // üéØ Cerrar al hacer clic fuera del lector
  camDiv.addEventListener("click", (e) => {
    if (e.target.id === "qrReaderContainer") {
      cerrarCamara();
    }
  });

});   // ‚úÖ ESTE CIERRE ES OBLIGATORIO
</script>
<style>
/* üé® ESTILOS MEJORADOS PARA EL ESC√ÅNER */
#qrReaderContainer {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 3000;
  backdrop-filter: blur(5px);
}

#reader {
  width: 90%;
  max-width: 400px;
  margin: auto;
  background: #fff;
  border-radius: 16px;
  padding: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

#cerrarCam {
  margin-top: 20px;
  background: #c0392b;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-size: 16px;
  transition: all 0.2s ease;
}

#cerrarCam:hover {
  background: #a93226;
  transform: scale(1.05);
}
</style>


<!-- üõ°Ô∏è BLOQUE 10: BLOQUEO DE SALIDA Y REFRESCO ACCIDENTAL -->
<script>
let bloqueoSalida=true;

// üö´ Bloquear F5 y Ctrl+R
window.addEventListener("keydown",e=>{
  if (!haySesionActiva()) return; // üîì login libre
  if(e.key==="F5" || (e.ctrlKey && e.key.toLowerCase()==="r")){
    e.preventDefault();
    alert("Usa el bot√≥n üö™ Salir para cerrar sesi√≥n correctamente.");
  }
});

// ‚ö†Ô∏è Confirmar antes de salir o recargar
window.addEventListener("beforeunload",e=>{
  if (!haySesionActiva()) return; // üîì login libre
  if(bloqueoSalida){
    e.preventDefault();
    e.returnValue="¬øDeseas salir del sistema?";
    return "¬øDeseas salir del sistema?";
  }
});

// ‚úÖ Al cerrar sesi√≥n, desbloquear salida
document.getElementById("btnLogout").addEventListener("click",()=>{
  bloqueoSalida = false;
});

// üöß GUARDI√ÅN GLOBAL ANTI-BUG ‚Äî Bloquea navegaci√≥n durante cobro
function bloquearSiCobroActivo() {
  const modal = document.getElementById("modalCobro");
  if (modal && modal.style.display === "flex") {
    toast("üö´ Finaliza la venta primero");
    return true;
  }
  return false;
}

  

</script>
<!-- üî¢ MODAL CANTIDAD PERSONALIZADO -->
<div id="modalCantidad" 
     style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
            z-index:4000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;width:80%;max-width:320px;
              text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.2);">
    <h3 style="margin-bottom:10px;color:#00416A;">Cantidad</h3>
    <input id="inputCantidadModal" type="number" inputmode="decimal" min="0" step="0.01"
           style="width:100%;padding:10px;font-size:18px;border-radius:8px;border:1px solid #ccc;text-align:center;">
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button id="btnCancelarCant" class="btn" style="background:#aaa;">Cancelar</button>
      <button id="btnAceptarCant" class="btn">Aceptar</button>
    </div>
  </div>
</div>

<style>
  /* üéØ Barra inferior fija profesional */
/* üö´ Barra inferior OCULTA por defecto */
#bottomBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg, #003366, #0c6cbd);
  display: none; /* üî• CLAVE */
  justify-content: space-around;
  align-items: center;
  padding: 10px 0;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.25);
  z-index: 9999;
}

/* ‚úÖ Visible SOLO cuando el body tiene sesi√≥n */
body.sesion-activa #bottomBar {
  display: flex;
}
  .bar-btn {
    flex: 1;
    margin: 0 6px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    color: white;
    background: linear-gradient(180deg, #0c6cbd, #00416A);
    font-size: 16px;
    padding: 10px 8px;
    transition: transform .15s ease, opacity .15s ease;
  }
  .bar-btn:active { transform: scale(0.95); opacity: 0.85; }
  .bar-btn.azul { background: linear-gradient(180deg, #0c6cbd, #00416A); }
  .bar-btn.rojo { background: linear-gradient(180deg, #c0392b, #8e2620); }
  
  
  /* üì± Adaptaci√≥n a m√≥vil */
  @media (max-width: 600px) {
    #bottomBar { padding: 8px 0; }
    .bar-btn { font-size: 14px; padding: 8px 4px; }
  }

</style>
<script>
document.getElementById("btnCorteRuta").addEventListener("click", () => {
  window.location.href = "corterutamovil.html";
});

</script>
<footer class="provsoft-footer">
  PROVSOFT POS ¬∑ v2.0 ¬∑ Commit 63c5c43
 ¬∑ ¬© ProvSoft
</footer>
<div class="snow"></div>
</body>
</html>

<!--
üìå NOTAS PROVSOFT ‚Äì 2025-12-15
--------------------------------
/*
üß† NOTA DESARROLLO ‚Äì BLOQUEO TEMPORAL DEL POS
--------------------------------------------
Se ajust√≥ el bloqueo de F5 / Ctrl+R / beforeunload
para permitir HARD REFRESH en la pantalla de LOGIN
mientras se realizan cambios y pruebas.

ESTE AJUSTE ES TEMPORAL.

CUANDO TERMINES EL DESARROLLO Y QUIERAS
BLINDAR TODO EL POS DE NUEVO:

üëâ BORRAR COMPLETAMENTE esta funci√≥n:
   function haySesionActiva() {
     return !!localStorage.getItem("usuario_ruta");
   }

üëâ BORRAR √öNICAMENTE estas dos l√≠neas (y solo estas):

   En el listener de keydown:
   if (!haySesionActiva()) return;

   En el listener de beforeunload:
   if (!haySesionActiva()) return;

üëâ Dejar el bloqueo GLOBAL como estaba originalmente
(sin distinguir login / sesi√≥n activa).

Estado actual del sistema:
- Login: refresh permitido (F5 / Ctrl+R / hard refresh)
- POS activo: refresh bloqueado
- Cobro activo: refresh bloqueado
- VERSION ACTUAL ESTABLE 7adaacf
- en prubas de la version 63c5c43

‚ö†Ô∏è IMPORTANTE:
No olvidar eliminar este ajuste antes de producci√≥n final
para mantener el POS totalmente blindado.
*/
