|<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CORTE DE RUTAS ‚Äì PROVEEDORA DE DULCES Y DESECHABLES</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- =============================================
       [1] ESTILOS GLOBALES Y TABLA
       ============================================= -->
  <style>
    body {font-family:'Poppins',sans-serif;background:#f5f7fa;padding:20px;color:#222;}
    h1 {color:#00416A;text-align:center;margin-bottom:10px;}
    select,input[type="date"]{display:block;margin:10px auto 20px auto;padding:8px 12px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
    table {width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,.1);}
    th,td{padding:10px 12px;border-bottom:1px solid #ddd;text-align:left;font-size:14px;}
    th{background:#00416A;color:#fff;}
    tr:hover{background:#f1f5f9;}
    button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:#0c6cbd;color:white;font-weight:600;}
    #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:3000;align-items:center;justify-content:center;color:white;font-size:18px;flex-direction:column;}
    .spinner{width:60px;height:60px;border:6px solid rgba(255,255,255,0.3);border-top:6px solid #0c6cbd;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;}
    @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
  </style>

  <!-- =============================================
       [2] LIBRER√çAS EXTERNAS
       ============================================= -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <h1>CORTE DE RUTAS ‚Äì PROVEEDORA DE DULCES Y DESECHABLES</h1>

  <!-- =============================================
       [3] CONTROLES DE FILTRO Y TABLA
       ============================================= -->
  <select id="selectRuta"><option value="">Selecciona una ruta...</option></select>
  <input type="date" id="selectFecha"/>

  <table id="tablaPendientes">
    <thead>
      <tr>
        <th>Usuario</th><th>Ruta</th><th>Fecha</th><th>Total D√≠a</th><th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody id="tbodyPendientes">
      <tr><td colspan="5" style="text-align:center;">Selecciona ruta y fecha</td></tr>
    </tbody>
  </table>

  <!-- =============================================
       [4] OVERLAY DE PROCESO
       ============================================= -->
  <div id="overlay">
    <div class="spinner"></div>
    Procesando corte...
    <div id="overlayText"></div>
  </div>

  <!-- =============================================
       [5] SCRIPT PRINCIPAL FIREBASE
       ============================================= -->
  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {getFirestore,collection,query,where,getDocs,addDoc,updateDoc,doc,serverTimestamp} 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // [5.1] Configuraci√≥n Firebase
    const firebaseConfig={
      apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain:"inventariopv-643f1.firebaseapp.com",
      projectId:"inventariopv-643f1",
      storageBucket:"inventariopv-643f1.appspot.com",
      messagingSenderId:"96242533231",
      appId:"1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app=initializeApp(firebaseConfig);
    const db=getFirestore(app);

    // [5.2] Referencias DOM
    const selectRuta=document.getElementById("selectRuta");
    const selectFecha=document.getElementById("selectFecha");
    const tbody=document.getElementById("tbodyPendientes");
    const overlay=document.getElementById("overlay");
    const overlayText=document.getElementById("overlayText");

    // ============================================================
    // [6] FUNCI√ìN: CARGAR RUTAS PENDIENTES
    // ============================================================
    async function cargarRutas(){
      const snap=await getDocs(collection(db,"ventas_rutav2"));
      const rutas={};
      snap.forEach(d=>{
        const v=d.data();
        if(!v.cortado&&v.rutaId){
          if(!rutas[v.rutaId]) rutas[v.rutaId]=v.usuarioNombre||"Desconocido";
        }
      });
      Object.entries(rutas).forEach(([id,nombre])=>{
        const opt=document.createElement("option");
        opt.value=id; opt.textContent=`${nombre} ‚Äì ${id}`;
        selectRuta.appendChild(opt);
      });
    }
    await cargarRutas();

    // ============================================================
    // [7] EVENTOS PRINCIPALES
    // ============================================================
    selectFecha.addEventListener("change",listarPendientes);
    selectRuta.addEventListener("change",listarPendientes);

    // ============================================================
    // [8] FUNCI√ìN: LISTAR PENDIENTES
    // ============================================================
    async function listarPendientes(){
      tbody.innerHTML="<tr><td colspan='5'>Buscando...</td></tr>";
      const ruta=selectRuta.value, fecha=selectFecha.value;
      if(!ruta||!fecha){
        tbody.innerHTML="<tr><td colspan='5' style='text-align:center;color:#999;'>Selecciona ruta y fecha</td></tr>";
        return;
      }
      const qv=query(collection(db,"ventas_rutav2"),where("rutaId","==",ruta),where("cortado","==",false));
      const snap=await getDocs(qv);
      const ventas=snap.docs.map(d=>({id:d.id,...d.data()}));

      const partes=fecha.split("-");
      const fechaRef=`${parseInt(partes[2])}/${parseInt(partes[1])}/${partes[0]}`;
      const ventasDia=ventas.filter(v=>v.fecha_txt?.startsWith(fechaRef)||v.fecha_txt?.includes(fechaRef));

      if(!ventasDia.length){
        tbody.innerHTML="<tr><td colspan='5' style='text-align:center;'>No hay pendientes</td></tr>";
        return;
      }

      const usuario=ventasDia[0].usuarioNombre||"‚Äî";
      const totalDia=ventasDia.reduce((sum,v)=>{
        const rf=v.resumen_financiero||{};
        return sum+(Number(rf.total)||0);
      },0);

      tbody.innerHTML=`
        <tr>
          <td>${usuario}</td><td>${ruta}</td><td>${fecha}</td>
          <td>$${totalDia.toFixed(2)}</td>
          <td><button id='btnCorte'>üìä Generar Corte</button></td>
        </tr>`;
      document.getElementById("btnCorte").onclick=()=>generarCorte(ruta,fecha,usuario);
    }

    // ============================================================
    // [9] FUNCI√ìN PRINCIPAL: GENERAR CORTE ANAL√çTICO
    // ============================================================
    async function generarCorte(rutaId,fechaSel,usuario){
      overlay.style.display="flex"; overlayText.innerText="Analizando ventas...";
      try{
        // [9.1] Consultar ventas
        const qv=query(collection(db,"ventas_rutav2"),where("rutaId","==",rutaId),where("cortado","==",false));
        const snap=await getDocs(qv);
        const ventas=snap.docs.map(d=>({id:d.id,...d.data()}));

        // [9.2] Filtrar por fecha
        const partes=fechaSel.split("-");
        const fechaRef=`${parseInt(partes[2])}/${parseInt(partes[1])}/${partes[0]}`;
        const ventasDia=ventas.filter(v=>v.fecha_txt?.startsWith(fechaRef)||v.fecha_txt?.includes(fechaRef));
        if(!ventasDia.length){overlayText.innerText="‚ö†Ô∏è No hay ventas para esa fecha.";return;}

        // [9.3] C√°lculos globales
        let totalDia=0,totalDescuento=0,utilidadTotal=0;
        const porDepto={},porArticulo={},porNota=[];

        for(const v of ventasDia){
          const rf=v.resumen_financiero||{};
          const total=Number(rf.total)||0;
          const descuento=Number(rf.descuento)||Number(v.descuento_monto)||0;
          const costo=Number(rf.costo_total)||0;
          const utilidad=Number(rf.utilidad_total)||total-costo;

          totalDia+=total; totalDescuento+=descuento; utilidadTotal+=utilidad;

          // [9.4] Detalle por departamento / art√≠culo
          for(const det of (v.detalle||[])){
            const dep=det.departamento_info?.nombre?.toUpperCase()||"SIN DEPTO";
            const importe=(det.importe||0)-(det.descuento_monto||0);
            const costoD=det.costo_total||det.costo_unit*(det.cantidad||1)||0;
            const utilD=det.utilidad||importe-costoD;
            const iva=det.iva_calculado||0; const ieps=det.ieps_calculado||0;

            if(!porDepto[dep]) porDepto[dep]={venta:0,costo:0,utilidad:0,impuestos:0};
            porDepto[dep].venta+=importe; porDepto[dep].costo+=costoD;
            porDepto[dep].utilidad+=utilD; porDepto[dep].impuestos+=iva+ieps;

            const art=det.nombre?.toUpperCase()||"SIN NOMBRE";
            if(!porArticulo[art]) porArticulo[art]={cantidad:0,importe:0,costo:0};
            porArticulo[art].cantidad+=det.cantidad||0;
            porArticulo[art].importe+=importe;
            porArticulo[art].costo+=costoD;
          }

          porNota.push({folio:v.folio||v.id,total,descuento,costo,utilidad,ubicacion:v.ubicacion||{}});
        }

        // [9.5] Construcci√≥n de resumen general
        const resumen={
          empresa:"PROVEEDORA DE DULCES Y DESECHABLES",usuario,rutaId,fecha:fechaSel,
          creado_por:usuario,creado_en:new Date().toISOString(),
          ventas_totales:ventasDia.length,departamentos_unicos:Object.keys(porDepto).length,
          articulos_unicos:Object.keys(porArticulo).length,totalDia,totalDescuento,utilidadTotal,
          margenGlobal:totalDia?((utilidadTotal/(totalDia-totalDescuento))*100).toFixed(2):0,
          detalle_ventas:ventasDia.map(v=>({
            folio:v.folio||v.id,fecha_txt:v.fecha_txt,total:v.resumen_financiero?.total||0,
            descuento:v.resumen_financiero?.descuento||0,costo:v.resumen_financiero?.costo_total||0,
            utilidad:v.resumen_financiero?.utilidad_total||0,metodo_pago:v.metodo_pago||"‚Äî",
            cliente:v.cliente_nombre||"‚Äî",usuarioNombre:v.usuarioNombre||usuario,detalle:v.detalle||[]
          })),
          porDepto,porArticulo,porNota
        };

        // [9.6] Guardar en Firestore
        overlayText.innerText="Guardando corte en Firestore...";
        await addDoc(collection(db,"cortes_globalesV4"),{
          rutaId,fecha:serverTimestamp(),fecha_corte:fechaSel,creado_en:new Date().toISOString(),
          realizado_por:usuario,resumen
        });

        // [9.7] Marcar ventas cortadas
        for(const v of ventasDia){await updateDoc(doc(db,"ventas_rutav2",v.id),{cortado:true});}

        // [9.8] Generar PDF
        overlayText.innerText="Generando PDF...";
        await generarPDF(resumen);
        overlayText.innerText="Corte completado ‚úÖ";
        await new Promise(r=>setTimeout(r,1200));
        overlay.style.display="none";
        alert("‚úÖ Corte generado y guardado correctamente");
      }catch(e){
        console.error(e);
        overlayText.innerText="‚ùå Error al generar el corte";
      }
    }
</script> 
<script>
async function generarPDF(r) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "mm", format: "letter" });

  const azul = "#0c6cbd";
  let y = 15;

  // ============================================================
  // ENCABEZADO
  // ============================================================
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(15);
  pdf.setTextColor(azul);
  pdf.text("CORTE DE RUTA ‚Äì PROVEEDORA DE DULCES Y DESECHABLES", 105, y, { align: "center" });
  y += 10;

  pdf.setFontSize(12);
  pdf.setTextColor("#000");
  pdf.text(`Usuario: ${r.usuario}`, 15, y); y += 6;
  pdf.text(`Ruta: ${r.rutaId}`, 15, y); y += 6;
  pdf.text(`Fecha: ${r.fecha}`, 15, y); y += 10;

  // ============================================================
  // TOTALES GENERALES
  // ============================================================
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(13);
  pdf.setTextColor(azul);
  pdf.text("RESUMEN GENERAL", 15, y);
  y += 7;

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(11);
  pdf.setTextColor("#000");

  const neto = r.totalDia - r.totalDescuento;
  const margen = neto > 0 ? ((r.utilidadTotal / neto) * 100).toFixed(2) + "%" : "‚Äî";

  pdf.text(`Total D√≠a: $${r.totalDia.toFixed(2)}`, 15, y);
  pdf.text(`Descuento Total: $${r.totalDescuento.toFixed(2)}`, 110, y); y += 6;
  pdf.text(`Venta Neta: $${neto.toFixed(2)}`, 15, y);
  pdf.text(`Utilidad Neta: $${r.utilidadTotal.toFixed(2)}`, 110, y); y += 6;
  pdf.text(`Margen Global: ${margen}`, 15, y); y += 10;

  // ============================================================
  // TABLA DEPARTAMENTOS
  // ============================================================
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(13);
  pdf.setTextColor(azul);
  pdf.text("VENTA POR DEPARTAMENTO", 15, y);
  y += 8;

  // Encabezado tabla
  pdf.setFillColor(12, 108, 189);
  pdf.setTextColor(255, 255, 255);
  pdf.rect(10, y, 190, 6, "F");

  pdf.text("Departamento", 12, y + 4);
  pdf.text("Venta", 75, y + 4, { align: "right" });
  pdf.text("Imp.", 105, y + 4, { align: "right" });
  pdf.text("Total", 130, y + 4, { align: "right" });
  pdf.text("Costo", 155, y + 4, { align: "right" });
  pdf.text("Utilidad", 180, y + 4, { align: "right" });

  y += 8;
  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(10);
  pdf.setTextColor("#000");

  let sumVenta = 0, sumImp = 0, sumCosto = 0, sumUtil = 0;

  for (const [dep, d] of Object.entries(r.porDepto)) {
    const venta = d.venta || 0;
    const imp = d.impuestos || 0;
    const total = venta;
    const costo = d.costo || 0;
    const util = d.utilidad || 0;

    sumVenta += venta;
    sumImp += imp;
    sumCosto += costo;
    sumUtil += util;

    if (y > 260) { pdf.addPage(); y = 20; }

    pdf.text(dep.substring(0, 25), 12, y);
    pdf.text(`$${venta.toFixed(2)}`, 75, y, { align: "right" });
    pdf.text(`$${imp.toFixed(2)}`, 105, y, { align: "right" });
    pdf.text(`$${total.toFixed(2)}`, 130, y, { align: "right" });
    pdf.text(`$${costo.toFixed(2)}`, 155, y, { align: "right" });
    pdf.text(`$${util.toFixed(2)}`, 180, y, { align: "right" });

    y += 6;
  }

  // Totales tabla
  pdf.setFillColor(220, 220, 220);
  pdf.rect(10, y - 4, 190, 7, "F");
  pdf.setFont("helvetica", "bold");
  pdf.text("TOT.", 12, y);
  pdf.text(`$${sumVenta.toFixed(2)}`, 75, y, { align: "right" });
  pdf.text(`$${sumImp.toFixed(2)}`, 105, y, { align: "right" });
  pdf.text(`$${sumVenta.toFixed(2)}`, 130, y, { align: "right" });
  pdf.text(`$${sumCosto.toFixed(2)}`, 155, y, { align: "right" });
  pdf.text(`$${sumUtil.toFixed(2)}`, 180, y, { align: "right" });

  // ============================================================
  // TABLA DE ART√çCULOS (TOP 80)
  // ============================================================
  pdf.addPage();
  y = 15;

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(13);
  pdf.setTextColor(azul);
  pdf.text("ART√çCULOS (TOP 80)", 15, y);
  y += 8;

  pdf.setFillColor(12, 108, 189);
  pdf.setTextColor(255, 255, 255);
  pdf.rect(10, y, 190, 6, "F");

  pdf.text("Art√≠culo", 12, y + 4);
  pdf.text("Cant.", 70, y + 4, { align: "right" });
  pdf.text("Venta", 105, y + 4, { align: "right" });
  pdf.text("Costo", 140, y + 4, { align: "right" });
  pdf.text("Util.", 180, y + 4, { align: "right" });

  y += 8;
  pdf.setFontSize(10);
  pdf.setTextColor("#000");

  const listaArticulos = Object.entries(r.porArticulo)
    .sort((a, b) => b[1].importe - a[1].importe)
    .slice(0, 80);

  for (const [name, d] of listaArticulos) {
    if (y > 260) { pdf.addPage(); y = 20; }

    pdf.text(name.substring(0, 38), 12, y);
    pdf.text(`${d.cantidad}`, 70, y, { align: "right" });
    pdf.text(`$${d.importe.toFixed(2)}`, 105, y, { align: "right" });
    pdf.text(`$${d.costo.toFixed(2)}`, 140, y, { align: "right" });
    pdf.text(`$${(d.importe - d.costo).toFixed(2)}`, 180, y, { align: "right" });

    y += 6;
  }

  // ============================================================
  // TABLA DE TICKETS
  // ============================================================
  pdf.addPage();
  y = 15;

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(13);
  pdf.setTextColor(azul);
  pdf.text(`RESUMEN DE TICKETS ‚Äì ${r.fecha}`, 15, y);
  y += 8;

  pdf.setFillColor(12, 108, 189);
  pdf.setTextColor(255, 255, 255);
  pdf.rect(10, y, 190, 6, "F");

  pdf.text("Folio", 12, y + 4);
  pdf.text("Hora", 42, y + 4);
  pdf.text("Total", 100, y + 4, { align: "right" });
  pdf.text("Costo", 140, y + 4, { align: "right" });
  pdf.text("Util.", 180, y + 4, { align: "right" });

  y += 8;
  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(10);
  pdf.setTextColor("#000");

  let totVenta = 0, totCosto = 0, totUtil = 0;

  for (const t of r.detalle_ventas) {
    if (y > 260) { pdf.addPage(); y = 20; }

    const folio = t.folio || "‚Äî";
    const hora = (t.fecha_txt || "").split(" ")[1] || "‚Äî";
    const tot = t.total || 0;
    const costo = t.costo || 0;
    const util = tot - costo;

    totVenta += tot;
    totCosto += costo;
    totUtil += util;

    pdf.text(folio.substring(0, 12), 12, y);
    pdf.text(hora, 42, y);
    pdf.text(`$${tot.toFixed(2)}`, 100, y, { align: "right" });
    pdf.text(`$${costo.toFixed(2)}`, 140, y, { align: "right" });
    pdf.text(`$${util.toFixed(2)}`, 180, y, { align: "right" });

    y += 6;
  }

  // Totales tickets
  pdf.setFillColor(220, 220, 220);
  pdf.rect(10, y - 4, 190, 7, "F");
  pdf.setFont("helvetica", "bold");
  pdf.text("TOTALES", 12, y);
  pdf.text(`$${totVenta.toFixed(2)}`, 100, y, { align: "right" });
  pdf.text(`$${totCosto.toFixed(2)}`, 140, y, { align: "right" });
  pdf.text(`$${totUtil.toFixed(2)}`, 180, y, { align: "right" });

  // ============================================================
  // EXPORTAR PDF Y ENVIAR A TELEGRAM
  // ============================================================
  const blob = pdf.output("blob");

  await enviarTelegram(
    blob,
    `Corte_${r.rutaId}_${r.fecha}.pdf`,
    `üì¶ Corte de Ruta\nüë§ ${r.usuario}\nüöö Ruta ${r.rutaId}\nüí∞ Total D√≠a $${r.totalDia.toFixed(2)}\nüìä Utilidad $${r.utilidadTotal.toFixed(2)}`
  );

  // Abrir en pesta√±a para prueba
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
}

// ============================================================
// ENVIAR A TELEGRAM
// ============================================================
async function enviarTelegram(pdfBlob, nombre, caption) {
  const BOT = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
  const CHAT = "6617988297";

  const f = new FormData();
  f.append("chat_id", CHAT);
  f.append("caption", caption);
  f.append("document", pdfBlob, nombre);

  try { await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, { method: "POST", body: f }); }
  catch (e) { console.error("Telegram error", e); }
}
</script>

</body>
</html>
