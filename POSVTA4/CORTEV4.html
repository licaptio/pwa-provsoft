<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cortes de Rutas â€“ PROVSOFT</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #222;
    }
    h1 { color: #00416A; text-align:center; margin-bottom:10px; }
    select, input[type="date"] {
      display:block; margin:10px auto 20px auto;
      padding:8px 12px; border-radius:6px; border:1px solid #ccc;
      font-size:14px;
    }
    table {
      width: 100%; border-collapse: collapse; background:#fff;
      border-radius: 10px; overflow:hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background: #00416A; color: #fff; }
    tr:hover { background: #f1f5f9; }
    button {
      padding: 6px 10px; border:none; border-radius:6px; cursor:pointer;
      background:#0c6cbd; color:white; font-weight:600;
    }
    #overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:3000;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:18px;
      flex-direction:column;
    }
    .spinner {
      width:60px; height:60px;
      border:6px solid rgba(255,255,255,0.3);
      border-top:6px solid #0c6cbd;
      border-radius:50%;
      animation: spin 1s linear infinite;
      margin-bottom:20px;
    }
    @keyframes spin { from { transform:rotate(0deg);} to { transform:rotate(360deg);} }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<h1>CORTE DE RUTAS â€“ PROVEEDORA DE DULCES Y DESECHABLES</h1>
<select id="selectRuta"><option value="">Selecciona una ruta...</option></select>
<input type="date" id="selectFecha" />
<table id="tablaPendientes">
  <thead><tr><th>Usuario</th><th>Ruta</th><th>Fecha</th><th>AcciÃ³n</th></tr></thead>
  <tbody id="tbodyPendientes"><tr><td colspan="4" style="text-align:center;">Selecciona ruta y fecha</td></tr></tbody>
</table>

<div id="overlay"><div class="spinner"></div>Procesando corte...<div id="overlayText"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const selectRuta = document.getElementById("selectRuta");
const selectFecha = document.getElementById("selectFecha");
const tbody = document.getElementById("tbodyPendientes");
const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");

await cargarRutas();

async function cargarRutas(){
  const snap = await getDocs(collection(db,"ventas_rutav2","DOpT5m1VoQOYDJPXzpWI","ventas"));
  const rutas = {};
  snap.forEach(d=>{
    const v=d.data();
    if(!v.cortado && v.rutaId){
      if(!rutas[v.rutaId]) rutas[v.rutaId]=v.usuarioNombre||"Desconocido";
    }
  });
  Object.entries(rutas).forEach(([id,nombre])=>{
    const opt=document.createElement("option");
    opt.value=id; opt.textContent=`${nombre} â€“ ${id}`;
    selectRuta.appendChild(opt);
  });
}

selectFecha.addEventListener("change",listarPendientes);
selectRuta.addEventListener("change",listarPendientes);

async function listarPendientes(){
  tbody.innerHTML="<tr><td colspan='4'>Buscando...</td></tr>";
  const ruta=selectRuta.value, fecha=selectFecha.value;
  if(!ruta||!fecha){tbody.innerHTML="<tr><td colspan='4' style='text-align:center;color:#999;'>Selecciona ruta y fecha</td></tr>";return;}
  const qv=query(collection(db,"ventas_rutav2","DOpT5m1VoQOYDJPXzpWI","ventas"),
                where("rutaId","==",ruta),where("cortado","==",false));
  const snap=await getDocs(qv);
  const ventas=snap.docs.map(d=>({id:d.id,...d.data()}));
  const fechaStr=fecha.replaceAll("-","/");
  const ventasDia=ventas.filter(v=>v.fecha_txt?.startsWith(fechaStr)||v.fecha_txt?.includes(fechaStr));
  if(!ventasDia.length){tbody.innerHTML="<tr><td colspan='4' style='text-align:center;'>No hay pendientes</td></tr>";return;}
  const usuario=ventasDia[0].usuarioNombre||"â€”";
  tbody.innerHTML=`<tr><td>${usuario}</td><td>${ruta}</td><td>${fecha}</td>
  <td><button id='btnCorte'>ðŸ“Š Generar Corte</button></td></tr>`;
  document.getElementById("btnCorte").onclick=()=>generarCorte(ruta,fecha,usuario);
}

async function generarCorte(rutaId,fechaSel,usuario){
  overlay.style.display="flex"; overlayText.innerText="Analizando ventas...";
  const qv=query(collection(db,"ventas_rutav2","DOpT5m1VoQOYDJPXzpWI","ventas"),
                where("rutaId","==",rutaId),where("cortado","==",false));
  const snap=await getDocs(qv);
  const ventas=snap.docs.map(d=>({id:d.id,...d.data()}));
  const ventasDia=ventas.filter(v=>v.fecha_txt?.startsWith(fechaSel.split("-").reverse().join("/")));
  if(!ventasDia.length){overlayText.innerText="No hay ventas para ese dÃ­a.";return;}
  let totalDia=0, totalDescuento=0, utilidadTotal=0, porDepto={}, porArticulo={}, porNota=[];
  for(const v of ventasDia){
    const rf=v.resumen_financiero||{};
    const total=Number(rf.total)||0;
    const desc=Number(rf.descuento)||Number(v.descuento_monto)||0;
    const costo=Number(rf.costo_total)||0;
    const utilidad=Number(rf.utilidad_total)||total-costo;
    totalDia+=total; totalDescuento+=desc; utilidadTotal+=utilidad;

    for(const det of (v.detalle||[])){
      const dep=det.departamento_info?.nombre?.toUpperCase()||"SIN DEPTO";
      const importe=(det.importe||0)-(det.descuento_monto||0);
      const costoD=det.costo_total||det.costo_unit*(det.cantidad||1)||0;
      const utilD=det.utilidad||importe-costoD;
      if(!porDepto[dep]) porDepto[dep]={venta:0,costo:0,utilidad:0,impuestos:0};
      porDepto[dep].venta+=importe;
      porDepto[dep].costo+=costoD;
      porDepto[dep].utilidad+=utilD;
      porDepto[dep].impuestos+=(det.iva_calculado||0)+(det.ieps_calculado||0);

      const art=det.nombre?.toUpperCase()||"SIN NOMBRE";
      if(!porArticulo[art]) porArticulo[art]={cantidad:0,importe:0,costo:0};
      porArticulo[art].cantidad+=det.cantidad||0;
      porArticulo[art].importe+=importe;
      porArticulo[art].costo+=costoD;
    }

    porNota.push({
      folio:v.folio||v.id,
      total,
      descuento:desc,
      costo:rf.costo_total||0,
      utilidad:rf.utilidad_total||0,
      ubicacion:v.ubicacion||{}
    });
  }
  const resumen={usuario,rutaId,fecha:fechaSel,totalDia,totalDescuento,utilidadTotal,porDepto,porArticulo,porNota};
  await addDoc(collection(db,"cortes_globales"),{
    rutaId,fecha:serverTimestamp(),fecha_corte:fechaSel,
    creado_en:new Date().toISOString(),
    realizado_por:usuario,
    resumen
  });
  for(const v of ventasDia){await updateDoc(doc(db,"ventas_rutav2","DOpT5m1VoQOYDJPXzpWI","ventas",v.id),{cortado:true});}
  await generarPDF(resumen);
  overlay.style.display="none";
  alert("âœ… Corte generado correctamente");
}

async function generarPDF(r){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({format:"letter",unit:"mm"});
  pdf.setFont("helvetica","bold");
  pdf.setFontSize(14);
  pdf.text("CORTE DE RUTAS â€“ PROVEEDORA DE DULCES Y DESECHABLES",10,15);
  pdf.setFontSize(12);
  pdf.text(`Usuario: ${r.usuario}`,15,25);
  pdf.text(`Ruta: ${r.rutaId}`,15,32);
  pdf.text(`Fecha: ${r.fecha}`,15,39);
  pdf.text(`Total DÃ­a: $${r.totalDia.toFixed(2)}`,15,46);
  pdf.text(`Descuento Total: $${r.totalDescuento.toFixed(2)}`,15,53);
  const neto=r.totalDia-r.totalDescuento;
  pdf.text(`Venta Neta: $${neto.toFixed(2)}  Utilidad: $${r.utilidadTotal.toFixed(2)}`,15,60);
  pdf.text(`Margen: ${(r.utilidadTotal/neto*100).toFixed(2)}%`,15,67);
  let y=80;
  pdf.setFontSize(10);
  pdf.text("DEPARTAMENTO",10,y); pdf.text("VENTA NETA",70,y); pdf.text("COSTO",110,y); pdf.text("UTILIDAD",150,y); y+=5;
  for(const [dep,v] of Object.entries(r.porDepto)){
    if(y>260){pdf.addPage(); y=20;}
    pdf.text(dep.substring(0,28),10,y);
    pdf.text(`$${v.venta.toFixed(2)}`,70,y);
    pdf.text(`$${v.costo.toFixed(2)}`,110,y);
    pdf.text(`$${v.utilidad.toFixed(2)}`,150,y);
    y+=5;
  }
  const blob=pdf.output("blob");
  const url=URL.createObjectURL(blob);
  window.open(url,"_blank");
  await enviarTelegram(blob,`Corte_${r.rutaId}_${r.fecha}.pdf`,
  `ðŸ“¦ Corte ${r.usuario}\nTotal: $${r.totalDia.toFixed(2)}\nDescuento: $${r.totalDescuento.toFixed(2)}\nUtilidad: $${r.utilidadTotal.toFixed(2)}`);
}

async function enviarTelegram(pdfBlob,nombre,caption){
  const BOT="8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
  const CHAT="6617988297";
  const f=new FormData();
  f.append("chat_id",CHAT);
  f.append("caption",caption);
  f.append("document",pdfBlob,nombre);
  try{await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`,{method:"POST",body:f});}
  catch(e){console.error("Telegram error",e);}
}
</script>
</body>
</html>
