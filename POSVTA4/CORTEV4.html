<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CORTE DE RUTAS ‚Äì PROVEEDORA DE DULCES Y DESECHABLES</title>
  <meta name="theme-color" content="#0c6cbd">
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- =============================================
       [1] ESTILOS GLOBALES Y TABLA
       ============================================= -->
  <style>
    body {font-family:'Poppins',sans-serif;background:#f5f7fa;padding:20px;color:#222;}
    h1 {color:#00416A;text-align:center;margin-bottom:10px;}
    select,input[type="date"]{display:block;margin:10px auto 20px auto;padding:8px 12px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
    table {width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,.1);}
    th,td{padding:10px 12px;border-bottom:1px solid #ddd;text-align:left;font-size:14px;}
    th{background:#00416A;color:#fff;}
    tr:hover{background:#f1f5f9;}
    button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:#0c6cbd;color:white;font-weight:600;}
    #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:3000;align-items:center;justify-content:center;color:white;font-size:18px;flex-direction:column;}
    .spinner{width:60px;height:60px;border:6px solid rgba(255,255,255,0.3);border-top:6px solid #0c6cbd;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;}
    @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
  </style>

  <!-- =============================================
       [2] LIBRER√çAS EXTERNAS
       ============================================= -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <h1>CORTE DE RUTAS ‚Äì PROVEEDORA DE DULCES Y DESECHABLES</h1>

  <!-- =============================================
       [3] CONTROLES DE FILTRO Y TABLA
       ============================================= -->
  <select id="selectRuta"><option value="">Selecciona una ruta...</option></select>
  <input type="date" id="selectFecha"/>

  <table id="tablaPendientes">
    <thead>
      <tr>
        <th>Usuario</th><th>Ruta</th><th>Fecha</th><th>Total D√≠a</th><th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody id="tbodyPendientes">
      <tr><td colspan="5" style="text-align:center;">Selecciona ruta y fecha</td></tr>
    </tbody>
  </table>

  <!-- =============================================
       [4] OVERLAY DE PROCESO
       ============================================= -->
  <div id="overlay">
    <div class="spinner"></div>
    Procesando corte...
    <div id="overlayText"></div>
  </div>

  <!-- =============================================
       [5] SCRIPT PRINCIPAL FIREBASE
       ============================================= -->
  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {getFirestore,collection,query,where,getDocs,addDoc,updateDoc,doc,serverTimestamp} 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // [5.1] Configuraci√≥n Firebase
    const firebaseConfig={
      apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain:"inventariopv-643f1.firebaseapp.com",
      projectId:"inventariopv-643f1",
      storageBucket:"inventariopv-643f1.appspot.com",
      messagingSenderId:"96242533231",
      appId:"1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app=initializeApp(firebaseConfig);
    const db=getFirestore(app);

    // [5.2] Referencias DOM
    const selectRuta=document.getElementById("selectRuta");
    const selectFecha=document.getElementById("selectFecha");
    const tbody=document.getElementById("tbodyPendientes");
    const overlay=document.getElementById("overlay");
    const overlayText=document.getElementById("overlayText");

    // ============================================================
    // [6] FUNCI√ìN: CARGAR RUTAS PENDIENTES
    // ============================================================
    async function cargarRutas(){
      const snap=await getDocs(collection(db,"ventas_rutav2"));
      const rutas={};
      snap.forEach(d=>{
        const v=d.data();
        if(!v.cortado&&v.rutaId){
          if(!rutas[v.rutaId]) rutas[v.rutaId]=v.usuarioNombre||"Desconocido";
        }
      });
      Object.entries(rutas).forEach(([id,nombre])=>{
        const opt=document.createElement("option");
        opt.value=id; opt.textContent=`${nombre} ‚Äì ${id}`;
        selectRuta.appendChild(opt);
      });
    }
    await cargarRutas();

    // ============================================================
    // [7] EVENTOS PRINCIPALES
    // ============================================================
    selectFecha.addEventListener("change",listarPendientes);
    selectRuta.addEventListener("change",listarPendientes);

    // ============================================================
    // [8] FUNCI√ìN: LISTAR PENDIENTES
    // ============================================================
    async function listarPendientes(){
      tbody.innerHTML="<tr><td colspan='5'>Buscando...</td></tr>";
      const ruta=selectRuta.value, fecha=selectFecha.value;
      if(!ruta||!fecha){
        tbody.innerHTML="<tr><td colspan='5' style='text-align:center;color:#999;'>Selecciona ruta y fecha</td></tr>";
        return;
      }
      const qv=query(collection(db,"ventas_rutav2"),where("rutaId","==",ruta),where("cortado","==",false));
      const snap=await getDocs(qv);
      const ventas=snap.docs.map(d=>({id:d.id,...d.data()}));

      const partes=fecha.split("-");
      const fechaRef=`${parseInt(partes[2])}/${parseInt(partes[1])}/${partes[0]}`;
      const ventasDia=ventas.filter(v=>v.fecha_txt?.startsWith(fechaRef)||v.fecha_txt?.includes(fechaRef));

      if(!ventasDia.length){
        tbody.innerHTML="<tr><td colspan='5' style='text-align:center;'>No hay pendientes</td></tr>";
        return;
      }

      const usuario=ventasDia[0].usuarioNombre||"‚Äî";
      const totalDia=ventasDia.reduce((sum,v)=>{
        const rf=v.resumen_financiero||{};
        return sum+(Number(rf.total)||0);
      },0);

      tbody.innerHTML=`
        <tr>
          <td>${usuario}</td><td>${ruta}</td><td>${fecha}</td>
          <td>$${totalDia.toFixed(2)}</td>
          <td><button id='btnCorte'>üìä Generar Corte</button></td>
        </tr>`;
      document.getElementById("btnCorte").onclick=()=>generarCorte(ruta,fecha,usuario);
    }

    // ============================================================
    // [9] FUNCI√ìN PRINCIPAL: GENERAR CORTE ANAL√çTICO
    // ============================================================
    async function generarCorte(rutaId,fechaSel,usuario){
      overlay.style.display="flex"; overlayText.innerText="Analizando ventas...";
      try{
        // [9.1] Consultar ventas
        const qv=query(collection(db,"ventas_rutav2"),where("rutaId","==",rutaId),where("cortado","==",false));
        const snap=await getDocs(qv);
        const ventas=snap.docs.map(d=>({id:d.id,...d.data()}));

        // [9.2] Filtrar por fecha
        const partes=fechaSel.split("-");
        const fechaRef=`${parseInt(partes[2])}/${parseInt(partes[1])}/${partes[0]}`;
        const ventasDia=ventas.filter(v=>v.fecha_txt?.startsWith(fechaRef)||v.fecha_txt?.includes(fechaRef));
        if(!ventasDia.length){overlayText.innerText="‚ö†Ô∏è No hay ventas para esa fecha.";return;}

        // [9.3] C√°lculos globales
        let totalDia=0,totalDescuento=0,utilidadTotal=0;
        const porDepto={},porArticulo={},porNota=[];

        for(const v of ventasDia){
          const rf=v.resumen_financiero||{};
          const total=Number(rf.total)||0;
          const descuento=Number(rf.descuento)||Number(v.descuento_monto)||0;
          const costo=Number(rf.costo_total)||0;
          const utilidad=Number(rf.utilidad_total)||total-costo;

          totalDia+=total; totalDescuento+=descuento; utilidadTotal+=utilidad;

          // [9.4] Detalle por departamento / art√≠culo
          for(const det of (v.detalle||[])){
            const dep=det.departamento_info?.nombre?.toUpperCase()||"SIN DEPTO";
            const importe=(det.importe||0)-(det.descuento_monto||0);
            const costoD=det.costo_total||det.costo_unit*(det.cantidad||1)||0;
            const utilD=det.utilidad||importe-costoD;
            const iva=det.iva_calculado||0; const ieps=det.ieps_calculado||0;

            if(!porDepto[dep]) porDepto[dep]={venta:0,costo:0,utilidad:0,impuestos:0};
            porDepto[dep].venta+=importe; porDepto[dep].costo+=costoD;
            porDepto[dep].utilidad+=utilD; porDepto[dep].impuestos+=iva+ieps;

            const art=det.nombre?.toUpperCase()||"SIN NOMBRE";
            if(!porArticulo[art]) porArticulo[art]={cantidad:0,importe:0,costo:0};
            porArticulo[art].cantidad+=det.cantidad||0;
            porArticulo[art].importe+=importe;
            porArticulo[art].costo+=costoD;
          }

          porNota.push({folio:v.folio||v.id,total,descuento,costo,utilidad,ubicacion:v.ubicacion||{}});
        }

        // [9.5] Construcci√≥n de resumen general
        const resumen={
          empresa:"PROVEEDORA DE DULCES Y DESECHABLES",usuario,rutaId,fecha:fechaSel,
          creado_por:usuario,creado_en:new Date().toISOString(),
          ventas_totales:ventasDia.length,departamentos_unicos:Object.keys(porDepto).length,
          articulos_unicos:Object.keys(porArticulo).length,totalDia,totalDescuento,utilidadTotal,
          margenGlobal:totalDia?((utilidadTotal/(totalDia-totalDescuento))*100).toFixed(2):0,
          detalle_ventas:ventasDia.map(v=>({
            folio:v.folio||v.id,fecha_txt:v.fecha_txt,total:v.resumen_financiero?.total||0,
            descuento:v.resumen_financiero?.descuento||0,costo:v.resumen_financiero?.costo_total||0,
            utilidad:v.resumen_financiero?.utilidad_total||0,metodo_pago:v.metodo_pago||"‚Äî",
            cliente:v.cliente_nombre||"‚Äî",usuarioNombre:v.usuarioNombre||usuario,detalle:v.detalle||[]
          })),
          porDepto,porArticulo,porNota
        };

        // [9.6] Guardar en Firestore
        overlayText.innerText="Guardando corte en Firestore...";
        await addDoc(collection(db,"cortes_globalesV4"),{
          rutaId,fecha:serverTimestamp(),fecha_corte:fechaSel,creado_en:new Date().toISOString(),
          realizado_por:usuario,resumen
        });

        // [9.7] Marcar ventas cortadas
        for(const v of ventasDia){await updateDoc(doc(db,"ventas_rutav2",v.id),{cortado:true});}

        // [9.8] Generar PDF
        overlayText.innerText="Generando PDF...";
        await generarPDF(resumen);
        overlayText.innerText="Corte completado ‚úÖ";
        await new Promise(r=>setTimeout(r,1200));
        overlay.style.display="none";
        alert("‚úÖ Corte generado y guardado correctamente");
      }catch(e){
        console.error(e);
        overlayText.innerText="‚ùå Error al generar el corte";
      }
    }

    // ============================================================
    // [10] FUNCI√ìN: GENERAR PDF DEL CORTE
    // ============================================================
    async function generarPDF(r){
      const {jsPDF}=window.jspdf;
      const pdf=new jsPDF({format:"letter",unit:"mm"});

      // [10.1] Encabezado
      pdf.setFont("helvetica","bold");pdf.setFontSize(14);
      pdf.text("CORTE DE RUTAS ‚Äì PROVEEDORA DE DULCES Y DESECHABLES",10,15);
      pdf.setFontSize(12);
      pdf.text(`Usuario: ${r.usuario}`,15,25);
      pdf.text(`Ruta: ${r.rutaId}`,15,32);
      pdf.text(`Fecha: ${r.fecha}`,15,39);

      // [10.2] Totales
      const neto=r.totalDia-r.totalDescuento;
      pdf.text(`Total D√≠a: $${r.totalDia.toFixed(2)}`,15,46);
      pdf.text(`Descuento Total: $${r.totalDescuento.toFixed(2)}`,15,53);
      pdf.text(`Venta Neta: $${neto.toFixed(2)}`,15,60);
      pdf.text(`Utilidad Neta: $${r.utilidadTotal.toFixed(2)}`,15,67);
      const margenTotal=neto>0?((r.utilidadTotal/neto)*100).toFixed(2)+"%":"‚Äî";
      pdf.text(`Margen Promedio: ${margenTotal}`,15,74);

// ============================================================
// [10.3] TABLA DEPARTAMENTOS EN LA MISMA HOJA
// ============================================================
pdf.setFont("helvetica", "bold");
pdf.setFontSize(12);
pdf.text("AN√ÅLISIS POR DEPARTAMENTO", 15, 90);

pdf.setFontSize(9);
pdf.setFillColor(12, 108, 189);
pdf.setTextColor(255, 255, 255);
pdf.rect(10, 95, 190, 6, "F");
pdf.text("Departamento", 12, 99);
pdf.text("Venta", 65, 99);
pdf.text("Imp.", 88, 99);
pdf.text("Venta+Imp", 106, 99);
pdf.text("Costo", 136, 99);
pdf.text("Utilidad", 158, 99);
pdf.text("%", 182, 99);

pdf.setTextColor(0, 0, 0);
let yDepto = 106;
let totalVenta = 0, totalImp = 0, totalCosto = 0, totalUtil = 0;

for (const [dep, d] of Object.entries(r.porDepto)) {
  const venta = d.venta || 0;
  const imp = d.impuestos || 0;
  const ventaImp = venta + imp;
  const costo = d.costo || 0;
  const util = d.utilidad || 0;
  const marg = ventaImp > 0 ? ((util / ventaImp) * 100).toFixed(1) + "%" : "‚Äî";

  // Color alternado (gris claro cada dos filas)
  if (Math.floor((yDepto - 106) / 6) % 2 === 1) {
    pdf.setFillColor(240, 240, 240);
    pdf.rect(10, yDepto - 4, 190, 6, "F");
  }

  pdf.text(dep.substring(0, 25), 12, yDepto);
  pdf.text(`$${venta.toFixed(2)}`, 65, yDepto, { align: "right" });
  pdf.text(`$${imp.toFixed(2)}`, 88, yDepto, { align: "right" });
  pdf.text(`$${ventaImp.toFixed(2)}`, 106, yDepto, { align: "right" });
  pdf.text(`$${costo.toFixed(2)}`, 136, yDepto, { align: "right" });
  pdf.text(`$${util.toFixed(2)}`, 158, yDepto, { align: "right" });
  pdf.text(marg, 182, yDepto, { align: "right" });

  totalVenta += venta;
  totalImp += imp;
  totalCosto += costo;
  totalUtil += util;

  yDepto += 6;
}

// Totales
const totalVentaImp = totalVenta + totalImp;
const margenTotalTabla = totalVentaImp > 0 ? ((totalUtil / totalVentaImp) * 100).toFixed(1) + "%" : "‚Äî";

pdf.setFillColor(220, 220, 220);
pdf.rect(10, yDepto - 4, 190, 7, "F");
pdf.setFont("helvetica", "bold");
pdf.text("TOTALES", 12, yDepto);
pdf.text(`$${totalVenta.toFixed(2)}`, 65, yDepto, { align: "right" });
pdf.text(`$${totalImp.toFixed(2)}`, 88, yDepto, { align: "right" });
pdf.text(`$${totalVentaImp.toFixed(2)}`, 106, yDepto, { align: "right" });
pdf.text(`$${totalCosto.toFixed(2)}`, 136, yDepto, { align: "right" });
pdf.text(`$${totalUtil.toFixed(2)}`, 158, yDepto, { align: "right" });
pdf.text(margenTotalTabla, 182, yDepto, { align: "right" });

  // ============================================================
  // [10.4] RESUMEN DE TICKETS (POR FECHA DE CORTE)
  // ============================================================
  pdf.addPage();
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text(`RESUMEN DE TICKETS ‚Äì ${r.fecha}`, 50, 15);

  pdf.setFontSize(10);
  const tickets = r.detalle_ventas || [];

  // Encabezados
  pdf.setFillColor(12, 108, 189);
  pdf.setTextColor(255, 255, 255);
  pdf.rect(10, 22, 190, 7, "F");
  pdf.text("Folio", 12, 27);
  pdf.text("Hora", 42, 27);
  pdf.text("Venta", 74, 27);
  pdf.text("Imp.", 96, 27);
  pdf.text("Total", 112, 27);
  pdf.text("Costo", 134, 27);
  pdf.text("Utilidad", 158, 27);
  pdf.text("%", 182, 27);

  pdf.setTextColor(0, 0, 0);
  let y = 34;
  let totalVentaT = 0, totalImpT = 0, totalCostoT = 0, totalUtilT = 0;


  for (const t of tickets) {
    // Datos base
    const folio = t.folio || "‚Äî";
    const fechaTxt = t.fecha_txt || "";
    const hora = fechaTxt.split(" ")[1] || "";
    const totalVentaTicket = Number(t.total) || 0;
    const imp = t.detalle?.reduce((s, d) => s + (d.iva_calculado || 0) + (d.ieps_calculado || 0), 0) || 0;
    const ventaSinImp = totalVentaTicket - imp;
    const costo = Number(t.costo) || 0;
    const utilidad = ventaSinImp - costo;
    const marg = ventaSinImp > 0 ? ((utilidad / ventaSinImp) * 100).toFixed(1) + "%" : "‚Äî";

    // Fila
    if ((y - 34) / 6 % 2 === 1) {
      pdf.setFillColor(245, 245, 245);
      pdf.rect(10, y - 4, 190, 6, "F");
    }

    pdf.text(folio.substring(0, 10), 12, y);
    pdf.text(hora || "‚Äî", 42, y);
    pdf.text(`$${ventaSinImp.toFixed(2)}`, 74, y, { align: "right" });
    pdf.text(`$${imp.toFixed(2)}`, 96, y, { align: "right" });
    pdf.text(`$${totalVentaTicket.toFixed(2)}`, 112, y, { align: "right" });
    pdf.text(`$${costo.toFixed(2)}`, 134, y, { align: "right" });
    pdf.text(`$${utilidad.toFixed(2)}`, 158, y, { align: "right" });
    pdf.text(marg, 182, y, { align: "right" });

totalVentaT += ventaSinImp;
totalImpT += imp;
totalCostoT += costo;
totalUtilT += utilidad;
    y += 6;

    if (y > 270) { pdf.addPage(); y = 20; }
  }

const margenGlobal = totalVentaT > 0 ? ((totalUtilT / totalVentaT) * 100).toFixed(1) + "%" : "‚Äî";
const totalConImp = totalVentaT + totalImpT;
      
  pdf.setFillColor(220, 220, 220);
  pdf.rect(10, y - 4, 190, 8, "F");
  pdf.setFont("helvetica", "bold");
  pdf.text("TOTALES", 12, y);
  pdf.text(`$${totalVentaT.toFixed(2)}`, 74, y, { align: "right" });
pdf.text(`$${totalImpT.toFixed(2)}`, 96, y, { align: "right" });
pdf.text(`$${totalConImp.toFixed(2)}`, 112, y, { align: "right" });
pdf.text(`$${totalCostoT.toFixed(2)}`, 134, y, { align: "right" });
pdf.text(`$${totalUtilT.toFixed(2)}`, 158, y, { align: "right" });
  pdf.text(margenGlobal, 182, y, { align: "right" });
      
      // [10.3] Gr√°fica por Departamento
      try{
        overlayText.innerText="Generando gr√°fica de departamentos...";
        const imgDepto=await graficaDeptos(r.porDepto);
        pdf.addPage();pdf.setFont("helvetica","bold");pdf.setFontSize(14);
        pdf.text("GR√ÅFICA DE VENTAS POR DEPARTAMENTO",40,15);
        if(imgDepto) pdf.addImage(imgDepto,"PNG",20,25,170,100);
      }catch(e){console.error("Error en gr√°fica deptos:",e);}

      // [10.4] Gr√°fica de m√°rgenes bajos
      try{
        overlayText.innerText="Generando gr√°fica de utilidades...";
        await generarMargenesBajos(pdf,r.porArticulo);
      }catch(e){console.error("Error en margen bajos:",e);}

      // [10.5] Enviar PDF a Telegram
      overlayText.innerText="Enviando reporte a Telegram...";
      const blob=pdf.output("blob");
      const url=URL.createObjectURL(blob);window.open(url,"_blank");
      await enviarTelegram(blob,`Corte_${r.rutaId}_${r.fecha}.pdf`,
        `üì¶ Corte ${r.usuario}\nTotal: $${r.totalDia.toFixed(2)}\nDescuento: $${r.totalDescuento.toFixed(2)}\nUtilidad: $${r.utilidadTotal.toFixed(2)} (${margenTotal})`);
    }

    // ============================================================
    // [11] FUNCI√ìN: GRAFICAR DEPARTAMENTOS
    // ============================================================
    async function graficaDeptos(porDepto){
      return new Promise(resolve=>{
        const canvas=document.createElement("canvas");canvas.width=800;canvas.height=400;
        const ctx=canvas.getContext("2d");
        const labels=Object.keys(porDepto);
        const data=Object.values(porDepto).map(v=>v.venta);
        const colors=labels.map((_,i)=>`hsl(${i*360/labels.length},70%,55%)`);
        new Chart(ctx,{type:"pie",data:{labels,datasets:[{data,backgroundColor:colors}]},
          options:{responsive:false,plugins:{legend:{position:"bottom"}}}});
        setTimeout(()=>resolve(canvas.toDataURL("image/png")),800);
      });
    }

    // ============================================================
    // [12] FUNCI√ìN: GRAFICAR M√ÅRGENES BAJOS
    // ============================================================
    async function generarMargenesBajos(pdf,porArticulo){
      const articulos=Object.entries(porArticulo).map(([n,d])=>{
        const imp=d.importe||0,cos=d.costo||0,util=imp-cos,marg=imp?(util/imp)*100:0;
        return{nombre:n,cantidad:d.cantidad,importe:imp,costo:cos,utilidad:util,margen:marg};
      }).sort((a,b)=>a.margen-b.margen).slice(0,20);

      const canvas=document.createElement("canvas");
      canvas.width=800;canvas.height=400;
      const ctx=canvas.getContext("2d");
      new Chart(ctx,{
        type:"bar",
        data:{
          labels:articulos.map(a=>a.nombre.substring(0,15)),
          datasets:[{data:articulos.map(a=>a.margen),
            backgroundColor:articulos.map(a=>
              a.margen<0?"rgba(255,99,132,0.7)":a.margen<10?"rgba(255,205,86,0.7)":"rgba(75,192,192,0.7)"
            )}]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>v+"%"}}}}
      });
      await new Promise(r=>setTimeout(r,800));
      const img=canvas.toDataURL("image/png");
      pdf.addPage();pdf.text("GR√ÅFICO DE UTILIDAD ‚Äì 20 ART√çCULOS CON MENOR MARGEN",20,15);
      pdf.addImage(img,"PNG",10,25,190,100);
    }

    // ============================================================
    // [13] FUNCI√ìN: ENVIAR PDF A TELEGRAM
    // ============================================================
    async function enviarTelegram(pdfBlob,nombre,caption){
      const BOT="8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
      const CHAT="6617988297";
      const f=new FormData();
      f.append("chat_id",CHAT);
      f.append("caption",caption);
      f.append("document",pdfBlob,nombre);
      try{
        await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`,{method:"POST",body:f});
      }catch(e){console.error("Telegram error",e);}
    }

  </script>
</body>
</html>
