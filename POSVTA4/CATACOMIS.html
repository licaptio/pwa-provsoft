<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Departamentos y Comisiones ‚Äì PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Poppins,Arial;background:#f4f6f8;padding:20px}
h2{margin-bottom:4px}
.small{font-size:12px;color:#666;margin-bottom:12px}

table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;font-size:14px}
th{background:#00416A;color:#fff}

input,select{
  padding:6px;width:100%;box-sizing:border-box
}

button{
  padding:6px 10px;border:none;border-radius:6px;
  cursor:pointer;color:#fff;font-size:13px
}
button.save{background:#0c6cbd}
button.fix{background:#e67e22}
button.ok{background:#1e8e3e}
button.edit{background:#7f8c8d}

.badge{
  font-size:11px;padding:3px 6px;border-radius:6px;color:#fff
}
.badge.ok{background:#1e8e3e}
.badge.warn{background:#e67e22}

/* OVERLAY */
#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;z-index:9999
}
#overlay .box{
  background:#fff;padding:20px;border-radius:12px;
  text-align:center;width:260px
}
.spinner{
  width:36px;height:36px;border:4px solid #ddd;
  border-top-color:#0c6cbd;border-radius:50%;
  animation:spin 1s linear infinite;margin:0 auto 10px
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<h2>‚öôÔ∏è Departamentos y Comisiones</h2>
<div class="small">
Control total por departamento. La comisi√≥n vive en los productos.
</div>

<table id="tabla">
<thead>
<tr>
  <th>ID</th>
  <th>Departamento</th>
  <th>Comisi√≥n actual</th>
  <th>Avance</th>
  <th>Asignar comisi√≥n</th>
  <th>Renombrar</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- OVERLAY -->
<div id="overlay">
  <div class="box">
    <div class="spinner"></div>
    <b>Procesando productos‚Ä¶</b>
    <div class="small" id="progressText">0 / 0</div>
    <div style="margin-top:8px;background:#eee;border-radius:6px;overflow:hidden">
      <div id="bar" style="height:10px;width:0%;background:#0c6cbd"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where,
  updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
});
const db = getFirestore(app);

/* UI helpers */
const overlay=document.getElementById("overlay");
const bar=document.getElementById("bar");
const progressText=document.getElementById("progressText");

function start(total){
  overlay.style.display="flex";
  bar.style.width="0%";
  progressText.textContent=`0 / ${total}`;
}
function step(i,total){
  bar.style.width=Math.round((i/total)*100)+"%";
  progressText.textContent=`${i} / ${total}`;
}
function stop(){overlay.style.display="none";}

/* MAIN */
async function cargar(){
  const tbody=document.querySelector("#tabla tbody");
  tbody.innerHTML="";

  const snap=await getDocs(
    query(collection(db,"productos"),where("activo","==",true))
  );

  const map=new Map();

  snap.forEach(d=>{
    const p=d.data();
    if(!p.departamento_id)return;
    if(!map.has(p.departamento_id)){
      map.set(p.departamento_id,{
        id:p.departamento_id,
        nombre:p.departamento||"SIN NOMBRE",
        docs:[]
      });
    }
    map.get(p.departamento_id).docs.push(d);
  });

  [...map.values()]
    .sort((a,b)=>Number(a.id)-Number(b.id))
    .forEach(dep=>renderFila(dep,tbody));
}

function renderFila(dep,tbody){
  const tr=document.createElement("tr");

  /* detectar dominante */
  const count=new Map();
  dep.docs.forEach(d=>{
    const p=d.data();
    if(p.comision_tipo!=null){
      const k=`${p.comision_tipo}|${p.comision_valor}`;
      count.set(k,(count.get(k)||0)+1);
    }
  });

  let dominante=null,max=0;
  for(const [k,v] of count){if(v>max){max=v;dominante=k}}

  let texto="‚Äî",pct=0,faltan=dep.docs.length;
  let tipoDom="",valorDom="";
  if(dominante){
    [tipoDom,valorDom]=dominante.split("|");
    texto=`${tipoDom} ${valorDom}`;
    pct=Math.round((max/dep.docs.length)*100);
    faltan=dep.docs.length-max;
  }

  tr.innerHTML=`
    <td>${dep.id}</td>
    <td>${dep.nombre}</td>
    <td>${texto}</td>
    <td>
      ${pct===100
        ? `<span class="badge ok">100 %</span>`
        : `<span class="badge warn">${pct} % (${faltan})</span>`}
    </td>
    <td>
      <select class="tipo">
        <option value="porcentaje">%</option>
        <option value="pieza">$ / pza</option>
      </select>
      <input class="valor" type="number" step="0.01" value="${valorDom||0}">
      <button class="save">üíæ Guardar</button>
    </td>
    <td>
      <button class="edit">‚úèÔ∏è</button>
    </td>
  `;

  const sel=tr.querySelector(".tipo");
  const inp=tr.querySelector(".valor");
  const btnSave=tr.querySelector(".save");
  const btnEdit=tr.querySelector(".edit");

  if(tipoDom) sel.value=tipoDom;

  /* GUARDAR COMISI√ìN */
  btnSave.onclick=async()=>{
    const tipo=sel.value;
    const valor=Number(inp.value)||0;
    if(!confirm(`Asignar comisi√≥n ${tipo} ${valor} a ${dep.docs.length} productos?`))return;

    start(dep.docs.length);
    let i=0;

    for(const d of dep.docs){
      i++;
      await updateDoc(d.ref,{
        comision_tipo:tipo,
        comision_valor:valor,
        updatedAt:serverTimestamp()
      });
      step(i,dep.docs.length);
    }
    stop();
    cargar();
  };

  /* RENOMBRAR */
  btnEdit.onclick=async()=>{
    const nuevo=prompt("Nuevo nombre del departamento:",dep.nombre);
    if(!nuevo)return;

    start(dep.docs.length);
    let i=0;

    for(const d of dep.docs){
      i++;
      await updateDoc(d.ref,{
        departamento:nuevo.toUpperCase(),
        updatedAt:serverTimestamp()
      });
      step(i,dep.docs.length);
    }
    stop();
    cargar();
  };

  tbody.appendChild(tr);
}

cargar();
</script>

</body>
</html>
