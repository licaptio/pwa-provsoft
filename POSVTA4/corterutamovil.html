<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CORTE MÃ“VIL â€“ PDD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0c6cbd">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #eef2f6;
      padding: 15px;
      color: #222;
    }

    h2 {
      text-align: center;
      color: #00416A;
      margin-bottom: 20px;
    }

    select, input[type="date"], button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background: #0c6cbd;
      color: white;
      font-weight: bold;
      border: none;
    }

    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      color: white;
      font-size: 17px;
      z-index: 3000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid #0c6cbd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <h2>CORTE DE RUTA â€“ VERSIÃ“N MÃ“VIL</h2>

  <!-- Filtros -->
  <select id="selectRuta">
    <option value="">Selecciona una ruta...</option>
  </select>

  <select id="selectFecha">
  <option value="">Selecciona una fecha pendiente...</option>
</select>


  <button id="btnGenerar">ðŸ“Š GENERAR CORTE</button>

  <!-- Overlay -->
  <div id="overlay">
    <div class="spinner"></div>
    Procesando...
    <div id="overlayText"></div>
  </div>

  <!-- ==============================================
       FIREBASE
  =============================================== -->
<script type="module">
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore, collection, query, where, getDocs,
  addDoc, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const selectRuta  = document.getElementById("selectRuta");
const selectFecha = document.getElementById("selectFecha");
const btnGenerar  = document.getElementById("btnGenerar");
const overlay     = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");

/* ===================================================
   ðŸ”‘ LEER USUARIO LOGUEADO DESDE EL POS (LOCALSTORAGE)
=================================================== */
let USUARIO = null;
let RUTA_USUARIO = null;

function cargarUsuarioLogueado() {
  const data = localStorage.getItem("usuario_ruta");

  if (!data) {
    alert("âš ï¸ No hay usuario logueado. Vuelve al POS e inicia sesiÃ³n.");
    window.location.href = "index.html";
    return;
  }

  USUARIO = JSON.parse(data);
  RUTA_USUARIO = USUARIO.rutaId;

  console.log("ðŸ‘¤ Usuario logueado:", USUARIO);
  console.log("ðŸšš Ruta asignada:", RUTA_USUARIO);

  // bloquear selector de ruta
  selectRuta.innerHTML = "";

  const opt = document.createElement("option");
  opt.value = RUTA_USUARIO;
  opt.textContent = `${USUARIO.nombre} â€“ Ruta ${RUTA_USUARIO}`;
  selectRuta.appendChild(opt);
}

/* ===================================================
   ðŸ”„ CARGAR RUTAS (solo para modo administrador)
=================================================== */
async function cargarRutas() {
  // si el usuario ya tiene ruta, NO cargamos rutas de Firebase
  if (RUTA_USUARIO) return;

  const snap = await getDocs(collection(db, "ventas_rutav2"));
  const rutas = {};

  snap.forEach(d => {
    const v = d.data();
    if (!v.cortado && v.rutaId) {
      if (!rutas[v.rutaId]) rutas[v.rutaId] = v.usuarioNombre;
    }
  });

  Object.entries(rutas).forEach(([id, nombre]) => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${nombre} â€“ ${id}`;
    selectRuta.appendChild(opt);
  });
}
/* ===================================================
   ðŸ“… CARGAR FECHAS PENDIENTES DE CORTE
=================================================== */
async function cargarFechasPendientes() {
  const q = query(
    collection(db, "ventas_rutav2"),
    where("rutaId", "==", RUTA_USUARIO),
    where("cortado", "==", false)
  );

  const snap = await getDocs(q);
  const ventas = snap.docs.map(d => d.data());

  const fechas = {};

  ventas.forEach(v => {
    // fecha_txt viene asÃ­: "03/02/2025 10:33"
    if (!v.fecha_txt) return;
    const fechaSolo = v.fecha_txt.split(" ")[0];

    if (!fechas[fechaSolo]) fechas[fechaSolo] = 0;
    fechas[fechaSolo]++;
  });

  const select = document.getElementById("selectFecha");
  select.innerHTML = "<option value=''>Selecciona una fecha pendiente...</option>";

  Object.entries(fechas).forEach(([fecha, cantidad]) => {
    const opt = document.createElement("option");
    opt.value = fecha;
    opt.textContent = `${fecha} â€“ ${cantidad} ventas pendientes`;
    select.appendChild(opt);
  });
}

/* ===================================================
   â–¶ï¸ EJECUCIÃ“N INICIAL
=================================================== */
cargarUsuarioLogueado();
await cargarRutas();
await cargarFechasPendientes();

// AquÃ­ sigue GENERAR CORTE SIN CAMBIOS
    // ===========================================
    // GENERAR CORTE
    // ===========================================
    btnGenerar.addEventListener("click", generarCorteMovil);

    async function generarCorteMovil() {
      const ruta  = selectRuta.value;
const fecha = selectFecha.value;

if (!ruta) {
  alert("Ruta invÃ¡lida.");
  return;
}

if (!fecha) {
  alert("Selecciona una fecha pendiente.");
  return;
}

      overlay.style.display = "flex";
      overlayText.textContent = "Buscando ventas...";

      // Traer ventas
      const qv = query(
        collection(db, "ventas_rutav2"),
        where("rutaId", "==", ruta),
        where("cortado", "==", false)
      );

      const snap = await getDocs(qv);
      const ventas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      // Filtrar por fecha, usando fecha_txt tipo "24/11/2025 10:22"
const fechaRef = fecha; // porque ahora viene en formato dd/mm/aaaa

const ventasDia = ventas.filter(v =>
  v.fecha_txt && v.fecha_txt.startsWith(fechaRef)
);

      if (!ventasDia.length) {
        overlay.style.display = "none";
        alert("No hay ventas sin cortar para esta fecha.");
        return;
      }

      // Calcular totales
      let totalDia = 0;
      let usuario = ventasDia[0].usuarioNombre || "â€”";

      ventasDia.forEach(v => {
        totalDia += Number(v.resumen_financiero?.total || 0);
      });

      // =======================================
      // CORTE SIMPLIFICADO para MINIIMPRESORA
      // =======================================
      overlayText.textContent = "Imprimiendo corte...";

      const texto = `
CORTE DE RUTA - ${fechaRef}
--------------------------------
Ruta: ${ruta}
Vendedor: ${usuario}
Total: $${totalDia.toFixed(2)}
Ventas: ${ventasDia.length}
--------------------------------
Â¡Gracias por tu trabajo!
`;

      try {
        if ("bluetooth" in navigator) {
          const encoder = new TextEncoder();
          const data = encoder.encode(texto);

          const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [0x18F0]
          });

          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(0x18F0);
          const characteristic = await service.getCharacteristic(0x2AF1);

          await characteristic.writeValue(data);
        }
      } catch (e) {
        console.warn("ImpresiÃ³n no disponible:", e);
      }

      // =======================================
      // GUARDAR CORTE EN FIRESTORE
      // =======================================
      overlayText.textContent = "Guardando corte...";

      const resumen = {
        rutaId: ruta,
        fecha: fecha,
        creado_en: new Date().toISOString(),
        realizado_por: usuario,
        total_dia: totalDia,
        ventas_ids: ventasDia.map(v => v.id)
      };

      await addDoc(collection(db, "cortes_globalesV4"), {
        rutaId: ruta,
        fecha_corte: fecha,
        creado_en: new Date().toISOString(),
        realizado_por: usuario,
        resumen
      });

      // Marcar ventas cortadas
      for (const v of ventasDia) {
        await updateDoc(doc(db, "ventas_rutav2", v.id), {
          cortado: true
        });
      }

      // =======================================
      // PDF GRANDE Y TELEGRAM
      // =======================================

      overlayText.textContent = "Generando PDF grande...";

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.text("CORTE DE RUTA â€“ PDD", 10, 10);
      pdf.text(`Ruta: ${ruta}`, 10, 20);
      pdf.text(`Vendedor: ${usuario}`, 10, 30);
      pdf.text(`Fecha: ${fecha}`, 10, 40);
      pdf.text(`Total DÃ­a: $${totalDia.toFixed(2)}`, 10, 50);

      const blob = pdf.output("blob");

      overlayText.textContent = "Enviando PDF a Telegram...";

      const BOT = "8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q";
      const CHAT = "6617988297";

      const f = new FormData();
      f.append("chat_id", CHAT);
      f.append("caption", `Corte de ruta ${ruta} â€“ ${fecha}\nTotal: $${totalDia.toFixed(2)}`);
      f.append("document", blob, `Corte_${ruta}_${fecha}.pdf`);

      await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, {
        method: "POST",
        body: f
      });

      // =======================================
      //  CIERRE DE SESIÃ“N AUTOMÃTICO
      // =======================================
      overlayText.textContent = "Cerrando sesiÃ³n...";

      localStorage.removeItem("usuario_ruta");
      localStorage.removeItem("catalogo_cache");
      localStorage.removeItem("catalogo_fecha");

      await new Promise(r => setTimeout(r, 800));

      window.location.href = "POSV4PASS.html";
    }
  </script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
