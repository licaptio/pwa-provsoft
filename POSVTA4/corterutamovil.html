<!DOCTYPE html><html lang="es"><head>
<meta charset="UTF-8"/>
<title>CORTE MÃ“VIL â€“ PDD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0c6cbd">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
body{font-family:'Poppins',sans-serif;margin:0;background:#eef2f6;padding:15px;color:#222}
h2{text-align:center;color:#00416A;margin-bottom:20px}
select,input[type="date"],button{width:100%;padding:12px;margin-bottom:15px;font-size:15px;border-radius:8px;border:1px solid #ccc}
button{background:#0c6cbd;color:#fff;font-weight:bold;border:none}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);color:#fff;font-size:17px;z-index:3000;align-items:center;justify-content:center;flex-direction:column;text-align:center}
.spinner{width:60px;height:60px;border:6px solid rgba(255,255,255,0.3);border-top:6px solid #0c6cbd;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>
</head>

<body>
<h2>CORTE DE RUTA â€“ VERSIÃ“N MÃ“VIL</h2>

<select id="selectRuta"><option value="">Selecciona una ruta...</option></select>
<select id="selectFecha"><option value="">Selecciona una fecha pendiente...</option></select>
<button id="btnGenerar">ðŸ“Š GENERAR CORTE</button>

<div id="overlay"><div class="spinner"></div>Procesando...<div id="overlayText"></div></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getFirestore,collection,query,where,getDocs,addDoc,updateDoc,doc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",authDomain:"inventariopv-643f1.firebaseapp.com",projectId:"inventariopv-643f1",storageBucket:"inventariopv-643f1.appspot.com",messagingSenderId:"96242533231",appId:"1:96242533231:web:aae75a18fbaf9840529e9a"};
const app=initializeApp(firebaseConfig),db=getFirestore(app);

const selectRuta=document.getElementById("selectRuta"),
selectFecha=document.getElementById("selectFecha"),
btnGenerar=document.getElementById("btnGenerar"),
overlay=document.getElementById("overlay"),
overlayText=document.getElementById("overlayText");

let USUARIO=null,RUTA_USUARIO=null;

function cargarUsuarioLogueado(){
  const data=localStorage.getItem("usuario_ruta");
  if(!data){alert("âš ï¸ No hay usuario logueado.");return(location.href="index.html");}
  USUARIO=JSON.parse(data);RUTA_USUARIO=USUARIO.rutaId;
  selectRuta.innerHTML="";
  const opt=document.createElement("option");
  opt.value=RUTA_USUARIO;opt.textContent=`${USUARIO.nombre} â€“ Ruta ${RUTA_USUARIO}`;
  selectRuta.appendChild(opt);
}

async function cargarFechasPendientes(){
  const q=query(collection(db,"ventas_rutav2"),where("rutaId","==",RUTA_USUARIO),where("cortado","==",false));
  const snap=await getDocs(q),ventas=snap.docs.map(d=>d.data()),fechas={};
  ventas.forEach(v=>{if(v.fecha_txt){const f=v.fecha_txt.split(" ")[0];fechas[f]=(fechas[f]||0)+1;}});
  selectFecha.innerHTML="<option value=''>Selecciona una fecha pendiente...</option>";
  Object.entries(fechas).forEach(([f,c])=>{
    const o=document.createElement("option");o.value=f;o.textContent=`${f} â€“ ${c} ventas pendientes`;selectFecha.appendChild(o);
  });
}

cargarUsuarioLogueado();
await cargarFechasPendientes();

btnGenerar.addEventListener("click",generarCorteMovil);

async function generarCorteMovil(){
  const ruta=selectRuta.value,fecha=selectFecha.value;
  if(!ruta)return alert("Ruta invÃ¡lida.");
  if(!fecha)return alert("Selecciona una fecha.");

  overlay.style.display="flex";overlayText.textContent="Buscando ventas...";

  const q=query(collection(db,"ventas_rutav2"),where("rutaId","==",ruta),where("cortado","==",false));
  const snap=await getDocs(q),ventas=snap.docs.map(d=>({id:d.id,...d.data()}));
  const ventasDia=ventas.filter(v=>v.fecha_txt&&v.fecha_txt.startsWith(fecha));
  if(!ventasDia.length){overlay.style.display="none";return alert("No hay ventas sin cortar.");}

  let totalDia=0,totalDescuento=0,utilidadTotal=0,porDepto={},porArticulo={},porNota=[];
  for(const v of ventasDia){
    const rf=v.resumen_financiero||{},total=+rf.total||0,desc=+rf.descuento||+v.descuento_monto||0,costo=+rf.costo_total||0,util=total-costo;
    totalDia+=total;totalDescuento+=desc;utilidadTotal+=util;

    for(const d of(v.detalle||[])){
      const dep=d.departamento_info?.nombre?.toUpperCase()||"SIN DEPTO";
      const imp=(d.importe||0)-(d.descuento_monto||0);
      const c=d.costo_total||d.costo_unit*(d.cantidad||1)||0;
      if(!porDepto[dep])porDepto[dep]={venta:0,costo:0,utilidad:0};
      porDepto[dep].venta+=imp;porDepto[dep].costo+=c;porDepto[dep].utilidad+=(imp-c);

      const art=d.nombre?.toUpperCase()||"SIN NOMBRE";
      if(!porArticulo[art])porArticulo[art]={cantidad:0,importe:0,costo:0};
      porArticulo[art].cantidad+=d.cantidad||0;
      porArticulo[art].importe+=imp;
      porArticulo[art].costo+=c;
    }
    porNota.push({folio:v.folio||v.id,total,desc,costo,utilidad:util});
  }

  overlayText.textContent="Imprimiendo corte...";
  function mxn(n){return Number(n).toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2});}

  const listaDeptos=Object.entries(porDepto).sort((a,b)=>b[1].venta-a[1].venta);
  const topArt=Object.entries(porArticulo).sort((a,b)=>b[1].importe-a[1].importe).slice(0,10);

  let texto=`CORTE ANALÃTICO - ${fecha}
--------------------------------
RUTA: ${ruta}
VENDEDOR: ${USUARIO.nombre}
TOTAL MXN: $${mxn(totalDia)}
VENTAS: ${ventasDia.length}
--------------------------------
VENTA POR DEPARTAMENTO
--------------------------------
`;

  listaDeptos.forEach(([d,v])=>texto+=`${d.substring(0,16).padEnd(16)} $${mxn(v.venta)}\n`);
  texto+=`\n--------------------------------\nTOP ARTÃCULOS\n--------------------------------\n`;
  topArt.forEach(([n,v])=>texto+=`${n.substring(0,20)}\n   $${mxn(v.importe)}\n`);
  texto+="\n--------------------------------\nÂ¡GRAN TRABAJO!\n";

  try{
    if("bluetooth"in navigator){
      const enc=new TextEncoder(),data=enc.encode(texto);
      const dev=await navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices:[0x18F0]});
      const srv=await dev.gatt.connect(),svc=await srv.getPrimaryService(0x18F0),ch=await svc.getCharacteristic(0x2AF1);
      await ch.writeValue(data);
    }
  }catch(e){console.warn("BT no disponible:",e);}

  overlayText.textContent="Enviando a Telegram...";
  await enviarTelegramTexto(texto);

  overlayText.textContent="Guardando corte...";
  await addDoc(collection(db,"cortes_globalesV4"),{
    rutaId:ruta,fecha:new Date().toISOString(),fecha_corte:fecha,
    creado_por:USUARIO.nombre,creado_en:new Date().toISOString(),
    resumen:{totalDia,totalDescuento,utilidadTotal,porDepto,porArticulo,porNota}
  });

  for(const v of ventasDia)await updateDoc(doc(db,"ventas_rutav2",v.id),{cortado:true});

  overlayText.textContent="Cerrando sesiÃ³n...";
  localStorage.removeItem("usuario_ruta");
  localStorage.removeItem("catalogo_cache");
  localStorage.removeItem("catalogo_fecha");
  await new Promise(r=>setTimeout(r,600));
  location.href="POSV4PASS.html";
}
</script>

<script>
async function enviarTelegramTexto(texto){
  const BOT="8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q",CHAT="6617988297";
  try{
    await fetch(`https://api.telegram.org/bot${BOT}/sendMessage`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id:CHAT,text:texto})
    });
  }catch(e){console.error("Telegram:",e);}
}
</script>

</body>
</html>
