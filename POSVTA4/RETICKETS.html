<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reimpresi√≥n de Tickets ‚Äì PROVSOFT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#00416A,#E4E5E6);
}
header{
  background:#0c6cbd;
  color:#fff;
  padding:12px;
  text-align:center;
  font-size:18px;
  font-weight:700;
}
.card{
  background:#fff;
  margin:14px;
  padding:14px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.2);
}
label{font-size:13px;font-weight:600}
select,input,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}
button{
  background:#0c6cbd;
  color:#fff;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.ticket{
  border-bottom:1px dashed #ccc;
  padding:10px 0;
}
.ticket:last-child{border:none}
.ticket button{
  margin-top:6px;
  background:#1e8e3e;
}
.small{font-size:12px;color:#555}
</style>
</head>

<body>

<header>üßæ Reimpresi√≥n de Tickets ‚Äì Ruta Venta</header>

<div class="card">
  <label>Ruta</label>
  <select id="selRuta"></select>

  <label>Desde</label>
  <input type="date" id="desde">

  <label>Hasta</label>
  <input type="date" id="hasta">

  <button onclick="buscar()">üîç Buscar Tickets</button>
</div>

<div class="card" id="listaTickets">
  <div class="small">Seleccione una ruta y fechas</div>
</div>

<!-- ========= TICKET OCULTO ========= -->
<div id="ticketArea" style="display:none">
  <pre id="ticketTexto"></pre>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* üî• Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const selRuta = document.getElementById("selRuta");
const lista = document.getElementById("listaTickets");
const money = n => "$" + Number(n||0).toFixed(2);

/* ================= CARGAR RUTAS ================= */
async function cargarRutas(){
  selRuta.innerHTML = `<option value="">Seleccione ruta</option>`;

  const snap = await getDocs(collection(db,"usuarios_ruta"));

  snap.forEach(d=>{
    const u = d.data();

    // üî¥ ESTA ES LA CLAVE
    // value = rutaId (NO el nombre)
    // texto = nombre del vendedor

    if(!u.rutaId) return;

    selRuta.innerHTML += `
      <option value="${u.rutaId}">
        ${u.nombre || u.usuario || u.rutaId}
      </option>
    `;
  });
}
cargarRutas();

window.buscar = async function(){
  const ruta = selRuta.value;
  if(!ruta){ 
    alert("Seleccione una ruta"); 
    return; 
  }

  let f1 = null;
  let f2 = null;

  if(desde.value){
    f1 = new Date(desde.value + "T00:00:00");
  }
  if(hasta.value){
    f2 = new Date(hasta.value + "T23:59:59");
  }

  const q = query(
    collection(db,"ventas_rutav2"),
    where("rutaId","==",ruta)
  );

  const snap = await getDocs(q);
  lista.innerHTML = "";

  let encontrados = 0;

  snap.forEach(d=>{
    const v = d.data();
    if(!v.fecha || !v.fecha.toDate) return;

    const f = v.fecha.toDate();

    // üîé FILTRO DE FECHAS SEGURO
    if(f1 && f < f1) return;
    if(f2 && f > f2) return;

    encontrados++;

    const div = document.createElement("div");
    div.className="ticket";
    div.innerHTML = `
      <strong>${v.folio}</strong><br>
      <span class="small">${v.fecha_txt}</span><br>
      Total: ${money(v.resumen_financiero.total)}
      <button>üñ®Ô∏è Imprimir</button>
    `;
    div.querySelector("button").onclick=()=>imprimir(v);
    lista.appendChild(div);
  });

  if(!encontrados){
    lista.innerHTML = "<div class='small'>No hay resultados</div>";
  }
};

/* ================= IMPRIMIR ================= */
function imprimir(v){
  let t = `
PROVEEDORA MATRIZ
MADERO 690 SUR, CENTRO
LINARES, NL
------------------------------
Venta: ${v.folio}
Fecha: ${v.fecha_txt}
Cliente: ${v.cliente || "P√öBLICO"}
------------------------------
`;

  (v.detalle||[]).forEach(p=>{
    t+=`${p.nombre}\n`;
    t+=`Cant:${p.cantidad}  ${p.precio_unit.toFixed(2)}  ${p.importe.toFixed(2)}\n`;
  });

  t+=`
------------------------------
Total: ${money(v.resumen_financiero.total)}
Cajero: ${v.usuarioNombre || ""}
------------------------------
¬°Gracias por su compra!
`;

  if(window.InnerPrinter){
    InnerPrinter.printText(t);
    return;
  }

  if(/Android/i.test(navigator.userAgent)){
    location.href="rawbt:print?data="+encodeURIComponent(t);
    return;
  }

  const w=window.open("");
  w.document.write("<pre>"+t+"</pre>");
  w.print();
}
</script>

</body>
</html>
