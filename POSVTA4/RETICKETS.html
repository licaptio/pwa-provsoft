<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reimpresi√≥n de Tickets ‚Äì PROVSOFT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#00416A,#E4E5E6);
  color:#111;
}
header{
  background:#0c6cbd;
  color:#fff;
  padding:12px;
  text-align:center;
  font-size:18px;
  font-weight:700;
}
.card{
  background:#fff;
  border-radius:14px;
  margin:12px;
  padding:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.2);
}
label{font-size:13px;font-weight:600}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}
button{
  background:#0c6cbd;
  color:#fff;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.ticket-row{
  border-bottom:1px dashed #ccc;
  padding:10px 0;
}
.ticket-row:last-child{border:none}
.ticket-row button{
  margin-top:6px;
  background:#1e8e3e;
}
.small{font-size:12px;color:#555}
</style>
</head>

<body>

<header>üßæ Reimpresi√≥n de Tickets ‚Äì Ruta Venta</header>

<div class="card">
  <label>Ruta</label>
  <input id="rutaId" placeholder="Ej. RUTA01">

  <label>Desde</label>
  <input type="date" id="desde">

  <label>Hasta</label>
  <input type="date" id="hasta">

  <button onclick="buscar()">üîç Buscar Tickets</button>
</div>

<div class="card" id="listaTickets">
  <div class="small">No hay resultados</div>
</div>

<!-- ================= TICKET (OCULTO) ================= -->
<div id="ticketArea" style="display:none">
  <div id="ticket" style="font-family:monospace;width:72mm">
    <div style="text-align:center;font-weight:bold">
      PROVEEDORA MATRIZ<br>
      MADERO 690 SUR, CENTRO<br>
      LINARES, NUEVO LE√ìN<br>
      RFC: PDD-031204-KL5
    </div>
    <hr>
    <div># Venta: <span id="tFolio"></span></div>
    <div>Fecha: <span id="tFecha"></span></div>
    <div>Cliente: <span id="tCliente"></span></div>
    <hr>
    <table width="100%">
      <thead>
        <tr>
          <th align="left">Desc</th>
          <th>Cant</th>
          <th>P.U</th>
          <th>Imp</th>
        </tr>
      </thead>
      <tbody id="tLineas"></tbody>
    </table>
    <hr>
    <div>Subtotal: <span id="tSubtotal"></span></div>
    <div>Impuestos: <span id="tImpuestos"></span></div>
    <div>Total: <span id="tTotal"></span></div>
    <div>Cajero: <span id="tCajero"></span></div>
    <hr>
    <div style="text-align:center">¬°Gracias por su compra!</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, query, where, orderBy, getDocs, Timestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const money = n => "$" + Number(n||0).toFixed(2);

/* ================= BUSCAR ================= */
window.buscar = async function(){
  const ruta = rutaId.value.trim();
  if(!ruta){ alert("Ruta requerida"); return; }

  const d1 = new Date(desde.value);
  const d2 = new Date(hasta.value);
  d2.setHours(23,59,59);

  const q = query(
    collection(db,"ventas_rutav2"),
    where("rutaId","==",ruta),
    where("fecha",">=",Timestamp.fromDate(d1)),
    where("fecha","<=",Timestamp.fromDate(d2)),
    orderBy("fecha","desc")
  );

  const snap = await getDocs(q);
  const cont = document.getElementById("listaTickets");
  cont.innerHTML = "";

  if(snap.empty){
    cont.innerHTML = "<div class='small'>Sin resultados</div>";
    return;
  }

  snap.docs.forEach(d=>{
    const v = d.data();
    const div = document.createElement("div");
    div.className="ticket-row";
    div.innerHTML=`
      <strong>${v.folio}</strong><br>
      <span class="small">${v.fecha_txt}</span><br>
      Total: ${money(v.resumen_financiero.total)}
      <button>üñ®Ô∏è Reimprimir</button>
    `;
    div.querySelector("button").onclick=()=>reimprimir(v);
    cont.appendChild(div);
  });
};

/* ================= REIMPRESI√ìN ================= */
function reimprimir(v){
  window.__VENTA_ACTUAL = v;
  window.__ULTIMOS_TOTALES = v.resumen_financiero;

  document.getElementById("tFolio").textContent = v.folio;
  document.getElementById("tFecha").textContent = v.fecha_txt;
  document.getElementById("tCliente").textContent = v.cliente;
  document.getElementById("tSubtotal").textContent = money(v.resumen_financiero.subtotal);
  document.getElementById("tImpuestos").textContent = money(v.resumen_financiero.impuestos);
  document.getElementById("tTotal").textContent = money(v.resumen_financiero.total);
  document.getElementById("tCajero").textContent = v.usuarioNombre;

  const tb = document.getElementById("tLineas");
  tb.innerHTML="";
  v.detalle.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.nombre}</td>
      <td align="center">${p.cantidad}</td>
      <td align="right">${p.precio_unit.toFixed(2)}</td>
      <td align="right">${p.importe.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  });

  imprimir();
}

/* ================= IMPRESI√ìN ================= */
function imprimir(){
  let txt = document.getElementById("ticket").innerText;

  if(window.InnerPrinter){
    InnerPrinter.printText(txt);
    return;
  }

  if(/Android/i.test(navigator.userAgent)){
    location.href="rawbt:print?data="+encodeURIComponent(txt);
    return;
  }

  const w=window.open("");
  w.document.write("<pre>"+txt+"</pre>");
  w.print();
}
</script>

</body>
</html>
