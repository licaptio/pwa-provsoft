<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üß© PROVSOFT ‚Äì Catalog Mapper Visual</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --azul:#00416A;--resalte:#0c6cbd;--gris:#E4E5E6;--blanco:#fff;
    --borde:#cfd8dc;--resalte-columna:#d0e6ff;
  }
  body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--azul),var(--gris));color:#111;margin:0;padding:20px;}
  h1{color:white;text-align:center;text-shadow:1px 1px 3px rgba(0,0,0,.3);}
  .card{background:rgba(255,255,255,.96);border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.15);max-width:95%;margin:20px auto;}
  input[type=file],button{padding:10px 16px;border-radius:10px;border:1px solid #ccc;font-size:15px;margin:6px;}
  button{background:#9e9e9e;color:white;font-weight:600;cursor:not-allowed;transition:.3s;}
  button.activo{background:var(--resalte);cursor:pointer;}
  button.activo:hover{background:var(--azul);transform:scale(1.02);}
  table{width:100%;border-collapse:collapse;margin-top:15px;background:var(--blanco);}
  th,td{border:1px solid var(--borde);padding:6px 8px;font-size:13px;text-align:left;white-space:nowrap;}
  th{background:var(--resalte);color:white;position:sticky;top:0;z-index:3;}
  select{padding:4px 6px;border-radius:6px;border:1px solid #ccc;font-size:13px;}
  .tabla-container{overflow:auto;max-height:70vh;border:2px solid var(--borde);border-radius:8px;}
  .resaltada{background:var(--resalte-columna);}
</style>
</head>
<body>
<h1>üß© PROVSOFT ‚Äì Catalog Mapper Visual</h1>
<div class="card">
  <h3>1Ô∏è‚É£ Selecciona tu archivo TXT</h3>
  <input type="file" id="fileInput" accept=".txt">
  <button onclick="leerArchivo()">üìÇ Cargar y visualizar</button>
  <p id="status"></p>

  <div id="tablaContainer" class="tabla-container" style="display:none;">
    <h3>2Ô∏è‚É£ Asigna las columnas</h3>
    <table id="tablaDatos">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
    <br>
    <button id="btnGenerar" onclick="generarJSON()">üíæ Generar JSON</button>
  </div>
</div>

<script>
const CAMPOS=["claveSat","codigoBarra","concepto","costoSinImpuesto","departamento_id","mayoreo","medioMayoreo","precioPublico","unidadMedidaSat"];
let lineas=[],separador=/\s{2,}/,mapeo={};

// Detecta separador
function detectarSeparador(l){
  if(l.includes('\t'))return /\t/;
  if(l.includes(';'))return /;/;
  if(l.includes('|'))return /\|/;
  return /\s{2,}/;
}
// Divide respetando comillas
function dividirRespetandoComillas(l){
  const regex=/"([^"]*)"|(\S+)/g,tokens=[];let m;
  while((m=regex.exec(l))!==null)tokens.push(m[1]??m[2]);
  return tokens;
}
// Leer archivo
function leerArchivo(){
  const file=document.getElementById("fileInput").files[0];
  if(!file)return alert("Selecciona un archivo TXT primero.");
  const reader=new FileReader();
  reader.onload=e=>{
    lineas=e.target.result.split('\n').filter(l=>l.trim()!=="");
    separador=detectarSeparador(lineas[0]);
    const datos=lineas.map(l=>dividirRespetandoComillas(l)); // TODAS las filas
    const maxCols=Math.max(...datos.map(r=>r.length));
    document.getElementById("status").innerText=
      `Archivo cargado con ${lineas.length} l√≠neas. Columnas detectadas: ${maxCols}`;
    mostrarTabla(datos,maxCols);
  };
  reader.readAsText(file,"utf-8");
}
// Mostrar tabla
function mostrarTabla(datos,maxCols){
  const thead=document.getElementById("thead");
  const tbody=document.getElementById("tbody");
  thead.innerHTML="";tbody.innerHTML="";
  // fila selects
  const filaMap=document.createElement("tr");
  for(let i=0;i<maxCols;i++){
    const th=document.createElement("th");
    const sel=document.createElement("select");
    sel.dataset.columna=i;
    sel.innerHTML=`<option value="">-- Sin asignar --</option>`;
    CAMPOS.forEach(c=>{
      const op=document.createElement("option");
      op.value=c;op.textContent=c;sel.appendChild(op);
    });
    sel.addEventListener("change",validarMapeo);
    sel.addEventListener("change",e=>resaltarColumna(i,e.target.value!==""));
    th.appendChild(sel);filaMap.appendChild(th);
  }
  thead.appendChild(filaMap);
  // encabezado fijo
  const filaHead=document.createElement("tr");
  for(let i=0;i<maxCols;i++){
    const th=document.createElement("th");
    th.textContent=`Col${String(i+1).padStart(2,'0')}`;
    filaHead.appendChild(th);
  }
  thead.appendChild(filaHead);
  // filas
  datos.forEach(fila=>{
    const tr=document.createElement("tr");
    for(let i=0;i<maxCols;i++){
      const td=document.createElement("td");
      td.textContent=fila[i]||"";
      td.classList.add(`col-${i}`);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  document.getElementById("tablaContainer").style.display="block";
  const btn=document.getElementById("btnGenerar");
  btn.disabled=true;btn.classList.remove("activo");
}
// Validar mapeo
function validarMapeo(){
  const sels=document.querySelectorAll("thead select");
  const valores=[...sels].map(s=>s.value).filter(v=>v!=="");
  const faltantes=CAMPOS.filter(c=>!valores.includes(c));
  const repetidos=valores.filter((v,i,a)=>a.indexOf(v)!==i&&v!=="");
  sels.forEach(s=>s.classList.remove("error"));
  sels.forEach(s=>{if(repetidos.includes(s.value))s.classList.add("error");});
  const btn=document.getElementById("btnGenerar");
  if(faltantes.length===0&&repetidos.length===0){btn.classList.add("activo");btn.disabled=false;}
  else{btn.classList.remove("activo");btn.disabled=true;}
}
function resaltarColumna(i,activo){
  document.querySelectorAll(`.col-${i}`).forEach(td=>td.classList.toggle("resaltada",activo));
}
// Generar JSON, usando √∫ltimo registro por claveSat o c√≥digo
function generarJSON(){
  const sels=document.querySelectorAll("thead select");
  mapeo={};
  sels.forEach(s=>{if(s.value!=="")mapeo[s.value]=parseInt(s.dataset.columna);});
  const mapa=new Map();
  for(const l of lineas){
    const d=dividirRespetandoComillas(l);
    const obj={};
    for(const c of CAMPOS){
      const idx=mapeo[c];let val=d[idx]||"";
      if(["costoSinImpuesto","mayoreo","medioMayoreo","precioPublico"].includes(c))
        val=parseFloat(val)||0;
      obj[c]=val;
    }
    const clave=obj.codigoBarra||obj.claveSat||Math.random();
    mapa.set(clave,obj); // sobreescribe si ya exist√≠a
  }
  const productos=[...mapa.values()];
  const blob=new Blob([JSON.stringify(productos,null,2)],{type:"application/json"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="catalogo_actualizado.json";
  link.click();
}
</script>
</body>
</html>
