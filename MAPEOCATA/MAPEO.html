<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ðŸ§© PROVSOFT â€“ Catalog Mapper Visual</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --azul:#00416A;--res:#0c6cbd;--gris:#E4E5E6;--blanco:#fff;
  --borde:#cfd8dc;--resaltado:#d0e6ff;
}
body{
  font-family:Poppins,sans-serif;
  background:linear-gradient(135deg,var(--azul),var(--gris));
  margin:0;padding:20px;color:#111;
}
h1{color:#fff;text-align:center}
.card{
  background:#fff;border-radius:16px;padding:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.15);
  max-width:95%;margin:auto;
}
button,input{padding:10px 16px;border-radius:10px}
button{background:#999;color:#fff;border:none;cursor:not-allowed}
button.activo{background:var(--res);cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid var(--borde);padding:6px;font-size:13px}
th{background:var(--res);color:#fff;position:sticky;top:0}
.resaltada{background:var(--resaltado)}
.tabla-container{max-height:65vh;overflow:auto;border:2px solid var(--borde)}
</style>
</head>

<body>
<h1>ðŸ§© PROVSOFT â€“ Catalog Mapper Visual</h1>

<div class="card">
  <input type="file" id="fileInput" accept=".txt">
  <button onclick="leerArchivo()">ðŸ“‚ Cargar TXT</button>
  <button onclick="exportarMapeo()">ðŸ“¦ Exportar mapeo</button>
  <input type="file" accept=".json" onchange="importarMapeo(this.files[0])">
  <p id="status"></p>

  <div id="tablaContainer" class="tabla-container" style="display:none">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
    <br>
    <button id="btnGenerar" onclick="generarJSON()">ðŸ’¾ Descargar JSON</button>
  </div>
</div>

<!-- ================= FIREBASE + APP ================= -->
<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= APP ================= */
const CAMPOS=[
  "claveSat","codigoBarra","concepto","costoSinImpuesto",
  "departamento_id","mayoreo","medioMayoreo",
  "precioPublico","unidadMedidaSat"
];

let lineas=[],mapeo={},jsonGenerado=null;
const STORAGE_KEY="provsoft_mapeo_catalogo";
const MAPEO_DOC="catalogo_default";

/* ================= MAPEO STORAGE ================= */
async function guardarMapeoFirestore(data){
  await setDoc(doc(db,"configuraciones","mapeos","catalogos",MAPEO_DOC),{
    mapeo:data,updatedAt:new Date()
  });
}

async function cargarMapeoFirestore(){
  const d=await getDoc(doc(db,"configuraciones","mapeos","catalogos",MAPEO_DOC));
  return d.exists()?d.data().mapeo:null;
}

async function inicializarMapeo(){
  const remoto=await cargarMapeoFirestore();
  if(remoto){
    localStorage.setItem(STORAGE_KEY,JSON.stringify(remoto));
    mapeo=remoto;
  } else {
    const local=localStorage.getItem(STORAGE_KEY);
    if(local) mapeo=JSON.parse(local);
  }
}
window.addEventListener("DOMContentLoaded",inicializarMapeo);

/* ================= UTIL ================= */
function dividir(l){
  const r=/"([^"]*)"|(\S+)/g,a=[];let m;
  while((m=r.exec(l))!==null)a.push(m[1]??m[2]);
  return a;
}

/* ================= UI ================= */
window.leerArchivo=()=>{
  const f=document.getElementById("fileInput").files[0];
  if(!f)return alert("Selecciona archivo");
  const r=new FileReader();
  r.onload=e=>{
    lineas=e.target.result.split("\n").filter(x=>x.trim());
    mostrarTabla(lineas.map(dividir));
    setTimeout(procesarAutomatico,200);
  };
  r.readAsText(f,"utf-8");
};

function mostrarTabla(datos){
  const th=document.getElementById("thead");
  const tb=document.getElementById("tbody");
  th.innerHTML="";tb.innerHTML="";
  const max=Math.max(...datos.map(r=>r.length));

  const tr=document.createElement("tr");
  for(let i=0;i<max;i++){
    const sel=document.createElement("select");
    sel.dataset.col=i;
    sel.innerHTML="<option></option>"+CAMPOS.map(c=>`<option>${c}</option>`).join("");
    sel.onchange=()=>guardarMapeoDesdeUI();
    const thd=document.createElement("th");
    thd.appendChild(sel);tr.appendChild(thd);
  }
  th.appendChild(tr);

  datos.forEach(r=>{
    const tr=document.createElement("tr");
    for(let i=0;i<max;i++){
      const td=document.createElement("td");
      td.textContent=r[i]||"";tr.appendChild(td);
    }
    tb.appendChild(tr);
  });

  document.getElementById("tablaContainer").style.display="block";
  aplicarMapeoVisual();
}

async function guardarMapeoDesdeUI(){
  mapeo={};
  document.querySelectorAll("thead select").forEach(s=>{
    if(s.value)mapeo[s.value]=+s.dataset.col;
  });
  localStorage.setItem(STORAGE_KEY,JSON.stringify(mapeo));
  await guardarMapeoFirestore(mapeo);
}

function aplicarMapeoVisual(){
  document.querySelectorAll("thead select").forEach(s=>{
    const k=Object.keys(mapeo).find(x=>mapeo[x]==s.dataset.col);
    if(k)s.value=k;
  });
}

function procesarAutomatico(){
  if(!Object.keys(mapeo).length)return;
  const map=new Map();
  for(const l of lineas){
    const d=dividir(l),o={};
    CAMPOS.forEach(c=>{
      let v=d[mapeo[c]]||"";
      if(["costoSinImpuesto","mayoreo","medioMayoreo","precioPublico"].includes(c))
        v=parseFloat(v)||0;
      o[c]=v;
    });
    map.set(o.codigoBarra||o.claveSat||Math.random(),o);
  }
  jsonGenerado=[...map.values()];
  document.getElementById("btnGenerar").classList.add("activo");
  document.getElementById("btnGenerar").disabled=false;
}

window.generarJSON=()=>{
  if(!jsonGenerado)return alert("Nada procesado");
  const b=new Blob([JSON.stringify(jsonGenerado,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);a.download="catalogo_actualizado.json";a.click();
};

window.exportarMapeo=()=>{
  const d=localStorage.getItem(STORAGE_KEY);
  if(!d)return alert("No hay mapeo");
  const b=new Blob([d],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);a.download="mapeo_provsoft.json";a.click();
};

window.importarMapeo=f=>{
  const r=new FileReader();
  r.onload=e=>{
    localStorage.setItem(STORAGE_KEY,e.target.result);
    location.reload();
  };
  r.readAsText(f);
};
</script>
</body>
</html>
