<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üß© PROVSOFT ‚Äì Sincronizador por Lotes Firebase</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg,#00416A,#E4E5E6); color: #111; margin: 0; padding: 20px;}
  h1 { color: white; text-align: center; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);}
  .card { background: rgba(255,255,255,0.96); border-radius: 16px; padding: 20px; max-width: 95%; margin: 20px auto; box-shadow: 0 8px 24px rgba(0,0,0,0.15);}
  input[type="file"], button { padding: 10px 16px; border-radius: 10px; border: 1px solid #ccc; font-size: 15px; margin: 6px;}
  button { background: #0c6cbd; color: white; font-weight: 600; cursor: pointer; }
  button:hover { background: #00416A; }
  #log { white-space: pre-line; background: #111; color: #00FF7F; font-family: monospace; font-size: 13px; padding: 10px; border-radius: 10px; height: 400px; overflow-y: auto;}
  #barra { width: 100%; background: #ddd; height: 20px; border-radius: 10px; margin-top: 10px; }
  #progreso { height: 100%; width: 0%; background: #0c6cbd; border-radius: 10px; transition: width 0.3s ease; }
</style>
</head>
<body>
<h1>üß© PROVSOFT ‚Äì Sincronizador por Lotes Firebase</h1>

<div class="card">
  <h3>1Ô∏è‚É£ Subir archivo JSON generado</h3>
  <input type="file" id="fileInput" accept=".json">
  <button onclick="sincronizar()">üöÄ Sincronizar con Firebase (por lotes)</button>
  <p id="estado"></p>
  <div id="barra"><div id="progreso"></div></div>
  <div id="log"></div>
</div>

<!-- üî• FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ‚öôÔ∏è CONFIGURACI√ìN FIREBASE ‚Äì PROYECTO inventariopv-643f1
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.firebasestorage.app",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const logBox = document.getElementById("log");
  const progresoBar = document.getElementById("progreso");

  function log(msg) {
    logBox.textContent += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  // üïì pausa de n milisegundos
  const delay = ms => new Promise(res => setTimeout(res, ms));

  async function sincronizar() {
    const archivo = document.getElementById("fileInput").files[0];
    if (!archivo) return alert("Selecciona primero el archivo JSON.");

    const texto = await archivo.text();
    const nuevos = JSON.parse(texto);
    const total = nuevos.length;
    const loteTam = 400; // üî¢ cantidad por lote
    let procesados = 0;
    let nuevosCont = 0, actualizados = 0, reactivados = 0;

    log(`üìÇ Archivo cargado (${total} productos)\nDescargando colecci√≥n actual...`);
    const productosRef = collection(db, "productos");
    const snapshot = await getDocs(productosRef);
    const actuales = {};
    snapshot.forEach(d => actuales[d.data().codigoBarra] = { id: d.id, ...d.data() });
    log(`üì¶ Productos actuales: ${snapshot.size}`);

    for (let i = 0; i < total; i += loteTam) {
      const lote = nuevos.slice(i, i + loteTam);
      log(`üöß Procesando lote ${Math.floor(i / loteTam) + 1}/${Math.ceil(total / loteTam)} (${lote.length} items)...`);

      for (const nuevo of lote) {
        const codigo = (nuevo.codigoBarra || "").trim();
        if (!codigo) continue;

        const actual = actuales[codigo];
        const fecha = new Date().toISOString();

        if (!actual) {
          // Nuevo producto
          await setDoc(doc(productosRef), { ...nuevo, activo: true, actualizadoEn: fecha });
          log("‚ûï Nuevo: " + nuevo.concepto);
          nuevosCont++;
        } else {
          // Comparar campos
          let modificado = false;
          const cambios = {};
          for (const campo of [
            "claveSat","concepto","costoSinImpuesto","departamento_id",
            "mayoreo","medioMayoreo","precioPublico","unidadMedidaSat"
          ]) {
            if (nuevo[campo] !== actual[campo]) {
              cambios[campo] = nuevo[campo];
              modificado = true;
            }
          }

          if (modificado) {
            cambios.activo = true;
            cambios.actualizadoEn = fecha;
            await updateDoc(doc(db, "productos", actual.id), cambios);
            log("üìù Actualizado: " + nuevo.concepto);
            actualizados++;
          } else {
            if (!actual.activo) {
              await updateDoc(doc(db, "productos", actual.id), { activo: true });
              log("‚úÖ Reactivado: " + nuevo.concepto);
              reactivados++;
            } else {
              log("üÜó Sin cambios: " + nuevo.concepto);
            }
          }
        }
        procesados++;
        progresoBar.style.width = ((procesados / total) * 100).toFixed(2) + "%";
      }

      log(`‚è∏Ô∏è Pausa 2 segundos para evitar sobrecarga...`);
      await delay(2000);
    }

    log(`\n‚úÖ Sincronizaci√≥n completada.
üÜï Nuevos: ${nuevosCont}
üìù Actualizados: ${actualizados}
‚úÖ Reactivados: ${reactivados}
üìä Total procesados: ${procesados}`);
  }
  // üëá ESTA L√çNEA HACE VISIBLE LA FUNCI√ìN PARA EL BOT√ìN
  window.sincronizar = sincronizar;

</script>
</body>
</html>
