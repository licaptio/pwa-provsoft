<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00416A">

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>

  <meta charset="UTF-8" />
  <title>BOOKIT ‚Äì Subida Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; margin: 20px; background:#f3f3f3; }
    h2 { text-align: center; }

    #preview {
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      display: none;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    #pasteArea {
      width: 100%;
      padding: 20px;
      border: 2px dashed #888;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 15px;
      color: #444;
      background: white;
    }

    .btn {
      width: 100%; 
      padding: 12px; 
      margin-bottom: 10px;
      border-radius: 8px; 
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }

    .camera { background:#007bff; }
    .gallery { background:#28a745; }
    .upload { background:#00416A; }
    .upload:hover { background:#003055; }

    input, textarea {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border-radius: 8px; border: 1px solid #ccc;
      font-size: 16px;
      background:white;
    }
  label.btn {
  display: block;
  text-align: center;
  position: relative;
}

label.btn input[type=file] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

  </style>
</head>
<body>

<h2>üì§ Bookit ‚Äì Subida Pro</h2>

<!-- üìå Vista previa -->
<img id="preview">

<!-- üìå Zona de pegado -->
<div id="pasteArea">üìå Pega aqu√≠ una imagen (Ctrl+V o Windows+Shift+S)</div>
<!-- üì∏ Selecci√≥n de imagen (Android + Desktop OK) -->
<label class="btn camera">
  üì∑ Tomar foto
  <input
    type="file"
    accept="image/*"
    capture="environment"
    onchange="loadPreviewFile(this.files[0])">
</label>

<label class="btn gallery">
  üñºÔ∏è Galer√≠a
  <input
    type="file"
    accept="image/*"
    onchange="loadPreviewFile(this.files[0])">
</label>

<textarea id="caption" rows="3" placeholder="Escribe una nota..."></textarea>
<input type="text" id="relation" placeholder="Relaci√≥n (ej: Sergio Aguayo)" />

<button class="btn upload" onclick="upload()">üöÄ SUBIR FOTO</button>
<script>
const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

let selectedFile = null;

/* ============================
   üß© PEGADO CTRL+V
============================ */
document.addEventListener("paste", (event) => {
  const items = event.clipboardData.items;

  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf("image") !== -1) {
      const file = items[i].getAsFile();
      loadPreviewFile(file);
      return;
    }
  }

  alert("No pegaste una imagen.");
});

/* ============================
   üé® VISTA PREVIA
============================ */
function loadPreviewFile(file) {
  selectedFile = file;

  const preview = document.getElementById("preview");
  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";

  document.getElementById("pasteArea").innerText =
    "üì∏ Imagen lista para subir";
}

/* ============================
   üóúÔ∏è COMPRESI√ìN
============================ */
function compressImage(file) {
  return new Promise((resolve) => {
    const img = document.createElement("img");
    const reader = new FileReader();

    reader.onload = (e) => {
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const MAX_WIDTH = 1280;

      let width = img.width;
      let height = img.height;

      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
      }

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob(
        (blob) => resolve(new File([blob], file.name, { type: "image/jpeg" })),
        "image/jpeg",
        0.8
      );
    };
  });
}

/* ============================
   üöÄ SUBIR A SUPABASE
============================ */
async function upload() {
  if (!selectedFile) return alert("Selecciona o pega una imagen primero.");

  const caption = document.getElementById("caption").value;
  const relation = document.getElementById("relation").value;

  // Comprimir antes de subir
  const compressed = await compressImage(selectedFile);

  const fileName = Date.now() + "-" + compressed.name.replace(/\s+/g, "");

  const { data: uploadData, error: uploadError } = await supabase.storage
    .from("bookit")
    .upload(fileName, compressed);

  if (uploadError) {
    console.error(uploadError);
    return alert("Error al subir imagen");
  }

  // MUY IMPORTANTE: AQU√ç SE GUARDA LA RUTA CORRECTA
  const path = uploadData.path;

  await supabase.from("bookit_entries").insert({
    image_url: path,
    caption,
    relation
  });

  alert("üì§ ¬°Imagen subida con √©xito!");

  selectedFile = null;
  document.getElementById("preview").style.display = "none";
  document.getElementById("caption").value = "";
  document.getElementById("relation").value = "";
  document.getElementById("pasteArea").innerText =
    "üìå Pega aqu√≠ una imagen (Ctrl+V o Windows+Shift+S)";
}
</script>


</body>
</html>
