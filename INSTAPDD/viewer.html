<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00416A">

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js?v=6");
  }
</script>

  <meta charset="UTF-8"/>
  <title>BOOKIT ‚Äì Diario Visual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #fafafa;
  margin: 0;
  padding: 0;
}

/* FILTROS IG */
.filters {
  position: sticky;
  top: 0;
  background: white;
  padding: 10px;
  border-bottom: 1px solid #ddd;
  z-index: 10;
}

select {
  padding: 10px;
  width: 100%;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  margin: 0;
}

/* ===== GRID IG ===== */
.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* siempre 3 columnas */
  gap: 3px;             /* separaci√≥n tipo instagram */
  padding: 3px;
}
/* Cada item debe ser cuadrado IG REAL */
.grid-item {
  position: relative;
  width: 100%;
  padding-top: 100%; /* üî• CREA EL CUADRADO PERFECTO */
  overflow: hidden;
  border-radius: 3px;
  background: #eee;
  cursor: pointer;
  box-sizing: border-box;
}

.grid-item img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Hover de informaci√≥n */
.info-hover {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.65);
  color: white;
  font-size: 12px;
  padding: 6px;
  opacity: 0;
  transition: .2s;
}
.grid-item:hover .info-hover {
  opacity: 1;
}

/* Bot√≥n borrar */
.delete-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(255, 0, 0, 0.85);
  border: none;
  padding: 4px 8px;
  color: white;
  border-radius: 3px;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: .2s;
}
.grid-item:hover .delete-btn {
  opacity: 1;
}

/* ALERTAS IGUALES */
.alert-sergio {
  border: 3px solid red !important;
  animation: blink-sergio 1s infinite !important;
}
@keyframes blink-sergio {
  0% { box-shadow: 0 0 8px red; }
  50% { box-shadow: 0 0 25px red; }
  100% { box-shadow: 0 0 8px red; }
}

.alert-pago {
  border: 3px solid #7b00ff !important;
  animation: blink-pago 1s infinite !important;
}
@keyframes blink-pago {
  0% { box-shadow: 0 0 8px #7b00ff; }
  50% { box-shadow: 0 0 25px #d28bff; }
  100% { box-shadow: 0 0 8px #7b00ff; }
}

/* ======== M√ìVIL ======== */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.hidden-item {
  display: none !important;
}
.hide-check {
  position: absolute;
  top: 6px;
  left: 6px;
  z-index: 10;
  width: 22px;
  height: 22px;
  appearance: none;
  display: none;
  border-radius: 6px;

  /* üî• FONDO OSCURO QUE SE VE EN CUALQUIER IMAGEN */
  background: rgba(0,0,0,0.55);

  /* BORDE BLANCO FIRME */
  border: 2px solid white;

  /* SOMBRA PARA SEPARARSE DE LA FOTO */
  box-shadow: 0 0 4px rgba(0,0,0,0.7);

  cursor: pointer;
}

.hide-check:checked {
  background: #00c853; /* VERDE DE SELECCI√ìN */
  border-color: white;
}
/* üî• ALERTA RECLAMACI√ìN ‚Äì AMARILLO NE√ìN */
.alert-reclamacion {
  border: 3px solid #fff200 !important; /* Amarillo ne√≥n */
  animation: blink-reclamacion 0.85s infinite !important;
}

@keyframes blink-reclamacion {
  0%   { box-shadow: 0 0 10px #fff200; }
  50%  { box-shadow: 0 0 32px #fffb7a; }
  100% { box-shadow: 0 0 10px #fff200; }
}

</style>
</head>

<body>

<div class="filters">
  <select id="relationFilter">
    <option value="">üîé Filtrar por relaci√≥n</option>
  </select>

  <!-- BOT√ìN PARA ACTIVAR MODO OCULTAR -->
  <button id="toggleHideMode" style="
    width:100%;padding:10px;margin-top:10px;
    background:#444;color:white;border:none;border-radius:6px;font-size:14px;
  ">
    üëÅÔ∏è Modo Ocultar/Mostrar
  </button>

  <!-- BOT√ìN PARA DESOCULTAR TODO -->
  <button id="showAllBtn" style="
    width:100%;padding:10px;margin-top:10px;
    background:#0c6cbd;color:white;border:none;border-radius:6px;
    font-size:14px;display:none;
  ">
    üîÑ Mostrar TODO lo oculto
  </button>
</div>


<div id="gallery" class="grid"></div>

<script>
/* üîë SUPABASE */
const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

let page = 0;
const limit = 30;
let loading = false;
// ============================
// Guardar im√°genes ocultas
// ============================


/* ===============================
   CARGAR RELACIONES
=============================== */
async function loadRelations() {
  const { data } = await supabase.from("bookit_entries").select("relation");

  const relations = [...new Set(data
  .map(r => r.relation)
  .filter(Boolean)
)].sort((a, b) => a.localeCompare(b, "es")); 

  const sel = document.getElementById("relationFilter");

  relations.forEach(rel => {
    const op = document.createElement("option");
    op.value = rel;
    op.textContent = "üè∑ " + rel;
    sel.appendChild(op);
  });
}

/* ===============================
   CARGAR FOTOS
=============================== */
async function loadMore(reset = false) {
  if (loading) return;
  loading = true;

  if (reset) {
    document.getElementById("gallery").innerHTML = "";
    page = 0;
  }

  const start = page * limit;
  const end = start + limit - 1;

let q = supabase.from("bookit_entries")
  .select("*")
  .eq("hidden", false) // üî• solo mostrar im√°genes no ocultas
  .order("created_at", { ascending: false })
  .range(start, end);
  

  const rel = document.getElementById("relationFilter").value;
  if (rel) q = q.eq("relation", rel);

  const { data } = await q;

  data.forEach(addImage);

  page++;
  loading = false;
}

/* ===============================
   AGREGAR IMAGEN
=============================== */
function addImage(item) {
  const gallery = document.getElementById("gallery");

  const { data: publicUrlData } = supabase.storage
    .from("bookit")
    .getPublicUrl(item.image_url);

  const url = publicUrlData.publicUrl + "?v=" + Date.now();
  const fecha = new Date(item.created_at).toLocaleString();

  const div = document.createElement("div");
div.dataset.id = item.id;

  let extraClass = "";

// üî¥ Sergio Aguayo (rojo parpadeante)
if (item.relation && item.relation.toUpperCase() === "SERGIO AGUAYO") {
  extraClass = "alert-sergio";
}

// üü£ Pago (morado parpadeante)
if (item.relation && item.relation.toUpperCase().includes("PAGO")) {
  extraClass = "alert-pago";
}


if (item.relation && item.relation.toUpperCase().includes("RECLAMACION")) {
  extraClass = "alert-reclamacion";
}


  div.className = "grid-item " + extraClass;

div.innerHTML = `
<input type="checkbox" class="hide-check" onchange="toggleItem(this)">
      <img src="${url}" onclick="downloadImage('${url}')">

      <div class="info-hover">
        <b>Nota:</b> ${item.caption || "-"}<br>
        <b>Relaci√≥n:</b> ${item.relation || "-"}<br>
        <b>Fecha:</b> ${fecha}
      </div>

      <button class="delete-btn" onclick="deleteImage('${item.id}', '${item.image_url}', event)">X</button>
  `;

  gallery.appendChild(div);
}

function downloadImage(url) {
  const a = document.createElement("a");
  a.href = url;
  a.download = "imagen.jpg";
  a.click();
}

async function deleteImage(id, path, ev) {
  ev.stopPropagation();

  const pass = prompt("Contrase√±a para borrar:");

  if (pass !== "1982") return alert("‚ùå Contrase√±a incorrecta");

  await supabase.from("bookit_entries").delete().eq("id", id);
  await supabase.storage.from("bookit").remove([path]);

  alert("‚úî Imagen eliminada");
  loadMore(true);
}

/* ===============================
   EVENTOS
=============================== */
relationFilter.onchange = () => loadMore(true);

window.onscroll = () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    loadMore();
  }
};

loadRelations();
loadMore();
function toggleItem(check) {
  const card = check.closest(".grid-item");
  const id = card.dataset.id; // <-- ID √∫nico del item

  if (check.checked) {
    card.classList.add("hidden-item");

await supabase.from("bookit_entries")
  .update({ hidden: true })
  .eq("id", id);

  } else {
    card.classList.remove("hidden-item");

    // Quitar ID de localStorage
await supabase.from("bookit_entries")
  .update({ hidden: false })
  .eq("id", id);
  }
}

let hideMode = false;

document.getElementById("toggleHideMode").onclick = () => {
  hideMode = !hideMode;

  document.querySelectorAll(".hide-check").forEach(ch => {
    ch.style.display = hideMode ? "block" : "none";
  });

  document.getElementById("toggleHideMode").textContent =
    hideMode ? "üëÅÔ∏è‚Äçüó®Ô∏è Salir del modo ocultar" : "üëÅÔ∏è Modo Ocultar/Mostrar";

  document.getElementById("showAllBtn").style.display =
    hideMode ? "block" : "none";
};

document.getElementById("showAllBtn").onclick = async () => {

  // üî• Actualizar TODAS en Supabase (quitar oculto)
  await supabase
    .from("bookit_entries")
    .update({ hidden: false })
    .eq("hidden", true);

  // üî• Quitar la clase visual de los elementos
  document.querySelectorAll(".hidden-item").forEach(el => {
    el.classList.remove("hidden-item");
    const check = el.querySelector(".hide-check");
    if (check) check.checked = false;
  });

  alert("‚úî Todas las im√°genes han sido desocultadas");

  // üî• Recargar galer√≠a ya limpia
  loadMore(true);
};

</script>
</body>
</html>
