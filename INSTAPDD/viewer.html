<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00416A">

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js?v=7");
  }
</script>

  <meta charset="UTF-8"/>
  <title>BOOKIT ‚Äì Diario Visual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #fafafa;
  margin: 0;
  padding: 0;
}

/* FILTROS IG */
.filters {
  position: sticky;
  top: 0;
  background: white;
  padding: 10px;
  border-bottom: 1px solid #ddd;
  z-index: 10;
}

select {
  padding: 10px;
  width: 100%;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  margin: 0;
}
/* GRID RESPONSIVO TIPO INSTAGRAM */
.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* üíª 3 columnas en PC */
  gap: 3px;
  padding: 3px;
}

/* üì± Celular: solo 2 columnas */
@media (max-width: 600px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* CUADRO PERFECTO 1:1 */
.grid-item {
  position: relative;
  width: 100%;
  padding-top: 100%; /* cuadrado */
  overflow: hidden;
  border-radius: 3px;
  background: black; /* üî• RELLENO NEGRO */
  box-sizing: border-box;
}

/* CONTENEDOR INTERNO */
.grid-item .inner-content {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: black; /* üî• fondo negro tambi√©n */
}

/* IMAGEN COMPLETA SIN DESBORDARSE */
.grid-item .inner-content img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain !important; /* üî• NO SE RECORTA */
  background: black;
}

/* Hover info */
.info-hover {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.65);
  color: white;
  font-size: 12px;
  padding: 6px;
  opacity: 0;
  transition: .2s;
}
.grid-item:hover .info-hover {
  opacity: 1;
}

/* Checkbox */
.hide-check {
  position: absolute;
  top: 6px;
  left: 6px;
  z-index: 40;
  width: 26px;
  height: 26px;
  display: none;
  background: rgba(0,0,0,0.55);
  border: 2px solid white;
  border-radius: 6px;
  box-shadow: 0 0 4px rgba(0,0,0,0.8);
  cursor: pointer;
}

/* Botones */
.delete-btn, .edit-btn {
  z-index: 50;
  position: absolute;
  opacity: 0;
  transition: .2s;
}

.grid-item:hover .delete-btn,
.grid-item:hover .edit-btn {
  opacity: 1;
}

.delete-btn {
  top: 6px;
  right: 6px;
  background: rgba(255, 0, 0, 0.85);
  padding: 4px 8px;
  color: white;
  border: none;
  border-radius: 3px;
}

.edit-btn {
  top: 6px;
  left: 40px;
  background: rgba(0,0,0,0.75);
  padding: 4px 8px;
  color: white;
  border: none;
  border-radius: 3px;
}

/* Oculto visual */
.hidden-item {
  opacity: 0.40;
  filter: grayscale(80%);
}

/* Alertas */
.alert-sergio {
  border: 3px solid red !important;
  animation: blink-sergio 1s infinite !important;
}
@keyframes blink-sergio {
  0% { box-shadow: 0 0 8px red; }
  50% { box-shadow: 0 0 25px red; }
  100% { box-shadow: 0 0 8px red; }
}

.alert-pago {
  border: 3px solid #7b00ff !important;
  animation: blink-pago 1s infinite !important;
}
@keyframes blink-pago {
  0% { box-shadow: 0 0 8px #7b00ff; }
  50% { box-shadow: 0 0 25px #d28bff; }
  100% { box-shadow: 0 0 8px #7b00ff; }
}

/* Reclamo */
.alert-reclamacion {
  border: 3px solid #fff200 !important;
  animation: blink-reclamacion 0.85s infinite !important;
}
@keyframes blink-reclamacion {
  0% { box-shadow: 0 0 10px #fff200; }
  50% { box-shadow: 0 0 32px #fffb7a; }
  100% { box-shadow: 0 0 10px #fff200; }
}
/* üî• Ocultar visualmente cuando est√° hidden */
.hidden-item {
  opacity: 0.35;
  filter: grayscale(100%);
}
/* üî• CHECKBOX PARA OCULTAR */
.hide-check {
  position: absolute;
  top: 6px;
  left: 6px;
  width: 26px;
  height: 26px;
  display: none;
  z-index: 20;

  /* Fondo oscuro visible sobre cualquier imagen */
  background: rgba(0, 0, 0, 0.55);

  /* Bordes y forma */
  border: 2px solid white;
  border-radius: 6px;

  /* Sombras */
  box-shadow: 0 0 4px rgba(0,0,0,0.8);

  cursor: pointer;
}

.hide-check:checked {
  background: #00c853; /* verde selecci√≥n */
  border-color: white;
}
.hidden-item img {
  display: none !important;
}

.hidden-item .info-hover,
.hidden-item .delete-btn,
.hidden-item .edit-btn {
  display: none !important;
}
  
</style>
</head>

<body>

<div class="filters">
  <select id="relationFilter">
    <option value="">üîé Filtrar por relaci√≥n</option>
  </select>

  <button id="toggleHideMode" style="
    width:100%;padding:10px;margin-top:10px;
    background:#444;color:white;border:none;border-radius:6px;font-size:14px;
  ">
    üëÅÔ∏è Modo Ocultar/Mostrar
  </button>

  <button id="showAllBtn" style="
    width:100%;padding:10px;margin-top:10px;
    background:#0c6cbd;color:white;border:none;border-radius:6px;
    font-size:14px;display:none;
  ">
    üîÑ Mostrar TODO lo oculto
  </button>
</div>

<div id="gallery" class="grid"></div>

<script>
/* SUPABASE */
const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

let page = 0;
const limit = 30;
let loading = false;

/* CARGAR RELACIONES */
async function loadRelations() {
  const { data } = await supabase.from("bookit_entries").select("relation");

  const relations = [...new Set(data
    .map(r => r.relation)
    .filter(Boolean)
  )].sort((a, b) => a.localeCompare(b, "es"));

  const sel = document.getElementById("relationFilter");

  relations.forEach(rel => {
    const op = document.createElement("option");
    op.value = rel;
    op.textContent = "üè∑ " + rel;
    sel.appendChild(op);
  });
}

/* CARGAR FOTOS */
async function loadMore(reset = false) {
  if (loading) return;
  loading = true;

  if (reset) {
    document.getElementById("gallery").innerHTML = "";
    page = 0;
  }

  const start = page * limit;
  const end = start + limit - 1;

  let q = supabase.from("bookit_entries")
    .select("*")
    .eq("hidden", false)
.order("updated_at", { ascending: false })
.order("created_at", { ascending: false })
    .range(start, end);

  const rel = document.getElementById("relationFilter").value;
  if (rel) q = q.eq("relation", rel);

  const { data } = await q;

  data.forEach(addImage);

  page++;
  loading = false;
}
/* üî• MODO OCULTAR / MOSTRAR */
let hideMode = false;

document.getElementById("toggleHideMode").onclick = () => {
  hideMode = !hideMode;

  document.querySelectorAll(".hide-check").forEach(ch => {
    if (hideMode) {
      ch.style.setProperty("display", "block", "important");
    } else {
      ch.style.setProperty("display", "none", "important");
      ch.checked = false;
    }
  });

  document.getElementById("toggleHideMode").textContent =
    hideMode ? "üëÅÔ∏è‚Äçüó®Ô∏è Salir del modo ocultar" : "üëÅÔ∏è Modo Ocultar/Mostrar";

  // Mostrar bot√≥n desocultar
  document.getElementById("showAllBtn").style.display =
    hideMode ? "block" : "none";
};

/* üî• DESOCULTAR TODO */
document.getElementById("showAllBtn").onclick = async () => {

  await supabase.from("bookit_entries")
    .update({ hidden: false })
    .eq("hidden", true);

  document.querySelectorAll(".hidden-item").forEach(el => {
    el.classList.remove("hidden-item");
    const check = el.querySelector(".hide-check");
    if (check) check.checked = false;
  });

  alert("‚úî Todas las im√°genes han sido desocultadas");
  loadMore(true);
};

/* AGREGAR IMAGEN */
function addImage(item) {
  const gallery = document.getElementById("gallery");

  const { data: publicUrlData } = supabase.storage
    .from("bookit")
    .getPublicUrl(item.image_url);

  const url = publicUrlData.publicUrl + "?v=" + Date.now();
  const fecha = new Date(item.created_at).toLocaleString();

  const div = document.createElement("div");
  div.dataset.id = item.id;

  let extraClass = "";

  if (item.relation?.toUpperCase() === "SERGIO AGUAYO") extraClass = "alert-sergio";
  if (item.relation?.toUpperCase().includes("PAGO")) extraClass = "alert-pago";
  if (item.relation?.toUpperCase().includes("RECLAMACION")) extraClass = "alert-reclamacion";

  div.className = "grid-item " + extraClass;

div.innerHTML = `
  <div class="inner-content">

    <input type="checkbox" class="hide-check" onchange="toggleItem(this)">
    
    <img src="${url}" onclick="downloadImage('${url}')">

    <div class="info-hover">
      <b>Nota:</b> ${item.caption || "-"}<br>
      <b>Relaci√≥n:</b> ${item.relation || "-"}<br>
      <b>Fecha:</b> ${fecha}
    </div>

    <button class="delete-btn" onclick="deleteImage('${item.id}', '${item.image_url}', event)">X</button>

    <button class="edit-btn" onclick="editImage('${item.id}', '${item.caption || ""}', '${item.relation || ""}', event)">‚úèÔ∏è</button>

  </div>
`;


  gallery.appendChild(div);
}

/* DESCARGAR */
function downloadImage(url) {
  const a = document.createElement("a");
  a.href = url;
  a.download = "imagen.jpg";
  a.click();
}

/* üî• EDITAR ITEM */
async function editImage(id, currentCaption, currentRelation, ev) {
  ev.stopPropagation();

  const newCaption = prompt("üìù Nuevo comentario:", currentCaption);
  if (newCaption === null) return;

  const newRelation = prompt("üè∑ Nueva relaci√≥n:", currentRelation);
  if (newRelation === null) return;

  await supabase.from("bookit_entries")
    .update({
      caption: newCaption,
      relation: newRelation,
      updated_at: new Date()   // üî• marca de tiempo
    })
    .eq("id", id);

  alert("‚úî Informaci√≥n actualizada");
  loadMore(true);
}

/* BORRAR */
async function deleteImage(id, path, ev) {
  ev.stopPropagation();

  const pass = prompt("Contrase√±a para borrar:");
  if (pass !== "1982") return alert("‚ùå Contrase√±a incorrecta");

  await supabase.from("bookit_entries").delete().eq("id", id);
  await supabase.storage.from("bookit").remove([path]);

  alert("‚úî Imagen eliminada");
  loadMore(true);
}
/* üî• OCULTAR / MOSTRAR ITEM (GUARDA EN SUPABASE) */
async function toggleItem(check) {
  const card = check.closest(".grid-item");
  const id = card.dataset.id;

  if (check.checked) {
    card.classList.add("hidden-item");
    await supabase.from("bookit_entries")
      .update({ hidden: true })
      .eq("id", id);
  } else {
    card.classList.remove("hidden-item");
    await supabase.from("bookit_entries")
      .update({ hidden: false })
      .eq("id", id);
  }
}

/* EVENTOS */
relationFilter.onchange = () => loadMore(true);

window.onscroll = () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    loadMore();
  }
};

loadRelations();
loadMore();

</script>
</body>
</html>
