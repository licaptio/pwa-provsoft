<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ASIGNACIÃ“N DE DEPARTAMENTOS E IMPUESTOS â€“ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #eef2f6;
  margin: 0;
}
header {
  background: #0B3C5D;
  color: white;
  padding: 15px;
  font-size: 20px;
  font-weight: 600;
  text-align: center;
}
.container {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
.card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
}
button {
  background: #1E88E5;
  color: white;
  border: none;
  padding: 14px 22px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  background: #1565C0;
}
.log {
  margin-top: 20px;
  font-size: 14px;
  background: #f5f7fa;
  padding: 10px;
  border-radius: 6px;
  max-height: 300px;
  overflow: auto;
}
.ok { color: green; }
.warn { color: #c62828; }
</style>
</head>

<body>

<header>ðŸ§© ASIGNACIÃ“N DE DEPARTAMENTOS E IMPUESTOS</header>

<div class="container">
  <div class="card">
    <p>
      Esta herramienta sincroniza los <b>productos</b> con el catÃ¡logo
      <b>departamentos_venta</b>, asignando correctamente:
    </p>
    <ul>
      <li>Nombre del departamento</li>
      <li>IVA</li>
      <li>IEPS</li>
    </ul>

    <button onclick="asignar()">â–¶ Ejecutar asignaciÃ³n</button>

    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ðŸ” TU CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};


firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function log(msg, type="ok") {
  const div = document.createElement("div");
  div.className = type;
  div.innerText = msg;
  document.getElementById("log").appendChild(div);
}

async function asignar() {
  document.getElementById("log").innerHTML = "";
  log("Cargando departamentos...");

  // 1ï¸âƒ£ Departamentos
  const depSnap = await db.collection("departamentos_venta").get();
  const deps = {};

  depSnap.forEach(doc => {
    const d = doc.data();
    deps[String(d.id)] = d;
  });

  log(`Departamentos cargados: ${Object.keys(deps).length}`);

  // 2ï¸âƒ£ Productos
  log("Cargando productos...");
  const prodSnap = await db.collection("productos").get();

  let batch = db.batch();
  let actualizados = 0;
  let sinDepto = 0;

prodSnap.forEach(doc => {
  const p = doc.data();

  // ðŸ”’ SOLO PRODUCTOS ACTIVOS
  if (p.activo !== true) return;

  const dep = deps[String(p.departamento_id)];

  if (!dep) {
    sinDepto++;
    log(`âŒ Producto sin departamento vÃ¡lido: ${p.concepto}`, "warn");
    return;
  }

  batch.update(doc.ref, {
    departamento: dep.nombre,
    ivaTasa: dep.iva,
    iepsTasa: dep.ieps,
    updatedAt: new Date().toISOString()
  });

  actualizados++;
});

  if (actualizados > 0) {
    await batch.commit();
  }

  log(`âœ” Productos actualizados: ${actualizados}`);
  if (sinDepto > 0) {
    log(`âš  Productos sin departamento asignable: ${sinDepto}`, "warn");
  }
  log("Proceso finalizado.");
}
</script>

</body>
</html>
